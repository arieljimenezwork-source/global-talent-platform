This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.cursor/rules/ariel-fundamentos.mdc
.env.local.example
.gitignore
components.json
confirm-and-assign-roles.sql
database-invitations-system.sql
datos-prueba-fix.sql
datos-prueba.sql
docs/sql/create_monthly_reports.sql
docs/sql/create_storage_bucket.sql
docs/sql/fix_monthly_reports.sql
docs/WORKFLOW.md
entrevistas-module/database-interviews-schema.sql
entrevistas-module/INSTRUCCIONES.md
entrevistas-module/src/app/api/interviews/complete/route.ts
entrevistas-module/src/app/api/interviews/create/route.ts
entrevistas-module/src/app/api/interviews/start/route.ts
entrevistas-module/src/app/api/interviews/webhook/route.ts
entrevistas-module/src/app/entrevista/[token]/InterviewRoom.tsx
entrevistas-module/src/app/entrevista/[token]/page.tsx
entrevistas-module/src/app/entrevista/[token]/TokenInvalido.tsx
entrevistas-module/src/middleware.ts
entrevistas-module/src/types/interviews.types.ts
gtc-sprint-permisos-perfil-azul/001-migration-permisos-perfil-leads.sql
gtc-sprint-permisos-perfil-azul/README.md
gtc-sprint-permisos-perfil-azul/src/app/(dashboard)/perfil/page.tsx
gtc-sprint-permisos-perfil-azul/src/app/entrevista/[token]/InterviewRoom.tsx
gtc-sprint-permisos-perfil-azul/src/app/globals.css
gtc-sprint-permisos-perfil-azul/src/components/calidad/QualityScoreBar.tsx
gtc-sprint-permisos-perfil-azul/src/components/profile/AssistantProfileForm.tsx
gtc-sprint-permisos-perfil-azul/src/components/shared/Sidebar.tsx
gtc-sprint-permisos-perfil-azul/src/types/database.types.ts
GUIA-PRUEBAS.md
MIGRACION-COMPLETA.md
migration-interviews-module.sql
next.config.js
package.json
PASO-A-PASO-SUPABASE.md
postcss.config.js
public/logo.png
README.md
scripts/create-ariel-assistant.mjs
scripts/seed-team.mjs
setup-leads-kanban.sql
setup-roles-v2.sql
setup-usuario-prueba.sql
src/app/(auth)/layout.tsx
src/app/(auth)/login/page.tsx
src/app/(auth)/register/page.tsx
src/app/(dashboard)/asistentes/page.tsx
src/app/(dashboard)/banco-talento/page.tsx
src/app/(dashboard)/calendario-global/page.tsx
src/app/(dashboard)/calendario/page.tsx
src/app/(dashboard)/calidad/page.tsx
src/app/(dashboard)/calidad/reportes/page.tsx
src/app/(dashboard)/candidatos/page.tsx
src/app/(dashboard)/clientes/page.tsx
src/app/(dashboard)/configuracion/page.tsx
src/app/(dashboard)/dashboard/page.tsx
src/app/(dashboard)/entrevistas/page.tsx
src/app/(dashboard)/layout.tsx
src/app/(dashboard)/leads/page.tsx
src/app/(dashboard)/marketing/page.tsx
src/app/(dashboard)/metricas/page.tsx
src/app/(dashboard)/page.tsx
src/app/(dashboard)/panel-ejecutivo/page.tsx
src/app/(dashboard)/perfil/page.tsx
src/app/(dashboard)/reportes/mensual/page.tsx
src/app/(dashboard)/reportes/nuevo/page.tsx
src/app/(dashboard)/reportes/page.tsx
src/app/(dashboard)/reportes/semanal/[id]/page.tsx
src/app/(dashboard)/reportes/semanal/page.tsx
src/app/api/ai/improve-entry/route.ts
src/app/api/ai/improve/route.ts
src/app/api/interviews/complete/route.ts
src/app/api/interviews/create/route.ts
src/app/api/interviews/register-conversation/route.ts
src/app/api/interviews/start/route.ts
src/app/api/interviews/webhook/route.ts
src/app/entrevista/[token]/page.tsx
src/app/entrevista/[token]/TokenInvalido.tsx
src/app/globals.css
src/app/layout.tsx
src/components/calidad/QualityScoreBar.tsx
src/components/interview/InterviewRoom.tsx
src/components/leads/KanbanBoard.tsx
src/components/leads/KanbanColumn.tsx
src/components/leads/LeadCard.tsx
src/components/mensual/index.ts
src/components/mensual/MonthlyReportForm.tsx
src/components/profile/AssistantProfileForm.tsx
src/components/reportes/AssistantStatusCard.tsx
src/components/reportes/index.ts
src/components/reportes/monthly/ActivitiesTab.tsx
src/components/reportes/monthly/MetricsTab.tsx
src/components/reportes/monthly/MonthlyReportForm.tsx
src/components/reportes/monthly/ObjectivesTab.tsx
src/components/reportes/monthly/SuggestionsTab.tsx
src/components/reportes/monthly/SummaryTab.tsx
src/components/reportes/PlanEntryCard.tsx
src/components/reportes/ProgressRing.tsx
src/components/reportes/QualityDashboard.tsx
src/components/reportes/RuptureEntryCard.tsx
src/components/reportes/SubmitConfirmDialog.tsx
src/components/reportes/WeeklyReportForm.tsx
src/components/reportes/WeekSelector.tsx
src/components/shared/AlertBell.tsx
src/components/shared/ComingSoon.tsx
src/components/shared/index.ts
src/components/shared/Navbar.tsx
src/components/shared/Sidebar.tsx
src/components/shared/UserMenu.tsx
src/components/ui/alert.tsx
src/components/ui/avatar.tsx
src/components/ui/badge.tsx
src/components/ui/button.tsx
src/components/ui/card.tsx
src/components/ui/dropdown-menu.tsx
src/components/ui/input.tsx
src/components/ui/label.tsx
src/components/ui/MagicWandButton.tsx
src/components/ui/separator.tsx
src/components/ui/tabs.tsx
src/components/ui/textarea.tsx
src/components/ui/tooltip.tsx
src/hooks/useReportBackup.ts
src/lib/actions/monthly-reports.ts
src/lib/actions/reports.ts
src/lib/ai/gemini.ts
src/lib/hooks/index.ts
src/lib/hooks/useUser.ts
src/lib/supabase/client.ts
src/lib/supabase/index.ts
src/lib/supabase/server.ts
src/lib/utils/index.ts
src/lib/validations/monthly-reports.ts
src/lib/validations/reports.ts
src/middleware.ts
src/types/database.types.ts
src/types/interviews.types.ts
src/types/monthly-reports.types.ts
src/types/reports.types.ts
tailwind.config.ts
tsconfig.json
update-leads-access.sql
VERIFICACION-COMPLETA.md
verificar-constraint-clients.sql
verificar-supabase.sql
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".cursor/rules/ariel-fundamentos.mdc">
---
description: Cómo dirigirse a Ariel y cómo dar respuestas (explicar primero, pedir autorización)
alwaysApply: true
---

# Reglas de trabajo con Ariel

## 1. Tratar a Ariel como diseñador de estructuras

- Dirigir las respuestas a Ariel desde lo **fundamental y estructural**, no desde lo técnico por defecto.
- Explicar conceptos de forma que alguien que piensa en estructuras, flujos y decisiones pueda entender sin entrar en detalles técnicos complejos.
- Si hace falta tocar lo técnico, primero dar la idea general (qué se está haciendo y por qué) y solo después el detalle, si Ariel lo pide o lo autoriza.

## 2. No dar código ni tocar nada sin explicar y sin autorización

- **Antes de dar código o hacer cambios:** explicar siempre qué se va a hacer, por qué y qué implicaciones tiene. Nutrir primero, actuar después.
- **No disparar respuestas:** analizar la pregunta o el contexto, resumir el análisis si es útil, y solo entonces proponer la respuesta o los pasos.
- **Pedir autorización:** antes de desplegar respuestas largas, aplicar cambios en archivos o ejecutar comandos, preguntar explícitamente si Ariel autoriza (por ejemplo: "¿Quieres que te escriba el código / que aplique estos cambios?").
- Priorizar que Ariel entienda y decida; el código es una consecuencia de esa decisión, no lo primero.
</file>

<file path=".env.local.example">
# =====================================================
# GLOBAL TALENT PLATFORM - Environment Variables
# =====================================================
# Copia este archivo a .env.local y completa los valores

# -----------------------------------------------------
# SUPABASE
# -----------------------------------------------------
# URL del proyecto Supabase (encontrar en Settings > API)
NEXT_PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co

# Anon key (pública, segura para frontend)
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key-here

# Service role key (SOLO para server-side, nunca exponer al cliente)
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# Project ID (para generar tipos)
SUPABASE_PROJECT_ID=your-project-id

# -----------------------------------------------------
# AUTENTICACIÓN
# -----------------------------------------------------
# URL base de la aplicación
NEXT_PUBLIC_APP_URL=http://localhost:3000

# Secreto para JWT (generar con: openssl rand -base64 32)
NEXTAUTH_SECRET=your-random-secret-here

# -----------------------------------------------------
# APLICACIÓN
# -----------------------------------------------------
# Nombre de la empresa
NEXT_PUBLIC_COMPANY_NAME="Global Talent"

# Ambiente (development, staging, production)
NEXT_PUBLIC_ENVIRONMENT=development

# -----------------------------------------------------
# OPCIONAL: EMAILS (para notificaciones futuras)
# -----------------------------------------------------
# RESEND_API_KEY=your-resend-api-key
# EMAIL_FROM=noreply@globaltalent.com

# -----------------------------------------------------
# OPCIONAL: STORAGE (URLs personalizadas)
# -----------------------------------------------------
# NEXT_PUBLIC_STORAGE_URL=https://your-cdn.com

# -----------------------------------------------------
# OPCIONAL: ANALYTICS
# -----------------------------------------------------
# NEXT_PUBLIC_GA_TRACKING_ID=G-XXXXXXXXXX
# NEXT_PUBLIC_POSTHOG_KEY=your-posthog-key

# -----------------------------------------------------
# DESARROLLO
# -----------------------------------------------------
# Habilitar logs de Supabase
# NEXT_PUBLIC_SUPABASE_DEBUG=true
</file>

<file path=".gitignore">
# =====================================================
# GLOBAL TALENT PLATFORM - .gitignore
# =====================================================

# Dependencies
node_modules/
/.pnp
.pnp.js
# package-lock.json - INCLUIDO (para garantizar versiones consistentes)
yarn.lock
pnpm-lock.yaml

# Testing
/coverage
.nyc_output

# Next.js
/.next/
/out/
/build
/dist
.next
out
build
dist

# Production
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

# Environment variables (CRÍTICO - NO SUBIR)
.env
.env*.local
.env.development.local
.env.test.local
.env.production.local
.env.development
.env.test
.env.production

# Vercel
.vercel

# TypeScript
*.tsbuildinfo
next-env.d.ts

# IDE
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store
*.sublime-project
*.sublime-workspace

# OS
Thumbs.db
.DS_Store
.AppleDouble
.LSOverride

# Temporary files
*.tmp
*.temp
.cache/
.turbo/

# Supabase
.supabase/
supabase/.temp/

# Scripts con claves hardcodeadas (contienen API keys)
probar-post.sh
probar-post-con-id.sh

# Archivos grandes o temporales
repomix-output.xml
*.sql.bak
*.backup

# Logs
logs/
*.log

# Optional npm cache directory
.npm

# Optional eslint cache
.eslintcache

# Microbundle cache
.rpt2_cache/
.rts2_cache_cjs/
.rts2_cache_es/
.rts2_cache_umd/

# Optional REPL history
.node_repl_history

# Output of 'npm pack'
*.tgz

# Yarn Integrity file
.yarn-integrity

# parcel-bundler cache
.parcel-cache

# Stores VSCode versions used for testing VSCode extensions
.vscode-test
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "default",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "tailwind.config.ts",
    "css": "src/app/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/lib/hooks"
  }
}
</file>

<file path="confirm-and-assign-roles.sql">
-- =========================================================================
-- SCRIPT: CONFIRMAR USUARIOS Y ASIGNAR ROLES
-- =========================================================================
-- Instrucciones:
-- 1. Registra los usuarios manualmente en http://localhost:3002/register
--    (Crea: ariel@globaltalent.com y quality@globaltalent.com con cualquier contraseña)
-- 2. Ejecuta este script para "verificarlos" automáticamente y darles sus roles.

-- 1. AUTO-VERIFICAR EMAILS (Bypasear confirmación)
UPDATE auth.users
SET email_confirmed_at = now(),
    last_sign_in_at = now(),
    raw_user_meta_data = jsonb_set(
      COALESCE(raw_user_meta_data, '{}'::jsonb),
      '{email_verified}',
      'true'
    )
WHERE email IN ('ariel@globaltalent.com', 'quality@globaltalent.com', 'admin@globaltalent.com');

-- 2. ASIGNAR ROL: ARIEL JIMENEZ (DIRECTOR)
INSERT INTO public.profiles (id, email, full_name, department, position, role)
SELECT 
  id, 
  email, 
  'Ariel Jimenez', 
  'automation', 
  'director', 
  'user' 
FROM auth.users 
WHERE email = 'ariel@globaltalent.com'
ON CONFLICT (id) DO UPDATE
SET 
  full_name = 'Ariel Jimenez',
  department = 'automation',
  position = 'director',
  role = 'user';

-- 3. ASIGNAR ROL: EQUIPO CALIDAD (SUPERVISOR)
INSERT INTO public.profiles (id, email, full_name, department, position, role)
SELECT 
  id, 
  email, 
  'Equipo Calidad', 
  'quality', 
  'manager', 
  'admin' 
FROM auth.users 
WHERE email = 'quality@globaltalent.com'
ON CONFLICT (id) DO UPDATE
SET 
  full_name = 'Equipo Calidad',
  department = 'quality',
  position = 'manager',
  role = 'admin';

-- 4. ASEGURAR DEPARTAMENTO DE IA (ADMIN)
UPDATE public.profiles
SET 
  full_name = 'Departamento de IA',
  department = 'automation',
  position = 'director',
  role = 'admin'
WHERE email = 'admin@globaltalent.com';
</file>

<file path="database-invitations-system.sql">
-- =====================================================
-- GLOBAL TALENT PLATFORM - SISTEMA DE INVITACIONES
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- =====================================================
-- TABLA: invitations (Invitaciones para nuevos asistentes)
-- =====================================================
CREATE TABLE IF NOT EXISTS invitations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT NOT NULL,
  token TEXT NOT NULL UNIQUE,
  invited_by UUID REFERENCES profiles(id),
  full_name TEXT,
  position TEXT,
  status TEXT NOT NULL DEFAULT 'pending' 
    CHECK (status IN ('pending', 'accepted', 'expired')),
  expires_at TIMESTAMPTZ NOT NULL,
  accepted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  UNIQUE(email, token)
);

-- Índices para búsquedas rápidas
CREATE INDEX IF NOT EXISTS idx_invitations_token ON invitations(token);
CREATE INDEX IF NOT EXISTS idx_invitations_email ON invitations(email);
CREATE INDEX IF NOT EXISTS idx_invitations_status ON invitations(status);

-- =====================================================
-- FUNCIÓN: Crear profile y assistant automáticamente
-- Se ejecuta cuando un usuario se registra
-- =====================================================
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
DECLARE
  v_invitation invitations%ROWTYPE;
  v_role TEXT := 'asistente';
  v_full_name TEXT;
BEGIN
  -- Crear perfil automáticamente cuando se registra un usuario
  INSERT INTO public.profiles (id, email, full_name, role)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', split_part(NEW.email, '@', 1)),
    v_role
  )
  ON CONFLICT (id) DO UPDATE
  SET email = EXCLUDED.email,
      full_name = COALESCE(EXCLUDED.full_name, profiles.full_name),
      updated_at = NOW();
  
  -- Buscar si hay una invitación pendiente para este email
  SELECT * INTO v_invitation
  FROM invitations
  WHERE email = NEW.email
    AND status = 'pending'
    AND expires_at > NOW()
  ORDER BY created_at DESC
  LIMIT 1;
  
  -- Si hay invitación, crear registro de assistant automáticamente
  IF v_invitation.id IS NOT NULL THEN
    v_full_name := COALESCE(v_invitation.full_name, NEW.raw_user_meta_data->>'full_name', split_part(NEW.email, '@', 1));
    
    INSERT INTO assistants (
      user_id,
      full_name,
      email,
      status,
      position,
      created_at,
      updated_at
    )
    VALUES (
      NEW.id,
      v_full_name,
      NEW.email,
      'activo',
      COALESCE(v_invitation.position, 'Asistente Virtual'),
      NOW(),
      NOW()
    )
    ON CONFLICT (user_id) DO UPDATE
    SET full_name = EXCLUDED.full_name,
        email = EXCLUDED.email,
        status = 'activo',
        position = COALESCE(EXCLUDED.position, assistants.position),
        updated_at = NOW();
    
    -- Marcar invitación como aceptada
    UPDATE invitations
    SET status = 'accepted',
        accepted_at = NOW()
    WHERE id = v_invitation.id;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =====================================================
-- TRIGGER: Ejecutar función cuando se crea un nuevo usuario
-- =====================================================
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();

-- =====================================================
-- PERMISOS RLS (Row Level Security)
-- =====================================================
ALTER TABLE invitations ENABLE ROW LEVEL SECURITY;

-- Política: Los admins pueden ver todas las invitaciones
CREATE POLICY "Admins can view all invitations"
  ON invitations FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- Política: Los admins pueden crear invitaciones
CREATE POLICY "Admins can create invitations"
  ON invitations FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- Política: Los admins pueden actualizar invitaciones
CREATE POLICY "Admins can update invitations"
  ON invitations FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND profiles.role = 'admin'
    )
  );

-- Política: Cualquiera puede ver invitaciones con su token (para registro)
CREATE POLICY "Anyone can view invitation by token"
  ON invitations FOR SELECT
  USING (true);

-- =====================================================
-- COMENTARIOS
-- =====================================================
COMMENT ON TABLE invitations IS 'Invitaciones para que asistentes se registren en la plataforma';
COMMENT ON FUNCTION public.handle_new_user() IS 'Función que crea automáticamente profile y assistant cuando un usuario se registra';
</file>

<file path="datos-prueba-fix.sql">
-- =====================================================
-- DATOS DE PRUEBA - VERSIÓN CORREGIDA
-- Este script evita el error del constraint de status
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- =====================================================
-- PRIMERO: Verificar qué valores acepta el constraint
-- =====================================================
SELECT 
  conname AS constraint_name,
  pg_get_constraintdef(oid) AS constraint_definition
FROM pg_constraint
WHERE conrelid = 'clients'::regclass
AND contype = 'c'
AND conname LIKE '%status%';

-- =====================================================
-- 1. CREAR CLIENTE DE PRUEBA (versión segura)
-- =====================================================

DO $$
DECLARE
  test_client_id UUID;
  valid_status TEXT;
BEGIN
  -- Buscar cliente de prueba existente
  SELECT id INTO test_client_id
  FROM clients
  WHERE name = 'Empresa de Prueba' OR company_name = 'Empresa de Prueba'
  LIMIT 1;

  -- Si no existe, crearlo
  IF test_client_id IS NULL THEN
    -- Intentar determinar el status válido
    -- Primero intentar sin status (usará default)
    BEGIN
      INSERT INTO clients (
        name,
        company_name,
        legal_name,
        contact_name,
        contact_email,
        contact_phone,
        primary_color
      ) VALUES (
        'Empresa de Prueba',
        'Empresa de Prueba S.A.',
        'Empresa de Prueba S.A.',
        'Juan Administrador',
        'admin@empresaprueba.com',
        '+1234567890',
        '#10b981'
      )
      RETURNING id INTO test_client_id;
      
      RAISE NOTICE 'Cliente de prueba creado con ID: % (sin especificar status)', test_client_id;
    EXCEPTION WHEN OTHERS THEN
      -- Si falla, intentar con diferentes valores de status
      BEGIN
        -- Intentar con 'inactive'
        INSERT INTO clients (
          name,
          company_name,
          legal_name,
          contact_name,
          contact_email,
          contact_phone,
          primary_color,
          status
        ) VALUES (
          'Empresa de Prueba',
          'Empresa de Prueba S.A.',
          'Empresa de Prueba S.A.',
          'Juan Administrador',
          'admin@empresaprueba.com',
          '+1234567890',
          '#10b981',
          'inactive'
        )
        RETURNING id INTO test_client_id;
        
        RAISE NOTICE 'Cliente de prueba creado con ID: % (status: inactive)', test_client_id;
      EXCEPTION WHEN OTHERS THEN
        -- Último intento: verificar qué valores hay en la tabla existente
        SELECT status INTO valid_status
        FROM clients
        WHERE status IS NOT NULL
        LIMIT 1;
        
        IF valid_status IS NOT NULL THEN
          INSERT INTO clients (
            name,
            company_name,
            legal_name,
            contact_name,
            contact_email,
            contact_phone,
            primary_color,
            status
          ) VALUES (
            'Empresa de Prueba',
            'Empresa de Prueba S.A.',
            'Empresa de Prueba S.A.',
            'Juan Administrador',
            'admin@empresaprueba.com',
            '+1234567890',
            '#10b981',
            valid_status
          )
          RETURNING id INTO test_client_id;
          
          RAISE NOTICE 'Cliente de prueba creado con ID: % (status: %)', test_client_id, valid_status;
        ELSE
          RAISE EXCEPTION 'No se pudo crear el cliente. Error: %', SQLERRM;
        END IF;
      END;
    END;
  ELSE
    RAISE NOTICE 'Cliente de prueba ya existe con ID: %', test_client_id;
  END IF;
END $$;

-- =====================================================
-- 2. CREAR JOB POSITION DE PRUEBA
-- =====================================================

DO $$
DECLARE
  test_client_id UUID;
  test_job_id UUID;
  default_agent_id TEXT := 'agent_3301kf0s7m79fq78742kp9c4qp5b';
BEGIN
  -- Obtener cliente de prueba
  SELECT id INTO test_client_id
  FROM clients
  WHERE name = 'Empresa de Prueba' OR company_name = 'Empresa de Prueba'
  LIMIT 1;

  IF test_client_id IS NULL THEN
    RAISE EXCEPTION 'No se encontró el cliente de prueba. Ejecuta primero la parte 1.';
  END IF;

  -- Verificar si ya existe un job position de prueba
  SELECT id INTO test_job_id
  FROM job_positions
  WHERE client_id = test_client_id
  AND title = 'Desarrollador Full Stack - Prueba'
  LIMIT 1;

  -- Si no existe, crearlo
  IF test_job_id IS NULL THEN
    INSERT INTO job_positions (
      client_id,
      title,
      description,
      requirements,
      location,
      remote_type,
      salary_min,
      salary_max,
      salary_currency,
      status,
      elevenlabs_agent_id,
      opened_at
    ) VALUES (
      test_client_id,
      'Desarrollador Full Stack - Prueba',
      'Estamos buscando un desarrollador full stack con experiencia en React, Node.js y bases de datos. Este es un puesto de prueba para el módulo de entrevistas.',
      '• 3+ años de experiencia en desarrollo web
• Conocimiento sólido de React y Node.js
• Experiencia con bases de datos (PostgreSQL preferido)
• Buen nivel de inglés
• Trabajo en equipo',
      'Buenos Aires, Argentina',
      'hybrid',
      1500.00,
      2500.00,
      'USD',
      'open',
      default_agent_id,
      NOW()
    )
    RETURNING id INTO test_job_id;
    
    RAISE NOTICE 'Job position de prueba creado con ID: %', test_job_id;
    RAISE NOTICE 'Título: Desarrollador Full Stack - Prueba';
  ELSE
    RAISE NOTICE 'Job position de prueba ya existe con ID: %', test_job_id;
  END IF;
END $$;

-- =====================================================
-- 3. MOSTRAR DATOS CREADOS
-- =====================================================

-- Mostrar cliente de prueba
SELECT 
  id,
  name,
  company_name,
  contact_email,
  status
FROM clients
WHERE name = 'Empresa de Prueba' OR company_name = 'Empresa de Prueba';

-- Mostrar job position de prueba
SELECT 
  jp.id,
  jp.title,
  jp.status,
  jp.remote_type,
  jp.location,
  jp.elevenlabs_agent_id,
  c.name as client_name
FROM job_positions jp
JOIN clients c ON jp.client_id = c.id
WHERE c.name = 'Empresa de Prueba' OR c.company_name = 'Empresa de Prueba'
ORDER BY jp.created_at DESC
LIMIT 5;
</file>

<file path="datos-prueba.sql">
-- =====================================================
-- DATOS DE PRUEBA - MÓDULO DE ENTREVISTAS
-- Ejecutar en Supabase SQL Editor DESPUÉS de la migración
-- =====================================================

-- =====================================================
-- 1. CREAR CLIENTE DE PRUEBA (si no existe)
-- =====================================================

-- Verificar si ya existe un cliente de prueba
DO $$
DECLARE
  test_client_id UUID;
BEGIN
  -- Buscar cliente de prueba
  SELECT id INTO test_client_id
  FROM clients
  WHERE name = 'Empresa de Prueba' OR company_name = 'Empresa de Prueba'
  LIMIT 1;

  -- Si no existe, crearlo
  IF test_client_id IS NULL THEN
    -- Intentar insertar sin especificar status (usará el default)
    -- Si falla, intentar con valores alternativos
    BEGIN
      INSERT INTO clients (
        name,
        company_name,
        legal_name,
        contact_name,
        contact_email,
        contact_phone,
        primary_color
        -- No especificamos status, usará el default de la tabla
      ) VALUES (
        'Empresa de Prueba',
        'Empresa de Prueba S.A.',
        'Empresa de Prueba S.A.',
        'Juan Administrador',
        'admin@empresaprueba.com',
        '+1234567890',
        '#10b981'
      )
      RETURNING id INTO test_client_id;
    EXCEPTION WHEN OTHERS THEN
      -- Si falla, intentar con status explícito 'inactive'
      INSERT INTO clients (
        name,
        company_name,
        legal_name,
        contact_name,
        contact_email,
        contact_phone,
        primary_color,
        status
      ) VALUES (
        'Empresa de Prueba',
        'Empresa de Prueba S.A.',
        'Empresa de Prueba S.A.',
        'Juan Administrador',
        'admin@empresaprueba.com',
        '+1234567890',
        '#10b981',
        'inactive'
      )
      RETURNING id INTO test_client_id;
    END;
    
    RAISE NOTICE 'Cliente de prueba creado con ID: %', test_client_id;
  ELSE
    RAISE NOTICE 'Cliente de prueba ya existe con ID: %', test_client_id;
  END IF;
END $$;

-- =====================================================
-- 2. CREAR JOB POSITION DE PRUEBA
-- =====================================================

-- Obtener el ID del cliente de prueba
DO $$
DECLARE
  test_client_id UUID;
  test_job_id UUID;
  default_agent_id TEXT := 'agent_3301kf0s7m79fq78742kp9c4qp5b';
BEGIN
  -- Obtener cliente de prueba
  SELECT id INTO test_client_id
  FROM clients
  WHERE name = 'Empresa de Prueba' OR company_name = 'Empresa de Prueba'
  LIMIT 1;

  IF test_client_id IS NULL THEN
    RAISE EXCEPTION 'No se encontró el cliente de prueba. Ejecuta primero la parte 1.';
  END IF;

  -- Verificar si ya existe un job position de prueba
  SELECT id INTO test_job_id
  FROM job_positions
  WHERE client_id = test_client_id
  AND title = 'Desarrollador Full Stack - Prueba'
  LIMIT 1;

  -- Si no existe, crearlo
  IF test_job_id IS NULL THEN
    INSERT INTO job_positions (
      client_id,
      title,
      description,
      requirements,
      location,
      remote_type,
      salary_min,
      salary_max,
      salary_currency,
      status,
      elevenlabs_agent_id,
      opened_at
    ) VALUES (
      test_client_id,
      'Desarrollador Full Stack - Prueba',
      'Estamos buscando un desarrollador full stack con experiencia en React, Node.js y bases de datos. Este es un puesto de prueba para el módulo de entrevistas.',
      '• 3+ años de experiencia en desarrollo web
• Conocimiento sólido de React y Node.js
• Experiencia con bases de datos (PostgreSQL preferido)
• Buen nivel de inglés
• Trabajo en equipo',
      'Buenos Aires, Argentina',
      'hybrid',
      1500.00,
      2500.00,
      'USD',
      'open',
      default_agent_id,
      NOW()
    )
    RETURNING id INTO test_job_id;
    
    RAISE NOTICE 'Job position de prueba creado con ID: %', test_job_id;
    RAISE NOTICE 'Título: Desarrollador Full Stack - Prueba';
  ELSE
    RAISE NOTICE 'Job position de prueba ya existe con ID: %', test_job_id;
  END IF;
END $$;

-- =====================================================
-- 3. MOSTRAR DATOS CREADOS
-- =====================================================

-- Mostrar cliente de prueba
SELECT 
  id,
  name,
  company_name,
  contact_email,
  status
FROM clients
WHERE name = 'Empresa de Prueba' OR company_name = 'Empresa de Prueba';

-- Mostrar job position de prueba
SELECT 
  jp.id,
  jp.title,
  jp.status,
  jp.remote_type,
  jp.location,
  jp.elevenlabs_agent_id,
  c.name as client_name
FROM job_positions jp
JOIN clients c ON jp.client_id = c.id
WHERE c.name = 'Empresa de Prueba' OR c.company_name = 'Empresa de Prueba'
ORDER BY jp.created_at DESC
LIMIT 5;

-- =====================================================
-- 4. COPIAR EL JOB_POSITION_ID PARA USAR EN LA API
-- =====================================================
-- El ID que aparece arriba es el que necesitas para probar el POST
-- Ejemplo: 
-- curl -X POST http://localhost:3000/api/interviews/create \
--   -H "Authorization: Bearer 48d5e45849279a48ccd37c0a98523f0c02e1ffcc61089d3f541dc4ce41bfd858" \
--   -H "Content-Type: application/json" \
--   -d '{
--     "email": "candidato@example.com",
--     "candidate_name": "María García",
--     "job_position_id": "AQUÍ_PEGA_EL_ID_QUE_APARECE_ARRIBA"
--   }'
</file>

<file path="docs/sql/create_monthly_reports.sql">
-- Create monthly_reports table
CREATE TABLE IF NOT EXISTS public.monthly_reports (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    assistant_id UUID NOT NULL REFERENCES public.assistants(id),
    month INTEGER NOT NULL CHECK (month BETWEEN 1 AND 12),
    year INTEGER NOT NULL,
    status TEXT NOT NULL DEFAULT 'borrador' CHECK (status IN ('borrador', 'enviado')),
    
    -- JSONB sections
    activities JSONB DEFAULT '[]'::jsonb,
    objectives JSONB DEFAULT '[]'::jsonb,
    suggestions JSONB DEFAULT '[]'::jsonb,
    metrics_files JSONB DEFAULT '[]'::jsonb,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    
    -- Unique constraint: Only one report per assistant per month
    UNIQUE(assistant_id, month, year)
);

-- Enable RLS
ALTER TABLE public.monthly_reports ENABLE ROW LEVEL SECURITY;

-- Policies (Assuming standard role-based access similar to weekly reports)
CREATE POLICY "Users can view their own reports" ON public.monthly_reports
    FOR SELECT USING (
        assistant_id IN (
            SELECT id FROM public.assistants WHERE user_id = auth.uid()
        )
        OR 
        EXISTS (
            SELECT 1 FROM public.profiles 
            WHERE id = auth.uid() 
            AND (role IN ('admin', 'calidad') OR department IN ('c_level', 'quality'))
        )
    );

CREATE POLICY "Users can insert their own reports" ON public.monthly_reports
    FOR INSERT WITH CHECK (
        assistant_id IN (
            SELECT id FROM public.assistants WHERE user_id = auth.uid()
        )
    );

CREATE POLICY "Users can update their own reports" ON public.monthly_reports
    FOR UPDATE USING (
        assistant_id IN (
            SELECT id FROM public.assistants WHERE user_id = auth.uid()
        )
    );
</file>

<file path="docs/sql/create_storage_bucket.sql">
-- Create the storage bucket for monthly reports
INSERT INTO storage.buckets (id, name, public)
VALUES ('monthly_reports', 'monthly_reports', true)
ON CONFLICT (id) DO NOTHING;

-- Policy to allow authenticated users to view files in the bucket
CREATE POLICY "Public Access"
ON storage.objects FOR SELECT
USING ( bucket_id = 'monthly_reports' );

-- Policy to allow authenticated users to upload files
CREATE POLICY "Authenticated Users Can Upload"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'monthly_reports' AND
  auth.role() = 'authenticated'
);

-- Policy to allow users to delete their own files (optional, good for cleanup)
CREATE POLICY "Users Can Delete Own Files"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'monthly_reports' AND
  auth.uid() = owner
);
</file>

<file path="docs/sql/fix_monthly_reports.sql">
-- FIX SCRIPT FOR MONTHLY REPORTS
-- Run this in Supabase SQL Editor

-- 1. Ensure the table exists with all columns
CREATE TABLE IF NOT EXISTS public.monthly_reports (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    assistant_id UUID NOT NULL REFERENCES public.assistants(id),
    month INTEGER NOT NULL CHECK (month BETWEEN 1 AND 12),
    year INTEGER NOT NULL,
    status TEXT NOT NULL DEFAULT 'borrador' CHECK (status IN ('borrador', 'enviado')),
    activities JSONB DEFAULT '[]'::jsonb,
    objectives JSONB DEFAULT '[]'::jsonb,
    suggestions JSONB DEFAULT '[]'::jsonb,
    metrics_files JSONB DEFAULT '[]'::jsonb,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
    UNIQUE(assistant_id, month, year)
);

-- 2. Add 'month' column if it was missing (which seems to be the original error)
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'monthly_reports' AND column_name = 'month') THEN
        ALTER TABLE public.monthly_reports ADD COLUMN month INTEGER CHECK (month BETWEEN 1 AND 12);
    END IF;
    
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'monthly_reports' AND column_name = 'year') THEN
        ALTER TABLE public.monthly_reports ADD COLUMN year INTEGER;
    END IF;
END $$;

-- 3. Enable RLS (idempotent)
ALTER TABLE public.monthly_reports ENABLE ROW LEVEL SECURITY;

-- 4. Drop existing policies to avoid "policy already exists" error
DROP POLICY IF EXISTS "Users can view their own reports" ON public.monthly_reports;
DROP POLICY IF EXISTS "Users can insert their own reports" ON public.monthly_reports;
DROP POLICY IF EXISTS "Users can update their own reports" ON public.monthly_reports;

-- 5. Re-create Policies
CREATE POLICY "Users can view their own reports" ON public.monthly_reports
    FOR SELECT USING (
        assistant_id IN (
            SELECT id FROM public.assistants WHERE user_id = auth.uid()
        )
        OR 
        EXISTS (
            SELECT 1 FROM public.profiles 
            WHERE id = auth.uid() 
            AND (role IN ('admin', 'calidad') OR department IN ('c_level', 'quality'))
        )
    );

CREATE POLICY "Users can insert their own reports" ON public.monthly_reports
    FOR INSERT WITH CHECK (
        assistant_id IN (
            SELECT id FROM public.assistants WHERE user_id = auth.uid()
        )
    );

CREATE POLICY "Users can update their own reports" ON public.monthly_reports
    FOR UPDATE USING (
        assistant_id IN (
            SELECT id FROM public.assistants WHERE user_id = auth.uid()
        )
    );
</file>

<file path="entrevistas-module/database-interviews-schema.sql">
-- =====================================================
-- GLOBAL TALENT PLATFORM - MÓDULO DE ENTREVISTAS
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- =====================================================
-- TABLA: clients (Empresas que contratan a Global Talent)
-- =====================================================
CREATE TABLE IF NOT EXISTS clients (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Datos básicos
  name TEXT NOT NULL,
  legal_name TEXT,
  tax_id TEXT, -- CUIT/RUT/NIF
  
  -- Contacto
  contact_name TEXT,
  contact_email TEXT,
  contact_phone TEXT,
  
  -- Branding (para futuro white-label)
  logo_url TEXT,
  primary_color TEXT DEFAULT '#10b981', -- Emerald por defecto
  
  -- Estado
  status TEXT NOT NULL DEFAULT 'active' 
    CHECK (status IN ('active', 'inactive', 'prospect')),
  
  -- Zoho integration (opcional)
  zoho_account_id TEXT,
  
  -- Metadata
  notes TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Índices
CREATE INDEX IF NOT EXISTS idx_clients_status ON clients(status);
CREATE INDEX IF NOT EXISTS idx_clients_name ON clients(name);

-- =====================================================
-- TABLA: job_positions (Búsquedas activas)
-- =====================================================
CREATE TABLE IF NOT EXISTS job_positions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Relación con cliente
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  
  -- Datos del puesto
  title TEXT NOT NULL, -- "Desarrollador Python Senior"
  description TEXT,
  requirements TEXT,
  
  -- Ubicación
  location TEXT,
  remote_type TEXT DEFAULT 'hybrid' 
    CHECK (remote_type IN ('onsite', 'hybrid', 'remote')),
  
  -- Compensación (opcional)
  salary_min DECIMAL(12,2),
  salary_max DECIMAL(12,2),
  salary_currency TEXT DEFAULT 'USD',
  
  -- Estado de la búsqueda
  status TEXT NOT NULL DEFAULT 'open' 
    CHECK (status IN ('draft', 'open', 'paused', 'closed', 'filled')),
  
  -- Configuración de entrevista bot
  elevenlabs_agent_id TEXT, -- ID del agente específico para este puesto (opcional)
  interview_questions JSONB, -- Preguntas personalizadas (opcional)
  
  -- Zoho integration
  zoho_job_id TEXT,
  
  -- Asignación interna
  assigned_to UUID REFERENCES profiles(id), -- Reclutadora asignada
  
  -- Metadata
  opened_at TIMESTAMPTZ DEFAULT NOW(),
  closed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Índices
CREATE INDEX IF NOT EXISTS idx_job_positions_client ON job_positions(client_id);
CREATE INDEX IF NOT EXISTS idx_job_positions_status ON job_positions(status);
CREATE INDEX IF NOT EXISTS idx_job_positions_assigned ON job_positions(assigned_to);

-- =====================================================
-- TABLA: candidates (Personas que aplican)
-- =====================================================
CREATE TABLE IF NOT EXISTS candidates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Datos personales
  email TEXT NOT NULL,
  full_name TEXT NOT NULL,
  phone TEXT,
  
  -- Documentos
  cv_url TEXT, -- Link a Zoho WorkDrive o Storage
  video_url TEXT, -- Video de presentación
  linkedin_url TEXT,
  portfolio_url TEXT,
  
  -- Zoho integration
  zoho_candidate_id TEXT,
  
  -- Metadata
  source TEXT DEFAULT 'form', -- 'form', 'linkedin', 'referral', etc.
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Email único
  UNIQUE(email)
);

-- Índices
CREATE INDEX IF NOT EXISTS idx_candidates_email ON candidates(email);
CREATE INDEX IF NOT EXISTS idx_candidates_zoho ON candidates(zoho_candidate_id);

-- =====================================================
-- TABLA: applications (Candidato aplicó a un puesto)
-- =====================================================
CREATE TABLE IF NOT EXISTS applications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Relaciones
  candidate_id UUID NOT NULL REFERENCES candidates(id) ON DELETE CASCADE,
  job_position_id UUID NOT NULL REFERENCES job_positions(id) ON DELETE CASCADE,
  
  -- Análisis inicial (del Index/Gemini)
  initial_score DECIMAL(5,2), -- Score 0-100
  initial_analysis JSONB, -- Análisis detallado de Gemini
  
  -- Estado del pipeline
  status TEXT NOT NULL DEFAULT 'new' CHECK (status IN (
    'new',              -- Recién llegó
    'screening',        -- En revisión inicial
    'approved_for_bot', -- Aprobado para entrevista bot (score >= 75)
    'bot_pending',      -- Esperando que haga la entrevista
    'bot_completed',    -- Terminó entrevista bot
    'approved_for_human', -- Aprobado para entrevista humana
    'human_scheduled',  -- Entrevista humana agendada
    'human_completed',  -- Terminó entrevista humana
    'offer',            -- En proceso de oferta
    'hired',            -- Contratado
    'rejected',         -- Rechazado
    'withdrawn'         -- Se bajó el candidato
  )),
  
  -- Quién aprobó cada etapa
  approved_by UUID REFERENCES profiles(id),
  approved_at TIMESTAMPTZ,
  
  -- Notas del reclutador
  recruiter_notes TEXT,
  
  -- Zoho
  zoho_application_id TEXT,
  
  -- Metadata
  applied_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Un candidato solo puede aplicar una vez al mismo puesto
  UNIQUE(candidate_id, job_position_id)
);

-- Índices
CREATE INDEX IF NOT EXISTS idx_applications_candidate ON applications(candidate_id);
CREATE INDEX IF NOT EXISTS idx_applications_job ON applications(job_position_id);
CREATE INDEX IF NOT EXISTS idx_applications_status ON applications(status);

-- =====================================================
-- TABLA: interviews (Entrevistas con Bot)
-- =====================================================
CREATE TABLE IF NOT EXISTS interviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Relaciones
  application_id UUID NOT NULL REFERENCES applications(id) ON DELETE CASCADE,
  
  -- TOKEN DE ACCESO (CRÍTICO PARA SEGURIDAD)
  token UUID NOT NULL DEFAULT gen_random_uuid(),
  
  -- Estado de la entrevista
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN (
    'pending',      -- Link enviado, esperando que entre
    'in_progress',  -- Entrevista en curso
    'completed',    -- Terminó correctamente
    'expired',      -- Token expirado (no entró a tiempo)
    'abandoned'     -- Entró pero no terminó
  )),
  
  -- Expiración
  expires_at TIMESTAMPTZ NOT NULL,
  
  -- ElevenLabs data
  elevenlabs_conversation_id TEXT,
  elevenlabs_agent_id TEXT,
  
  -- Resultado de la entrevista
  transcript TEXT, -- Transcripción completa
  analysis JSONB, -- Análisis de tu Index/Gemini
  bot_score DECIMAL(5,2), -- Score 0-100
  
  -- Timestamps de la sesión
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  
  -- Metadata técnica
  user_agent TEXT,
  ip_address INET,
  
  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Token único
  UNIQUE(token)
);

-- Índices
CREATE INDEX IF NOT EXISTS idx_interviews_token ON interviews(token);
CREATE INDEX IF NOT EXISTS idx_interviews_application ON interviews(application_id);
CREATE INDEX IF NOT EXISTS idx_interviews_status ON interviews(status);
CREATE INDEX IF NOT EXISTS idx_interviews_expires ON interviews(expires_at);

-- =====================================================
-- ROW LEVEL SECURITY
-- =====================================================

ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE job_positions ENABLE ROW LEVEL SECURITY;
ALTER TABLE candidates ENABLE ROW LEVEL SECURITY;
ALTER TABLE applications ENABLE ROW LEVEL SECURITY;
ALTER TABLE interviews ENABLE ROW LEVEL SECURITY;

-- Políticas para clients
CREATE POLICY "Admin and RRHH can view all clients" ON clients
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'rrhh', 'calidad')
    )
  );

CREATE POLICY "Admin can manage clients" ON clients
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role = 'admin'
    )
  );

-- Políticas para job_positions
CREATE POLICY "RRHH can view all job positions" ON job_positions
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'rrhh', 'calidad')
    )
  );

CREATE POLICY "RRHH can manage job positions" ON job_positions
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'rrhh')
    )
  );

-- Políticas para candidates
CREATE POLICY "RRHH can view all candidates" ON candidates
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'rrhh', 'calidad')
    )
  );

CREATE POLICY "RRHH can manage candidates" ON candidates
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'rrhh')
    )
  );

-- Políticas para applications
CREATE POLICY "RRHH can view all applications" ON applications
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'rrhh', 'calidad')
    )
  );

CREATE POLICY "RRHH can manage applications" ON applications
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'rrhh')
    )
  );

-- Políticas para interviews (especial - acceso público por token)
-- El acceso por token se maneja en la API, no por RLS
CREATE POLICY "RRHH can view all interviews" ON interviews
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'rrhh', 'calidad')
    )
  );

CREATE POLICY "System can manage interviews" ON interviews
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND role IN ('admin', 'rrhh')
    )
  );

-- =====================================================
-- TRIGGERS
-- =====================================================

-- Actualizar updated_at automáticamente
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS update_clients_updated_at ON clients;
CREATE TRIGGER update_clients_updated_at 
  BEFORE UPDATE ON clients
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_job_positions_updated_at ON job_positions;
CREATE TRIGGER update_job_positions_updated_at 
  BEFORE UPDATE ON job_positions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_candidates_updated_at ON candidates;
CREATE TRIGGER update_candidates_updated_at 
  BEFORE UPDATE ON candidates
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_applications_updated_at ON applications;
CREATE TRIGGER update_applications_updated_at 
  BEFORE UPDATE ON applications
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_interviews_updated_at ON interviews;
CREATE TRIGGER update_interviews_updated_at 
  BEFORE UPDATE ON interviews
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =====================================================
-- FUNCIÓN: Validar token de entrevista
-- Para usar desde la API sin autenticación
-- =====================================================
CREATE OR REPLACE FUNCTION validate_interview_token(p_token UUID)
RETURNS TABLE (
  interview_id UUID,
  status TEXT,
  is_valid BOOLEAN,
  candidate_name TEXT,
  candidate_email TEXT,
  job_title TEXT,
  client_name TEXT,
  elevenlabs_agent_id TEXT,
  error_message TEXT
) AS $$
DECLARE
  v_interview RECORD;
  v_application RECORD;
  v_candidate RECORD;
  v_job RECORD;
  v_client RECORD;
BEGIN
  -- Buscar la entrevista por token
  SELECT * INTO v_interview 
  FROM interviews i 
  WHERE i.token = p_token;
  
  -- Si no existe el token
  IF NOT FOUND THEN
    RETURN QUERY SELECT 
      NULL::UUID,
      'invalid'::TEXT,
      FALSE,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      'Token no encontrado'::TEXT;
    RETURN;
  END IF;
  
  -- Si ya expiró
  IF v_interview.expires_at < NOW() THEN
    -- Actualizar status a expired si no lo está
    UPDATE interviews SET status = 'expired' WHERE id = v_interview.id AND status = 'pending';
    
    RETURN QUERY SELECT 
      v_interview.id,
      'expired'::TEXT,
      FALSE,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      'El enlace ha expirado'::TEXT;
    RETURN;
  END IF;
  
  -- Si ya fue usada (no está en pending)
  IF v_interview.status NOT IN ('pending', 'in_progress') THEN
    RETURN QUERY SELECT 
      v_interview.id,
      v_interview.status,
      FALSE,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      'Esta entrevista ya fue completada o cancelada'::TEXT;
    RETURN;
  END IF;
  
  -- Obtener datos relacionados
  SELECT * INTO v_application FROM applications WHERE id = v_interview.application_id;
  SELECT * INTO v_candidate FROM candidates WHERE id = v_application.candidate_id;
  SELECT * INTO v_job FROM job_positions WHERE id = v_application.job_position_id;
  SELECT * INTO v_client FROM clients WHERE id = v_job.client_id;
  
  -- Token válido
  RETURN QUERY SELECT 
    v_interview.id,
    v_interview.status,
    TRUE,
    v_candidate.full_name,
    v_candidate.email,
    v_job.title,
    v_client.name,
    COALESCE(v_interview.elevenlabs_agent_id, v_job.elevenlabs_agent_id),
    NULL::TEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =====================================================
-- FUNCIÓN: Marcar entrevista como iniciada (quema el token)
-- =====================================================
CREATE OR REPLACE FUNCTION start_interview(p_token UUID, p_user_agent TEXT DEFAULT NULL, p_ip TEXT DEFAULT NULL)
RETURNS TABLE (
  success BOOLEAN,
  interview_id UUID,
  conversation_id TEXT,
  error_message TEXT
) AS $$
DECLARE
  v_interview RECORD;
BEGIN
  -- Buscar y validar
  SELECT * INTO v_interview 
  FROM interviews i 
  WHERE i.token = p_token 
    AND i.status = 'pending'
    AND i.expires_at > NOW();
  
  IF NOT FOUND THEN
    RETURN QUERY SELECT FALSE, NULL::UUID, NULL::TEXT, 'Token inválido o expirado'::TEXT;
    RETURN;
  END IF;
  
  -- Marcar como en progreso (quema el token para otros intentos)
  UPDATE interviews 
  SET 
    status = 'in_progress',
    started_at = NOW(),
    user_agent = p_user_agent,
    ip_address = p_ip::INET
  WHERE id = v_interview.id;
  
  -- Actualizar el status de la application
  UPDATE applications 
  SET status = 'bot_pending'
  WHERE id = v_interview.application_id 
    AND status IN ('approved_for_bot', 'bot_pending');
  
  RETURN QUERY SELECT TRUE, v_interview.id, v_interview.elevenlabs_conversation_id, NULL::TEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =====================================================
-- FUNCIÓN: Completar entrevista
-- =====================================================
CREATE OR REPLACE FUNCTION complete_interview(
  p_interview_id UUID,
  p_conversation_id TEXT,
  p_transcript TEXT DEFAULT NULL
)
RETURNS BOOLEAN AS $$
BEGIN
  UPDATE interviews 
  SET 
    status = 'completed',
    completed_at = NOW(),
    elevenlabs_conversation_id = p_conversation_id,
    transcript = p_transcript
  WHERE id = p_interview_id 
    AND status = 'in_progress';
  
  -- Actualizar application
  UPDATE applications 
  SET status = 'bot_completed'
  WHERE id = (SELECT application_id FROM interviews WHERE id = p_interview_id);
  
  RETURN FOUND;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =====================================================
-- VISTAS ÚTILES
-- =====================================================

-- Vista: Pipeline de candidatos por puesto
CREATE OR REPLACE VIEW v_recruitment_pipeline AS
SELECT 
  jp.id AS job_position_id,
  jp.title AS job_title,
  c.name AS client_name,
  a.status,
  COUNT(a.id) AS count
FROM job_positions jp
JOIN clients c ON jp.client_id = c.id
LEFT JOIN applications a ON a.job_position_id = jp.id
WHERE jp.status = 'open'
GROUP BY jp.id, jp.title, c.name, a.status
ORDER BY jp.title, a.status;

-- Vista: Entrevistas pendientes del día
CREATE OR REPLACE VIEW v_pending_interviews_today AS
SELECT 
  i.id,
  i.token,
  i.status,
  i.expires_at,
  cand.full_name AS candidate_name,
  cand.email AS candidate_email,
  jp.title AS job_title,
  cl.name AS client_name
FROM interviews i
JOIN applications a ON i.application_id = a.id
JOIN candidates cand ON a.candidate_id = cand.id
JOIN job_positions jp ON a.job_position_id = jp.id
JOIN clients cl ON jp.client_id = cl.id
WHERE i.status = 'pending'
  AND i.expires_at > NOW()
ORDER BY i.expires_at;

-- =====================================================
-- DATOS DE EJEMPLO (opcional, comentar en producción)
-- =====================================================

-- Insertar un cliente de ejemplo
-- INSERT INTO clients (name, contact_email, status) 
-- VALUES ('TechCorp SA', 'rrhh@techcorp.com', 'active');

-- Insertar un puesto de ejemplo
-- INSERT INTO job_positions (client_id, title, status, assigned_to)
-- SELECT c.id, 'Desarrollador Full Stack', 'open', 
--   (SELECT id FROM profiles WHERE role = 'rrhh' LIMIT 1)
-- FROM clients c WHERE c.name = 'TechCorp SA';
</file>

<file path="entrevistas-module/INSTRUCCIONES.md">
# 🎤 MÓDULO DE ENTREVISTAS AUTOMATIZADAS

Sistema de entrevistas por voz con ElevenLabs integrado a Global Talent Platform.

---

## 📋 CONTENIDO DEL MÓDULO

```
entrevistas-module/
├── database-interviews-schema.sql     # Tablas SQL para Supabase
├── src/
│   ├── middleware.ts                  # Middleware modificado (REEMPLAZAR)
│   ├── types/
│   │   └── interviews.types.ts        # Tipos TypeScript
│   └── app/
│       ├── entrevista/
│       │   └── [token]/
│       │       ├── page.tsx           # Página pública de entrevista
│       │       ├── InterviewRoom.tsx  # Sala de entrevista
│       │       └── TokenInvalido.tsx  # Pantalla de error
│       └── api/
│           └── interviews/
│               ├── create/route.ts    # API para n8n
│               ├── start/route.ts     # Marcar inicio
│               ├── complete/route.ts  # Marcar fin
│               └── webhook/route.ts   # Webhook ElevenLabs
```

---

## 🚀 INSTALACIÓN

### PASO 1: Ejecutar SQL en Supabase

1. Ir a Supabase → **SQL Editor**
2. Copiar todo el contenido de `database-interviews-schema.sql`
3. Ejecutar

Esto crea:
- `clients` - Empresas clientes
- `job_positions` - Búsquedas/puestos
- `candidates` - Candidatos
- `applications` - Aplicaciones
- `interviews` - Entrevistas con tokens

### PASO 2: Instalar dependencia ElevenLabs

```bash
npm install @elevenlabs/react
```

### PASO 3: Configurar variables de entorno

Agregar a `.env.local`:

```env
# ElevenLabs
ELEVENLABS_DEFAULT_AGENT_ID=tu-agent-id-aqui

# API Key para n8n (cámbiala por una segura)
INTERVIEWS_API_KEY=gt-interviews-api-key-change-me

# Webhook secret (opcional)
ELEVENLABS_WEBHOOK_SECRET=tu-secret-opcional

# URL de tu app (para generar links)
NEXT_PUBLIC_APP_URL=https://tu-dominio.com
```

### PASO 4: Copiar archivos

1. **REEMPLAZAR** `src/middleware.ts` con el nuevo
2. **AGREGAR** `src/types/interviews.types.ts`
3. **AGREGAR** carpeta `src/app/entrevista/`
4. **AGREGAR** carpeta `src/app/api/interviews/`

### PASO 5: Verificar

```bash
npm run dev
```

Probar:
- `GET http://localhost:3000/api/interviews/create` → Debe mostrar el schema
- `GET http://localhost:3000/entrevista/token-invalido` → Debe mostrar error

---

## 🔗 FLUJO DE INTEGRACIÓN CON N8N

### Endpoint para crear entrevista:

```
POST /api/interviews/create
Authorization: Bearer {INTERVIEWS_API_KEY}
Content-Type: application/json

{
  "email": "candidato@email.com",
  "candidate_name": "Juan Pérez",
  "job_position_id": "uuid-del-puesto",
  "initial_score": 85,
  "initial_analysis": { ... },
  "cv_url": "https://...",
  "video_url": "https://...",
  "zoho_candidate_id": "123456"
}
```

### Respuesta:

```json
{
  "success": true,
  "data": {
    "interview_id": "uuid",
    "candidate_id": "uuid",
    "application_id": "uuid",
    "token": "uuid-del-token",
    "link": "https://tu-dominio.com/entrevista/uuid-del-token",
    "expires_at": "2025-01-29T12:00:00Z"
  }
}
```

---

## 🎯 FLUJO COMPLETO

```
1. Candidato llena formulario
         ↓
2. n8n recibe webhook
         ↓
3. n8n envía a tu Index/Gemini
         ↓
4. Si score >= 75, n8n llama a /api/interviews/create
         ↓
5. n8n envía email con el link al candidato
         ↓
6. Candidato entra a /entrevista/{token}
         ↓
7. Se valida el token (pending + no expirado)
         ↓
8. Candidato ve pantalla de bienvenida
         ↓
9. Click "Comenzar" → Conecta con ElevenLabs
         ↓
10. Token se "quema" (status = in_progress)
         ↓
11. Entrevista con bot (10-15 min)
         ↓
12. Candidato termina → status = completed
         ↓
13. Webhook de ElevenLabs envía transcripción (opcional)
         ↓
14. Tu Index analiza la transcripción
         ↓
15. RRHH recibe notificación
```

---

## 🔒 SEGURIDAD

| Aspecto | Implementación |
|---------|----------------|
| Token | UUID v4, único, un solo uso |
| Expiración | 72 horas por defecto |
| Quema de token | Al iniciar la entrevista, cambia a `in_progress` |
| API Key | Header `Authorization: Bearer ...` |
| RLS | Tablas protegidas, solo admin/rrhh pueden ver |
| Ruta pública | Solo `/entrevista/*` está excluida de auth |

---

## 📊 PRÓXIMOS PASOS (Fase 2)

- [ ] Dashboard de entrevistas en `/entrevistas`
- [ ] Integración de análisis con tu Index/Gemini
- [ ] Notificaciones a RRHH (email/slack)
- [ ] Métricas y reportes
- [ ] Envío por WhatsApp
- [ ] Agendar entrevista con humano

---

## 🐛 TROUBLESHOOTING

### Error: "No se pudo iniciar la entrevista"
- Verificar que el `ELEVENLABS_DEFAULT_AGENT_ID` es correcto
- Verificar que el navegador tiene permiso de micrófono

### Error: "Token no encontrado"
- El token UUID debe ser válido
- Verificar que la entrevista existe en la tabla

### Error: "API Key inválida"
- Verificar header `Authorization: Bearer {key}`
- Verificar que `INTERVIEWS_API_KEY` está configurada

---

## 📞 SOPORTE

Si hay problemas, revisar:
1. Logs de Supabase
2. Console del navegador
3. Network tab para ver requests
</file>

<file path="entrevistas-module/src/app/api/interviews/complete/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';

// =====================================================
// POST /api/interviews/complete
// Marca la entrevista como completada
// =====================================================

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { token, conversation_id, transcript } = body;

    if (!token) {
      return NextResponse.json(
        { success: false, error: 'Token requerido' },
        { status: 400 }
      );
    }

    const supabase = createAdminClient();

    // Primero obtener el interview_id del token
    const { data: interview, error: fetchError } = await supabase
      .from('interviews')
      .select('id, status')
      .eq('token', token)
      .single();

    if (fetchError || !interview) {
      return NextResponse.json(
        { success: false, error: 'Entrevista no encontrada' },
        { status: 404 }
      );
    }

    // Verificar que esté en progreso
    if (interview.status !== 'in_progress') {
      return NextResponse.json(
        { success: false, error: 'La entrevista no está en progreso' },
        { status: 400 }
      );
    }

    // Llamar a la función de PostgreSQL
    const { data, error } = await supabase
      .rpc('complete_interview', {
        p_interview_id: interview.id,
        p_conversation_id: conversation_id || null,
        p_transcript: transcript || null,
      });

    if (error) {
      console.error('Error completing interview:', error);
      return NextResponse.json(
        { success: false, error: 'Error al completar entrevista' },
        { status: 500 }
      );
    }

    // Notificar a RRHH (aquí podrías integrar con n8n, email, etc.)
    // Por ahora solo lo logueamos
    console.log('Interview completed:', {
      interview_id: interview.id,
      conversation_id,
    });

    // TODO: Llamar a tu Index/Gemini para analizar la transcripción
    // await analyzeInterview(interview.id, conversation_id);

    return NextResponse.json({
      success: true,
      data: {
        interview_id: interview.id,
        status: 'completed',
      },
    });

  } catch (error) {
    console.error('Unexpected error:', error);
    return NextResponse.json(
      { success: false, error: 'Error interno' },
      { status: 500 }
    );
  }
}
</file>

<file path="entrevistas-module/src/app/api/interviews/create/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';
import { z } from 'zod';

// =====================================================
// CONFIGURACIÓN
// =====================================================

// Token de expiración: 72 horas
const TOKEN_EXPIRATION_HOURS = 72;

// API Key para autenticar requests de n8n
// En producción, esto debería estar en una variable de entorno
const API_KEY = process.env.INTERVIEWS_API_KEY || 'gt-interviews-api-key-change-me';

// =====================================================
// VALIDACIÓN DEL REQUEST
// =====================================================

const createInterviewSchema = z.object({
  email: z.string().email('Email inválido'),
  candidate_name: z.string().min(2, 'Nombre requerido'),
  phone: z.string().optional(),
  job_position_id: z.string().uuid('ID de puesto inválido'),
  initial_score: z.number().min(0).max(100).optional(),
  initial_analysis: z.record(z.unknown()).optional(),
  cv_url: z.string().url().optional().or(z.literal('')),
  video_url: z.string().url().optional().or(z.literal('')),
  zoho_candidate_id: z.string().optional(),
  zoho_application_id: z.string().optional(),
});

// =====================================================
// HANDLER
// =====================================================

export async function POST(request: NextRequest) {
  try {
    // =====================================================
    // 1. VERIFICAR API KEY
    // =====================================================
    const authHeader = request.headers.get('Authorization');
    const apiKey = authHeader?.replace('Bearer ', '');
    
    if (!apiKey || apiKey !== API_KEY) {
      return NextResponse.json(
        { success: false, error: 'API Key inválida o faltante' },
        { status: 401 }
      );
    }

    // =====================================================
    // 2. PARSEAR Y VALIDAR BODY
    // =====================================================
    let body: unknown;
    try {
      body = await request.json();
    } catch {
      return NextResponse.json(
        { success: false, error: 'Body JSON inválido' },
        { status: 400 }
      );
    }

    const validation = createInterviewSchema.safeParse(body);
    if (!validation.success) {
      return NextResponse.json(
        { 
          success: false, 
          error: 'Datos inválidos',
          details: validation.error.errors 
        },
        { status: 400 }
      );
    }

    const data = validation.data;

    // =====================================================
    // 3. CONECTAR A SUPABASE (Admin para bypass RLS)
    // =====================================================
    const supabase = createAdminClient();

    // =====================================================
    // 4. VERIFICAR QUE EL JOB_POSITION EXISTE Y ESTÁ ABIERTO
    // =====================================================
    const { data: jobPosition, error: jobError } = await supabase
      .from('job_positions')
      .select('id, title, status, elevenlabs_agent_id, client_id')
      .eq('id', data.job_position_id)
      .single();

    if (jobError || !jobPosition) {
      return NextResponse.json(
        { success: false, error: 'Puesto de trabajo no encontrado' },
        { status: 404 }
      );
    }

    if (jobPosition.status !== 'open') {
      return NextResponse.json(
        { success: false, error: 'Este puesto ya no está abierto' },
        { status: 400 }
      );
    }

    // =====================================================
    // 5. BUSCAR O CREAR CANDIDATO
    // =====================================================
    let candidateId: string;

    // Buscar por email
    const { data: existingCandidate } = await supabase
      .from('candidates')
      .select('id')
      .eq('email', data.email.toLowerCase())
      .single();

    if (existingCandidate) {
      candidateId = existingCandidate.id;
      
      // Actualizar datos si hay nuevos
      await supabase
        .from('candidates')
        .update({
          full_name: data.candidate_name,
          phone: data.phone || null,
          cv_url: data.cv_url || null,
          video_url: data.video_url || null,
          zoho_candidate_id: data.zoho_candidate_id || null,
        })
        .eq('id', candidateId);
    } else {
      // Crear nuevo candidato
      const { data: newCandidate, error: createCandidateError } = await supabase
        .from('candidates')
        .insert({
          email: data.email.toLowerCase(),
          full_name: data.candidate_name,
          phone: data.phone || null,
          cv_url: data.cv_url || null,
          video_url: data.video_url || null,
          zoho_candidate_id: data.zoho_candidate_id || null,
          source: 'form',
        })
        .select('id')
        .single();

      if (createCandidateError || !newCandidate) {
        console.error('Error creating candidate:', createCandidateError);
        return NextResponse.json(
          { success: false, error: 'Error al crear candidato' },
          { status: 500 }
        );
      }

      candidateId = newCandidate.id;
    }

    // =====================================================
    // 6. BUSCAR O CREAR APPLICATION
    // =====================================================
    let applicationId: string;

    // Verificar si ya aplicó a este puesto
    const { data: existingApplication } = await supabase
      .from('applications')
      .select('id, status')
      .eq('candidate_id', candidateId)
      .eq('job_position_id', data.job_position_id)
      .single();

    if (existingApplication) {
      applicationId = existingApplication.id;
      
      // Verificar que no esté en un estado avanzado
      const advancedStatuses = ['bot_completed', 'approved_for_human', 'human_scheduled', 'human_completed', 'offer', 'hired'];
      if (advancedStatuses.includes(existingApplication.status)) {
        return NextResponse.json(
          { 
            success: false, 
            error: 'Este candidato ya completó el proceso para este puesto' 
          },
          { status: 400 }
        );
      }

      // Actualizar application
      await supabase
        .from('applications')
        .update({
          initial_score: data.initial_score || null,
          initial_analysis: data.initial_analysis || null,
          status: 'approved_for_bot',
          zoho_application_id: data.zoho_application_id || null,
        })
        .eq('id', applicationId);
    } else {
      // Crear nueva application
      const { data: newApplication, error: createAppError } = await supabase
        .from('applications')
        .insert({
          candidate_id: candidateId,
          job_position_id: data.job_position_id,
          initial_score: data.initial_score || null,
          initial_analysis: data.initial_analysis || null,
          status: 'approved_for_bot',
          zoho_application_id: data.zoho_application_id || null,
        })
        .select('id')
        .single();

      if (createAppError || !newApplication) {
        console.error('Error creating application:', createAppError);
        return NextResponse.json(
          { success: false, error: 'Error al crear aplicación' },
          { status: 500 }
        );
      }

      applicationId = newApplication.id;
    }

    // =====================================================
    // 7. VERIFICAR SI YA EXISTE UNA ENTREVISTA VÁLIDA
    // =====================================================
    const { data: existingInterview } = await supabase
      .from('interviews')
      .select('id, token, status, expires_at')
      .eq('application_id', applicationId)
      .in('status', ['pending', 'in_progress'])
      .gt('expires_at', new Date().toISOString())
      .single();

    if (existingInterview) {
      // Ya tiene una entrevista válida, devolver ese link
      const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://globaltalent.com';
      
      return NextResponse.json({
        success: true,
        data: {
          interview_id: existingInterview.id,
          candidate_id: candidateId,
          application_id: applicationId,
          token: existingInterview.token,
          link: `${baseUrl}/entrevista/${existingInterview.token}`,
          expires_at: existingInterview.expires_at,
        },
        message: 'Ya existía una entrevista pendiente',
      });
    }

    // =====================================================
    // 8. CREAR NUEVA ENTREVISTA
    // =====================================================
    const expiresAt = new Date();
    expiresAt.setHours(expiresAt.getHours() + TOKEN_EXPIRATION_HOURS);

    const { data: newInterview, error: createInterviewError } = await supabase
      .from('interviews')
      .insert({
        application_id: applicationId,
        status: 'pending',
        expires_at: expiresAt.toISOString(),
        elevenlabs_agent_id: jobPosition.elevenlabs_agent_id || process.env.ELEVENLABS_DEFAULT_AGENT_ID,
      })
      .select('id, token, expires_at')
      .single();

    if (createInterviewError || !newInterview) {
      console.error('Error creating interview:', createInterviewError);
      return NextResponse.json(
        { success: false, error: 'Error al crear entrevista' },
        { status: 500 }
      );
    }

    // =====================================================
    // 9. RESPONDER CON EL LINK
    // =====================================================
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://globaltalent.com';

    return NextResponse.json({
      success: true,
      data: {
        interview_id: newInterview.id,
        candidate_id: candidateId,
        application_id: applicationId,
        token: newInterview.token,
        link: `${baseUrl}/entrevista/${newInterview.token}`,
        expires_at: newInterview.expires_at,
      },
    });

  } catch (error) {
    console.error('Unexpected error in create interview:', error);
    return NextResponse.json(
      { success: false, error: 'Error interno del servidor' },
      { status: 500 }
    );
  }
}

// =====================================================
// MÉTODO GET PARA VERIFICAR QUE EL ENDPOINT EXISTE
// =====================================================
export async function GET() {
  return NextResponse.json({
    status: 'ok',
    endpoint: '/api/interviews/create',
    method: 'POST',
    description: 'Crear una nueva entrevista para un candidato',
    required_headers: {
      'Authorization': 'Bearer {API_KEY}',
      'Content-Type': 'application/json',
    },
    body_schema: {
      email: 'string (required)',
      candidate_name: 'string (required)',
      job_position_id: 'uuid (required)',
      phone: 'string (optional)',
      initial_score: 'number 0-100 (optional)',
      initial_analysis: 'object (optional)',
      cv_url: 'string url (optional)',
      video_url: 'string url (optional)',
      zoho_candidate_id: 'string (optional)',
      zoho_application_id: 'string (optional)',
    },
  });
}
</file>

<file path="entrevistas-module/src/app/api/interviews/start/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';

// =====================================================
// POST /api/interviews/start
// Marca la entrevista como iniciada (quema el token)
// =====================================================

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { token, user_agent } = body;

    if (!token) {
      return NextResponse.json(
        { success: false, error: 'Token requerido' },
        { status: 400 }
      );
    }

    const supabase = createAdminClient();

    // Obtener IP del request
    const forwarded = request.headers.get('x-forwarded-for');
    const ip = forwarded ? forwarded.split(',')[0] : request.headers.get('x-real-ip') || null;

    // Llamar a la función de PostgreSQL
    const { data, error } = await supabase
      .rpc('start_interview', {
        p_token: token,
        p_user_agent: user_agent || null,
        p_ip: ip,
      });

    if (error) {
      console.error('Error starting interview:', error);
      return NextResponse.json(
        { success: false, error: 'Error al iniciar entrevista' },
        { status: 500 }
      );
    }

    const result = data?.[0];

    if (!result?.success) {
      return NextResponse.json(
        { success: false, error: result?.error_message || 'Token inválido' },
        { status: 400 }
      );
    }

    return NextResponse.json({
      success: true,
      data: {
        interview_id: result.interview_id,
      },
    });

  } catch (error) {
    console.error('Unexpected error:', error);
    return NextResponse.json(
      { success: false, error: 'Error interno' },
      { status: 500 }
    );
  }
}
</file>

<file path="entrevistas-module/src/app/api/interviews/webhook/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';

// =====================================================
// POST /api/interviews/webhook
// Webhook para recibir eventos de ElevenLabs
// =====================================================

// Secreto para verificar que viene de ElevenLabs
const WEBHOOK_SECRET = process.env.ELEVENLABS_WEBHOOK_SECRET;

interface ElevenLabsWebhookPayload {
  event_type: 'conversation.started' | 'conversation.ended' | 'conversation.error';
  conversation_id: string;
  agent_id: string;
  transcript?: string;
  duration_seconds?: number;
  metadata?: Record<string, unknown>;
}

export async function POST(request: NextRequest) {
  try {
    // Verificar el secreto del webhook (si está configurado)
    if (WEBHOOK_SECRET) {
      const signature = request.headers.get('x-elevenlabs-signature');
      // Aquí deberías verificar la firma HMAC
      // Por simplicidad, solo verificamos que existe
      if (!signature) {
        return NextResponse.json(
          { error: 'Missing signature' },
          { status: 401 }
        );
      }
    }

    const payload = await request.json() as ElevenLabsWebhookPayload;
    const { event_type, conversation_id, transcript, duration_seconds } = payload;

    console.log('ElevenLabs webhook received:', event_type, conversation_id);

    const supabase = createAdminClient();

    // Buscar la entrevista por conversation_id
    const { data: interview, error: fetchError } = await supabase
      .from('interviews')
      .select('id, status')
      .eq('elevenlabs_conversation_id', conversation_id)
      .single();

    if (fetchError || !interview) {
      // Puede que la entrevista aún no tenga el conversation_id guardado
      console.log('Interview not found for conversation_id:', conversation_id);
      return NextResponse.json({ received: true });
    }

    // Procesar según el tipo de evento
    switch (event_type) {
      case 'conversation.ended':
        // Actualizar con la transcripción y marcar como completada
        if (interview.status === 'in_progress') {
          const { error: updateError } = await supabase
            .from('interviews')
            .update({
              status: 'completed',
              completed_at: new Date().toISOString(),
              transcript: transcript || null,
            })
            .eq('id', interview.id);

          if (updateError) {
            console.error('Error updating interview:', updateError);
          } else {
            // Actualizar application
            await supabase
              .from('applications')
              .update({ status: 'bot_completed' })
              .eq('id', (
                await supabase
                  .from('interviews')
                  .select('application_id')
                  .eq('id', interview.id)
                  .single()
              ).data?.application_id);

            // TODO: Llamar a tu Index/Gemini para analizar
            // await triggerAnalysis(interview.id, transcript);
            
            // TODO: Notificar a RRHH
            // await notifyRRHH(interview.id);
          }
        }
        break;

      case 'conversation.error':
        // Marcar como abandonada
        await supabase
          .from('interviews')
          .update({
            status: 'abandoned',
            completed_at: new Date().toISOString(),
          })
          .eq('id', interview.id);
        break;

      default:
        console.log('Unhandled event type:', event_type);
    }

    return NextResponse.json({ received: true });

  } catch (error) {
    console.error('Webhook error:', error);
    return NextResponse.json(
      { error: 'Internal error' },
      { status: 500 }
    );
  }
}

// GET para verificar que el endpoint existe
export async function GET() {
  return NextResponse.json({
    status: 'ok',
    endpoint: '/api/interviews/webhook',
    description: 'Webhook para eventos de ElevenLabs',
  });
}
</file>

<file path="entrevistas-module/src/app/entrevista/[token]/InterviewRoom.tsx">
'use client';

// =====================================================
// INTERVIEW ROOM - Sala de entrevista con ElevenLabs
// =====================================================

import { useState, useCallback, useEffect, useRef } from 'react';
import { useConversation } from '@elevenlabs/react';
import {
  Mic,
  MicOff,
  Phone,
  PhoneOff,
  Volume2,
  VolumeX,
  Loader2,
  CheckCircle2,
  AlertCircle,
  Clock,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import type { InterviewRoomData } from '@/types/interviews.types';

interface InterviewRoomProps {
  data: InterviewRoomData;
  token: string;
}

type RoomState = 
  | 'welcome'      // Pantalla de bienvenida
  | 'connecting'   // Conectando con ElevenLabs
  | 'active'       // Entrevista en curso
  | 'completed'    // Entrevista terminada
  | 'error';       // Error

export function InterviewRoom({ data, token }: InterviewRoomProps) {
  const [roomState, setRoomState] = useState<RoomState>('welcome');
  const [isMuted, setIsMuted] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [elapsedTime, setElapsedTime] = useState(0);
  const timerRef = useRef<NodeJS.Timeout | null>(null);

  // =====================================================
  // ELEVENLABS CONVERSATION HOOK
  // =====================================================
  const conversation = useConversation({
    onConnect: () => {
      console.log('Connected to ElevenLabs');
      setRoomState('active');
      markInterviewStarted();
      startTimer();
    },
    onDisconnect: () => {
      console.log('Disconnected from ElevenLabs');
      if (roomState === 'active') {
        setRoomState('completed');
        markInterviewCompleted();
        stopTimer();
      }
    },
    onError: (error) => {
      console.error('ElevenLabs error:', error);
      setError('Error de conexión con el asistente de voz');
      setRoomState('error');
      stopTimer();
    },
    onMessage: (message) => {
      console.log('Message:', message);
    },
  });

  // =====================================================
  // TIMER
  // =====================================================
  const startTimer = useCallback(() => {
    timerRef.current = setInterval(() => {
      setElapsedTime((prev) => prev + 1);
    }, 1000);
  }, []);

  const stopTimer = useCallback(() => {
    if (timerRef.current) {
      clearInterval(timerRef.current);
      timerRef.current = null;
    }
  }, []);

  useEffect(() => {
    return () => stopTimer();
  }, [stopTimer]);

  const formatTime = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  // =====================================================
  // API CALLS
  // =====================================================
  const markInterviewStarted = async () => {
    try {
      await fetch('/api/interviews/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          token,
          user_agent: navigator.userAgent,
        }),
      });
    } catch (error) {
      console.error('Error marking interview as started:', error);
    }
  };

  const markInterviewCompleted = async () => {
    try {
      await fetch('/api/interviews/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          token,
          conversation_id: conversation.conversationId,
        }),
      });
    } catch (error) {
      console.error('Error marking interview as completed:', error);
    }
  };

  // =====================================================
  // HANDLERS
  // =====================================================
  const handleStartInterview = async () => {
    setRoomState('connecting');
    setError(null);

    try {
      // Solicitar permiso de micrófono
      await navigator.mediaDevices.getUserMedia({ audio: true });

      // Conectar con ElevenLabs
      await conversation.startSession({
        agentId: data.agentId,
      });
    } catch (err) {
      console.error('Error starting interview:', err);
      if (err instanceof Error && err.name === 'NotAllowedError') {
        setError('Necesitas permitir el acceso al micrófono para continuar');
      } else {
        setError('No se pudo iniciar la entrevista. Por favor, recarga la página.');
      }
      setRoomState('error');
    }
  };

  const handleEndInterview = async () => {
    try {
      await conversation.endSession();
    } catch (err) {
      console.error('Error ending session:', err);
    }
    setRoomState('completed');
    stopTimer();
  };

  const handleToggleMute = () => {
    setIsMuted(!isMuted);
    // El SDK de ElevenLabs debería tener un método para mutear
    // Si no lo tiene, se puede implementar con MediaStreamTrack
  };

  // =====================================================
  // RENDER: WELCOME SCREEN
  // =====================================================
  if (roomState === 'welcome') {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center p-4">
        {/* Logo */}
        <div className="flex h-16 w-16 items-center justify-center rounded-2xl bg-emerald-500 shadow-lg shadow-emerald-500/30 mb-8">
          <span className="text-2xl font-bold text-white">GT</span>
        </div>

        {/* Card */}
        <div className="w-full max-w-lg rounded-2xl border border-slate-800 bg-slate-900/50 backdrop-blur p-8">
          {/* Greeting */}
          <div className="text-center mb-8">
            <h1 className="text-2xl font-semibold text-white mb-2">
              ¡Hola, {data.candidateName.split(' ')[0]}!
            </h1>
            <p className="text-slate-400">
              Estás a punto de comenzar tu entrevista técnica para el puesto de
            </p>
            <p className="text-lg font-medium text-emerald-400 mt-2">
              {data.jobTitle}
            </p>
            {data.clientName && (
              <p className="text-sm text-slate-500 mt-1">
                {data.clientName}
              </p>
            )}
          </div>

          {/* Instructions */}
          <div className="space-y-4 mb-8">
            <h2 className="text-sm font-medium text-slate-300 uppercase tracking-wider">
              Antes de comenzar
            </h2>
            <ul className="space-y-3">
              <li className="flex items-start gap-3">
                <div className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-400">
                  <Mic className="h-3.5 w-3.5" />
                </div>
                <span className="text-sm text-slate-400">
                  Asegúrate de estar en un lugar silencioso con buena conexión
                </span>
              </li>
              <li className="flex items-start gap-3">
                <div className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-400">
                  <Volume2 className="h-3.5 w-3.5" />
                </div>
                <span className="text-sm text-slate-400">
                  Usa auriculares para mejor calidad de audio
                </span>
              </li>
              <li className="flex items-start gap-3">
                <div className="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-emerald-500/20 text-emerald-400">
                  <Clock className="h-3.5 w-3.5" />
                </div>
                <span className="text-sm text-slate-400">
                  La entrevista durará aproximadamente 10-15 minutos
                </span>
              </li>
            </ul>
          </div>

          {/* Start Button */}
          <Button
            onClick={handleStartInterview}
            size="lg"
            className="w-full bg-emerald-600 hover:bg-emerald-700 text-white h-14 text-lg"
          >
            <Phone className="h-5 w-5 mr-2" />
            Comenzar entrevista
          </Button>

          {/* Note */}
          <p className="text-xs text-slate-500 text-center mt-4">
            Al hacer clic, aceptas que la conversación será grabada para fines de evaluación.
          </p>
        </div>
      </div>
    );
  }

  // =====================================================
  // RENDER: CONNECTING
  // =====================================================
  if (roomState === 'connecting') {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center p-4">
        <div className="text-center">
          <div className="relative mb-8">
            {/* Animated rings */}
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="h-32 w-32 rounded-full border-2 border-emerald-500/20 animate-ping" />
            </div>
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="h-24 w-24 rounded-full border-2 border-emerald-500/40 animate-pulse" />
            </div>
            <div className="relative flex h-20 w-20 mx-auto items-center justify-center rounded-full bg-emerald-500/20">
              <Loader2 className="h-10 w-10 text-emerald-400 animate-spin" />
            </div>
          </div>
          <h2 className="text-xl font-medium text-white mb-2">
            Conectando...
          </h2>
          <p className="text-slate-400">
            Por favor, permite el acceso al micrófono cuando se solicite
          </p>
        </div>
      </div>
    );
  }

  // =====================================================
  // RENDER: ACTIVE INTERVIEW
  // =====================================================
  if (roomState === 'active') {
    const isSpeaking = conversation.isSpeaking;

    return (
      <div className="min-h-screen flex flex-col">
        {/* Header */}
        <header className="flex items-center justify-between p-4 border-b border-slate-800">
          <div className="flex items-center gap-3">
            <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-500">
              <span className="text-sm font-bold text-white">GT</span>
            </div>
            <div>
              <p className="text-sm font-medium text-white">{data.jobTitle}</p>
              <p className="text-xs text-slate-400">Entrevista en curso</p>
            </div>
          </div>
          <div className="flex items-center gap-4">
            {/* Timer */}
            <div className="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-800">
              <div className="h-2 w-2 rounded-full bg-red-500 animate-pulse" />
              <span className="text-sm font-mono text-white">
                {formatTime(elapsedTime)}
              </span>
            </div>
          </div>
        </header>

        {/* Main content - Voice Orb */}
        <main className="flex-1 flex items-center justify-center p-4">
          <div className="relative">
            {/* Background rings - animated when speaking */}
            <div
              className={cn(
                'absolute inset-0 flex items-center justify-center transition-all duration-300',
                isSpeaking && 'scale-110'
              )}
            >
              <div
                className={cn(
                  'h-64 w-64 rounded-full border-2 transition-all duration-500',
                  isSpeaking
                    ? 'border-emerald-500/40 animate-pulse'
                    : 'border-slate-700/40'
                )}
              />
            </div>
            <div
              className={cn(
                'absolute inset-0 flex items-center justify-center transition-all duration-300',
                isSpeaking && 'scale-105'
              )}
            >
              <div
                className={cn(
                  'h-48 w-48 rounded-full border-2 transition-all duration-500',
                  isSpeaking
                    ? 'border-emerald-500/60 animate-pulse'
                    : 'border-slate-700/60'
                )}
              />
            </div>

            {/* Main orb */}
            <div
              className={cn(
                'relative flex h-36 w-36 items-center justify-center rounded-full transition-all duration-300',
                isSpeaking
                  ? 'bg-gradient-to-br from-emerald-500 to-emerald-600 shadow-lg shadow-emerald-500/30 scale-105'
                  : 'bg-gradient-to-br from-slate-700 to-slate-800'
              )}
            >
              {/* Waveform visualization */}
              <div className="flex items-center gap-1">
                {[...Array(5)].map((_, i) => (
                  <div
                    key={i}
                    className={cn(
                      'w-1.5 rounded-full transition-all duration-150',
                      isSpeaking
                        ? 'bg-white animate-pulse'
                        : 'bg-slate-500'
                    )}
                    style={{
                      height: isSpeaking ? `${Math.random() * 30 + 10}px` : '8px',
                      animationDelay: `${i * 0.1}s`,
                    }}
                  />
                ))}
              </div>
            </div>

            {/* Speaking indicator */}
            <div className="absolute -bottom-8 left-1/2 -translate-x-1/2">
              <p className={cn(
                'text-sm font-medium transition-colors',
                isSpeaking ? 'text-emerald-400' : 'text-slate-500'
              )}>
                {isSpeaking ? 'Hablando...' : 'Escuchando'}
              </p>
            </div>
          </div>
        </main>

        {/* Controls */}
        <footer className="p-6 border-t border-slate-800">
          <div className="flex items-center justify-center gap-4">
            {/* Mute button */}
            <Button
              variant="outline"
              size="lg"
              onClick={handleToggleMute}
              className={cn(
                'h-14 w-14 rounded-full p-0',
                isMuted
                  ? 'border-red-500/50 text-red-400 hover:bg-red-500/10'
                  : 'border-slate-700 text-slate-400 hover:bg-slate-800'
              )}
            >
              {isMuted ? (
                <MicOff className="h-6 w-6" />
              ) : (
                <Mic className="h-6 w-6" />
              )}
            </Button>

            {/* End call button */}
            <Button
              size="lg"
              onClick={handleEndInterview}
              className="h-16 w-16 rounded-full p-0 bg-red-600 hover:bg-red-700"
            >
              <PhoneOff className="h-7 w-7" />
            </Button>

            {/* Volume button (placeholder) */}
            <Button
              variant="outline"
              size="lg"
              className="h-14 w-14 rounded-full p-0 border-slate-700 text-slate-400 hover:bg-slate-800"
            >
              <Volume2 className="h-6 w-6" />
            </Button>
          </div>
        </footer>
      </div>
    );
  }

  // =====================================================
  // RENDER: COMPLETED
  // =====================================================
  if (roomState === 'completed') {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center p-4">
        {/* Logo */}
        <div className="flex h-16 w-16 items-center justify-center rounded-2xl bg-emerald-500 shadow-lg shadow-emerald-500/30 mb-8">
          <CheckCircle2 className="h-8 w-8 text-white" />
        </div>

        <div className="w-full max-w-lg text-center">
          <h1 className="text-2xl font-semibold text-white mb-4">
            ¡Entrevista completada!
          </h1>
          <p className="text-slate-400 mb-2">
            Gracias por tu tiempo, {data.candidateName.split(' ')[0]}.
          </p>
          <p className="text-slate-400 mb-8">
            Tu entrevista duró {formatTime(elapsedTime)}. Nuestro equipo revisará 
            tus respuestas y te contactará pronto.
          </p>

          {/* Stats */}
          <div className="flex justify-center gap-8 mb-8">
            <div className="text-center">
              <p className="text-3xl font-bold text-emerald-400">
                {formatTime(elapsedTime)}
              </p>
              <p className="text-xs text-slate-500 uppercase tracking-wider">
                Duración
              </p>
            </div>
          </div>

          <p className="text-sm text-slate-500">
            Ya puedes cerrar esta ventana.
          </p>
        </div>
      </div>
    );
  }

  // =====================================================
  // RENDER: ERROR
  // =====================================================
  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4">
      <div className="flex h-16 w-16 items-center justify-center rounded-2xl bg-red-500/20 mb-8">
        <AlertCircle className="h-8 w-8 text-red-400" />
      </div>

      <div className="w-full max-w-lg text-center">
        <h1 className="text-2xl font-semibold text-white mb-4">
          Ocurrió un error
        </h1>
        <p className="text-slate-400 mb-8">
          {error || 'No se pudo iniciar la entrevista.'}
        </p>

        <Button
          onClick={() => {
            setRoomState('welcome');
            setError(null);
          }}
          variant="outline"
          className="border-slate-700"
        >
          Intentar de nuevo
        </Button>
      </div>
    </div>
  );
}
</file>

<file path="entrevistas-module/src/app/entrevista/[token]/page.tsx">
// =====================================================
// /entrevista/[token]/page.tsx
// Sala de entrevista pública para candidatos
// =====================================================

import { Metadata } from 'next';
import { createAdminClient } from '@/lib/supabase/server';
import { InterviewRoom } from './InterviewRoom';
import { TokenInvalido } from './TokenInvalido';
import type { InterviewValidationResult, InterviewRoomData } from '@/types/interviews.types';

// =====================================================
// METADATA DINÁMICA
// =====================================================

export async function generateMetadata({
  params,
}: {
  params: { token: string };
}): Promise<Metadata> {
  return {
    title: 'Entrevista | Global Talent',
    description: 'Sala de entrevista técnica automatizada',
    robots: 'noindex, nofollow', // No indexar páginas de entrevista
  };
}

// =====================================================
// VALIDAR TOKEN
// =====================================================

async function validateToken(token: string): Promise<InterviewValidationResult | null> {
  try {
    const supabase = createAdminClient();
    
    // Llamar a la función de validación de PostgreSQL
    const { data, error } = await supabase
      .rpc('validate_interview_token', { p_token: token });

    if (error) {
      console.error('Error validating token:', error);
      return null;
    }

    // La función retorna un array con un solo elemento
    return data?.[0] as InterviewValidationResult || null;
  } catch (error) {
    console.error('Unexpected error validating token:', error);
    return null;
  }
}

// =====================================================
// PAGE COMPONENT (Server)
// =====================================================

export default async function InterviewPage({
  params,
}: {
  params: { token: string };
}) {
  const { token } = params;

  // Validar formato del token (UUID)
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (!uuidRegex.test(token)) {
    return (
      <TokenInvalido 
        reason="invalid"
        message="El enlace no es válido"
      />
    );
  }

  // Validar token contra la base de datos
  const validation = await validateToken(token);

  if (!validation) {
    return (
      <TokenInvalido 
        reason="error"
        message="Error al verificar el enlace. Por favor, intenta nuevamente."
      />
    );
  }

  // Token no válido
  if (!validation.is_valid) {
    let reason: 'expired' | 'used' | 'invalid' = 'invalid';
    
    if (validation.status === 'expired') {
      reason = 'expired';
    } else if (['completed', 'abandoned'].includes(validation.status)) {
      reason = 'used';
    }

    return (
      <TokenInvalido 
        reason={reason}
        message={validation.error_message || 'El enlace no es válido'}
      />
    );
  }

  // Token válido - preparar datos para la sala
  const interviewData: InterviewRoomData = {
    interviewId: validation.interview_id!,
    candidateName: validation.candidate_name || 'Candidato',
    jobTitle: validation.job_title || 'Puesto',
    clientName: validation.client_name || '',
    agentId: validation.elevenlabs_agent_id || process.env.ELEVENLABS_DEFAULT_AGENT_ID || '',
    status: validation.status as InterviewRoomData['status'],
  };

  // Renderizar la sala de entrevista
  return (
    <main className="min-h-screen bg-slate-950">
      <InterviewRoom 
        data={interviewData}
        token={token}
      />
    </main>
  );
}
</file>

<file path="entrevistas-module/src/app/entrevista/[token]/TokenInvalido.tsx">
'use client';

// =====================================================
// TOKEN INVÁLIDO - Pantalla de error
// =====================================================

import { AlertCircle, Clock, CheckCircle2, XCircle } from 'lucide-react';
import { cn } from '@/lib/utils';

interface TokenInvalidoProps {
  reason: 'expired' | 'used' | 'invalid' | 'error';
  message: string;
}

const reasonConfig = {
  expired: {
    icon: Clock,
    title: 'Enlace expirado',
    description: 'El tiempo para realizar la entrevista ha finalizado.',
    color: 'text-amber-400',
    bgColor: 'bg-amber-500/20',
    borderColor: 'border-amber-500/30',
  },
  used: {
    icon: CheckCircle2,
    title: 'Entrevista ya completada',
    description: 'Ya has completado esta entrevista anteriormente.',
    color: 'text-emerald-400',
    bgColor: 'bg-emerald-500/20',
    borderColor: 'border-emerald-500/30',
  },
  invalid: {
    icon: XCircle,
    title: 'Enlace no válido',
    description: 'Este enlace de entrevista no existe o ha sido revocado.',
    color: 'text-red-400',
    bgColor: 'bg-red-500/20',
    borderColor: 'border-red-500/30',
  },
  error: {
    icon: AlertCircle,
    title: 'Error técnico',
    description: 'Hubo un problema al verificar tu enlace.',
    color: 'text-slate-400',
    bgColor: 'bg-slate-500/20',
    borderColor: 'border-slate-500/30',
  },
};

export function TokenInvalido({ reason, message }: TokenInvalidoProps) {
  const config = reasonConfig[reason];
  const Icon = config.icon;

  return (
    <main className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
      <div className="w-full max-w-md">
        {/* Logo */}
        <div className="flex justify-center mb-8">
          <div className="flex h-14 w-14 items-center justify-center rounded-xl bg-emerald-500 shadow-lg shadow-emerald-500/20">
            <span className="text-xl font-bold text-white">GT</span>
          </div>
        </div>

        {/* Card */}
        <div className={cn(
          'rounded-2xl border p-8 text-center',
          config.bgColor,
          config.borderColor
        )}>
          {/* Icon */}
          <div className={cn(
            'mx-auto flex h-16 w-16 items-center justify-center rounded-full mb-6',
            config.bgColor
          )}>
            <Icon className={cn('h-8 w-8', config.color)} />
          </div>

          {/* Title */}
          <h1 className="text-2xl font-semibold text-white mb-2">
            {config.title}
          </h1>

          {/* Description */}
          <p className="text-slate-400 mb-4">
            {config.description}
          </p>

          {/* Message */}
          {message && message !== config.description && (
            <p className={cn('text-sm', config.color)}>
              {message}
            </p>
          )}
        </div>

        {/* Footer */}
        <div className="mt-8 text-center">
          <p className="text-sm text-slate-500">
            Si crees que esto es un error, contacta al equipo de reclutamiento.
          </p>
          <p className="text-sm text-slate-600 mt-2">
            © {new Date().getFullYear()} Global Talent Platform
          </p>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="entrevistas-module/src/middleware.ts">
import { createServerClient } from '@supabase/ssr';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import type { Database } from '@/types/database.types';

/**
 * Middleware de autenticación y protección de rutas
 * - Verifica la sesión del usuario
 * - Redirige a login si no está autenticado
 * - Maneja refresh de tokens
 * - EXCLUYE rutas públicas de candidatos (/entrevista/*)
 */

// Rutas públicas que no requieren autenticación
const PUBLIC_ROUTES = [
  '/login', 
  '/auth/callback', 
  '/auth/error',
  '/entrevista',  // 👈 NUEVA: Sala de entrevistas para candidatos
];

// Rutas de API públicas (para webhooks externos como n8n)
const PUBLIC_API_ROUTES = [
  '/api/interviews/create',  // 👈 NUEVA: Endpoint para n8n
  '/api/interviews/webhook', // 👈 NUEVA: Webhook de ElevenLabs
];

// Rutas que requieren roles específicos
const ROLE_ROUTES: Record<string, string[]> = {
  '/configuracion': ['admin'],
  '/metricas': ['admin', 'calidad', 'marketing'],
  '/calidad': ['admin', 'calidad'],
  '/busquedas': ['admin', 'rrhh'],
  '/candidatos': ['admin', 'rrhh'],
  '/entrevistas': ['admin', 'rrhh', 'calidad'], // 👈 NUEVA: Dashboard de entrevistas
};

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // =====================================================
  // RUTAS DE API PÚBLICAS (webhooks)
  // Verificar primero para evitar crear cliente Supabase innecesariamente
  // =====================================================
  const isPublicApiRoute = PUBLIC_API_ROUTES.some((route) => 
    pathname.startsWith(route)
  );
  
  if (isPublicApiRoute) {
    // Las rutas de API públicas manejan su propia autenticación (API Key)
    return NextResponse.next();
  }

  // =====================================================
  // PREPARAR RESPUESTA
  // =====================================================
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  // Crear cliente de Supabase para middleware usando @supabase/ssr
  const supabase = createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          // Establecer en las cookies de la request para que getUser vea las cookies actualizadas
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          );
          // También establecer en las cookies de la response para actualizar el navegador
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          });
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  // =====================================================
  // VERIFICAR SI ES RUTA PÚBLICA
  // =====================================================
  const isPublicRoute = PUBLIC_ROUTES.some((route) => pathname.startsWith(route));

  // Si es ruta pública, no necesitamos verificar autenticación
  if (isPublicRoute) {
    return response;
  }

  // =====================================================
  // VERIFICAR AUTENTICACIÓN PARA RUTAS PROTEGIDAS
  // =====================================================
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser();

  // Solo registrar errores reales (no "Auth session missing!" cuando no hay usuario)
  if (error && !(error.message === 'Auth session missing!' && !user)) {
    console.error('Session error in middleware:', error.message);
  }

  // Si no hay usuario y no es ruta pública, redirigir a login
  if (!user) {
    const redirectUrl = new URL('/login', request.url);
    redirectUrl.searchParams.set('redirectTo', pathname);
    return NextResponse.redirect(redirectUrl);
  }

  // Si hay usuario y está en login, redirigir al dashboard
  if (pathname === '/login') {
    return NextResponse.redirect(new URL('/dashboard', request.url));
  }

  // =====================================================
  // VERIFICAR PERMISOS DE ROL
  // =====================================================
  // Obtener el rol del usuario desde el profile
  const { data: profile } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .single();

  if (profile) {
    // Verificar si la ruta requiere un rol específico
    for (const [route, allowedRoles] of Object.entries(ROLE_ROUTES)) {
      if (pathname.startsWith(route)) {
        if (!allowedRoles.includes(profile.role)) {
          // Usuario no tiene permiso, redirigir a dashboard con error
          const redirectUrl = new URL('/dashboard', request.url);
          redirectUrl.searchParams.set('error', 'unauthorized');
          return NextResponse.redirect(redirectUrl);
        }
        break;
      }
    }

    // Agregar el rol a los headers para uso en server components
    response.headers.set('x-user-role', profile.role);
  }

  return response;
}

// Configurar qué rutas ejecutan el middleware
export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder assets
     */
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
</file>

<file path="entrevistas-module/src/types/interviews.types.ts">
// =====================================================
// GLOBAL TALENT PLATFORM - TIPOS DE ENTREVISTAS
// =====================================================

// =====================================================
// ENUMS Y TIPOS BASE
// =====================================================

export type ClientStatus = 'active' | 'inactive' | 'prospect';

export type JobRemoteType = 'onsite' | 'hybrid' | 'remote';

export type JobStatus = 'draft' | 'open' | 'paused' | 'closed' | 'filled';

export type ApplicationStatus = 
  | 'new'
  | 'screening'
  | 'approved_for_bot'
  | 'bot_pending'
  | 'bot_completed'
  | 'approved_for_human'
  | 'human_scheduled'
  | 'human_completed'
  | 'offer'
  | 'hired'
  | 'rejected'
  | 'withdrawn';

export type InterviewStatus = 
  | 'pending'
  | 'in_progress'
  | 'completed'
  | 'expired'
  | 'abandoned';

// =====================================================
// INTERFACES DE TABLAS
// =====================================================

export interface Client {
  id: string;
  name: string;
  legal_name: string | null;
  tax_id: string | null;
  contact_name: string | null;
  contact_email: string | null;
  contact_phone: string | null;
  logo_url: string | null;
  primary_color: string;
  status: ClientStatus;
  zoho_account_id: string | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}

export interface JobPosition {
  id: string;
  client_id: string;
  title: string;
  description: string | null;
  requirements: string | null;
  location: string | null;
  remote_type: JobRemoteType;
  salary_min: number | null;
  salary_max: number | null;
  salary_currency: string;
  status: JobStatus;
  elevenlabs_agent_id: string | null;
  interview_questions: Record<string, unknown> | null;
  zoho_job_id: string | null;
  assigned_to: string | null;
  opened_at: string | null;
  closed_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface Candidate {
  id: string;
  email: string;
  full_name: string;
  phone: string | null;
  cv_url: string | null;
  video_url: string | null;
  linkedin_url: string | null;
  portfolio_url: string | null;
  zoho_candidate_id: string | null;
  source: string;
  created_at: string;
  updated_at: string;
}

export interface Application {
  id: string;
  candidate_id: string;
  job_position_id: string;
  initial_score: number | null;
  initial_analysis: Record<string, unknown> | null;
  status: ApplicationStatus;
  approved_by: string | null;
  approved_at: string | null;
  recruiter_notes: string | null;
  zoho_application_id: string | null;
  applied_at: string;
  updated_at: string;
}

export interface Interview {
  id: string;
  application_id: string;
  token: string;
  status: InterviewStatus;
  expires_at: string;
  elevenlabs_conversation_id: string | null;
  elevenlabs_agent_id: string | null;
  transcript: string | null;
  analysis: Record<string, unknown> | null;
  bot_score: number | null;
  started_at: string | null;
  completed_at: string | null;
  user_agent: string | null;
  ip_address: string | null;
  created_at: string;
  updated_at: string;
}

// =====================================================
// TIPOS COMPUESTOS (con relaciones)
// =====================================================

export interface JobPositionWithClient extends JobPosition {
  client: Client;
}

export interface ApplicationWithDetails extends Application {
  candidate: Candidate;
  job_position: JobPositionWithClient;
  interviews?: Interview[];
}

export interface InterviewWithDetails extends Interview {
  application: ApplicationWithDetails;
}

// =====================================================
// TIPOS PARA LA SALA DE ENTREVISTA (público)
// =====================================================

export interface InterviewValidationResult {
  interview_id: string | null;
  status: string;
  is_valid: boolean;
  candidate_name: string | null;
  candidate_email: string | null;
  job_title: string | null;
  client_name: string | null;
  elevenlabs_agent_id: string | null;
  error_message: string | null;
}

export interface InterviewRoomData {
  interviewId: string;
  candidateName: string;
  jobTitle: string;
  clientName: string;
  agentId: string;
  status: InterviewStatus;
}

// =====================================================
// TIPOS PARA API (n8n)
// =====================================================

export interface CreateInterviewRequest {
  email: string;
  candidate_name: string;
  phone?: string;
  job_position_id: string;
  initial_score?: number;
  initial_analysis?: Record<string, unknown>;
  cv_url?: string;
  video_url?: string;
  zoho_candidate_id?: string;
  zoho_application_id?: string;
}

export interface CreateInterviewResponse {
  success: boolean;
  data?: {
    interview_id: string;
    candidate_id: string;
    application_id: string;
    token: string;
    link: string;
    expires_at: string;
  };
  error?: string;
}

// =====================================================
// TIPOS PARA DASHBOARD
// =====================================================

export interface InterviewStats {
  total: number;
  pending: number;
  in_progress: number;
  completed: number;
  expired: number;
  completion_rate: number;
}

export interface CandidatePipelineItem {
  application_id: string;
  candidate_name: string;
  candidate_email: string;
  job_title: string;
  client_name: string;
  status: ApplicationStatus;
  initial_score: number | null;
  bot_score: number | null;
  applied_at: string;
  interview_status: InterviewStatus | null;
}

// =====================================================
// CONSTANTES Y HELPERS
// =====================================================

export const APPLICATION_STATUS_LABELS: Record<ApplicationStatus, string> = {
  new: 'Nuevo',
  screening: 'En revisión',
  approved_for_bot: 'Aprobado para entrevista',
  bot_pending: 'Entrevista pendiente',
  bot_completed: 'Entrevista completada',
  approved_for_human: 'Aprobado (humano)',
  human_scheduled: 'Entrevista agendada',
  human_completed: 'Entrevista completada',
  offer: 'En oferta',
  hired: 'Contratado',
  rejected: 'Rechazado',
  withdrawn: 'Retirado',
};

export const APPLICATION_STATUS_COLORS: Record<ApplicationStatus, string> = {
  new: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
  screening: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
  approved_for_bot: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
  bot_pending: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  bot_completed: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
  approved_for_human: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
  human_scheduled: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
  human_completed: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
  offer: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  hired: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
  rejected: 'bg-red-500/20 text-red-400 border-red-500/30',
  withdrawn: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
};

export const INTERVIEW_STATUS_LABELS: Record<InterviewStatus, string> = {
  pending: 'Pendiente',
  in_progress: 'En curso',
  completed: 'Completada',
  expired: 'Expirada',
  abandoned: 'Abandonada',
};

export const INTERVIEW_STATUS_COLORS: Record<InterviewStatus, string> = {
  pending: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  in_progress: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
  completed: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
  expired: 'bg-red-500/20 text-red-400 border-red-500/30',
  abandoned: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
};

// Helper para calcular tiempo restante
export function getTimeRemaining(expiresAt: string): {
  expired: boolean;
  hours: number;
  minutes: number;
  label: string;
} {
  const now = new Date();
  const expires = new Date(expiresAt);
  const diffMs = expires.getTime() - now.getTime();
  
  if (diffMs <= 0) {
    return { expired: true, hours: 0, minutes: 0, label: 'Expirado' };
  }
  
  const hours = Math.floor(diffMs / (1000 * 60 * 60));
  const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
  
  if (hours > 24) {
    const days = Math.floor(hours / 24);
    return { expired: false, hours, minutes, label: `${days} día${days !== 1 ? 's' : ''}` };
  }
  
  if (hours > 0) {
    return { expired: false, hours, minutes, label: `${hours}h ${minutes}m` };
  }
  
  return { expired: false, hours, minutes, label: `${minutes} minutos` };
}
</file>

<file path="gtc-sprint-permisos-perfil-azul/001-migration-permisos-perfil-leads.sql">
-- =====================================================
-- GTC TECH APP - MIGRACIÓN COMPLETA
-- Sistema de Permisos + Perfil Asistente + Leads
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- =====================================================
-- PASO 1: CREAR ENUMS PARA DEPARTAMENTOS Y POSICIONES
-- =====================================================

-- Eliminar si existen (para poder re-ejecutar)
DROP TYPE IF EXISTS user_department CASCADE;
DROP TYPE IF EXISTS user_position CASCADE;

-- Departamentos de la empresa
CREATE TYPE user_department AS ENUM (
  'c_level',       -- CEO (Daniel), COO (Victor)
  'finance',       -- Antonio (Director de Negocios)
  'sales',         -- Pilar (RRHH + Ventas)
  'hr',            -- Gladymar, Viviana
  'quality',       -- Norma, Fabiola, Suany
  'marketing',     -- Jennifer
  'automation',    -- Ariel, Nelson
  'development',   -- Javier
  'operations'     -- Los 78 asistentes externos
);

-- Niveles jerárquicos
CREATE TYPE user_position AS ENUM (
  'ceo',
  'coo',
  'director',
  'manager',
  'specialist',
  'assistant'
);

-- =====================================================
-- PASO 2: ACTUALIZAR TABLA PROFILES
-- =====================================================

-- Agregar columnas nuevas a profiles
ALTER TABLE profiles 
  ADD COLUMN IF NOT EXISTS department user_department,
  ADD COLUMN IF NOT EXISTS position user_position,
  ADD COLUMN IF NOT EXISTS phone TEXT,
  ADD COLUMN IF NOT EXISTS timezone TEXT DEFAULT 'Europe/Madrid',
  ADD COLUMN IF NOT EXISTS country TEXT,
  ADD COLUMN IF NOT EXISTS avatar_url TEXT;

-- Comentarios
COMMENT ON COLUMN profiles.department IS 'Departamento al que pertenece el usuario';
COMMENT ON COLUMN profiles.position IS 'Cargo/nivel jerárquico del usuario';

-- =====================================================
-- PASO 3: ACTUALIZAR TABLA ASSISTANTS (Perfil completo)
-- =====================================================

-- Agregar columnas para perfil completo de asistente
ALTER TABLE assistants 
  ADD COLUMN IF NOT EXISTS client_id UUID REFERENCES clients(id),
  ADD COLUMN IF NOT EXISTS assistant_type TEXT,
  ADD COLUMN IF NOT EXISTS contract_type TEXT DEFAULT 'tiempo_completo',
  ADD COLUMN IF NOT EXISTS work_schedule TEXT DEFAULT '10:30-19:30',
  ADD COLUMN IF NOT EXISTS start_date DATE,
  ADD COLUMN IF NOT EXISTS timezone TEXT DEFAULT 'America/New_York',
  ADD COLUMN IF NOT EXISTS country TEXT,
  ADD COLUMN IF NOT EXISTS weekly_objectives JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS monthly_objectives JSONB DEFAULT '[]'::jsonb,
  ADD COLUMN IF NOT EXISTS skills TEXT[],
  ADD COLUMN IF NOT EXISTS languages TEXT[];

-- Constraint para tipos de asistente (basado en lo que vi en Zoho)
ALTER TABLE assistants 
  DROP CONSTRAINT IF EXISTS assistants_type_check;

ALTER TABLE assistants 
  ADD CONSTRAINT assistants_type_check 
  CHECK (assistant_type IS NULL OR assistant_type IN (
    'gestor_operaciones',
    'proyectos_software', 
    'desarrollo_web',
    'comunicaciones',
    'financiero_contable',
    'marketing_digital',
    'administrativo',
    'ventas_ecommerce'
  ));

-- Constraint para tipos de contrato
ALTER TABLE assistants 
  DROP CONSTRAINT IF EXISTS assistants_contract_check;

ALTER TABLE assistants 
  ADD CONSTRAINT assistants_contract_check 
  CHECK (contract_type IS NULL OR contract_type IN (
    'tiempo_completo',
    'medio_tiempo',
    'por_proyecto'
  ));

-- Comentarios
COMMENT ON COLUMN assistants.client_id IS 'Cliente al que está asignado actualmente';
COMMENT ON COLUMN assistants.assistant_type IS 'Tipo de asistente: gestor_operaciones, desarrollo_web, etc.';
COMMENT ON COLUMN assistants.weekly_objectives IS 'Objetivos semanales en formato JSON';
COMMENT ON COLUMN assistants.monthly_objectives IS 'Objetivos mensuales en formato JSON';

-- =====================================================
-- PASO 4: CREAR TABLA DE LEADS (Pipeline de ventas)
-- =====================================================

CREATE TABLE IF NOT EXISTS leads (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Datos de la empresa/contacto
  company_name TEXT NOT NULL,
  contact_name TEXT,
  contact_email TEXT,
  contact_phone TEXT,
  website TEXT,
  linkedin_url TEXT,
  
  -- Necesidad del cliente
  assistant_type TEXT, -- Tipo de asistente que busca
  quantity INTEGER DEFAULT 1,
  budget_min DECIMAL(10,2),
  budget_max DECIMAL(10,2),
  urgency TEXT DEFAULT 'medium' CHECK (urgency IN ('low', 'medium', 'high', 'urgent')),
  notes TEXT,
  
  -- Estado del pipeline
  status TEXT NOT NULL DEFAULT 'new' CHECK (status IN (
    'new',                  -- Contactar
    'contacted',            -- Contactado / Descripción
    'pending_confirmation', -- Pendiente de Confirmación
    'candidates_sent',      -- Fichas Enviadas
    'schedule_interview',   -- Agendar Entrevista
    'interview_scheduled',  -- Entrevista Agendada
    'negotiation',          -- Negociación
    'won',                  -- Personal para GTC / Contrato
    'lost',                 -- Solicitudes Desestimadas
    'postponed'             -- Solicitudes Postergadas (Inconvenientes)
  )),
  
  -- Asignación
  assigned_to UUID REFERENCES profiles(id),
  
  -- Candidatos presentados
  presented_candidates UUID[] DEFAULT '{}',
  
  -- Fechas importantes
  first_contact_at TIMESTAMPTZ,
  last_contact_at TIMESTAMPTZ,
  expected_close_date DATE,
  
  -- Cierre
  lost_reason TEXT,
  converted_client_id UUID REFERENCES clients(id), -- Si se convirtió en cliente
  
  -- Origen
  source TEXT DEFAULT 'linkedin' CHECK (source IN (
    'linkedin', 'referral', 'website', 'cold_call', 'event', 'other'
  )),
  
  -- Zoho sync
  zoho_lead_id TEXT,
  
  -- Metadata
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Índices
CREATE INDEX IF NOT EXISTS idx_leads_status ON leads(status);
CREATE INDEX IF NOT EXISTS idx_leads_assigned ON leads(assigned_to);
CREATE INDEX IF NOT EXISTS idx_leads_created ON leads(created_at DESC);

-- RLS
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;

-- Políticas para leads
CREATE POLICY "Sales and C-Level can view all leads" ON leads
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND (
        department IN ('c_level', 'sales', 'finance')
        OR role = 'admin'
      )
    )
  );

CREATE POLICY "Sales can manage leads" ON leads
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND (
        department IN ('c_level', 'sales')
        OR role = 'admin'
      )
    )
  );

-- Trigger para updated_at
DROP TRIGGER IF EXISTS update_leads_updated_at ON leads;
CREATE TRIGGER update_leads_updated_at 
  BEFORE UPDATE ON leads
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =====================================================
-- PASO 5: CREAR TABLA ASSISTANT_CANDIDATES (Banco)
-- =====================================================

CREATE TABLE IF NOT EXISTS assistant_candidates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Link al candidato original (de interviews/applications)
  candidate_id UUID REFERENCES candidates(id),
  application_id UUID REFERENCES applications(id),
  
  -- Datos del candidato
  full_name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  
  -- Tipo y especialización
  assistant_type TEXT NOT NULL,
  skills TEXT[],
  languages TEXT[],
  
  -- Evaluaciones (scores de cada etapa)
  cv_score DECIMAL(5,2),
  video_score DECIMAL(5,2),
  bot_score DECIMAL(5,2),
  human_interview_score DECIMAL(5,2),
  final_score DECIMAL(5,2),
  
  -- Estado en el banco
  status TEXT NOT NULL DEFAULT 'available' CHECK (status IN (
    'available',     -- Disponible para asignar
    'presented',     -- Presentado a un cliente
    'interviewing',  -- En entrevista con cliente final
    'selected',      -- Seleccionado por cliente
    'contracted',    -- Ya firmó contrato
    'unavailable'    -- No disponible temporalmente
  )),
  
  -- Asignación actual
  current_lead_id UUID REFERENCES leads(id), -- Lead al que fue presentado
  current_client_id UUID REFERENCES clients(id), -- Cliente si ya fue contratado
  
  -- Reclutador que lo procesó
  recruiter_id UUID REFERENCES profiles(id),
  
  -- Documentos
  cv_url TEXT,
  video_url TEXT,
  ficha_url TEXT, -- Ficha técnica generada
  
  -- Zoho sync
  zoho_candidate_id TEXT,
  
  -- Metadata
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Unique por email
  UNIQUE(email)
);

-- Índices
CREATE INDEX IF NOT EXISTS idx_assistant_candidates_status ON assistant_candidates(status);
CREATE INDEX IF NOT EXISTS idx_assistant_candidates_type ON assistant_candidates(assistant_type);
CREATE INDEX IF NOT EXISTS idx_assistant_candidates_score ON assistant_candidates(final_score DESC);

-- RLS
ALTER TABLE assistant_candidates ENABLE ROW LEVEL SECURITY;

-- Políticas
CREATE POLICY "HR and Sales can view all candidates" ON assistant_candidates
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND (
        department IN ('c_level', 'hr', 'sales')
        OR role = 'admin'
      )
    )
  );

CREATE POLICY "HR can manage candidates" ON assistant_candidates
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM profiles 
      WHERE id = auth.uid() 
      AND (
        department IN ('c_level', 'hr')
        OR role = 'admin'
      )
    )
  );

-- Trigger
DROP TRIGGER IF EXISTS update_assistant_candidates_updated_at ON assistant_candidates;
CREATE TRIGGER update_assistant_candidates_updated_at 
  BEFORE UPDATE ON assistant_candidates
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =====================================================
-- PASO 6: ACTUALIZAR LÓGICA DE REPORTES SEMANALES
-- Agregar control de edición por día
-- =====================================================

-- Agregar columna para controlar días de edición
ALTER TABLE weekly_submissions
  ADD COLUMN IF NOT EXISTS last_edited_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS edit_history JSONB DEFAULT '[]'::jsonb;

-- Función para verificar si se puede editar
CREATE OR REPLACE FUNCTION can_edit_weekly_submission(submission_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
  v_submission weekly_submissions%ROWTYPE;
  v_day_of_week INTEGER;
BEGIN
  -- Obtener el submission
  SELECT * INTO v_submission FROM weekly_submissions WHERE id = submission_id;
  
  IF NOT FOUND THEN
    RETURN FALSE;
  END IF;
  
  -- Si ya está enviado, no se puede editar
  IF v_submission.status = 'submitted' THEN
    RETURN FALSE;
  END IF;
  
  -- Obtener día de la semana (1=Lunes, 5=Viernes, 7=Domingo)
  v_day_of_week := EXTRACT(ISODOW FROM NOW());
  
  -- Se puede editar de Lunes (1) a Viernes (5)
  -- El viernes se puede editar Y hacer submit
  IF v_day_of_week >= 1 AND v_day_of_week <= 5 THEN
    RETURN TRUE;
  END IF;
  
  -- Sábado y Domingo no se puede editar
  RETURN FALSE;
END;
$$ LANGUAGE plpgsql;

-- =====================================================
-- PASO 7: VISTAS ÚTILES
-- =====================================================

-- Vista: Pipeline de leads por estado
CREATE OR REPLACE VIEW v_leads_pipeline AS
SELECT 
  status,
  COUNT(*) as count,
  AVG(EXTRACT(EPOCH FROM (NOW() - created_at)) / 86400)::INTEGER as avg_days_in_status
FROM leads
WHERE status NOT IN ('won', 'lost')
GROUP BY status
ORDER BY 
  CASE status
    WHEN 'new' THEN 1
    WHEN 'contacted' THEN 2
    WHEN 'interested' THEN 3
    WHEN 'presenting' THEN 4
    WHEN 'negotiating' THEN 5
    WHEN 'contract_sent' THEN 6
    WHEN 'frozen' THEN 7
  END;

-- Vista: Candidatos disponibles por tipo
CREATE OR REPLACE VIEW v_available_candidates AS
SELECT 
  assistant_type,
  COUNT(*) as count,
  AVG(final_score) as avg_score
FROM assistant_candidates
WHERE status = 'available'
GROUP BY assistant_type
ORDER BY count DESC;

-- Vista: Rendimiento de asistentes (para Calidad)
CREATE OR REPLACE VIEW v_assistant_performance AS
SELECT 
  a.id,
  a.full_name,
  a.assistant_type,
  a.client_id,
  c.name as client_name,
  COUNT(ws.id) as total_reports,
  COUNT(ws.id) FILTER (WHERE ws.status = 'submitted') as submitted_reports,
  AVG(ws.quality_score) as avg_quality_score,
  MAX(ws.submitted_at) as last_submission
FROM assistants a
LEFT JOIN weekly_submissions ws ON ws.assistant_id = a.id
LEFT JOIN clients c ON a.client_id = c.id
GROUP BY a.id, a.full_name, a.assistant_type, a.client_id, c.name;

-- =====================================================
-- PASO 8: MAPEAR USUARIOS EXISTENTES
-- Ejecutar DESPUÉS de crear los usuarios reales
-- =====================================================

-- Función para mapear roles existentes a nuevos departamentos
CREATE OR REPLACE FUNCTION migrate_user_departments()
RETURNS void AS $$
BEGIN
  -- Mapear admin → c_level + director (o ajustar manualmente)
  UPDATE profiles 
  SET department = 'c_level', position = 'director'
  WHERE role = 'admin' AND department IS NULL;
  
  -- Mapear calidad
  UPDATE profiles 
  SET department = 'quality', position = 'specialist'
  WHERE role = 'calidad' AND department IS NULL;
  
  -- Mapear rrhh
  UPDATE profiles 
  SET department = 'hr', position = 'specialist'
  WHERE role = 'rrhh' AND department IS NULL;
  
  -- Mapear marketing
  UPDATE profiles 
  SET department = 'marketing', position = 'specialist'
  WHERE role = 'marketing' AND department IS NULL;
  
  -- Mapear asistente (los externos)
  UPDATE profiles 
  SET department = 'operations', position = 'assistant'
  WHERE role = 'asistente' AND department IS NULL;
END;
$$ LANGUAGE plpgsql;

-- Ejecutar migración
SELECT migrate_user_departments();

-- =====================================================
-- PASO 9: ÍNDICES DE RENDIMIENTO
-- =====================================================

-- Índices adicionales para consultas frecuentes
CREATE INDEX IF NOT EXISTS idx_profiles_department ON profiles(department);
CREATE INDEX IF NOT EXISTS idx_profiles_position ON profiles(position);
CREATE INDEX IF NOT EXISTS idx_assistants_client ON assistants(client_id);
CREATE INDEX IF NOT EXISTS idx_assistants_type ON assistants(assistant_type);
CREATE INDEX IF NOT EXISTS idx_weekly_submissions_week ON weekly_submissions(week_start);

-- =====================================================
-- COMENTARIOS FINALES
-- =====================================================

COMMENT ON TABLE leads IS 'Pipeline de ventas - Leads que pueden convertirse en clientes';
COMMENT ON TABLE assistant_candidates IS 'Banco de candidatos aprobados listos para asignar a clientes';

-- =====================================================
-- VERIFICACIÓN
-- =====================================================
SELECT 'Migración completada exitosamente' as status;
</file>

<file path="gtc-sprint-permisos-perfil-azul/README.md">
# 🚀 GTC TECH APP - SPRINT 1
## Sistema de Permisos + Perfil de Asistente + Colores Azules

---

## 📋 CONTENIDO DEL SPRINT

Este sprint incluye:

1. **SQL de migración** - Sistema de permisos por departamento/posición
2. **Tipos TypeScript** - Nuevos tipos para permisos, leads, candidatos
3. **CSS global** - Colores azules corporativos
4. **Sidebar actualizado** - Navegación por departamento
5. **Perfil de asistente** - Formulario completo con objetivos
6. **Barra de calidad** - Componente rojo→amarillo→verde
7. **InterviewRoom** - Actualizado con colores azules y texto corregido

---

## 🔧 INSTRUCCIONES DE IMPLEMENTACIÓN

### PASO 1: Ejecutar SQL en Supabase

1. Ir a Supabase → SQL Editor
2. Copiar y pegar el contenido de `001-migration-permisos-perfil-leads.sql`
3. Ejecutar

**IMPORTANTE:** Este SQL:
- Crea los tipos ENUM para departamentos y posiciones
- Agrega columnas nuevas a `profiles` y `assistants`
- Crea las tablas `leads` y `assistant_candidates`
- Configura RLS y políticas

### PASO 2: Reemplazar archivos

Copiar los siguientes archivos a tu proyecto:

```
src/
├── types/
│   └── database.types.ts        ← REEMPLAZAR
├── app/
│   ├── globals.css              ← REEMPLAZAR
│   ├── (dashboard)/
│   │   └── perfil/
│   │       └── page.tsx         ← NUEVO
│   └── entrevista/
│       └── [token]/
│           └── InterviewRoom.tsx ← REEMPLAZAR
├── components/
│   ├── shared/
│   │   └── Sidebar.tsx          ← REEMPLAZAR
│   ├── profile/
│   │   └── AssistantProfileForm.tsx ← NUEVO
│   └── calidad/
│       └── QualityScoreBar.tsx  ← NUEVO
```

### PASO 3: Actualizar layout del dashboard

En `src/app/(dashboard)/layout.tsx`, actualizar el Sidebar para pasar los nuevos props:

```tsx
<Sidebar 
  userRole={profile.role} 
  userDepartment={profile.department}
  userPosition={profile.position}
/>
```

### PASO 4: Verificar tailwind.config.ts

Asegurarse de que los colores azules estén disponibles (ya deberían estar por defecto).

---

## 🎨 CAMBIOS DE COLORES

### Antes (Verde)
```css
--primary: #10b981; /* emerald-500 */
```

### Después (Azul)
```css
--primary: #3b82f6; /* blue-500 */
```

Los componentes actualizados usan:
- `bg-blue-500` en lugar de `bg-emerald-500`
- `text-blue-400` en lugar de `text-emerald-400`
- `border-blue-500` en lugar de `border-emerald-500`

---

## 👥 SISTEMA DE PERMISOS

### Departamentos disponibles:
- `c_level` - CEO, COO
- `finance` - Finanzas
- `sales` - Ventas
- `hr` - Recursos Humanos
- `quality` - Calidad
- `marketing` - Marketing
- `automation` - Automatización
- `development` - Desarrollo
- `operations` - Asistentes externos

### Posiciones disponibles:
- `ceo`
- `coo`
- `director`
- `manager`
- `specialist`
- `assistant`

### Ejemplo de uso:
```typescript
import { hasAccess } from '@/types/database.types';

const canViewLeads = hasAccess(
  user.department,
  user.position,
  user.role,
  { departments: ['c_level', 'sales'], positions: ['manager', 'director'] }
);
```

---

## 📝 PANTALLA DE ENTREVISTA

### Cambios realizados:
- ✅ Colores azules en lugar de verdes
- ✅ Duración: "5-7 minutos" (antes: "10-15 minutos")
- ✅ Eliminada recomendación de auriculares
- ✅ Solo muestra "Global Talent Connections" (sin nombre del cliente)
- ✅ Voice orb animado con colores azules

### Mensaje de bienvenida:
```
¡Hola, {nombre}!

Estás a punto de comenzar tu entrevista técnica

Antes de comenzar:
• Asegurate de estar en un lugar silencioso
• Verificá tu conexión a internet
• La entrevista durará aproximadamente 5-7 minutos

[Comenzar Entrevista]
```

---

## 📊 BARRA DE CALIDAD

El componente `QualityScoreBar` muestra un gradiente:
- **0-39%**: Rojo (necesita mejorar)
- **40-69%**: Amarillo (en progreso)
- **70-100%**: Verde (bueno/excelente)

### Uso:
```tsx
import { QualityScoreBar, ScoreBadge } from '@/components/calidad/QualityScoreBar';

<QualityScoreBar score={75} />
<ScoreBadge score={75} />
```

---

## 🔐 MAPEO DE USUARIOS EXISTENTES

El SQL incluye una función que mapea roles legacy a departamentos:

| Role anterior | Departamento nuevo | Posición nueva |
|--------------|-------------------|----------------|
| admin | c_level | director |
| calidad | quality | specialist |
| rrhh | hr | specialist |
| marketing | marketing | specialist |
| asistente | operations | assistant |

Para usuarios específicos (Daniel, Victor, Norma, etc.), actualizar manualmente:

```sql
-- Ejemplo: Actualizar a Daniel como CEO
UPDATE profiles 
SET department = 'c_level', position = 'ceo'
WHERE email = 'daniel@globaltalent.com';

-- Ejemplo: Actualizar a Norma como Manager de Calidad
UPDATE profiles 
SET department = 'quality', position = 'manager'
WHERE email = 'norma@globaltalent.com';
```

---

## ✅ CHECKLIST DE IMPLEMENTACIÓN

- [ ] Ejecutar SQL de migración
- [ ] Reemplazar `database.types.ts`
- [ ] Reemplazar `globals.css`
- [ ] Reemplazar `Sidebar.tsx`
- [ ] Agregar `AssistantProfileForm.tsx`
- [ ] Agregar `QualityScoreBar.tsx`
- [ ] Agregar página `/perfil`
- [ ] Actualizar `InterviewRoom.tsx`
- [ ] Actualizar layout del dashboard
- [ ] Asignar departamentos a usuarios existentes
- [ ] Probar navegación por rol
- [ ] Verificar colores azules

---

## 🐛 SOLUCIÓN DE PROBLEMAS

### Error: "department" column does not exist
→ El SQL no se ejecutó correctamente. Volver a ejecutar.

### El sidebar no filtra correctamente
→ Verificar que el layout pase los props `userDepartment` y `userPosition`.

### Los colores siguen verdes
→ Verificar que se reemplazó `globals.css` y hacer hard refresh (Ctrl+Shift+R).

---

## 📞 PRÓXIMOS PASOS

1. **Webhook de ElevenLabs** - Configurar en la consola del agente
2. **Dashboard con métricas reales** - Conectar a datos de Supabase
3. **Módulo de Leads** - Pipeline visual
4. **Edición diaria de reportes** - L-J editar, V submit

---

*Sprint generado: Enero 2026*
</file>

<file path="gtc-sprint-permisos-perfil-azul/src/app/(dashboard)/perfil/page.tsx">
import { redirect } from 'next/navigation';
import { createServerSupabaseClient, getServerUser } from '@/lib/supabase/server';
import { AssistantProfileForm } from '@/components/profile/AssistantProfileForm';

// =====================================================
// PÁGINA: /perfil
// Perfil completo del asistente
// =====================================================

export default async function ProfilePage() {
  const supabase = createServerSupabaseClient();
  const user = await getServerUser();

  if (!user) {
    redirect('/login');
  }

  // Obtener perfil del usuario
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (!profile) {
    redirect('/login');
  }

  // Obtener datos del asistente
  const { data: assistant } = await supabase
    .from('assistants')
    .select(`
      *,
      client:clients (
        id,
        name
      )
    `)
    .eq('user_id', user.id)
    .single();

  // Si no existe registro de asistente, crear uno básico
  if (!assistant) {
    const { data: newAssistant, error } = await supabase
      .from('assistants')
      .insert({
        user_id: user.id,
        full_name: profile.full_name || user.email?.split('@')[0] || 'Usuario',
        email: user.email || '',
        status: 'activo',
      })
      .select()
      .single();

    if (error) {
      console.error('Error creating assistant:', error);
    }

    // Recargar para obtener el nuevo registro
    return (
      <div className="min-h-screen bg-slate-950 p-6">
        <div className="max-w-4xl mx-auto">
          <h1 className="text-2xl font-bold text-white mb-6">Mi Perfil</h1>
          <AssistantProfileForm
            assistantId={newAssistant?.id || ''}
            initialData={newAssistant || undefined}
          />
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-950 p-6">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-2xl font-bold text-white">Mi Perfil</h1>
          <p className="text-slate-400 mt-1">
            Actualiza tu información personal, habilidades y objetivos
          </p>
        </div>

        {/* Formulario */}
        <AssistantProfileForm
          assistantId={assistant.id}
          initialData={assistant}
          clientName={assistant.client?.name}
        />
      </div>
    </div>
  );
}
</file>

<file path="gtc-sprint-permisos-perfil-azul/src/app/entrevista/[token]/InterviewRoom.tsx">
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useConversation } from '@elevenlabs/react';
import {
  Mic,
  MicOff,
  PhoneOff,
  Loader2,
  CheckCircle2,
  AlertCircle,
  Clock,
  User,
  Briefcase,
} from 'lucide-react';
import { cn } from '@/lib/utils';

// =====================================================
// TIPOS
// =====================================================

interface InterviewData {
  token: string;
  candidate_name: string;
  job_title: string;
  client_name: string;
  agent_id: string;
}

type RoomState = 'welcome' | 'connecting' | 'active' | 'completed' | 'error';

interface InterviewRoomProps {
  data: InterviewData;
}

// =====================================================
// COMPONENTE PRINCIPAL
// =====================================================

export function InterviewRoom({ data }: InterviewRoomProps) {
  const [roomState, setRoomState] = useState<RoomState>('welcome');
  const [isMuted, setIsMuted] = useState(false);
  const [duration, setDuration] = useState(0);
  const [error, setError] = useState<string | null>(null);

  // Hook de ElevenLabs
  const conversation = useConversation({
    onConnect: () => {
      console.log('🎙️ Conectado a ElevenLabs');
      setRoomState('active');
    },
    onDisconnect: () => {
      console.log('📴 Desconectado de ElevenLabs');
      if (roomState === 'active') {
        handleComplete();
      }
    },
    onError: (err) => {
      console.error('❌ Error ElevenLabs:', err);
      setError('Error de conexión. Por favor, recarga la página.');
      setRoomState('error');
    },
  });

  // Timer de duración
  useEffect(() => {
    let interval: NodeJS.Timeout;
    if (roomState === 'active') {
      interval = setInterval(() => {
        setDuration((prev) => prev + 1);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [roomState]);

  // Formatear tiempo
  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  // Iniciar entrevista
  const handleStart = async () => {
    setRoomState('connecting');
    setError(null);

    try {
      // 1. Notificar al servidor que inicia
      const startRes = await fetch('/api/interviews/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: data.token }),
      });

      if (!startRes.ok) {
        const errorData = await startRes.json();
        throw new Error(errorData.error || 'Error al iniciar la entrevista');
      }

      // 2. Solicitar permiso de micrófono
      await navigator.mediaDevices.getUserMedia({ audio: true });

      // 3. Conectar con ElevenLabs
      await conversation.startSession({
        agentId: data.agent_id,
      });

    } catch (err) {
      console.error('Error starting interview:', err);
      setError(err instanceof Error ? err.message : 'Error al iniciar');
      setRoomState('error');
    }
  };

  // Finalizar entrevista
  const handleComplete = useCallback(async () => {
    try {
      // Detener conversación si está activa
      if (conversation.status === 'connected') {
        await conversation.endSession();
      }

      // Notificar al servidor
      await fetch('/api/interviews/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          token: data.token,
          conversation_id: conversation.id || null,
        }),
      });

      setRoomState('completed');
    } catch (err) {
      console.error('Error completing interview:', err);
    }
  }, [conversation, data.token]);

  // Toggle mute
  const toggleMute = () => {
    setIsMuted((prev) => !prev);
    // ElevenLabs maneja el mute internamente
  };

  // ===== RENDER =====

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-blue-950 flex items-center justify-center p-4">
      <div className="w-full max-w-2xl">
        
        {/* ===== PANTALLA DE BIENVENIDA ===== */}
        {roomState === 'welcome' && (
          <div className="card text-center animate-fade-in">
            {/* Logo */}
            <div className="flex justify-center mb-6">
              <div className="w-16 h-16 rounded-xl bg-blue-500 flex items-center justify-center">
                <span className="text-2xl font-bold text-white">GT</span>
              </div>
            </div>

            {/* Saludo */}
            <h1 className="text-2xl font-bold text-white mb-2">
              ¡Hola, {data.candidate_name}!
            </h1>
            <p className="text-slate-400 mb-6">
              Estás a punto de comenzar tu entrevista técnica
            </p>

            {/* Info del puesto */}
            <div className="bg-slate-800/50 rounded-lg p-4 mb-6">
              <div className="flex items-center justify-center gap-2 text-blue-400 mb-2">
                <Briefcase className="h-5 w-5" />
                <span className="font-medium">{data.job_title}</span>
              </div>
              <p className="text-sm text-slate-500">
                Global Talent Connections
              </p>
            </div>

            {/* Instrucciones */}
            <div className="text-left bg-slate-800/30 rounded-lg p-4 mb-6">
              <h3 className="text-sm font-medium text-white mb-3">
                Antes de comenzar:
              </h3>
              <ul className="space-y-2 text-sm text-slate-400">
                <li className="flex items-start gap-2">
                  <span className="text-blue-400 mt-0.5">•</span>
                  <span>Asegurate de estar en un lugar <strong className="text-white">silencioso</strong></span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-400 mt-0.5">•</span>
                  <span>Verificá tu <strong className="text-white">conexión a internet</strong></span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-400 mt-0.5">•</span>
                  <span>La entrevista durará aproximadamente <strong className="text-white">5-7 minutos</strong></span>
                </li>
              </ul>
            </div>

            {/* Botón iniciar */}
            <button
              onClick={handleStart}
              className="w-full btn-primary py-4 text-lg font-semibold"
            >
              Comenzar Entrevista
            </button>
          </div>
        )}

        {/* ===== PANTALLA DE CONEXIÓN ===== */}
        {roomState === 'connecting' && (
          <div className="card text-center animate-fade-in">
            <div className="relative w-32 h-32 mx-auto mb-6">
              {/* Anillos animados */}
              <div className="absolute inset-0 rounded-full border-4 border-blue-500/20 animate-pulse" />
              <div className="absolute inset-4 rounded-full border-4 border-blue-500/40 animate-pulse" style={{ animationDelay: '0.2s' }} />
              <div className="absolute inset-8 rounded-full bg-blue-500 flex items-center justify-center">
                <Loader2 className="h-8 w-8 text-white animate-spin" />
              </div>
            </div>
            
            <h2 className="text-xl font-semibold text-white mb-2">
              Conectando...
            </h2>
            <p className="text-slate-400">
              Por favor, permite el acceso al micrófono
            </p>
          </div>
        )}

        {/* ===== PANTALLA DE ENTREVISTA ACTIVA ===== */}
        {roomState === 'active' && (
          <div className="card text-center animate-fade-in">
            {/* Timer */}
            <div className="flex items-center justify-center gap-2 text-slate-400 mb-6">
              <Clock className="h-4 w-4" />
              <span className="font-mono text-lg">{formatTime(duration)}</span>
            </div>

            {/* Voice Orb */}
            <div className="relative w-40 h-40 mx-auto mb-8">
              {/* Outer glow */}
              <div 
                className={cn(
                  'absolute inset-0 rounded-full transition-all duration-300',
                  conversation.isSpeaking 
                    ? 'bg-blue-500/20 scale-110' 
                    : 'bg-blue-500/10 scale-100'
                )}
              />
              
              {/* Main orb */}
              <div 
                className={cn(
                  'absolute inset-4 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 shadow-lg shadow-blue-500/30 transition-all duration-150',
                  conversation.isSpeaking && 'scale-105'
                )}
              >
                <div className="absolute inset-0 flex items-center justify-center">
                  <Mic className="h-12 w-12 text-white" />
                </div>
              </div>
              
              {/* Speaking indicator */}
              {conversation.isSpeaking && (
                <div className="absolute inset-0 rounded-full animate-ping bg-blue-500/20" />
              )}
            </div>

            {/* Status */}
            <p className="text-lg text-white mb-2">
              {conversation.isSpeaking ? 'Alexa está hablando...' : 'Escuchando...'}
            </p>
            <p className="text-sm text-slate-500 mb-8">
              Habla con claridad cuando sea tu turno
            </p>

            {/* Controls */}
            <div className="flex items-center justify-center gap-4">
              {/* Mute button */}
              <button
                onClick={toggleMute}
                className={cn(
                  'p-4 rounded-full transition-all duration-200',
                  isMuted 
                    ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30' 
                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                )}
              >
                {isMuted ? (
                  <MicOff className="h-6 w-6" />
                ) : (
                  <Mic className="h-6 w-6" />
                )}
              </button>

              {/* End call button */}
              <button
                onClick={handleComplete}
                className="p-4 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors"
              >
                <PhoneOff className="h-6 w-6" />
              </button>
            </div>
          </div>
        )}

        {/* ===== PANTALLA DE COMPLETADO ===== */}
        {roomState === 'completed' && (
          <div className="card text-center animate-fade-in">
            <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-green-500/20 flex items-center justify-center">
              <CheckCircle2 className="h-10 w-10 text-green-400" />
            </div>

            <h2 className="text-2xl font-bold text-white mb-2">
              ¡Entrevista completada!
            </h2>
            
            <p className="text-slate-400 mb-6">
              Gracias por tu tiempo, {data.candidate_name}.<br />
              Nuestro equipo revisará tus respuestas y te contactará pronto.
            </p>

            {/* Duración */}
            <div className="inline-flex items-center gap-2 px-4 py-2 bg-slate-800 rounded-lg text-slate-300">
              <Clock className="h-4 w-4" />
              <span>Duración: {formatTime(duration)}</span>
            </div>

            <p className="mt-8 text-sm text-slate-500">
              Ya podés cerrar esta ventana.
            </p>
          </div>
        )}

        {/* ===== PANTALLA DE ERROR ===== */}
        {roomState === 'error' && (
          <div className="card text-center animate-fade-in">
            <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-red-500/20 flex items-center justify-center">
              <AlertCircle className="h-10 w-10 text-red-400" />
            </div>

            <h2 className="text-2xl font-bold text-white mb-2">
              Ocurrió un error
            </h2>
            
            <p className="text-slate-400 mb-6">
              {error || 'No se pudo conectar con el sistema de entrevistas.'}
            </p>

            <button
              onClick={() => {
                setError(null);
                setRoomState('welcome');
              }}
              className="btn-primary"
            >
              Intentar de nuevo
            </button>
          </div>
        )}

        {/* Footer */}
        <p className="text-center text-slate-600 text-xs mt-6">
          Global Talent Connections © {new Date().getFullYear()}
        </p>
      </div>
    </div>
  );
}

export default InterviewRoom;
</file>

<file path="gtc-sprint-permisos-perfil-azul/src/app/globals.css">
/* =====================================================
   src/app/globals.css
   COLORES CORPORATIVOS AZUL TECNOLÓGICO
   ===================================================== */

@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  /* ===== COLORES PRINCIPALES (AZUL TECNOLÓGICO) ===== */
  --color-primary: 59 130 246;        /* blue-500 */
  --color-primary-dark: 37 99 235;    /* blue-600 */
  --color-primary-light: 96 165 250;  /* blue-400 */
  --color-primary-50: 239 246 255;    /* blue-50 */
  --color-primary-100: 219 234 254;   /* blue-100 */
  --color-primary-900: 30 58 138;     /* blue-900 */
  
  /* ===== COLORES DE ESTADO ===== */
  --color-success: 34 197 94;         /* green-500 */
  --color-warning: 245 158 11;        /* amber-500 */
  --color-error: 239 68 68;           /* red-500 */
  --color-info: 59 130 246;           /* blue-500 */
  
  /* ===== FONDO OSCURO ===== */
  --background: 2 6 23;               /* slate-950 */
  --foreground: 248 250 252;          /* slate-50 */
  
  /* ===== BORDES Y SEPARADORES ===== */
  --border: 30 41 59;                 /* slate-800 */
  --border-light: 51 65 85;           /* slate-700 */
}

/* ===== ESTILOS BASE ===== */
body {
  background-color: rgb(var(--background));
  color: rgb(var(--foreground));
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ===== SCROLLBAR PERSONALIZADO ===== */
.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: rgb(15 23 42); /* slate-900 */
  border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: rgb(51 65 85); /* slate-700 */
  border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: rgb(71 85 105); /* slate-600 */
}

/* ===== COMPONENTES REUTILIZABLES ===== */
@layer components {
  /* Botón primario (azul) */
  .btn-primary {
    @apply bg-blue-500 hover:bg-blue-600 text-white font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }
  
  .btn-primary:disabled {
    @apply bg-blue-500/50 cursor-not-allowed;
  }
  
  /* Botón secundario */
  .btn-secondary {
    @apply bg-slate-700 hover:bg-slate-600 text-white font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }
  
  /* Botón outline */
  .btn-outline {
    @apply border border-blue-500 text-blue-500 hover:bg-blue-500/10 font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }
  
  /* Botón ghost */
  .btn-ghost {
    @apply text-slate-400 hover:text-white hover:bg-slate-800 font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }
  
  /* Botón danger */
  .btn-danger {
    @apply bg-red-500 hover:bg-red-600 text-white font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }
  
  /* Card base */
  .card {
    @apply bg-slate-900 border border-slate-800 rounded-xl p-6;
  }
  
  .card-hover {
    @apply card hover:border-blue-500/50 transition-colors duration-200 cursor-pointer;
  }
  
  /* Input base */
  .input {
    @apply w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white placeholder:text-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors;
  }
  
  /* Select base */
  .select {
    @apply w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors appearance-none cursor-pointer;
  }
  
  /* Label base */
  .label {
    @apply block text-sm font-medium text-slate-300 mb-1.5;
  }
  
  /* Badge base */
  .badge {
    @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
  }
  
  .badge-primary {
    @apply badge bg-blue-500/20 text-blue-400;
  }
  
  .badge-success {
    @apply badge bg-green-500/20 text-green-400;
  }
  
  .badge-warning {
    @apply badge bg-amber-500/20 text-amber-400;
  }
  
  .badge-error {
    @apply badge bg-red-500/20 text-red-400;
  }
  
  .badge-gray {
    @apply badge bg-slate-500/20 text-slate-400;
  }
  
  /* Sidebar link */
  .sidebar-link {
    @apply flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800/50 transition-all duration-200;
  }
  
  .sidebar-link--active {
    @apply bg-blue-500/10 text-blue-400 border-l-2 border-blue-500;
  }
  
  /* Table */
  .table-container {
    @apply overflow-x-auto rounded-lg border border-slate-800;
  }
  
  .table {
    @apply w-full text-sm;
  }
  
  .table th {
    @apply px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider bg-slate-900/50;
  }
  
  .table td {
    @apply px-4 py-3 border-t border-slate-800;
  }
  
  .table tr:hover td {
    @apply bg-slate-800/30;
  }
  
  /* Progress bar */
  .progress-bar {
    @apply h-2 bg-slate-700 rounded-full overflow-hidden;
  }
  
  .progress-bar-fill {
    @apply h-full bg-blue-500 transition-all duration-300;
  }
  
  /* Quality score bar (rojo → amarillo → verde) */
  .quality-bar {
    @apply h-3 rounded-full overflow-hidden;
    background: linear-gradient(to right, 
      rgb(239 68 68) 0%, 
      rgb(245 158 11) 50%, 
      rgb(34 197 94) 100%
    );
  }
  
  .quality-bar-indicator {
    @apply absolute top-0 w-1 h-full bg-white rounded shadow-lg transition-all duration-300;
  }
}

/* ===== ANIMACIONES ===== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(-20px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes pulse-ring {
  0% { transform: scale(1); opacity: 0.8; }
  50% { transform: scale(1.1); opacity: 0.4; }
  100% { transform: scale(1); opacity: 0.8; }
}

.animate-fade-in {
  animation: fadeIn 0.3s ease-out forwards;
}

.animate-slide-in {
  animation: slideIn 0.3s ease-out forwards;
}

.animate-pulse-ring {
  animation: pulse-ring 2s ease-in-out infinite;
}

/* ===== SKELETON LOADING ===== */
@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton {
  background: linear-gradient(90deg, rgb(15 23 42) 25%, rgb(30 41 59) 50%, rgb(15 23 42) 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite;
  border-radius: 0.5rem;
}

/* ===== GLOW EFFECTS ===== */
.glow-blue {
  box-shadow: 0 0 20px -5px rgba(59, 130, 246, 0.3);
}

.glow-green {
  box-shadow: 0 0 20px -5px rgba(34, 197, 94, 0.3);
}

.glow-amber {
  box-shadow: 0 0 20px -5px rgba(245, 158, 11, 0.3);
}

.glow-red {
  box-shadow: 0 0 20px -5px rgba(239, 68, 68, 0.3);
}

/* ===== VOICE ORB (para entrevistas) ===== */
.voice-orb {
  @apply relative w-32 h-32 rounded-full bg-gradient-to-br from-blue-400 to-blue-600;
  box-shadow: 
    0 0 60px rgba(59, 130, 246, 0.4),
    0 0 100px rgba(59, 130, 246, 0.2);
}

.voice-orb.speaking {
  animation: voice-pulse 0.5s ease-in-out infinite;
}

@keyframes voice-pulse {
  0%, 100% { 
    transform: scale(1);
    box-shadow: 
      0 0 60px rgba(59, 130, 246, 0.4),
      0 0 100px rgba(59, 130, 246, 0.2);
  }
  50% { 
    transform: scale(1.05);
    box-shadow: 
      0 0 80px rgba(59, 130, 246, 0.5),
      0 0 120px rgba(59, 130, 246, 0.3);
  }
}

/* ===== TOOLTIP ===== */
.tooltip {
  @apply absolute z-50 px-2 py-1 text-xs font-medium text-white bg-slate-800 rounded shadow-lg;
  @apply invisible opacity-0 transition-all duration-200;
}

.tooltip-trigger:hover .tooltip {
  @apply visible opacity-100;
}

/* ===== FOCUS VISIBLE ===== */
.focus-visible:focus-visible {
  @apply outline-none ring-2 ring-blue-500 ring-offset-2 ring-offset-slate-900;
}

/* ===== DARK MODE FORM ELEMENTS ===== */
input[type="date"],
input[type="time"],
input[type="datetime-local"] {
  color-scheme: dark;
}

select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 2.5rem;
}

/* ===== STATUS INDICATORS ===== */
.status-dot {
  @apply w-2 h-2 rounded-full;
}

.status-dot--active {
  @apply bg-green-500 animate-pulse;
}

.status-dot--inactive {
  @apply bg-slate-500;
}

.status-dot--warning {
  @apply bg-amber-500;
}

.status-dot--error {
  @apply bg-red-500;
}
</file>

<file path="gtc-sprint-permisos-perfil-azul/src/components/calidad/QualityScoreBar.tsx">
'use client';

import { cn } from '@/lib/utils';

// =====================================================
// QUALITY SCORE BAR
// Barra de calificación: rojo → amarillo → verde
// =====================================================

interface QualityScoreBarProps {
  score: number; // 0-100
  showLabel?: boolean;
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

export function QualityScoreBar({
  score,
  showLabel = true,
  size = 'md',
  className,
}: QualityScoreBarProps) {
  // Clamp score entre 0 y 100
  const clampedScore = Math.min(100, Math.max(0, score));
  
  // Determinar color basado en el score
  const getScoreColor = (value: number) => {
    if (value < 40) return 'text-red-400';
    if (value < 70) return 'text-amber-400';
    return 'text-green-400';
  };
  
  const getScoreLabel = (value: number) => {
    if (value < 40) return 'Necesita mejorar';
    if (value < 70) return 'En progreso';
    if (value < 90) return 'Bueno';
    return 'Excelente';
  };
  
  const heights = {
    sm: 'h-2',
    md: 'h-3',
    lg: 'h-4',
  };
  
  return (
    <div className={cn('w-full', className)}>
      {showLabel && (
        <div className="flex items-center justify-between mb-1">
          <span className="text-xs text-slate-400">{getScoreLabel(clampedScore)}</span>
          <span className={cn('text-sm font-semibold', getScoreColor(clampedScore))}>
            {clampedScore}%
          </span>
        </div>
      )}
      
      <div className={cn('relative rounded-full overflow-hidden', heights[size])}>
        {/* Fondo con gradiente */}
        <div 
          className="absolute inset-0"
          style={{
            background: 'linear-gradient(to right, rgb(239 68 68), rgb(245 158 11), rgb(34 197 94))',
          }}
        />
        
        {/* Overlay oscuro sobre la parte no alcanzada */}
        <div 
          className="absolute inset-0 bg-slate-800/80 transition-all duration-500"
          style={{
            left: `${clampedScore}%`,
          }}
        />
        
        {/* Indicador de posición */}
        <div 
          className="absolute top-0 w-1 h-full bg-white rounded shadow-lg transition-all duration-500"
          style={{
            left: `calc(${clampedScore}% - 2px)`,
          }}
        />
      </div>
    </div>
  );
}

// =====================================================
// SCORE BADGE
// Badge circular con color según score
// =====================================================

interface ScoreBadgeProps {
  score: number;
  size?: 'sm' | 'md' | 'lg';
  showPercentage?: boolean;
}

export function ScoreBadge({
  score,
  size = 'md',
  showPercentage = true,
}: ScoreBadgeProps) {
  const clampedScore = Math.min(100, Math.max(0, score));
  
  const getScoreStyles = (value: number) => {
    if (value < 40) return 'bg-red-500/20 text-red-400 border-red-500/30';
    if (value < 70) return 'bg-amber-500/20 text-amber-400 border-amber-500/30';
    return 'bg-green-500/20 text-green-400 border-green-500/30';
  };
  
  const sizes = {
    sm: 'w-10 h-10 text-xs',
    md: 'w-14 h-14 text-sm',
    lg: 'w-20 h-20 text-lg',
  };
  
  return (
    <div
      className={cn(
        'rounded-full border-2 flex items-center justify-center font-bold',
        getScoreStyles(clampedScore),
        sizes[size]
      )}
    >
      {showPercentage ? `${Math.round(clampedScore)}` : clampedScore >= 70 ? '✓' : '!'}
    </div>
  );
}

// =====================================================
// QUALITY FEEDBACK CARD
// Card para mostrar feedback de calidad
// =====================================================

interface QualityFeedbackCardProps {
  score: number;
  feedback?: string;
  evaluatedBy?: string;
  evaluatedAt?: string;
  className?: string;
}

export function QualityFeedbackCard({
  score,
  feedback,
  evaluatedBy,
  evaluatedAt,
  className,
}: QualityFeedbackCardProps) {
  const getScoreStyles = (value: number) => {
    if (value < 40) return 'border-red-500/30 bg-red-500/5';
    if (value < 70) return 'border-amber-500/30 bg-amber-500/5';
    return 'border-green-500/30 bg-green-500/5';
  };
  
  return (
    <div className={cn('rounded-lg border p-4', getScoreStyles(score), className)}>
      <div className="flex items-start gap-4">
        <ScoreBadge score={score} size="md" />
        
        <div className="flex-1 min-w-0">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-white">
              Evaluación de Calidad
            </span>
            {evaluatedAt && (
              <span className="text-xs text-slate-500">
                {new Date(evaluatedAt).toLocaleDateString('es-ES')}
              </span>
            )}
          </div>
          
          <QualityScoreBar score={score} showLabel={false} size="sm" />
          
          {feedback && (
            <p className="mt-3 text-sm text-slate-300">{feedback}</p>
          )}
          
          {evaluatedBy && (
            <p className="mt-2 text-xs text-slate-500">
              Evaluado por: {evaluatedBy}
            </p>
          )}
        </div>
      </div>
    </div>
  );
}

// =====================================================
// MINI QUALITY INDICATOR
// Indicador pequeño para tablas/listas
// =====================================================

interface MiniQualityIndicatorProps {
  score: number;
  className?: string;
}

export function MiniQualityIndicator({ score, className }: MiniQualityIndicatorProps) {
  const getColor = (value: number) => {
    if (value < 40) return 'bg-red-500';
    if (value < 70) return 'bg-amber-500';
    return 'bg-green-500';
  };
  
  return (
    <div className={cn('flex items-center gap-2', className)}>
      <div className={cn('w-2 h-2 rounded-full', getColor(score))} />
      <span className="text-sm text-slate-300">{score}%</span>
    </div>
  );
}

// =====================================================
// EXPORTS
// =====================================================

export default QualityScoreBar;
</file>

<file path="gtc-sprint-permisos-perfil-azul/src/components/profile/AssistantProfileForm.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import {
  User,
  Mail,
  Phone,
  Globe,
  Clock,
  Building2,
  Briefcase,
  Calendar,
  Target,
  Save,
  Plus,
  Trash2,
  CheckCircle2,
  AlertCircle,
} from 'lucide-react';

import { Button } from '@/components/ui/button';
import { createClient } from '@/lib/supabase/client';
import { cn } from '@/lib/utils';
import type { 
  Assistant, 
  AssistantType, 
  ContractType,
  WeeklyObjective,
  MonthlyObjective,
} from '@/types/database.types';
import { 
  ASSISTANT_TYPE_LABELS, 
  CONTRACT_TYPE_LABELS 
} from '@/types/database.types';

// =====================================================
// TIPOS
// =====================================================

interface ProfileFormData {
  full_name: string;
  email: string;
  phone: string;
  country: string;
  timezone: string;
  assistant_type: AssistantType | '';
  contract_type: ContractType;
  work_schedule: string;
  start_date: string;
  skills: string[];
  languages: string[];
  weekly_objectives: WeeklyObjective[];
  monthly_objectives: MonthlyObjective[];
}

interface AssistantProfileFormProps {
  assistantId: string;
  initialData?: Partial<Assistant>;
  clientName?: string;
}

// =====================================================
// CONSTANTES
// =====================================================

const TIMEZONES = [
  { value: 'America/New_York', label: 'Nueva York (EST)' },
  { value: 'America/Chicago', label: 'Chicago (CST)' },
  { value: 'America/Denver', label: 'Denver (MST)' },
  { value: 'America/Los_Angeles', label: 'Los Angeles (PST)' },
  { value: 'America/Mexico_City', label: 'Ciudad de México' },
  { value: 'America/Bogota', label: 'Bogotá' },
  { value: 'America/Lima', label: 'Lima' },
  { value: 'America/Santiago', label: 'Santiago' },
  { value: 'America/Buenos_Aires', label: 'Buenos Aires' },
  { value: 'America/Sao_Paulo', label: 'São Paulo' },
  { value: 'Europe/Madrid', label: 'Madrid' },
  { value: 'Europe/London', label: 'Londres' },
];

const PRIORITY_OPTIONS = [
  { value: 'alta', label: 'Alta', color: 'text-red-400' },
  { value: 'media', label: 'Media', color: 'text-amber-400' },
  { value: 'baja', label: 'Baja', color: 'text-blue-400' },
];

const STATUS_OPTIONS = [
  { value: 'pendiente', label: 'Pendiente', color: 'bg-slate-500' },
  { value: 'en_progreso', label: 'En progreso', color: 'bg-amber-500' },
  { value: 'completado', label: 'Completado', color: 'bg-green-500' },
];

// =====================================================
// COMPONENTE PRINCIPAL
// =====================================================

export function AssistantProfileForm({
  assistantId,
  initialData,
  clientName,
}: AssistantProfileFormProps) {
  const router = useRouter();
  const supabase = createClient();
  
  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);
  
  const [formData, setFormData] = useState<ProfileFormData>({
    full_name: initialData?.full_name || '',
    email: initialData?.email || '',
    phone: initialData?.phone || '',
    country: initialData?.country || '',
    timezone: initialData?.timezone || 'America/New_York',
    assistant_type: initialData?.assistant_type || '',
    contract_type: initialData?.contract_type || 'tiempo_completo',
    work_schedule: initialData?.work_schedule || '10:30-19:30',
    start_date: initialData?.start_date || '',
    skills: initialData?.skills || [],
    languages: initialData?.languages || [],
    weekly_objectives: initialData?.weekly_objectives || [],
    monthly_objectives: initialData?.monthly_objectives || [],
  });

  const [newSkill, setNewSkill] = useState('');
  const [newLanguage, setNewLanguage] = useState('');

  // ===== HANDLERS =====
  
  const handleChange = (field: keyof ProfileFormData) => (
    e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>
  ) => {
    setFormData((prev) => ({
      ...prev,
      [field]: e.target.value,
    }));
  };

  const addSkill = () => {
    if (newSkill.trim() && !formData.skills.includes(newSkill.trim())) {
      setFormData((prev) => ({
        ...prev,
        skills: [...prev.skills, newSkill.trim()],
      }));
      setNewSkill('');
    }
  };

  const removeSkill = (skill: string) => {
    setFormData((prev) => ({
      ...prev,
      skills: prev.skills.filter((s) => s !== skill),
    }));
  };

  const addLanguage = () => {
    if (newLanguage.trim() && !formData.languages.includes(newLanguage.trim())) {
      setFormData((prev) => ({
        ...prev,
        languages: [...prev.languages, newLanguage.trim()],
      }));
      setNewLanguage('');
    }
  };

  const removeLanguage = (lang: string) => {
    setFormData((prev) => ({
      ...prev,
      languages: prev.languages.filter((l) => l !== lang),
    }));
  };

  // ===== OBJETIVOS SEMANALES =====
  
  const addWeeklyObjective = () => {
    const newObjective: WeeklyObjective = {
      id: crypto.randomUUID(),
      objective: '',
      description: '',
      key_result: '',
      priority: 'media',
      status: 'pendiente',
      due_date: '',
      comments: '',
    };
    setFormData((prev) => ({
      ...prev,
      weekly_objectives: [...prev.weekly_objectives, newObjective],
    }));
  };

  const updateWeeklyObjective = (id: string, field: keyof WeeklyObjective, value: string) => {
    setFormData((prev) => ({
      ...prev,
      weekly_objectives: prev.weekly_objectives.map((obj) =>
        obj.id === id ? { ...obj, [field]: value } : obj
      ),
    }));
  };

  const removeWeeklyObjective = (id: string) => {
    setFormData((prev) => ({
      ...prev,
      weekly_objectives: prev.weekly_objectives.filter((obj) => obj.id !== id),
    }));
  };

  // ===== OBJETIVOS MENSUALES =====
  
  const addMonthlyObjective = () => {
    const newObjective: MonthlyObjective = {
      id: crypto.randomUUID(),
      objective: '',
      description: '',
      key_result: '',
      progress: 0,
      status: 'pendiente',
    };
    setFormData((prev) => ({
      ...prev,
      monthly_objectives: [...prev.monthly_objectives, newObjective],
    }));
  };

  const updateMonthlyObjective = (id: string, field: keyof MonthlyObjective, value: string | number) => {
    setFormData((prev) => ({
      ...prev,
      monthly_objectives: prev.monthly_objectives.map((obj) =>
        obj.id === id ? { ...obj, [field]: value } : obj
      ),
    }));
  };

  const removeMonthlyObjective = (id: string) => {
    setFormData((prev) => ({
      ...prev,
      monthly_objectives: prev.monthly_objectives.filter((obj) => obj.id !== id),
    }));
  };

  // ===== GUARDAR =====
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSaving(true);
    setMessage(null);

    try {
      const { error } = await supabase
        .from('assistants')
        .update({
          full_name: formData.full_name,
          phone: formData.phone || null,
          country: formData.country || null,
          timezone: formData.timezone,
          assistant_type: formData.assistant_type || null,
          contract_type: formData.contract_type,
          work_schedule: formData.work_schedule,
          start_date: formData.start_date || null,
          skills: formData.skills,
          languages: formData.languages,
          weekly_objectives: formData.weekly_objectives,
          monthly_objectives: formData.monthly_objectives,
          updated_at: new Date().toISOString(),
        })
        .eq('id', assistantId);

      if (error) throw error;

      setMessage({ type: 'success', text: 'Perfil actualizado correctamente' });
      
      // Limpiar mensaje después de 3 segundos
      setTimeout(() => setMessage(null), 3000);
    } catch (error) {
      console.error('Error saving profile:', error);
      setMessage({ type: 'error', text: 'Error al guardar el perfil' });
    } finally {
      setIsSaving(false);
    }
  };

  // ===== RENDER =====
  
  return (
    <form onSubmit={handleSubmit} className="space-y-8">
      {/* Mensaje de estado */}
      {message && (
        <div
          className={cn(
            'flex items-center gap-2 rounded-lg p-4',
            message.type === 'success' ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'
          )}
        >
          {message.type === 'success' ? (
            <CheckCircle2 className="h-5 w-5" />
          ) : (
            <AlertCircle className="h-5 w-5" />
          )}
          <span>{message.text}</span>
        </div>
      )}

      {/* ===== DATOS PERSONALES ===== */}
      <section className="card">
        <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <User className="h-5 w-5 text-blue-400" />
          Datos Personales
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="label">Nombre completo *</label>
            <input
              type="text"
              value={formData.full_name}
              onChange={handleChange('full_name')}
              className="input"
              required
            />
          </div>
          
          <div>
            <label className="label">Email</label>
            <input
              type="email"
              value={formData.email}
              className="input bg-slate-800/50"
              disabled
            />
          </div>
          
          <div>
            <label className="label">Teléfono</label>
            <input
              type="tel"
              value={formData.phone}
              onChange={handleChange('phone')}
              className="input"
              placeholder="+1 234 567 8900"
            />
          </div>
          
          <div>
            <label className="label">País</label>
            <input
              type="text"
              value={formData.country}
              onChange={handleChange('country')}
              className="input"
              placeholder="Venezuela, Colombia, México..."
            />
          </div>
          
          <div>
            <label className="label">Zona horaria</label>
            <select
              value={formData.timezone}
              onChange={handleChange('timezone')}
              className="select"
            >
              {TIMEZONES.map((tz) => (
                <option key={tz.value} value={tz.value}>
                  {tz.label}
                </option>
              ))}
            </select>
          </div>
        </div>
      </section>

      {/* ===== DATOS LABORALES ===== */}
      <section className="card">
        <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <Briefcase className="h-5 w-5 text-blue-400" />
          Datos Laborales
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {clientName && (
            <div>
              <label className="label">Cliente asignado</label>
              <div className="input bg-slate-800/50 flex items-center gap-2">
                <Building2 className="h-4 w-4 text-slate-400" />
                <span>{clientName}</span>
              </div>
            </div>
          )}
          
          <div>
            <label className="label">Tipo de asistente</label>
            <select
              value={formData.assistant_type}
              onChange={handleChange('assistant_type')}
              className="select"
            >
              <option value="">Seleccionar...</option>
              {Object.entries(ASSISTANT_TYPE_LABELS).map(([value, label]) => (
                <option key={value} value={value}>
                  {label}
                </option>
              ))}
            </select>
          </div>
          
          <div>
            <label className="label">Tipo de contrato</label>
            <select
              value={formData.contract_type}
              onChange={handleChange('contract_type')}
              className="select"
            >
              {Object.entries(CONTRACT_TYPE_LABELS).map(([value, label]) => (
                <option key={value} value={value}>
                  {label}
                </option>
              ))}
            </select>
          </div>
          
          <div>
            <label className="label">Horario de trabajo</label>
            <input
              type="text"
              value={formData.work_schedule}
              onChange={handleChange('work_schedule')}
              className="input"
              placeholder="10:30-19:30"
            />
          </div>
          
          <div>
            <label className="label">Fecha de inicio</label>
            <input
              type="date"
              value={formData.start_date}
              onChange={handleChange('start_date')}
              className="input"
            />
          </div>
        </div>
      </section>

      {/* ===== HABILIDADES ===== */}
      <section className="card">
        <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <Target className="h-5 w-5 text-blue-400" />
          Habilidades e Idiomas
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Skills */}
          <div>
            <label className="label">Habilidades técnicas</label>
            <div className="flex gap-2 mb-2">
              <input
                type="text"
                value={newSkill}
                onChange={(e) => setNewSkill(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addSkill())}
                className="input flex-1"
                placeholder="Ej: Excel avanzado, n8n, React..."
              />
              <Button type="button" onClick={addSkill} className="btn-primary">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
            <div className="flex flex-wrap gap-2">
              {formData.skills.map((skill) => (
                <span
                  key={skill}
                  className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 text-sm"
                >
                  {skill}
                  <button
                    type="button"
                    onClick={() => removeSkill(skill)}
                    className="hover:text-red-400"
                  >
                    <Trash2 className="h-3 w-3" />
                  </button>
                </span>
              ))}
            </div>
          </div>
          
          {/* Languages */}
          <div>
            <label className="label">Idiomas</label>
            <div className="flex gap-2 mb-2">
              <input
                type="text"
                value={newLanguage}
                onChange={(e) => setNewLanguage(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addLanguage())}
                className="input flex-1"
                placeholder="Ej: Español nativo, Inglés B2..."
              />
              <Button type="button" onClick={addLanguage} className="btn-primary">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
            <div className="flex flex-wrap gap-2">
              {formData.languages.map((lang) => (
                <span
                  key={lang}
                  className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-400 text-sm"
                >
                  {lang}
                  <button
                    type="button"
                    onClick={() => removeLanguage(lang)}
                    className="hover:text-red-400"
                  >
                    <Trash2 className="h-3 w-3" />
                  </button>
                </span>
              ))}
            </div>
          </div>
        </div>
      </section>

      {/* ===== OBJETIVOS SEMANALES ===== */}
      <section className="card">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold text-white flex items-center gap-2">
            <Calendar className="h-5 w-5 text-blue-400" />
            Objetivos Semanales (PLAN_GTC)
          </h2>
          <Button type="button" onClick={addWeeklyObjective} className="btn-outline">
            <Plus className="h-4 w-4 mr-2" />
            Agregar objetivo
          </Button>
        </div>
        
        <div className="space-y-4">
          {formData.weekly_objectives.length === 0 ? (
            <p className="text-slate-500 text-center py-8">
              No hay objetivos semanales. Haz clic en "Agregar objetivo" para comenzar.
            </p>
          ) : (
            formData.weekly_objectives.map((obj, index) => (
              <div key={obj.id} className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                <div className="flex items-start justify-between mb-3">
                  <span className="text-xs text-slate-500">Objetivo #{index + 1}</span>
                  <button
                    type="button"
                    onClick={() => removeWeeklyObjective(obj.id)}
                    className="text-slate-500 hover:text-red-400"
                  >
                    <Trash2 className="h-4 w-4" />
                  </button>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="md:col-span-2">
                    <input
                      type="text"
                      value={obj.objective}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'objective', e.target.value)}
                      className="input"
                      placeholder="Título del objetivo"
                    />
                  </div>
                  
                  <div className="md:col-span-2">
                    <textarea
                      value={obj.description}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'description', e.target.value)}
                      className="input min-h-[80px]"
                      placeholder="Descripción detallada..."
                    />
                  </div>
                  
                  <div>
                    <input
                      type="text"
                      value={obj.key_result}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'key_result', e.target.value)}
                      className="input"
                      placeholder="Resultado clave esperado"
                    />
                  </div>
                  
                  <div className="flex gap-2">
                    <select
                      value={obj.priority}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'priority', e.target.value)}
                      className="select flex-1"
                    >
                      {PRIORITY_OPTIONS.map((opt) => (
                        <option key={opt.value} value={opt.value}>
                          {opt.label}
                        </option>
                      ))}
                    </select>
                    
                    <select
                      value={obj.status}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'status', e.target.value)}
                      className="select flex-1"
                    >
                      {STATUS_OPTIONS.map((opt) => (
                        <option key={opt.value} value={opt.value}>
                          {opt.label}
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <input
                      type="date"
                      value={obj.due_date}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'due_date', e.target.value)}
                      className="input"
                    />
                  </div>
                  
                  <div>
                    <input
                      type="text"
                      value={obj.comments}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'comments', e.target.value)}
                      className="input"
                      placeholder="Comentarios..."
                    />
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
      </section>

      {/* ===== OBJETIVOS MENSUALES ===== */}
      <section className="card">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold text-white flex items-center gap-2">
            <Target className="h-5 w-5 text-blue-400" />
            Objetivos Mensuales
          </h2>
          <Button type="button" onClick={addMonthlyObjective} className="btn-outline">
            <Plus className="h-4 w-4 mr-2" />
            Agregar objetivo
          </Button>
        </div>
        
        <div className="space-y-4">
          {formData.monthly_objectives.length === 0 ? (
            <p className="text-slate-500 text-center py-8">
              No hay objetivos mensuales definidos.
            </p>
          ) : (
            formData.monthly_objectives.map((obj, index) => (
              <div key={obj.id} className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                <div className="flex items-start justify-between mb-3">
                  <span className="text-xs text-slate-500">Objetivo mensual #{index + 1}</span>
                  <button
                    type="button"
                    onClick={() => removeMonthlyObjective(obj.id)}
                    className="text-slate-500 hover:text-red-400"
                  >
                    <Trash2 className="h-4 w-4" />
                  </button>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="md:col-span-2">
                    <input
                      type="text"
                      value={obj.objective}
                      onChange={(e) => updateMonthlyObjective(obj.id, 'objective', e.target.value)}
                      className="input"
                      placeholder="Título del objetivo"
                    />
                  </div>
                  
                  <div className="md:col-span-2">
                    <textarea
                      value={obj.description}
                      onChange={(e) => updateMonthlyObjective(obj.id, 'description', e.target.value)}
                      className="input min-h-[80px]"
                      placeholder="Descripción..."
                    />
                  </div>
                  
                  <div>
                    <input
                      type="text"
                      value={obj.key_result}
                      onChange={(e) => updateMonthlyObjective(obj.id, 'key_result', e.target.value)}
                      className="input"
                      placeholder="Resultado clave"
                    />
                  </div>
                  
                  <div>
                    <label className="label text-xs">Progreso: {obj.progress}%</label>
                    <input
                      type="range"
                      min="0"
                      max="100"
                      value={obj.progress}
                      onChange={(e) => updateMonthlyObjective(obj.id, 'progress', parseInt(e.target.value))}
                      className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                    />
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
      </section>

      {/* ===== BOTÓN GUARDAR ===== */}
      <div className="flex justify-end">
        <Button type="submit" disabled={isSaving} className="btn-primary">
          {isSaving ? (
            <>
              <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent mr-2" />
              Guardando...
            </>
          ) : (
            <>
              <Save className="h-4 w-4 mr-2" />
              Guardar cambios
            </>
          )}
        </Button>
      </div>
    </form>
  );
}

export default AssistantProfileForm;
</file>

<file path="gtc-sprint-permisos-perfil-azul/src/components/shared/Sidebar.tsx">
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useState } from 'react';
import {
  LayoutDashboard,
  FileText,
  Users,
  Calendar,
  Settings,
  ChevronLeft,
  ChevronRight,
  ClipboardCheck,
  BarChart3,
  Briefcase,
  UserCheck,
  Search,
  Target,
  TrendingUp,
  Mic,
  UserPlus,
  Building2,
} from 'lucide-react';

import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type { 
  UserRole, 
  UserDepartment, 
  UserPosition,
  PermissionConfig 
} from '@/types/database.types';
import { hasAccess, mapRoleToDepartment } from '@/types/database.types';

// =====================================================
// CONFIGURACIÓN DE NAVEGACIÓN
// =====================================================

interface NavItem {
  label: string;
  href: string;
  icon: React.ElementType;
  permissions: PermissionConfig;
  badge?: number;
  isNew?: boolean;
}

interface NavSection {
  title: string;
  items: NavItem[];
}

const navSections: NavSection[] = [
  {
    title: 'General',
    items: [
      {
        label: 'Dashboard',
        href: '/dashboard',
        icon: LayoutDashboard,
        permissions: {
          departments: ['c_level', 'finance', 'sales', 'hr', 'quality', 'marketing', 'automation', 'development', 'operations'],
        },
      },
      {
        label: 'Mis Reportes',
        href: '/reportes',
        icon: FileText,
        permissions: {
          departments: ['c_level', 'finance', 'sales', 'hr', 'quality', 'marketing', 'automation', 'development', 'operations'],
        },
      },
      {
        label: 'Mi Perfil',
        href: '/perfil',
        icon: UserPlus,
        permissions: {
          departments: ['c_level', 'finance', 'sales', 'hr', 'quality', 'marketing', 'automation', 'development', 'operations'],
        },
      },
      {
        label: 'Calendario',
        href: '/calendario',
        icon: Calendar,
        permissions: {
          departments: ['c_level', 'finance', 'sales', 'hr', 'quality', 'marketing', 'automation', 'development', 'operations'],
        },
      },
    ],
  },
  {
    title: 'Calidad',
    items: [
      {
        label: 'Gestión Reportes',
        href: '/calidad/reportes',
        icon: ClipboardCheck,
        permissions: {
          departments: ['c_level', 'quality'],
          positions: ['ceo', 'coo', 'director', 'manager', 'specialist'],
        },
      },
      {
        label: 'Métricas Equipo',
        href: '/calidad/metricas',
        icon: BarChart3,
        permissions: {
          departments: ['c_level', 'quality'],
          positions: ['ceo', 'coo', 'director', 'manager'],
        },
      },
      {
        label: 'Asistentes',
        href: '/asistentes',
        icon: Users,
        permissions: {
          departments: ['c_level', 'quality'],
        },
      },
    ],
  },
  {
    title: 'RRHH',
    items: [
      {
        label: 'Candidatos',
        href: '/candidatos',
        icon: UserCheck,
        permissions: {
          departments: ['c_level', 'hr', 'sales'],
        },
      },
      {
        label: 'Entrevistas',
        href: '/entrevistas',
        icon: Mic,
        permissions: {
          departments: ['c_level', 'hr'],
        },
        isNew: true,
      },
      {
        label: 'Banco Talento',
        href: '/banco-talento',
        icon: Search,
        permissions: {
          departments: ['c_level', 'hr', 'sales'],
        },
      },
    ],
  },
  {
    title: 'Ventas',
    items: [
      {
        label: 'Leads',
        href: '/leads',
        icon: Target,
        permissions: {
          departments: ['c_level', 'sales', 'finance'],
          positions: ['ceo', 'coo', 'director', 'manager'],
        },
      },
      {
        label: 'Clientes',
        href: '/clientes',
        icon: Building2,
        permissions: {
          departments: ['c_level', 'sales', 'finance'],
          positions: ['ceo', 'coo', 'director', 'manager'],
        },
      },
    ],
  },
  {
    title: 'Dirección',
    items: [
      {
        label: 'Panel Ejecutivo',
        href: '/ejecutivo',
        icon: TrendingUp,
        permissions: {
          departments: ['c_level'],
          positions: ['ceo', 'coo'],
        },
      },
      {
        label: 'Calendario Global',
        href: '/calendario-global',
        icon: Calendar,
        permissions: {
          departments: ['c_level'],
          positions: ['ceo', 'coo'],
        },
      },
      {
        label: 'Configuración',
        href: '/configuracion',
        icon: Settings,
        permissions: {
          departments: ['c_level', 'automation'],
          positions: ['ceo', 'coo', 'director'],
        },
      },
    ],
  },
];

// =====================================================
// COMPONENTE SIDEBAR
// =====================================================

interface SidebarProps {
  userRole: UserRole;
  userDepartment?: UserDepartment | null;
  userPosition?: UserPosition | null;
}

export function Sidebar({ 
  userRole, 
  userDepartment, 
  userPosition 
}: SidebarProps) {
  const [collapsed, setCollapsed] = useState(false);
  const pathname = usePathname();

  // Filtrar secciones e items según permisos
  const filteredSections = navSections
    .map((section) => ({
      ...section,
      items: section.items.filter((item) =>
        hasAccess(userDepartment ?? null, userPosition ?? null, userRole, item.permissions)
      ),
    }))
    .filter((section) => section.items.length > 0);

  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          'fixed left-0 top-0 z-40 flex h-screen flex-col border-r border-slate-800 bg-slate-950 transition-all duration-300',
          collapsed ? 'w-16' : 'w-64'
        )}
      >
        {/* Logo */}
        <div className="flex h-16 items-center justify-between border-b border-slate-800 px-4">
          {!collapsed && (
            <Link href="/dashboard" className="flex items-center gap-2">
              <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-500">
                <span className="text-sm font-bold text-white">GT</span>
              </div>
              <span className="text-lg font-semibold text-white">
                Global Talent
              </span>
            </Link>
          )}
          {collapsed && (
            <Link
              href="/dashboard"
              className="mx-auto flex h-8 w-8 items-center justify-center rounded-lg bg-blue-500"
            >
              <span className="text-sm font-bold text-white">GT</span>
            </Link>
          )}
        </div>

        {/* Navegación */}
        <nav className="flex-1 overflow-y-auto p-3 custom-scrollbar">
          {filteredSections.map((section, sectionIndex) => (
            <div key={section.title} className={cn(sectionIndex > 0 && 'mt-6')}>
              {/* Título de sección */}
              {!collapsed && (
                <h3 className="mb-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-500">
                  {section.title}
                </h3>
              )}
              
              {/* Items de la sección */}
              <div className="space-y-1">
                {section.items.map((item) => {
                  const isActive =
                    pathname === item.href || pathname.startsWith(`${item.href}/`);
                  const Icon = item.icon;

                  const linkContent = (
                    <Link
                      href={item.href}
                      className={cn(
                        'sidebar-link',
                        isActive && 'sidebar-link--active',
                        collapsed && 'justify-center px-2'
                      )}
                    >
                      <Icon className="h-5 w-5 shrink-0" />
                      {!collapsed && (
                        <>
                          <span className="flex-1">{item.label}</span>
                          {item.isNew && (
                            <span className="flex h-5 items-center rounded bg-blue-500/20 px-1.5 text-[10px] font-medium text-blue-400">
                              NUEVO
                            </span>
                          )}
                          {item.badge && item.badge > 0 && (
                            <span className="flex h-5 min-w-5 items-center justify-center rounded-full bg-blue-500 px-1.5 text-xs font-medium text-white">
                              {item.badge}
                            </span>
                          )}
                        </>
                      )}
                    </Link>
                  );

                  if (collapsed) {
                    return (
                      <Tooltip key={item.href}>
                        <TooltipTrigger asChild>{linkContent}</TooltipTrigger>
                        <TooltipContent side="right" className="flex items-center gap-2">
                          {item.label}
                          {item.isNew && (
                            <span className="rounded bg-blue-500/20 px-1 text-[10px] font-medium text-blue-400">
                              NUEVO
                            </span>
                          )}
                          {item.badge && item.badge > 0 && (
                            <span className="flex h-5 min-w-5 items-center justify-center rounded-full bg-blue-500 px-1.5 text-xs font-medium text-white">
                              {item.badge}
                            </span>
                          )}
                        </TooltipContent>
                      </Tooltip>
                    );
                  }

                  return <div key={item.href}>{linkContent}</div>;
                })}
              </div>
            </div>
          ))}
        </nav>

        {/* Toggle collapse */}
        <div className="border-t border-slate-800 p-3">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => setCollapsed(!collapsed)}
            className={cn(
              'w-full justify-center text-slate-400 hover:text-white hover:bg-slate-800',
              !collapsed && 'justify-start'
            )}
          >
            {collapsed ? (
              <ChevronRight className="h-4 w-4" />
            ) : (
              <>
                <ChevronLeft className="h-4 w-4 mr-2" />
                <span>Colapsar</span>
              </>
            )}
          </Button>
        </div>
      </aside>
    </TooltipProvider>
  );
}

// =====================================================
// EXPORT POR DEFECTO
// =====================================================

export default Sidebar;
</file>

<file path="gtc-sprint-permisos-perfil-azul/src/types/database.types.ts">
// =====================================================
// src/types/database.types.ts
// TIPOS ACTUALIZADOS CON PERMISOS Y PERFIL COMPLETO
// =====================================================

// =====================================================
// ENUMS DE PERMISOS
// =====================================================

export type UserDepartment = 
  | 'c_level'      // CEO, COO
  | 'finance'      // Antonio
  | 'sales'        // Pilar
  | 'hr'           // Gladymar, Viviana
  | 'quality'      // Norma, Fabiola, Suany
  | 'marketing'    // Jennifer
  | 'automation'   // Ariel, Nelson
  | 'development'  // Javier
  | 'operations';  // Asistentes externos

export type UserPosition = 
  | 'ceo'
  | 'coo'
  | 'director'
  | 'manager'
  | 'specialist'
  | 'assistant';

// Mantener compatibilidad con el sistema anterior
export type UserRole = 'admin' | 'calidad' | 'rrhh' | 'marketing' | 'asistente';

// =====================================================
// TIPO DE ASISTENTE (según Zoho CRM)
// =====================================================

export type AssistantType = 
  | 'gestor_operaciones'
  | 'proyectos_software'
  | 'desarrollo_web'
  | 'comunicaciones'
  | 'financiero_contable'
  | 'marketing_digital'
  | 'administrativo'
  | 'ventas_ecommerce';

export const ASSISTANT_TYPE_LABELS: Record<AssistantType, string> = {
  gestor_operaciones: 'Gestor de Operaciones',
  proyectos_software: 'Proyectos de Software',
  desarrollo_web: 'Desarrollo Web',
  comunicaciones: 'Comunicaciones',
  financiero_contable: 'Financiero y Contable',
  marketing_digital: 'Marketing Digital',
  administrativo: 'Administrativo',
  ventas_ecommerce: 'Ventas / E-commerce',
};

export const ASSISTANT_TYPE_COLORS: Record<AssistantType, string> = {
  gestor_operaciones: 'bg-slate-600',
  proyectos_software: 'bg-gray-500',
  desarrollo_web: 'bg-green-600',
  comunicaciones: 'bg-orange-500',
  financiero_contable: 'bg-yellow-500',
  marketing_digital: 'bg-lime-500',
  administrativo: 'bg-blue-500',
  ventas_ecommerce: 'bg-purple-500',
};

// =====================================================
// TIPOS DE CONTRATO
// =====================================================

export type ContractType = 'tiempo_completo' | 'medio_tiempo' | 'por_proyecto';

export const CONTRACT_TYPE_LABELS: Record<ContractType, string> = {
  tiempo_completo: 'Tiempo Completo (40h)',
  medio_tiempo: 'Medio Tiempo (20h)',
  por_proyecto: 'Por Proyecto',
};

// =====================================================
// PERFIL DE USUARIO
// =====================================================

export interface Profile {
  id: string;
  email: string;
  full_name: string | null;
  role: UserRole;
  department: UserDepartment | null;
  position: UserPosition | null;
  phone: string | null;
  timezone: string;
  country: string | null;
  avatar_url: string | null;
  created_at: string;
  updated_at: string;
}

// =====================================================
// ASISTENTE VIRTUAL (Perfil completo)
// =====================================================

export interface Assistant {
  id: string;
  user_id: string;
  full_name: string;
  email: string;
  phone: string | null;
  status: 'activo' | 'inactivo' | 'vacaciones' | 'baja';
  position: string | null;
  
  // Datos de asignación
  client_id: string | null;
  assistant_type: AssistantType | null;
  
  // Contrato
  contract_type: ContractType;
  work_schedule: string; // "10:30-19:30"
  start_date: string | null;
  
  // Ubicación
  timezone: string;
  country: string | null;
  
  // Objetivos (JSONB)
  weekly_objectives: WeeklyObjective[];
  monthly_objectives: MonthlyObjective[];
  
  // Habilidades
  skills: string[];
  languages: string[];
  
  // Metadata
  created_at: string;
  updated_at: string;
}

export interface WeeklyObjective {
  id: string;
  objective: string;
  description: string;
  key_result: string;
  priority: 'alta' | 'media' | 'baja';
  status: 'pendiente' | 'en_progreso' | 'completado';
  due_date: string;
  comments: string;
}

export interface MonthlyObjective {
  id: string;
  objective: string;
  description: string;
  key_result: string;
  progress: number; // 0-100
  status: 'pendiente' | 'en_progreso' | 'completado';
}

// =====================================================
// ASISTENTE CON RELACIONES
// =====================================================

export interface AssistantWithDetails extends Assistant {
  client?: {
    id: string;
    name: string;
  } | null;
  profile?: Profile | null;
}

// =====================================================
// LEADS (Pipeline de ventas)
// =====================================================

export type LeadStatus = 
  | 'new'
  | 'contacted'
  | 'interested'
  | 'presenting'
  | 'negotiating'
  | 'contract_sent'
  | 'won'
  | 'lost'
  | 'frozen';

export type LeadUrgency = 'low' | 'medium' | 'high' | 'urgent';
export type LeadSource = 'linkedin' | 'referral' | 'website' | 'cold_call' | 'event' | 'other';

export const LEAD_STATUS_LABELS: Record<LeadStatus, string> = {
  new: 'Nuevo',
  contacted: 'Contactado',
  interested: 'Interesado',
  presenting: 'Presentando candidatos',
  negotiating: 'Negociando',
  contract_sent: 'Contrato enviado',
  won: 'Cerrado ganado',
  lost: 'Cerrado perdido',
  frozen: 'Congelado',
};

export const LEAD_STATUS_COLORS: Record<LeadStatus, string> = {
  new: 'bg-blue-500',
  contacted: 'bg-cyan-500',
  interested: 'bg-teal-500',
  presenting: 'bg-emerald-500',
  negotiating: 'bg-yellow-500',
  contract_sent: 'bg-orange-500',
  won: 'bg-green-600',
  lost: 'bg-red-500',
  frozen: 'bg-slate-500',
};

export interface Lead {
  id: string;
  company_name: string;
  contact_name: string | null;
  contact_email: string | null;
  contact_phone: string | null;
  website: string | null;
  linkedin_url: string | null;
  
  assistant_type: AssistantType | null;
  quantity: number;
  budget_min: number | null;
  budget_max: number | null;
  urgency: LeadUrgency;
  notes: string | null;
  
  status: LeadStatus;
  assigned_to: string | null;
  
  presented_candidates: string[];
  
  first_contact_at: string | null;
  last_contact_at: string | null;
  expected_close_date: string | null;
  
  lost_reason: string | null;
  converted_client_id: string | null;
  
  source: LeadSource;
  zoho_lead_id: string | null;
  
  created_at: string;
  updated_at: string;
}

// =====================================================
// CANDIDATOS EN BANCO (listos para asignar)
// =====================================================

export type CandidateBankStatus = 
  | 'available'
  | 'presented'
  | 'interviewing'
  | 'selected'
  | 'contracted'
  | 'unavailable';

export const CANDIDATE_BANK_STATUS_LABELS: Record<CandidateBankStatus, string> = {
  available: 'Disponible',
  presented: 'Presentado',
  interviewing: 'En entrevista',
  selected: 'Seleccionado',
  contracted: 'Contratado',
  unavailable: 'No disponible',
};

export interface AssistantCandidate {
  id: string;
  candidate_id: string | null;
  application_id: string | null;
  
  full_name: string;
  email: string;
  phone: string | null;
  
  assistant_type: AssistantType;
  skills: string[];
  languages: string[];
  
  cv_score: number | null;
  video_score: number | null;
  bot_score: number | null;
  human_interview_score: number | null;
  final_score: number | null;
  
  status: CandidateBankStatus;
  
  current_lead_id: string | null;
  current_client_id: string | null;
  recruiter_id: string | null;
  
  cv_url: string | null;
  video_url: string | null;
  ficha_url: string | null;
  
  zoho_candidate_id: string | null;
  
  created_at: string;
  updated_at: string;
}

// =====================================================
// HELPERS DE PERMISOS
// =====================================================

export interface PermissionConfig {
  departments: UserDepartment[];
  positions?: UserPosition[];
  // 'all' significa que aplica a todos dentro de los departamentos especificados
}

/**
 * Verifica si un usuario tiene acceso basado en departamento y posición
 */
export function hasAccess(
  userDepartment: UserDepartment | null,
  userPosition: UserPosition | null,
  userRole: UserRole,
  config: PermissionConfig
): boolean {
  // Admin siempre tiene acceso
  if (userRole === 'admin') return true;
  
  // Si no tiene departamento asignado, usar el mapeo de role
  const effectiveDepartment = userDepartment || mapRoleToDepartment(userRole);
  
  // Verificar departamento
  if (!config.departments.includes(effectiveDepartment)) {
    return false;
  }
  
  // Si no se especifican posiciones, cualquier posición del departamento tiene acceso
  if (!config.positions || config.positions.length === 0) {
    return true;
  }
  
  // Verificar posición
  const effectivePosition = userPosition || 'assistant';
  return config.positions.includes(effectivePosition);
}

/**
 * Mapea roles legacy a departamentos
 */
export function mapRoleToDepartment(role: UserRole): UserDepartment {
  const mapping: Record<UserRole, UserDepartment> = {
    admin: 'c_level',
    calidad: 'quality',
    rrhh: 'hr',
    marketing: 'marketing',
    asistente: 'operations',
  };
  return mapping[role];
}

/**
 * Obtiene el label del departamento
 */
export const DEPARTMENT_LABELS: Record<UserDepartment, string> = {
  c_level: 'Dirección',
  finance: 'Finanzas',
  sales: 'Ventas',
  hr: 'Recursos Humanos',
  quality: 'Calidad',
  marketing: 'Marketing',
  automation: 'Automatización',
  development: 'Desarrollo',
  operations: 'Operaciones',
};

/**
 * Obtiene el label de la posición
 */
export const POSITION_LABELS: Record<UserPosition, string> = {
  ceo: 'CEO',
  coo: 'COO',
  director: 'Director',
  manager: 'Manager',
  specialist: 'Especialista',
  assistant: 'Asistente',
};

// =====================================================
// TIPOS DE BASE DE DATOS (para Supabase)
// =====================================================

export interface Database {
  public: {
    Tables: {
      profiles: {
        Row: Profile;
        Insert: Omit<Profile, 'created_at' | 'updated_at'>;
        Update: Partial<Omit<Profile, 'id' | 'created_at'>>;
      };
      assistants: {
        Row: Assistant;
        Insert: Omit<Assistant, 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Omit<Assistant, 'id' | 'created_at'>>;
      };
      leads: {
        Row: Lead;
        Insert: Omit<Lead, 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Omit<Lead, 'id' | 'created_at'>>;
      };
      assistant_candidates: {
        Row: AssistantCandidate;
        Insert: Omit<AssistantCandidate, 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Omit<AssistantCandidate, 'id' | 'created_at'>>;
      };
      // ... mantener las otras tablas existentes
    };
  };
}
</file>

<file path="GUIA-PRUEBAS.md">
# 🧪 Guía de Pruebas - Módulo de Entrevistas

## 📋 Índice
1. [Probar Endpoints GET en el Navegador](#1-probar-endpoints-get-en-el-navegador)
2. [Verificar Tablas y Funciones en Supabase](#2-verificar-tablas-y-funciones-en-supabase)
3. [Crear Datos de Prueba](#3-crear-datos-de-prueba)
4. [Probar POST con API Key](#4-probar-post-con-api-key)

---

## 1. Probar Endpoints GET en el Navegador

### ✅ Paso 1: Asegúrate de que el servidor esté corriendo

Abre una terminal y ejecuta:
```bash
cd "/Users/arielemilianojimenez/Downloads/global-talent-platform 2"
npm run dev
```

Deberías ver algo como:
```
▲ Next.js 14.2.35
- Local:        http://localhost:3000
✓ Ready in 2.3s
```

### ✅ Paso 2: Abrir el navegador

Abre tu navegador (Chrome, Firefox, Safari, etc.)

### ✅ Paso 3: Probar el endpoint `/api/interviews/create`

1. **Copia esta URL y pégala en la barra de direcciones:**
   ```
   http://localhost:3000/api/interviews/create
   ```

2. **Presiona Enter**

3. **Resultado esperado:**
   Deberías ver un JSON como este:
   ```json
   {
     "status": "ok",
     "endpoint": "/api/interviews/create",
     "method": "POST",
     "description": "Crear una nueva entrevista para un candidato",
     "required_headers": {
       "Authorization": "Bearer {API_KEY}",
       "Content-Type": "application/json"
     },
     "body_schema": {
       "email": "string (required)",
       "candidate_name": "string (required)",
       "job_position_id": "uuid (required)",
       ...
     }
   }
   ```

   ✅ **Si ves esto, el endpoint funciona correctamente**

### ✅ Paso 4: Probar el endpoint `/api/interviews/webhook`

1. **Copia esta URL:**
   ```
   http://localhost:3000/api/interviews/webhook
   ```

2. **Pégala en la barra de direcciones y presiona Enter**

3. **Resultado esperado:**
   ```json
   {
     "status": "ok",
     "endpoint": "/api/interviews/webhook",
     "description": "Webhook para eventos de ElevenLabs"
   }
   ```

   ✅ **Si ves esto, el endpoint funciona correctamente**

---

## 2. Verificar Tablas y Funciones en Supabase

### ✅ Paso 1: Abrir Supabase

1. Ve a [https://supabase.com](https://supabase.com)
2. Inicia sesión en tu cuenta
3. Selecciona tu proyecto: `hxnnettudbgprzprrmdp`

### ✅ Paso 2: Abrir SQL Editor

1. En el menú lateral izquierdo, haz clic en **"SQL Editor"**
2. Haz clic en **"New query"** (Nueva consulta)

### ✅ Paso 3: Ejecutar Script de Verificación

1. **Abre el archivo `verificar-supabase.sql`** en tu editor de código
2. **Copia TODO el contenido** del archivo
3. **Pégalo en el SQL Editor de Supabase**
4. **Haz clic en "Run"** (o presiona `Ctrl+Enter` / `Cmd+Enter`)

### ✅ Paso 4: Revisar los Resultados

Deberías ver varios resultados:

#### Resultado 1: Columnas de `clients`
- ✅ Debe mostrar `name` y `company_name`

#### Resultado 2: Tablas nuevas
- ✅ Debe mostrar: `job_positions`, `applications`, `interviews`, `candidates`

#### Resultado 3: Funciones
- ✅ Debe mostrar: `validate_interview_token`, `start_interview`, `complete_interview`

#### Resultado 4: Estructura de tablas
- ✅ Debe mostrar todas las columnas de cada tabla

#### Resultado 5: Constraints
- ✅ Debe mostrar foreign keys y checks

#### Resultado 6: Conteo de registros
- ✅ Muestra cuántos registros hay en cada tabla

**Si todos los resultados muestran datos, ¡todo está correcto! ✅**

---

## 3. Crear Datos de Prueba

### ✅ Paso 1: Ejecutar Script de Datos de Prueba

1. En Supabase SQL Editor, crea una **nueva query**
2. **Abre el archivo `datos-prueba.sql`** en tu editor
3. **Copia TODO el contenido**
4. **Pégalo en el SQL Editor de Supabase**
5. **Haz clic en "Run"**

### ✅ Paso 2: Obtener el Job Position ID

Después de ejecutar el script, deberías ver un resultado con:
- Un cliente llamado "Empresa de Prueba"
- Un job position llamado "Desarrollador Full Stack - Prueba"

**IMPORTANTE:** Copia el `id` del job position (es un UUID como: `a1b2c3d4-e5f6-7890-abcd-ef1234567890`)

Este ID lo necesitarás para probar el POST.

### ✅ Paso 3: Verificar que se crearon

Ejecuta esta query en Supabase para ver los datos:

```sql
SELECT 
  jp.id,
  jp.title,
  jp.status,
  c.name as client_name
FROM job_positions jp
JOIN clients c ON jp.client_id = c.id
WHERE c.name = 'Empresa de Prueba'
ORDER BY jp.created_at DESC;
```

---

## 4. Probar POST con API Key

### Opción A: Usar Terminal (Recomendado)

1. **Abre una terminal nueva** (no la del servidor)

2. **Ejecuta este comando** (reemplaza `TU_JOB_POSITION_ID` con el ID que copiaste):

```bash
curl -X POST http://localhost:3000/api/interviews/create \
  -H "Authorization: Bearer 48d5e45849279a48ccd37c0a98523f0c02e1ffcc61089d3f541dc4ce41bfd858" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "candidato@example.com",
    "candidate_name": "María García",
    "job_position_id": "TU_JOB_POSITION_ID"
  }'
```

3. **Resultado esperado:**
```json
{
  "success": true,
  "data": {
    "interview_id": "...",
    "candidate_id": "...",
    "application_id": "...",
    "token": "...",
    "link": "http://localhost:3000/entrevista/...",
    "expires_at": "..."
  }
}
```

✅ **Si ves esto, el POST funciona correctamente**

### Opción B: Usar Postman

1. **Abre Postman** (si lo tienes instalado)
2. **Crea una nueva request:**
   - Método: `POST`
   - URL: `http://localhost:3000/api/interviews/create`
3. **En la pestaña "Headers", agrega:**
   - Key: `Authorization`
   - Value: `Bearer 48d5e45849279a48ccd37c0a98523f0c02e1ffcc61089d3f541dc4ce41bfd858`
   - Key: `Content-Type`
   - Value: `application/json`
4. **En la pestaña "Body", selecciona "raw" y "JSON", luego pega:**
```json
{
  "email": "candidato@example.com",
  "candidate_name": "María García",
  "job_position_id": "TU_JOB_POSITION_ID"
}
```
5. **Haz clic en "Send"**

### Opción C: Usar el Navegador (Solo para GET)

⚠️ **Nota:** Los navegadores solo pueden hacer GET. Para POST necesitas usar curl o Postman.

---

## 🎯 Checklist Final

Marca cada paso cuando lo completes:

- [ ] Servidor inicia sin errores (`npm run dev`)
- [ ] Endpoint GET `/api/interviews/create` responde en el navegador
- [ ] Endpoint GET `/api/interviews/webhook` responde en el navegador
- [ ] Script de verificación ejecutado en Supabase
- [ ] Todas las tablas existen (job_positions, applications, interviews, candidates)
- [ ] Todas las funciones existen (validate_interview_token, start_interview, complete_interview)
- [ ] Script de datos de prueba ejecutado
- [ ] Job position de prueba creado
- [ ] POST `/api/interviews/create` funciona con curl o Postman
- [ ] Se creó una entrevista exitosamente

---

## 🐛 Problemas Comunes

### El servidor no inicia
- Verifica que el puerto 3000 no esté ocupado
- Revisa que todas las dependencias estén instaladas: `npm install`

### Los endpoints no responden
- Asegúrate de que el servidor esté corriendo
- Verifica que la URL sea exactamente `http://localhost:3000/api/interviews/create`

### Error en Supabase: "relation does not exist"
- Ejecuta primero el script de migración completo (`migration-interviews-module.sql`)

### Error en POST: "Puesto de trabajo no encontrado"
- Verifica que el `job_position_id` sea correcto
- Asegúrate de que el job position tenga `status = 'open'`

---

## 📞 Siguiente Paso

Una vez que todo funcione, puedes:
1. Probar abrir el link de la entrevista en el navegador
2. Verificar que se creó el candidato y la aplicación en Supabase
3. Integrar con n8n usando el endpoint `/api/interviews/create`

¡Éxito! 🚀
</file>

<file path="MIGRACION-COMPLETA.md">
# 📋 Guía de Migración - Módulo de Entrevistas

## ✅ Lo que ya está hecho

### 1. Script de Migración SQL
📁 Archivo: `migration-interviews-module.sql`

Este script:
- ✅ Agrega la columna `name` a la tabla `clients` (si no existe)
- ✅ Copia los datos de `company_name` a `name` automáticamente
- ✅ Agrega nuevas columnas necesarias (`legal_name`, `tax_id`, `logo_url`, etc.)
- ✅ Crea las nuevas tablas: `job_positions`, `applications`, `interviews`
- ✅ Actualiza la tabla `candidates` con columnas faltantes
- ✅ Configura Row Level Security (RLS) en todas las nuevas tablas
- ✅ Crea funciones de base de datos para validar tokens
- ✅ Crea vistas útiles para el dashboard

**Características importantes:**
- 🔒 **Seguro**: Verifica si las columnas/tablas existen antes de crearlas
- 🔄 **Idempotente**: Puedes ejecutarlo múltiples veces sin problemas
- 🔀 **Compatible**: Mantiene `company_name` para no romper código existente

### 2. Middleware Actualizado
📁 Archivo: `src/middleware.ts`

**Cambios realizados:**
- ✅ Agregada ruta pública `/entrevista/*` (candidatos pueden entrar sin login)
- ✅ Agregadas rutas de API públicas para webhooks (`/api/interviews/*`)
- ✅ Agregada protección de rol para `/entrevistas` (dashboard)
- ✅ Optimización: verifica rutas de API públicas antes de crear cliente Supabase

## 🚀 Pasos para completar la instalación

### PASO 1: Ejecutar la migración en Supabase

1. Abre tu proyecto en [Supabase Dashboard](https://supabase.com/dashboard)
2. Ve a **SQL Editor** (menú lateral izquierdo)
3. Abre el archivo `migration-interviews-module.sql` en tu editor
4. Copia **TODO** el contenido del archivo
5. Pégalo en el SQL Editor de Supabase
6. Haz clic en **Run** (o presiona `Ctrl+Enter` / `Cmd+Enter`)

**⚠️ Importante:**
- El script es seguro y no borra datos
- Puedes ejecutarlo múltiples veces si es necesario
- Si ves errores sobre "ya existe", es normal (el script verifica antes de crear)

### PASO 2: Verificar que la migración funcionó

Ejecuta esta consulta en Supabase SQL Editor para verificar:

```sql
-- Verificar que la columna 'name' existe en clients
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'clients' 
AND column_name IN ('name', 'company_name');

-- Verificar que las nuevas tablas existen
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('job_positions', 'applications', 'interviews');
```

Deberías ver:
- ✅ `name` y `company_name` en la tabla `clients`
- ✅ Las 3 nuevas tablas: `job_positions`, `applications`, `interviews`

### PASO 3: Instalar dependencia de ElevenLabs

En la terminal, ejecuta:

```bash
npm install @elevenlabs/react
```

### PASO 4: Configurar variables de entorno

Abre tu archivo `.env.local` y agrega:

```env
# ElevenLabs
ELEVENLABS_DEFAULT_AGENT_ID=tu-agent-id-aqui

# API Key para n8n (cámbiala por una segura)
INTERVIEWS_API_KEY=gt-interviews-api-key-change-me

# Webhook secret (opcional)
ELEVENLABS_WEBHOOK_SECRET=tu-secret-opcional

# URL de tu app (para generar links)
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

**⚠️ Importante:**
- `ELEVENLABS_DEFAULT_AGENT_ID`: Lo obtienes de tu cuenta de ElevenLabs
- `INTERVIEWS_API_KEY`: Cámbiala por una clave segura (usa un generador de UUID)
- `NEXT_PUBLIC_APP_URL`: En producción, usa tu dominio real

### PASO 5: Copiar archivos del módulo de entrevistas

El módulo está en `entrevistas-module/src/`. Necesitas copiar:

1. **Tipos TypeScript:**
   ```bash
   # Ya debería estar en: src/types/interviews.types.ts
   # Si no existe, cópialo desde: entrevistas-module/src/types/interviews.types.ts
   ```

2. **Rutas de API:**
   ```bash
   # Copiar desde: entrevistas-module/src/app/api/interviews/
   # Hacia: src/app/api/interviews/
   ```

3. **Páginas públicas:**
   ```bash
   # Copiar desde: entrevistas-module/src/app/entrevista/
   # Hacia: src/app/entrevista/
   ```

### PASO 6: Verificar que todo funciona

1. Inicia el servidor de desarrollo:
   ```bash
   npm run dev
   ```

2. Prueba las rutas:
   - ✅ `GET http://localhost:3000/api/interviews/create` → Debe mostrar el schema (sin autenticación)
   - ✅ `GET http://localhost:3000/entrevista/token-invalido` → Debe mostrar pantalla de error
   - ✅ `GET http://localhost:3000/dashboard` → Debe funcionar normalmente (con login)

## 📊 Estructura Final

Después de la migración, tendrás:

### Tablas de Base de Datos (28 tablas totales)

**Módulo de Reportes/Calidad (15 tablas):**
- `profiles`, `assistants`, `weekly_reports`, `weekly_submissions`
- `monthly_reports`, `monthly_activities`, `monthly_metrics`, etc.

**Módulo de RRHH (4 tablas):**
- `clients` (✅ actualizada con `name`)
- `candidates` (✅ actualizada con nuevas columnas)
- `job_searches` (existente, no cambia)
- `calendar_events`

**Módulo de Entrevistas (5 tablas nuevas):**
- `job_positions` (nueva)
- `applications` (nueva)
- `interviews` (nueva)
- `clients` (actualizada)
- `candidates` (actualizada)

**Sistema (4 tablas):**
- `alerts`, `activity_logs`, `company_values`, `departments`

### Rutas del Middleware

**Rutas Públicas (sin login):**
- `/login`
- `/auth/callback`
- `/auth/error`
- `/entrevista/*` ← Nueva

**Rutas de API Públicas (con API Key):**
- `/api/interviews/create` ← Nueva
- `/api/interviews/webhook` ← Nueva

**Rutas Protegidas por Rol:**
- `/configuracion` → Solo `admin`
- `/calidad` → Solo `admin`, `calidad`
- `/entrevistas` → Solo `admin`, `rrhh`, `calidad` ← Nueva

## 🔍 Solución de Problemas

### Error: "column 'name' does not exist"
**Causa:** La migración no se ejecutó correctamente.

**Solución:**
1. Verifica que ejecutaste el script completo en Supabase
2. Ejecuta manualmente:
   ```sql
   ALTER TABLE clients ADD COLUMN IF NOT EXISTS name TEXT;
   UPDATE clients SET name = company_name WHERE name IS NULL;
   ```

### Error: "Table 'job_positions' does not exist"
**Causa:** Las nuevas tablas no se crearon.

**Solución:**
1. Ejecuta solo la sección "PASO 2" del script de migración
2. O ejecuta el script completo nuevamente (es seguro)

### Error: "Unauthorized" en rutas de API
**Causa:** Falta la API Key o está mal configurada.

**Solución:**
1. Verifica que `INTERVIEWS_API_KEY` está en `.env.local`
2. Verifica que el header `Authorization: Bearer {key}` está presente
3. Reinicia el servidor después de cambiar `.env.local`

## 📝 Notas Importantes

1. **Compatibilidad hacia atrás:**
   - Tu código existente que usa `company_name` seguirá funcionando
   - Puedes migrar gradualmente a usar `name` cuando quieras
   - Las vistas usan `COALESCE(c.name, c.company_name)` para compatibilidad

2. **Datos existentes:**
   - Los datos en `clients.company_name` se copian automáticamente a `name`
   - No se pierden datos durante la migración

3. **Seguridad:**
   - Las rutas `/entrevista/*` son públicas pero usan tokens UUID únicos
   - Los tokens expiran después de 72 horas
   - Los tokens se "queman" al iniciar la entrevista (no se pueden reusar)

## ✅ Checklist Final

- [ ] Script de migración ejecutado en Supabase
- [ ] Verificación de tablas y columnas exitosa
- [ ] Dependencia `@elevenlabs/react` instalada
- [ ] Variables de entorno configuradas en `.env.local`
- [ ] Archivos del módulo copiados a `src/`
- [ ] Middleware actualizado (ya está hecho ✅)
- [ ] Servidor de desarrollo funciona sin errores
- [ ] Rutas de API responden correctamente

## 🎉 ¡Listo!

Una vez completados todos los pasos, tu módulo de entrevistas estará completamente integrado y funcionando.

Si tienes dudas o problemas, revisa la sección de "Solución de Problemas" o consulta los logs del servidor.
</file>

<file path="migration-interviews-module.sql">
-- =====================================================
-- MIGRACIÓN: MÓDULO DE ENTREVISTAS
-- Este script adapta tu base de datos existente para el nuevo módulo
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- =====================================================
-- PASO 1: MIGRAR TABLA clients
-- =====================================================

-- 1.1: Agregar columna 'name' si no existe
DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'clients' AND column_name = 'name'
  ) THEN
    ALTER TABLE clients ADD COLUMN name TEXT;
    RAISE NOTICE 'Columna "name" agregada a tabla clients';
  ELSE
    RAISE NOTICE 'Columna "name" ya existe en tabla clients';
  END IF;
END $$;

-- 1.2: Copiar datos de company_name a name (solo si name está vacío)
UPDATE clients 
SET name = company_name 
WHERE (name IS NULL OR name = '') AND company_name IS NOT NULL;

-- 1.3: Agregar nuevas columnas para el módulo de entrevistas
DO $$ 
BEGIN
  -- legal_name
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'clients' AND column_name = 'legal_name'
  ) THEN
    ALTER TABLE clients ADD COLUMN legal_name TEXT;
  END IF;

  -- tax_id
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'clients' AND column_name = 'tax_id'
  ) THEN
    ALTER TABLE clients ADD COLUMN tax_id TEXT;
  END IF;

  -- logo_url
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'clients' AND column_name = 'logo_url'
  ) THEN
    ALTER TABLE clients ADD COLUMN logo_url TEXT;
  END IF;

  -- primary_color
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'clients' AND column_name = 'primary_color'
  ) THEN
    ALTER TABLE clients ADD COLUMN primary_color TEXT DEFAULT '#10b981';
  END IF;

  -- zoho_account_id
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'clients' AND column_name = 'zoho_account_id'
  ) THEN
    ALTER TABLE clients ADD COLUMN zoho_account_id TEXT;
  END IF;
END $$;

-- 1.4: Crear índice en 'name' si no existe
CREATE INDEX IF NOT EXISTS idx_clients_name ON clients(name);

-- =====================================================
-- PASO 2: CREAR TABLA job_positions (nueva)
-- =====================================================

CREATE TABLE IF NOT EXISTS job_positions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Relación con cliente
  client_id UUID NOT NULL REFERENCES clients(id) ON DELETE CASCADE,
  
  -- Datos del puesto
  title TEXT NOT NULL,
  description TEXT,
  requirements TEXT,
  
  -- Ubicación
  location TEXT,
  remote_type TEXT DEFAULT 'hybrid' 
    CHECK (remote_type IN ('onsite', 'hybrid', 'remote')),
  
  -- Compensación (opcional)
  salary_min DECIMAL(12,2),
  salary_max DECIMAL(12,2),
  salary_currency TEXT DEFAULT 'USD',
  
  -- Estado de la búsqueda
  status TEXT NOT NULL DEFAULT 'open' 
    CHECK (status IN ('draft', 'open', 'paused', 'closed', 'filled')),
  
  -- Configuración de entrevista bot
  elevenlabs_agent_id TEXT,
  interview_questions JSONB,
  
  -- Zoho integration
  zoho_job_id TEXT,
  
  -- Asignación interna
  assigned_to UUID REFERENCES profiles(id),
  
  -- Metadata
  opened_at TIMESTAMPTZ DEFAULT NOW(),
  closed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Índices para job_positions
CREATE INDEX IF NOT EXISTS idx_job_positions_client ON job_positions(client_id);
CREATE INDEX IF NOT EXISTS idx_job_positions_status ON job_positions(status);
CREATE INDEX IF NOT EXISTS idx_job_positions_assigned ON job_positions(assigned_to);

-- =====================================================
-- PASO 3: ACTUALIZAR TABLA candidates (si necesita nuevas columnas)
-- =====================================================

-- Agregar columnas que pueden faltar en candidates
DO $$ 
BEGIN
  -- linkedin_url
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'candidates' AND column_name = 'linkedin_url'
  ) THEN
    ALTER TABLE candidates ADD COLUMN linkedin_url TEXT;
  END IF;

  -- portfolio_url
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'candidates' AND column_name = 'portfolio_url'
  ) THEN
    ALTER TABLE candidates ADD COLUMN portfolio_url TEXT;
  END IF;

  -- zoho_candidate_id
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'candidates' AND column_name = 'zoho_candidate_id'
  ) THEN
    ALTER TABLE candidates ADD COLUMN zoho_candidate_id TEXT;
  END IF;

  -- source
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'candidates' AND column_name = 'source'
  ) THEN
    ALTER TABLE candidates ADD COLUMN source TEXT DEFAULT 'form';
  END IF;
END $$;

-- Índice para zoho_candidate_id
CREATE INDEX IF NOT EXISTS idx_candidates_zoho ON candidates(zoho_candidate_id);

-- =====================================================
-- PASO 4: CREAR TABLA applications (nueva)
-- =====================================================

CREATE TABLE IF NOT EXISTS applications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Relaciones
  candidate_id UUID NOT NULL REFERENCES candidates(id) ON DELETE CASCADE,
  job_position_id UUID NOT NULL REFERENCES job_positions(id) ON DELETE CASCADE,
  
  -- Análisis inicial (del Index/Gemini)
  initial_score DECIMAL(5,2),
  initial_analysis JSONB,
  
  -- Estado del pipeline
  status TEXT NOT NULL DEFAULT 'new' CHECK (status IN (
    'new',
    'screening',
    'approved_for_bot',
    'bot_pending',
    'bot_completed',
    'approved_for_human',
    'human_scheduled',
    'human_completed',
    'offer',
    'hired',
    'rejected',
    'withdrawn'
  )),
  
  -- Quién aprobó cada etapa
  approved_by UUID REFERENCES profiles(id),
  approved_at TIMESTAMPTZ,
  
  -- Notas del reclutador
  recruiter_notes TEXT,
  
  -- Zoho
  zoho_application_id TEXT,
  
  -- Metadata
  applied_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Un candidato solo puede aplicar una vez al mismo puesto
  UNIQUE(candidate_id, job_position_id)
);

-- Índices para applications
CREATE INDEX IF NOT EXISTS idx_applications_candidate ON applications(candidate_id);
CREATE INDEX IF NOT EXISTS idx_applications_job ON applications(job_position_id);
CREATE INDEX IF NOT EXISTS idx_applications_status ON applications(status);

-- =====================================================
-- PASO 5: CREAR TABLA interviews (nueva)
-- =====================================================

CREATE TABLE IF NOT EXISTS interviews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- Relaciones
  application_id UUID NOT NULL REFERENCES applications(id) ON DELETE CASCADE,
  
  -- TOKEN DE ACCESO (CRÍTICO PARA SEGURIDAD)
  token UUID NOT NULL DEFAULT gen_random_uuid(),
  
  -- Estado de la entrevista
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN (
    'pending',
    'in_progress',
    'completed',
    'expired',
    'abandoned'
  )),
  
  -- Expiración
  expires_at TIMESTAMPTZ NOT NULL,
  
  -- ElevenLabs data
  elevenlabs_conversation_id TEXT,
  elevenlabs_agent_id TEXT,
  
  -- Resultado de la entrevista
  transcript TEXT,
  analysis JSONB,
  bot_score DECIMAL(5,2),
  
  -- Timestamps de la sesión
  started_at TIMESTAMPTZ,
  completed_at TIMESTAMPTZ,
  
  -- Metadata técnica
  user_agent TEXT,
  ip_address INET,
  
  -- Timestamps
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Token único
  UNIQUE(token)
);

-- Índices para interviews
CREATE INDEX IF NOT EXISTS idx_interviews_token ON interviews(token);
CREATE INDEX IF NOT EXISTS idx_interviews_application ON interviews(application_id);
CREATE INDEX IF NOT EXISTS idx_interviews_status ON interviews(status);
CREATE INDEX IF NOT EXISTS idx_interviews_expires ON interviews(expires_at);

-- =====================================================
-- PASO 6: ROW LEVEL SECURITY (RLS)
-- =====================================================

-- Habilitar RLS en las nuevas tablas
ALTER TABLE job_positions ENABLE ROW LEVEL SECURITY;
ALTER TABLE applications ENABLE ROW LEVEL SECURITY;
ALTER TABLE interviews ENABLE ROW LEVEL SECURITY;

-- Políticas para job_positions
DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies 
    WHERE tablename = 'job_positions' AND policyname = 'RRHH can view all job positions'
  ) THEN
    CREATE POLICY "RRHH can view all job positions" ON job_positions
      FOR SELECT USING (
        EXISTS (
          SELECT 1 FROM profiles 
          WHERE id = auth.uid() 
          AND role IN ('admin', 'rrhh', 'calidad')
        )
      );
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM pg_policies 
    WHERE tablename = 'job_positions' AND policyname = 'RRHH can manage job positions'
  ) THEN
    CREATE POLICY "RRHH can manage job positions" ON job_positions
      FOR ALL USING (
        EXISTS (
          SELECT 1 FROM profiles 
          WHERE id = auth.uid() 
          AND role IN ('admin', 'rrhh')
        )
      );
  END IF;
END $$;

-- Políticas para applications
DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies 
    WHERE tablename = 'applications' AND policyname = 'RRHH can view all applications'
  ) THEN
    CREATE POLICY "RRHH can view all applications" ON applications
      FOR SELECT USING (
        EXISTS (
          SELECT 1 FROM profiles 
          WHERE id = auth.uid() 
          AND role IN ('admin', 'rrhh', 'calidad')
        )
      );
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM pg_policies 
    WHERE tablename = 'applications' AND policyname = 'RRHH can manage applications'
  ) THEN
    CREATE POLICY "RRHH can manage applications" ON applications
      FOR ALL USING (
        EXISTS (
          SELECT 1 FROM profiles 
          WHERE id = auth.uid() 
          AND role IN ('admin', 'rrhh')
        )
      );
  END IF;
END $$;

-- Políticas para interviews
DO $$ 
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_policies 
    WHERE tablename = 'interviews' AND policyname = 'RRHH can view all interviews'
  ) THEN
    CREATE POLICY "RRHH can view all interviews" ON interviews
      FOR SELECT USING (
        EXISTS (
          SELECT 1 FROM profiles 
          WHERE id = auth.uid() 
          AND role IN ('admin', 'rrhh', 'calidad')
        )
      );
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM pg_policies 
    WHERE tablename = 'interviews' AND policyname = 'System can manage interviews'
  ) THEN
    CREATE POLICY "System can manage interviews" ON interviews
      FOR ALL USING (
        EXISTS (
          SELECT 1 FROM profiles 
          WHERE id = auth.uid() 
          AND role IN ('admin', 'rrhh')
        )
      );
  END IF;
END $$;

-- =====================================================
-- PASO 7: TRIGGERS (actualizar updated_at automáticamente)
-- =====================================================

-- Función para actualizar updated_at (ya debería existir, pero la creamos por si acaso)
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Triggers para las nuevas tablas
DROP TRIGGER IF EXISTS update_job_positions_updated_at ON job_positions;
CREATE TRIGGER update_job_positions_updated_at 
  BEFORE UPDATE ON job_positions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_applications_updated_at ON applications;
CREATE TRIGGER update_applications_updated_at 
  BEFORE UPDATE ON applications
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_interviews_updated_at ON interviews;
CREATE TRIGGER update_interviews_updated_at 
  BEFORE UPDATE ON interviews
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =====================================================
-- PASO 8: FUNCIONES DE BASE DE DATOS
-- =====================================================

-- Función: Validar token de entrevista
CREATE OR REPLACE FUNCTION validate_interview_token(p_token UUID)
RETURNS TABLE (
  interview_id UUID,
  status TEXT,
  is_valid BOOLEAN,
  candidate_name TEXT,
  candidate_email TEXT,
  job_title TEXT,
  client_name TEXT,
  elevenlabs_agent_id TEXT,
  error_message TEXT
) AS $$
DECLARE
  v_interview RECORD;
  v_application RECORD;
  v_candidate RECORD;
  v_job RECORD;
  v_client RECORD;
BEGIN
  -- Buscar la entrevista por token
  SELECT * INTO v_interview 
  FROM interviews i 
  WHERE i.token = p_token;
  
  -- Si no existe el token
  IF NOT FOUND THEN
    RETURN QUERY SELECT 
      NULL::UUID,
      'invalid'::TEXT,
      FALSE,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      'Token no encontrado'::TEXT;
    RETURN;
  END IF;
  
  -- Si ya expiró
  IF v_interview.expires_at < NOW() THEN
    UPDATE interviews SET status = 'expired' WHERE id = v_interview.id AND status = 'pending';
    
    RETURN QUERY SELECT 
      v_interview.id,
      'expired'::TEXT,
      FALSE,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      'El enlace ha expirado'::TEXT;
    RETURN;
  END IF;
  
  -- Si ya fue usada
  IF v_interview.status NOT IN ('pending', 'in_progress') THEN
    RETURN QUERY SELECT 
      v_interview.id,
      v_interview.status,
      FALSE,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      NULL::TEXT,
      'Esta entrevista ya fue completada o cancelada'::TEXT;
    RETURN;
  END IF;
  
  -- Obtener datos relacionados
  SELECT * INTO v_application FROM applications WHERE id = v_interview.application_id;
  SELECT * INTO v_candidate FROM candidates WHERE id = v_application.candidate_id;
  SELECT * INTO v_job FROM job_positions WHERE id = v_application.job_position_id;
  SELECT * INTO v_client FROM clients WHERE id = v_job.client_id;
  
  -- Token válido - usar COALESCE para manejar tanto 'name' como 'company_name'
  RETURN QUERY SELECT 
    v_interview.id,
    v_interview.status,
    TRUE,
    v_candidate.full_name,
    v_candidate.email,
    v_job.title,
    COALESCE(v_client.name, v_client.company_name)::TEXT, -- Compatibilidad con ambas columnas
    COALESCE(v_interview.elevenlabs_agent_id, v_job.elevenlabs_agent_id),
    NULL::TEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Función: Marcar entrevista como iniciada
CREATE OR REPLACE FUNCTION start_interview(p_token UUID, p_user_agent TEXT DEFAULT NULL, p_ip TEXT DEFAULT NULL)
RETURNS TABLE (
  success BOOLEAN,
  interview_id UUID,
  conversation_id TEXT,
  error_message TEXT
) AS $$
DECLARE
  v_interview RECORD;
BEGIN
  SELECT * INTO v_interview 
  FROM interviews i 
  WHERE i.token = p_token 
    AND i.status = 'pending'
    AND i.expires_at > NOW();
  
  IF NOT FOUND THEN
    RETURN QUERY SELECT FALSE, NULL::UUID, NULL::TEXT, 'Token inválido o expirado'::TEXT;
    RETURN;
  END IF;
  
  UPDATE interviews 
  SET 
    status = 'in_progress',
    started_at = NOW(),
    user_agent = p_user_agent,
    ip_address = p_ip::INET
  WHERE id = v_interview.id;
  
  UPDATE applications 
  SET status = 'bot_pending'
  WHERE id = v_interview.application_id 
    AND status IN ('approved_for_bot', 'bot_pending');
  
  RETURN QUERY SELECT TRUE, v_interview.id, v_interview.elevenlabs_conversation_id, NULL::TEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Función: Completar entrevista
CREATE OR REPLACE FUNCTION complete_interview(
  p_interview_id UUID,
  p_conversation_id TEXT,
  p_transcript TEXT DEFAULT NULL
)
RETURNS BOOLEAN AS $$
BEGIN
  UPDATE interviews 
  SET 
    status = 'completed',
    completed_at = NOW(),
    elevenlabs_conversation_id = p_conversation_id,
    transcript = p_transcript
  WHERE id = p_interview_id 
    AND status = 'in_progress';
  
  UPDATE applications 
  SET status = 'bot_completed'
  WHERE id = (SELECT application_id FROM interviews WHERE id = p_interview_id);
  
  RETURN FOUND;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- =====================================================
-- PASO 9: VISTAS ÚTILES
-- =====================================================

-- Vista: Pipeline de candidatos por puesto
CREATE OR REPLACE VIEW v_recruitment_pipeline AS
SELECT 
  jp.id AS job_position_id,
  jp.title AS job_title,
  COALESCE(c.name, c.company_name) AS client_name, -- Compatibilidad
  a.status,
  COUNT(a.id) AS count
FROM job_positions jp
JOIN clients c ON jp.client_id = c.id
LEFT JOIN applications a ON a.job_position_id = jp.id
WHERE jp.status = 'open'
GROUP BY jp.id, jp.title, COALESCE(c.name, c.company_name), a.status
ORDER BY jp.title, a.status;

-- Vista: Entrevistas pendientes del día
CREATE OR REPLACE VIEW v_pending_interviews_today AS
SELECT 
  i.id,
  i.token,
  i.status,
  i.expires_at,
  cand.full_name AS candidate_name,
  cand.email AS candidate_email,
  jp.title AS job_title,
  COALESCE(cl.name, cl.company_name) AS client_name -- Compatibilidad
FROM interviews i
JOIN applications a ON i.application_id = a.id
JOIN candidates cand ON a.candidate_id = cand.id
JOIN job_positions jp ON a.job_position_id = jp.id
JOIN clients cl ON jp.client_id = cl.id
WHERE i.status = 'pending'
  AND i.expires_at > NOW()
ORDER BY i.expires_at;

-- =====================================================
-- FIN DE LA MIGRACIÓN
-- =====================================================

-- Mensaje de confirmación
DO $$ 
BEGIN
  RAISE NOTICE '✅ Migración completada exitosamente';
  RAISE NOTICE '📋 Tablas creadas/actualizadas: clients, job_positions, applications, interviews';
  RAISE NOTICE '🔒 RLS habilitado en todas las nuevas tablas';
  RAISE NOTICE '⚙️ Funciones y vistas creadas';
END $$;
</file>

<file path="PASO-A-PASO-SUPABASE.md">
# 📋 Guía Paso a Paso - Verificar en Supabase

## ✅ PASO 1 COMPLETADO
Los endpoints GET funcionan correctamente:
- ✅ `/api/interviews/create` - Funciona
- ✅ `/api/interviews/webhook` - Funciona

---

## 🔍 PASO 2: Verificar Tablas y Funciones en Supabase

### Instrucciones Visuales:

1. **Abre Supabase en tu navegador:**
   - Ve a: https://supabase.com
   - Inicia sesión
   - Selecciona tu proyecto

2. **Abre el SQL Editor:**
   - En el menú lateral izquierdo, busca **"SQL Editor"**
   - Haz clic en **"New query"** (botón verde arriba a la derecha)

3. **Copia el script de verificación:**
   - Abre el archivo `verificar-supabase.sql` que está en tu proyecto
   - Selecciona TODO el contenido (Cmd+A / Ctrl+A)
   - Cópialo (Cmd+C / Ctrl+C)

4. **Pega en Supabase:**
   - Pega el contenido en el editor SQL de Supabase
   - Haz clic en **"Run"** (botón verde) o presiona `Cmd+Enter` / `Ctrl+Enter`

5. **Revisa los resultados:**
   Deberías ver varios resultados (tabs) en la parte inferior:

   **Resultado 1:** Columnas de `clients`
   - Debe mostrar: `name` y `company_name`
   
   **Resultado 2:** Tablas nuevas
   - Debe mostrar: `job_positions`, `applications`, `interviews`, `candidates`
   
   **Resultado 3:** Funciones
   - Debe mostrar: `validate_interview_token`, `start_interview`, `complete_interview`
   
   **Resultado 4-5:** Estructura de tablas
   - Muestra todas las columnas
   
   **Resultado 6:** Conteo de registros
   - Muestra cuántos registros hay en cada tabla

### ✅ Qué buscar:
- Si ves las 4 tablas → ✅ Correcto
- Si ves las 3 funciones → ✅ Correcto
- Si ves la columna `name` en `clients` → ✅ Correcto

---

## 📝 PASO 3: Crear Datos de Prueba

Una vez que verifiques que todo existe, crea los datos de prueba:

1. **En Supabase SQL Editor, crea una nueva query** (botón "New query")

2. **Abre el archivo `datos-prueba.sql`**

3. **Copia TODO el contenido y pégalo en Supabase**

4. **Ejecuta el script** (botón "Run")

5. **IMPORTANTE: Copia el `id` del job position**
   - En los resultados, verás una tabla con el job position
   - Copia el `id` (es un UUID como: `a1b2c3d4-e5f6-7890-abcd-ef1234567890`)
   - **Este ID lo necesitarás para probar el POST**

---

## 🚀 PASO 4: Probar el POST

Una vez que tengas el `job_position_id`, puedes probar el POST de dos formas:

### Opción A: Usar el script (más fácil)
```bash
cd "/Users/arielemilianojimenez/Downloads/global-talent-platform 2"
./probar-post.sh
```
Cuando te pida el ID, pégalo.

### Opción B: Usar curl manualmente
```bash
curl -X POST http://localhost:3000/api/interviews/create \
  -H "Authorization: Bearer 48d5e45849279a48ccd37c0a98523f0c02e1ffcc61089d3f541dc4ce41bfd858" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "candidato@example.com",
    "candidate_name": "María García",
    "job_position_id": "AQUÍ_PEGA_EL_ID"
  }'
```

---

## 📊 Resumen del Progreso

- [x] ✅ Endpoints GET funcionan
- [ ] ⏳ Verificar tablas y funciones en Supabase
- [ ] ⏳ Crear datos de prueba
- [ ] ⏳ Probar POST con API Key

---

¿Necesitas ayuda con algún paso? ¡Avísame cuando termines de verificar en Supabase!
</file>

<file path="postcss.config.js">
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
</file>

<file path="scripts/create-ariel-assistant.mjs">
import { createClient } from '@supabase/supabase-js';
import fs from 'fs';
import path from 'path';

// Load env vars manually to avoid dotenv dependency
const envPath = path.resolve('.env.local');
const envContent = fs.readFileSync(envPath, 'utf8');
const envVars = {};
envContent.split('\n').forEach(line => {
    const match = line.match(/^([^=]+)=(.*)$/);
    if (match) {
        const key = match[1].trim();
        let value = match[2].trim();
        if (value.startsWith('"') && value.endsWith('"')) {
            value = value.slice(1, -1);
        }
        envVars[key] = value;
    }
});

const supabaseUrl = envVars.NEXT_PUBLIC_SUPABASE_URL;
// Try to find service role key, otherwise anon key (anon might fail for RLS, but if RLS allows insert for self or public, it might work. Usually service role is in .env.local for local dev)
const supabaseKey = envVars.SUPABASE_SERVICE_ROLE_KEY || envVars.NEXT_PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing Supabase credentials in .env.local');
    process.exit(1);
}

console.log('Connecting to Supabase:', supabaseUrl);
const supabase = createClient(supabaseUrl, supabaseKey);

async function main() {
    const email = 'ariel@globaltalent.com';
    console.log(`Looking for user ${email}...`);

    // 1. Get User ID from Profile
    const { data: profile, error: profileError } = await supabase
        .from('profiles')
        .select('id, full_name')
        .eq('email', email)
        .single();

    if (profileError || !profile) {
        console.error('User found in profiles:', profileError);
        // Fallback: try to list users (only works with service role)
        const { data: { users }, error: authError } = await supabase.auth.admin.listUsers();
        if (authError) {
            console.error('Could not list auth users either:', authError);
            process.exit(1);
        }
        const user = users.find(u => u.email === email);
        if (!user) {
            console.error('User strictly not found.');
            process.exit(1);
        }
        console.log('Found user in Auth but not Profile (weird), using Auth ID:', user.id);
        profile = { id: user.id, full_name: 'Ariel Jimenez' };
    } else {
        console.log(`Found profile for ${profile.full_name}: ${profile.id}`);
    }

    const userId = profile.id;

    // 2. Check if Assistant exists
    const { data: existingAssistant } = await supabase
        .from('assistants')
        .select('id')
        .eq('user_id', userId)
        .single();

    if (existingAssistant) {
        console.log('Assistant record already exists:', existingAssistant.id);
        return;
    }

    // 3. Create Assistant
    console.log('Creating assistant record...');
    const newAssistant = {
        user_id: userId,
        full_name: profile.full_name || 'Ariel Jimenez',
        email: email,
        status: 'activo',
        assistant_type: 'proyectos_software', // Fits Director of Automation
        contract_type: 'tiempo_completo',
        work_schedule: '09:00-18:00',
        timezone: 'America/Mexico_City',
        weekly_objectives: [],
        monthly_objectives: [],
        skills: ['GenAI', 'Automation', 'Next.js'],
        languages: ['Español', 'Inglés']
    };

    const { data, error: insertError } = await supabase
        .from('assistants')
        .insert(newAssistant)
        .select()
        .single();

    if (insertError) {
        console.error('Error creating assistant:', insertError);
    } else {
        console.log('SUCCESS: Assistant created!', data.id);
    }
}

main().catch(err => console.error(err));
</file>

<file path="scripts/seed-team.mjs">
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
    console.error('Missing Supabase URL or Service Key in .env.local');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

const USERS = [
    // HR Team
    {
        email: 'gladymar@globaltalent.com',
        password: 'globaltalent2026',
        full_name: 'Gladymar',
        role: 'rrhh',
        department: 'hr',
        position: 'assistant',
        avatar_color: 'bg-pink-500'
    },
    {
        email: 'viviana@globaltalent.com',
        password: 'globaltalent2026',
        full_name: 'Viviana',
        role: 'rrhh',
        department: 'hr',
        position: 'assistant',
        avatar_color: 'bg-purple-500'
    },
    {
        email: 'reyna@globaltalent.com',
        password: 'globaltalent2026',
        full_name: 'Reyna',
        role: 'rrhh',
        department: 'hr',
        position: 'specialist',
        avatar_color: 'bg-indigo-500'
    },

    // Sales
    {
        email: 'pilar@globaltalent.com',
        password: 'globaltalent2026',
        full_name: 'Pilar',
        role: 'asistente', // Legacy role map needed? Sales isn't in legacy roles exactly, usually 'asistente' or 'marketing'
        department: 'sales',
        position: 'specialist', // Closer
        avatar_color: 'bg-emerald-500'
    },

    // Marketing (Replaces Javier/Dev in user request logic)
    {
        email: 'jennifer@globaltalent.com',
        password: 'globaltalent2026',
        full_name: 'Jennifer',
        role: 'marketing',
        department: 'marketing',
        position: 'manager',
        avatar_color: 'bg-orange-500'
    },

    // Quality
    {
        email: 'norma@globaltalent.com',
        password: 'globaltalent2026',
        full_name: 'Norma',
        role: 'calidad',
        department: 'quality',
        position: 'manager',
        avatar_color: 'bg-cyan-500'
    },

    // C-Level
    {
        email: 'daniel@globaltalent.com',
        password: 'globaltalent2026',
        full_name: 'Daniel (CEO)',
        role: 'admin',
        department: 'c_level',
        position: 'ceo',
        avatar_color: 'bg-blue-600'
    },
    {
        email: 'victor@globaltalent.com',
        password: 'globaltalent2026',
        full_name: 'Victor',
        role: 'admin',
        department: 'c_level',
        position: 'coo', // Operations Director
        avatar_color: 'bg-slate-500'
    },

    // Admin Superuser
    {
        email: 'admin@globaltalent.com',
        password: 'globaltalent2026',
        full_name: 'Admin',
        role: 'admin',
        department: 'c_level',
        position: 'director',
        avatar_color: 'bg-red-500'
    }
];

async function seedUsers() {
    console.log(`Starting seed for ${USERS.length} users...`);

    for (const user of USERS) {
        try {
            console.log(`Processing ${user.full_name} (${user.email})...`);

            // 1. Check if user exists (by email) to avoid duplicate auth errors
            // Note: Admin API listUsers is paginated, but for seed we can try Create and catch error
            // Or we can just try to signUp/admin.createUser

            let userId;

            // Try to get user by email directly? No direct method by email in public API without listing
            // We will try create an auth user
            const { data: authData, error: authError } = await supabase.auth.admin.createUser({
                email: user.email,
                password: user.password,
                email_confirm: true,
                user_metadata: { full_name: user.full_name }
            });

            if (authError) {
                if (authError.message.includes('already been registered')) {
                    console.log(`User ${user.email} already exists. Fetching ID...`);
                    // Find the user ID - brute force list for now (small team)
                    const { data: { users } } = await supabase.auth.admin.listUsers();
                    const existing = users.find(u => u.email === user.email);
                    if (existing) userId = existing.id;
                } else {
                    console.error(`Failed to create auth for ${user.email}:`, authError.message);
                    continue;
                }
            } else {
                userId = authData.user.id;
                console.log(`Created Auth User: ${userId}`);
            }

            if (!userId) {
                console.error(`Could not determine User ID for ${user.email}`);
                continue;
            }

            // 2. Upsert Profile
            // We use upsert to ensure role/department are correct even if user existed
            const { error: profileError } = await supabase
                .from('profiles')
                .upsert({
                    id: userId,
                    email: user.email,
                    full_name: user.full_name,
                    role: user.role,
                    department: user.department,
                    position: user.position,
                    // Defaults
                    country: 'Argentina',
                    timezone: 'America/Argentina/Buenos_Aires',
                    updated_at: new Date().toISOString()
                });

            if (profileError) {
                console.error(`Failed to update profile for ${user.email}:`, profileError.message);
            } else {
                console.log(`Profile updated for ${user.full_name}`);
            }

            // 3. Upsert Assistant Record (required for reports)
            // Only for assistant/hr/sales generic roles? Or everyone?
            // System seems to require assistant record for Reports module specifically.
            // Let's create an assistant record for everyone to be safe for testing features.

            const { error: assistantError } = await supabase
                .from('assistants')
                .upsert({
                    user_id: userId,
                    full_name: user.full_name,
                    email: user.email,
                    status: 'activo',
                    contract_type: 'tiempo_completo',
                    work_schedule: '09:00-18:00',
                    timezone: 'America/Argentina/Buenos_Aires',
                    updated_at: new Date().toISOString()
                    // Assistants table has a unique key on user_id usually? Or just ID? 
                    // We need to resolve conflicts. The table might not have user_id as unique constraint formally?
                    // Let's check if we can find existing assistant by user_id first.
                }, { onConflict: 'user_id' }); // Assuming user_id is unique or we can match on it. 
            // If user_id is not unique constraint, upsert might fail or duplicate.
            // Let's do a select first to be safe.

            // Manual upsert logic for assistants to be safe
            const { data: existingAssistant } = await supabase
                .from('assistants')
                .select('id')
                .eq('user_id', userId)
                .single();

            if (existingAssistant) {
                await supabase.from('assistants').update({
                    full_name: user.full_name,
                    email: user.email,
                    status: 'activo'
                }).eq('id', existingAssistant.id);
            } else {
                await supabase.from('assistants').insert({
                    user_id: userId, // Link to auth user
                    full_name: user.full_name,
                    email: user.email,
                    status: 'activo',
                    contract_type: 'tiempo_completo',
                    work_schedule: '09:00-18:00', // Default
                    timezone: 'America/Argentina/Buenos_Aires',
                    skills: [],
                    languages: ['Español']
                });
            }

            console.log(`Assistant record synced for ${user.full_name}`);

        } catch (e) {
            console.error(`Unexpected error for ${user.email}:`, e);
        }
    }

    console.log('Seed completed!');
}

seedUsers();
</file>

<file path="setup-leads-kanban.sql">
-- =====================================================
-- GLOBAL TALENT PLATFORM - KANBAN DE LEADS
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- 1. Crear tipo ENUM para estados del lead si no existe (o actualizar check constraint)
-- En Supabase es más fácil manejarlo como TEXT con CHECK constraint para flexibilidad
-- pero documentamos los estados esperados:
-- 'new' (Nuevo)
-- 'to_contact' (Contactar)  <- NUEVO
-- 'contacted' (Contactado / En Conversación)
-- 'files_sent' (Fichas Enviadas) <- NUEVO
-- 'interested' (Interesado)
-- 'presenting' (Presentando candidatos)
-- 'negotiating' (Negociando)
-- 'contract_sent' (Contrato enviado)
-- 'won' (Ganado)
-- 'lost' (Perdido)
-- 'frozen' (Congelado)

-- 2. Crear tabla leads si no existe
CREATE TABLE IF NOT EXISTS leads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  company_name TEXT NOT NULL,
  contact_name TEXT,
  contact_email TEXT,
  contact_phone TEXT,
  website TEXT,
  linkedin_url TEXT,
  
  assistant_type TEXT, -- Tipo de asistente que buscan
  quantity INTEGER DEFAULT 1,
  budget_min NUMERIC,
  budget_max NUMERIC,
  urgency TEXT CHECK (urgency IN ('low', 'medium', 'high', 'urgent')) DEFAULT 'medium',
  notes TEXT,
  
  status TEXT NOT NULL DEFAULT 'new',
  assigned_to UUID REFERENCES profiles(id), -- Quién gestiona el lead
  
  source TEXT, -- linkedin, referral, etc.
  
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  
  -- Campos de seguimiento
  last_contact_at TIMESTAMPTZ,
  next_followup_at TIMESTAMPTZ,
  
  -- Metadata adicional
  zoho_lead_id TEXT
);

-- 3. Actualizar constraint de status para incluir los nuevos estados
ALTER TABLE leads DROP CONSTRAINT IF EXISTS leads_status_check;
ALTER TABLE leads ADD CONSTRAINT leads_status_check CHECK (
  status IN (
    'new', 
    'to_contact', 
    'contacted', 
    'files_sent', 
    'interested', 
    'presenting', 
    'negotiating', 
    'contract_sent', 
    'won', 
    'lost', 
    'frozen'
  )
);

-- 4. Habilitar RLS
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;

-- 5. Políticas RLS
-- Admins, Ventas y C-Level pueden ver todos los leads
DROP POLICY IF EXISTS "Full access for authorized roles" ON leads;
CREATE POLICY "Full access for authorized roles" ON leads
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND (
        profiles.role = 'admin' 
        OR profiles.department IN ('sales', 'c_level', 'marketing')
      )
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND (
        profiles.role = 'admin' 
        OR profiles.department IN ('sales', 'c_level', 'marketing')
      )
    )
  );

-- Permitir lectura si el lead está asignado al usuario (aunque no sea de ventas)
DROP POLICY IF EXISTS "View assigned leads" ON leads;
CREATE POLICY "View assigned leads" ON leads
  FOR SELECT
  USING (assigned_to = auth.uid());

-- Permitir actualización si el lead está asignado al usuario
DROP POLICY IF EXISTS "Update assigned leads" ON leads;
CREATE POLICY "Update assigned leads" ON leads
  FOR UPDATE
  USING (assigned_to = auth.uid());

-- 6. Índices
CREATE INDEX IF NOT EXISTS idx_leads_status ON leads(status);
CREATE INDEX IF NOT EXISTS idx_leads_assigned_to ON leads(assigned_to);
CREATE INDEX IF NOT EXISTS idx_leads_created_at ON leads(created_at);

-- 7. Comentarios
COMMENT ON TABLE leads IS 'Pipeline de ventas y gestión de prospectos';
COMMENT ON COLUMN leads.status IS 'Estado del lead en el Kanban';

-- 8. Datos de prueba (Opcional, comentar si no se desea)
INSERT INTO leads (company_name, contact_name, status, urgency, assistant_type)
VALUES 
('Tech Corp', 'John Doe', 'new', 'high', 'desarrollo_web'),
('Marketing Agency', 'Jane Smith', 'to_contact', 'medium', 'marketing_digital'),
('Law Firm', 'Mike Ross', 'contacted', 'low', 'administrativo'),
('E-commerce Start', 'Sarah Connor', 'files_sent', 'urgent', 'ventas_ecommerce')
ON CONFLICT DO NOTHING;
</file>

<file path="setup-roles-v2.sql">
-- =========================================================================
-- SCRIPT DE CONFIGURACIÓN DE ROLES V2 (PERSONAS ESPECÍFICAS)
-- =========================================================================

-- 1. DEPARTAMENTO DE IA (ADMINISTRADOR SUPREMO)
-- Observador total, no genera reportes.
UPDATE public.profiles
SET 
  full_name = 'Departamento de IA',
  department = 'automation',
  position = 'director', -- Para tener acceso top
  role = 'admin',
  avatar_url = null
WHERE email = 'admin@globaltalent.com';

-- 2. ARIEL JIMENEZ (DIRECTOR DE AUTOMATIZACIONES)
-- Usuario Operativo: Genera reportes.
-- Primero, aseguramos que exista el usuario en profiles si ya está en auth.users
-- o lo actualizamos si ya existe.
INSERT INTO public.profiles (id, email, full_name, department, position, role)
SELECT 
  id, 
  email, 
  'Ariel Jimenez', 
  'automation', 
  'director', 
  'user' -- Rol 'user' para que flow normal de reportes aplique, pero con permisos de director
FROM auth.users 
WHERE email = 'ariel@globaltalent.com'
ON CONFLICT (id) DO UPDATE
SET 
  full_name = 'Ariel Jimenez',
  department = 'automation',
  position = 'director',
  role = 'user';

-- 3. EQUIPO CALIDAD (SUPERVISOR)
UPDATE public.profiles
SET 
  full_name = 'Equipo Calidad',
  department = 'quality',
  position = 'manager',
  role = 'admin'
WHERE email = 'quality@globaltalent.com';
</file>

<file path="setup-usuario-prueba.sql">
-- =====================================================
-- CONFIGURAR USUARIO DE PRUEBA
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- IMPORTANTE: 
-- 1. Asegúrate de que tu usuario admin ya existe en auth.users con email: arieljimenez.work@globaltalent.com
-- 2. Si necesitas cambiar el email, ve a Authentication → Users → Update User

-- =====================================================
-- ASOCIAR TU USUARIO ADMIN COMO ASISTENTE TAMBIÉN
-- (Para que puedas crear reportes)
-- =====================================================

DO $$
DECLARE
  v_user_id UUID;
  v_email TEXT := 'arieljimenez.work@globaltalent.com';
BEGIN
  -- Obtener el user_id del email
  SELECT id INTO v_user_id 
  FROM auth.users 
  WHERE email = v_email;
  
  IF v_user_id IS NULL THEN
    RAISE EXCEPTION 'Usuario no encontrado con email: %. Primero asegúrate de que existe en Authentication → Users', v_email;
  END IF;
  
  -- Verificar que existe en profiles (debe existir si eres admin)
  IF NOT EXISTS (SELECT 1 FROM profiles WHERE id = v_user_id) THEN
    -- Si no existe, crearlo
    INSERT INTO profiles (id, email, full_name, role)
    VALUES (v_user_id, v_email, 'Ariel Jimenez', 'admin')
    ON CONFLICT (id) DO NOTHING;
  END IF;
  
  -- Crear registro en assistants si no existe
  INSERT INTO assistants (
    id,
    user_id,
    full_name,
    email,
    status,
    position,
    created_at,
    updated_at
  )
  VALUES (
    gen_random_uuid(),
    v_user_id,
    'Ariel Jimenez',
    v_email,
    'activo',
    'Admin/Desarrollador',
    NOW(),
    NOW()
  )
  ON CONFLICT (user_id) DO UPDATE
  SET status = 'activo',
      updated_at = NOW();
  
  RAISE NOTICE '✅ Tu usuario admin ahora también está asociado como asistente!';
  RAISE NOTICE '   Email: %', v_email;
  RAISE NOTICE '   Ahora puedes crear reportes semanales y mensuales';
END $$;
</file>

<file path="src/app/(dashboard)/asistentes/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function AssistantsPage() {
    return (
        <ComingSoon
            title="Directorio de Asistentes"
            description="Base de datos completa de asistentes activos, perfiles y asignaciones."
        />
    );
}
</file>

<file path="src/app/(dashboard)/banco-talento/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function TalentPoolPage() {
    return (
        <ComingSoon
            title="Banco de Talento"
            description="Repositorio de perfiles calificados listos para asignación."
        />
    );
}
</file>

<file path="src/app/(dashboard)/calendario-global/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function GlobalCalendarPage() {
    return (
        <ComingSoon
            title="Calendario Global"
            description="Vista unificada de eventos, entrevistas y fechas límite de toda la organización."
        />
    );
}
</file>

<file path="src/app/(dashboard)/calendario/page.tsx">
import { Calendar } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export default function CalendarPage() {
    return (
        <div className="flex min-h-[50vh] flex-col items-center justify-center p-4">
            <Card className="w-full max-w-md border-slate-800 bg-slate-900/50 backdrop-blur text-center">
                <CardHeader>
                    <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-xl bg-blue-500/10">
                        <Calendar className="h-6 w-6 text-blue-400" />
                    </div>
                    <CardTitle className="text-xl font-semibold text-white">
                        Calendario
                    </CardTitle>
                </CardHeader>
                <CardContent>
                    <p className="text-slate-400">
                        El módulo de calendario está en desarrollo. Pronto podrás ver tus entrevistas y fechas de reporte aquí.
                    </p>
                </CardContent>
            </Card>
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/calidad/page.tsx">
import { Suspense } from 'react';
import Link from 'next/link';
import {
  AlertTriangle,
  FileText,
  Users,
  TrendingUp,
  Clock,
  CheckCircle2,
  XCircle,
  ChevronRight,
  Filter,
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { cn } from '@/lib/utils';

// Datos de ejemplo para el dashboard de calidad
const qualityMetrics = {
  totalPending: 6,
  deliveredThisWeek: 18,
  avgPerformance: 8.4,
  alertsActive: 4,
};

// Alertas activas de ejemplo
const activeAlerts = [
  {
    id: '1',
    assistant: 'María García',
    type: 'reporte_pendiente',
    message: 'No ha entregado su reporte semanal',
    daysOverdue: 3,
    priority: 'alta',
  },
  {
    id: '2',
    assistant: 'Carlos Ruiz',
    type: 'bajo_rendimiento',
    message: 'Performance bajo el promedio por 2 semanas',
    score: 5.2,
    priority: 'media',
  },
  {
    id: '3',
    assistant: 'Ana López',
    type: 'reporte_pendiente',
    message: 'Reporte incompleto - faltan gastos',
    daysOverdue: 1,
    priority: 'baja',
  },
];

// Reportes recientes de ejemplo
const recentReports = [
  {
    id: '1',
    assistant: 'Pedro Sánchez',
    week: '13 - 19 Ene',
    status: 'revisado',
    score: 9.2,
    submittedAt: 'Hace 2 horas',
  },
  {
    id: '2',
    assistant: 'Laura Méndez',
    week: '13 - 19 Ene',
    status: 'entregado',
    score: null,
    submittedAt: 'Hace 4 horas',
  },
  {
    id: '3',
    assistant: 'Juan Torres',
    week: '13 - 19 Ene',
    status: 'aprobado',
    score: 8.7,
    submittedAt: 'Ayer',
  },
  {
    id: '4',
    assistant: 'Sofia Herrera',
    week: '13 - 19 Ene',
    status: 'pendiente',
    score: null,
    submittedAt: '-',
  },
];

const statusConfig = {
  pendiente: { label: 'Pendiente', variant: 'warning' as const },
  entregado: { label: 'Entregado', variant: 'info' as const },
  revisado: { label: 'Revisado', variant: 'default' as const },
  aprobado: { label: 'Aprobado', variant: 'success' as const },
};

const priorityConfig = {
  baja: { label: 'Baja', color: 'text-slate-400' },
  media: { label: 'Media', color: 'text-amber-400' },
  alta: { label: 'Alta', color: 'text-red-400' },
  critica: { label: 'Crítica', color: 'text-red-500' },
};

export default function CalidadPage() {
  return (
    <div className="page-container page-enter">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="page-title">Dashboard de Calidad</h1>
          <p className="page-description">
            Monitorea reportes, alertas y rendimiento del equipo
          </p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" size="sm">
            <Filter className="h-4 w-4 mr-2" />
            Filtrar
          </Button>
          <Button asChild>
            <Link href="/calidad/reportes">
              Ver todos los reportes
              <ChevronRight className="h-4 w-4 ml-1" />
            </Link>
          </Button>
        </div>
      </div>

      {/* Métricas principales */}
      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-8">
        {/* Reportes Pendientes */}
        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium text-slate-400">
              Reportes Pendientes
            </CardTitle>
            <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-amber-500/20">
              <Clock className="h-4 w-4 text-amber-400" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-white">
              {qualityMetrics.totalPending}
            </div>
            <p className="text-xs text-slate-400">de esta semana</p>
          </CardContent>
        </Card>

        {/* Entregados */}
        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium text-slate-400">
              Entregados
            </CardTitle>
            <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-500/20">
              <CheckCircle2 className="h-4 w-4 text-emerald-400" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-white">
              {qualityMetrics.deliveredThisWeek}
            </div>
            <p className="text-xs text-emerald-400">+3 vs semana anterior</p>
          </CardContent>
        </Card>

        {/* Performance Promedio */}
        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium text-slate-400">
              Performance Promedio
            </CardTitle>
            <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-500/20">
              <TrendingUp className="h-4 w-4 text-blue-400" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-white">
              {qualityMetrics.avgPerformance}
              <span className="text-sm font-normal text-slate-500">/10</span>
            </div>
            <p className="text-xs text-emerald-400">+0.3 vs mes anterior</p>
          </CardContent>
        </Card>

        {/* Alertas Activas */}
        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium text-slate-400">
              Alertas Activas
            </CardTitle>
            <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-red-500/20">
              <AlertTriangle className="h-4 w-4 text-red-400" />
            </div>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-white">
              {qualityMetrics.alertsActive}
            </div>
            <p className="text-xs text-amber-400">2 de alta prioridad</p>
          </CardContent>
        </Card>
      </div>

      {/* Sección de Alertas y Reportes */}
      <div className="grid gap-6 lg:grid-cols-2">
        {/* Alertas activas */}
        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader className="flex flex-row items-center justify-between">
            <CardTitle className="flex items-center gap-2 text-lg">
              <AlertTriangle className="h-5 w-5 text-amber-400" />
              Alertas Activas
            </CardTitle>
            <Badge variant="warning">{activeAlerts.length}</Badge>
          </CardHeader>
          <CardContent className="space-y-3">
            {activeAlerts.map((alert) => (
              <div
                key={alert.id}
                className="flex items-start gap-3 rounded-lg border border-slate-800 bg-slate-800/30 p-4 hover:bg-slate-800/50 transition-colors cursor-pointer"
              >
                <div
                  className={cn(
                    'mt-1 h-2 w-2 rounded-full shrink-0',
                    alert.priority === 'alta' && 'bg-red-400',
                    alert.priority === 'media' && 'bg-amber-400',
                    alert.priority === 'baja' && 'bg-slate-400'
                  )}
                />
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <p className="text-sm font-medium text-white">
                      {alert.assistant}
                    </p>
                    <span
                      className={cn(
                        'text-xs',
                        priorityConfig[alert.priority as keyof typeof priorityConfig]?.color
                      )}
                    >
                      • {priorityConfig[alert.priority as keyof typeof priorityConfig]?.label}
                    </span>
                  </div>
                  <p className="text-xs text-slate-400">{alert.message}</p>
                  {alert.daysOverdue && (
                    <p className="text-xs text-red-400 mt-1">
                      {alert.daysOverdue} días de retraso
                    </p>
                  )}
                  {alert.score && (
                    <p className="text-xs text-amber-400 mt-1">
                      Score: {alert.score}/10
                    </p>
                  )}
                </div>
                <ChevronRight className="h-4 w-4 text-slate-500" />
              </div>
            ))}

            <Button variant="ghost" className="w-full mt-2" asChild>
              <Link href="/calidad/alertas">Ver todas las alertas</Link>
            </Button>
          </CardContent>
        </Card>

        {/* Reportes recientes */}
        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader className="flex flex-row items-center justify-between">
            <CardTitle className="flex items-center gap-2 text-lg">
              <FileText className="h-5 w-5 text-blue-400" />
              Reportes Recientes
            </CardTitle>
            <Button variant="ghost" size="sm" asChild>
              <Link href="/calidad/reportes">Ver todos</Link>
            </Button>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {recentReports.map((report) => (
                <Link
                  key={report.id}
                  href={`/calidad/reportes/${report.id}`}
                  className="flex items-center gap-3 rounded-lg border border-slate-800 bg-slate-800/30 p-3 hover:bg-slate-800/50 transition-colors"
                >
                  <div className="flex h-10 w-10 items-center justify-center rounded-full bg-slate-700/50 text-sm font-medium text-white">
                    {report.assistant.split(' ').map((n) => n[0]).join('')}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium text-white truncate">
                      {report.assistant}
                    </p>
                    <p className="text-xs text-slate-400">
                      Semana {report.week}
                    </p>
                  </div>
                  <div className="text-right">
                    <Badge
                      variant={statusConfig[report.status as keyof typeof statusConfig]?.variant}
                    >
                      {statusConfig[report.status as keyof typeof statusConfig]?.label}
                    </Badge>
                    {report.score && (
                      <p className="text-xs text-slate-400 mt-1">
                        {report.score}/10
                      </p>
                    )}
                  </div>
                </Link>
              ))}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/candidatos/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function CandidatesPage() {
    return (
        <ComingSoon
            title="Pipeline de Candidatos"
            description="Seguimiento de postulantes, estados de entrevistas y evaluaciones."
        />
    );
}
</file>

<file path="src/app/(dashboard)/clientes/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function ClientsPage() {
    return (
        <ComingSoon
            title="Cartera de Clientes"
            description="Visualiza y administra la información de clientes activos y sus asistentes asignados."
        />
    );
}
</file>

<file path="src/app/(dashboard)/configuracion/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function SettingsPage() {
    return (
        <ComingSoon
            title="Configuración"
            description="Ajustes del sistema, usuarios y preferencias de la plataforma."
        />
    );
}
</file>

<file path="src/app/(dashboard)/entrevistas/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function InterviewsPage() {
    return (
        <ComingSoon
            title="Dashboard de Entrevistas"
            description="Centro de control para entrevistas activas, grabaciones y resultados de IA."
        />
    );
}
</file>

<file path="src/app/(dashboard)/leads/page.tsx">
import KanbanBoard from '@/components/leads/KanbanBoard';
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { Lead } from '@/types/database.types';

export default async function LeadsPage() {
    const supabase = createServerComponentClient({ cookies });

    const { data: leads } = await supabase
        .from('leads')
        .select('*')
        .order('created_at', { ascending: false });

    return (
        <div className="h-full flex flex-col">
            <div className="mb-6 px-2">
                <h1 className="text-3xl font-bold tracking-tight">Gestión de Leads</h1>
                <p className="text-muted-foreground">
                    Gestiona el pipeline de ventas, estados y seguimientos de prospectos.
                </p>
            </div>

            <KanbanBoard initialLeads={(leads as Lead[]) || []} />
        </div>
    );
}
</file>

<file path="src/app/(dashboard)/marketing/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function MarketingPage() {
    return (
        <ComingSoon
            title="Marketing & LinkedIn"
            description="Gestión de campañas, publicaciones y métricas de engagement."
        />
    );
}
</file>

<file path="src/app/(dashboard)/metricas/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function MetricsPage() {
    return (
        <ComingSoon
            title="Métricas de Equipo"
            description="KPIs detallados de rendimiento y productividad por departamento."
        />
    );
}
</file>

<file path="src/app/(dashboard)/panel-ejecutivo/page.tsx">
import ComingSoon from '@/components/shared/ComingSoon';

export default function ExecutivePanelPage() {
    return (
        <ComingSoon
            title="Panel Ejecutivo"
            description="Métricas de alto nivel y reportes estratégicos para dirección."
        />
    );
}
</file>

<file path="src/app/(dashboard)/perfil/page.tsx">
import { redirect } from 'next/navigation';
import { createServerSupabaseClient, getServerUser } from '@/lib/supabase/server';
import { AssistantProfileForm } from '@/components/profile/AssistantProfileForm';

// =====================================================
// PÁGINA: /perfil
// Perfil completo del asistente
// =====================================================

export default async function ProfilePage() {
  const supabase = createServerSupabaseClient();
  const user = await getServerUser();

  if (!user) {
    redirect('/login');
  }

  // Obtener perfil del usuario
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (!profile) {
    redirect('/login');
  }

  // Obtener datos del asistente
  const { data: assistant } = await supabase
    .from('assistants')
    .select(`
      *,
      client:clients (
        id,
        name
      )
    `)
    .eq('user_id', user.id)
    .single();

  // Si no existe registro de asistente, crear uno básico
  if (!assistant) {
    const { data: newAssistant, error } = await supabase
      .from('assistants')
      .insert({
        user_id: user.id,
        full_name: profile.full_name || user.email?.split('@')[0] || 'Usuario',
        email: user.email || '',
        status: 'activo',
      })
      .select()
      .single();

    if (error) {
      console.error('Error creating assistant:', error);
    }

    // Recargar para obtener el nuevo registro
    return (
      <div className="min-h-screen bg-slate-950 p-6">
        <div className="max-w-4xl mx-auto">
          <h1 className="text-2xl font-bold text-white mb-6">Mi Perfil</h1>
          <AssistantProfileForm
            assistantId={newAssistant?.id || ''}
            initialData={newAssistant || undefined}
          />
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-950 p-6">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-2xl font-bold text-white">Mi Perfil</h1>
          <p className="text-slate-400 mt-1">
            Actualiza tu información personal, habilidades y objetivos
          </p>
        </div>

        {/* Formulario */}
        <AssistantProfileForm
          assistantId={assistant.id}
          initialData={assistant}
          clientName={assistant.client?.name}
        />
      </div>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/reportes/nuevo/page.tsx">
// =====================================================
// /reportes/nuevo - Página para crear/editar reporte
// =====================================================

import { Suspense } from 'react';
import { getOrCreateCurrentWeekSubmission, getCatalogs } from '@/lib/actions/reports';
import { WeeklyReportForm } from '@/components/reportes/WeeklyReportForm';
import { Loader2, AlertCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

export const dynamic = 'force-dynamic';
export const metadata = {
    title: 'Nuevo Reporte | Global Talent Platform',
    description: 'Carga tu reporte semanal con Plan GTC y Rupturas de Valor',
};

function LoadingState() {
    return (
        <div className="flex items-center justify-center min-h-[400px]">
            <div className="text-center">
                <Loader2 className="h-8 w-8 animate-spin text-emerald-500 mx-auto mb-4" />
                <p className="text-slate-400">Cargando formulario...</p>
            </div>
        </div>
    );
}

// Params tipo Promise para Next.js 15
type PageProps = {
    searchParams: Promise<{ week?: string }>;
}

async function NewReportContent({ week }: { week?: string }) {
    const [submissionResult, catalogsResult] = await Promise.all([
        getOrCreateCurrentWeekSubmission(week),
        getCatalogs(),
    ]);

    if (!submissionResult.success || !submissionResult.data) {
        return (
            <div className="flex items-center justify-center min-h-[400px]">
                <div className="text-center max-w-md p-6 rounded-lg bg-slate-900/50 border border-slate-800">
                    <div className="flex h-16 w-16 items-center justify-center rounded-full bg-red-500/20 mx-auto mb-4">
                        <AlertCircle className="h-8 w-8 text-red-400" />
                    </div>
                    <h2 className="text-xl font-semibold text-slate-100 mb-2">
                        No se pudo cargar el reporte
                    </h2>
                    <p className="text-slate-400 mb-6">
                        {submissionResult.error ?? 'Ocurrió un error al intentar crear o recuperar el reporte.'}
                    </p>
                    <Button asChild variant="outline">
                        <Link href="/reportes">Volver a mis reportes</Link>
                    </Button>
                </div>
            </div>
        );
    }

    const catalogs = catalogsResult.success ? catalogsResult.data : { departments: [], companyValues: [] };

    return (
        <WeeklyReportForm
            submission={submissionResult.data}
            departments={catalogs?.departments ?? []}
            companyValues={catalogs?.companyValues ?? []}
        />
    );
}

export default async function NewReportPage({ searchParams }: PageProps) {
    const resolvedParams = await searchParams;
    const week = resolvedParams.week;

    return (
        <div className="container max-w-4xl py-6">
            <Suspense fallback={<LoadingState />}>
                <NewReportContent week={week} />
            </Suspense>
        </div>
    );
}
</file>

<file path="src/app/api/ai/improve-entry/route.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { cookies } from 'next/headers';
import { NextResponse } from 'next/server';
import { improveEntryWithGemini } from '@/lib/ai/gemini';
import type { Database } from '@/types/database.types';

export const dynamic = 'force-dynamic';

export async function POST(request: Request) {
    try {
        const cookieStore = cookies();

        // 1. Crear cliente Supabase (SSR)
        const supabase = createServerClient<Database>(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
            {
                cookies: {
                    getAll() {
                        return cookieStore.getAll();
                    },
                    setAll(cookiesToSet) {
                        try {
                            cookiesToSet.forEach(({ name, value, options }) =>
                                cookieStore.set(name, value, options)
                            );
                        } catch {
                            // The `setAll` method was called from a Server Component.
                            // This can be ignored if you have middleware refreshing
                            // user sessions.
                        }
                    },
                },
            }
        );

        // 2. Verificar sesión
        const { data: { user }, error } = await supabase.auth.getUser();

        if (error || !user) {
            console.error('AI Entry Route Auth Error:', error);
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // 3. Procesar Request
        const body = await request.json();
        const { entry, type } = body;

        if (!entry || !type) {
            return NextResponse.json({ error: 'Missing entry or type' }, { status: 400 });
        }

        // 4. Llamar a Gemini (Entry Level)
        const improvedEntry = await improveEntryWithGemini(entry, type);

        return NextResponse.json({ improvedEntry });

    } catch (error) {
        console.error('AI Entry Endpoint Error:', error);
        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });
    }
}
</file>

<file path="src/app/api/interviews/create/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';
import { z } from 'zod';

// =====================================================
// CONFIGURACIÓN
// =====================================================

// Token de expiración: 72 horas
const TOKEN_EXPIRATION_HOURS = 72;

// API Key para autenticar requests de n8n
// En producción, esto debería estar en una variable de entorno
const API_KEY = process.env.INTERVIEWS_API_KEY || 'gt-interviews-api-key-change-me';

// =====================================================
// VALIDACIÓN DEL REQUEST
// =====================================================

const createInterviewSchema = z.object({
  email: z.string().email('Email inválido'),
  candidate_name: z.string().min(2, 'Nombre requerido'),
  phone: z.string().optional(),
  job_position_id: z.string().uuid('ID de puesto inválido'),
  initial_score: z.number().min(0).max(100).optional(),
  initial_analysis: z.record(z.unknown()).optional(),
  cv_url: z.string().url().optional().or(z.literal('')),
  video_url: z.string().url().optional().or(z.literal('')),
  zoho_candidate_id: z.string().optional(),
  zoho_application_id: z.string().optional(),
});

// =====================================================
// HANDLER
// =====================================================

export async function POST(request: NextRequest) {
  try {
    // =====================================================
    // 1. VERIFICAR API KEY
    // =====================================================
    const authHeader = request.headers.get('Authorization');
    const apiKey = authHeader?.replace('Bearer ', '');
    
    if (!apiKey || apiKey !== API_KEY) {
      return NextResponse.json(
        { success: false, error: 'API Key inválida o faltante' },
        { status: 401 }
      );
    }

    // =====================================================
    // 2. PARSEAR Y VALIDAR BODY
    // =====================================================
    let body: unknown;
    try {
      body = await request.json();
    } catch {
      return NextResponse.json(
        { success: false, error: 'Body JSON inválido' },
        { status: 400 }
      );
    }

    const validation = createInterviewSchema.safeParse(body);
    if (!validation.success) {
      return NextResponse.json(
        { 
          success: false, 
          error: 'Datos inválidos',
          details: validation.error.errors 
        },
        { status: 400 }
      );
    }

    const data = validation.data;

    // =====================================================
    // 3. CONECTAR A SUPABASE (Admin para bypass RLS)
    // =====================================================
    const supabase = createAdminClient();

    // =====================================================
    // 4. VERIFICAR QUE EL JOB_POSITION EXISTE Y ESTÁ ABIERTO
    // =====================================================
    const { data: jobPosition, error: jobError } = await supabase
      .from('job_positions')
      .select('id, title, status, elevenlabs_agent_id, client_id')
      .eq('id', data.job_position_id)
      .single();

    if (jobError || !jobPosition) {
      return NextResponse.json(
        { success: false, error: 'Puesto de trabajo no encontrado' },
        { status: 404 }
      );
    }

    if (jobPosition.status !== 'open') {
      return NextResponse.json(
        { success: false, error: 'Este puesto ya no está abierto' },
        { status: 400 }
      );
    }

    // =====================================================
    // 5. BUSCAR O CREAR CANDIDATO
    // =====================================================
    let candidateId: string;

    // Buscar por email
    const { data: existingCandidate } = await supabase
      .from('candidates')
      .select('id')
      .eq('email', data.email.toLowerCase())
      .single();

    if (existingCandidate) {
      candidateId = existingCandidate.id;
      
      // Actualizar datos si hay nuevos
      await supabase
        .from('candidates')
        .update({
          full_name: data.candidate_name,
          phone: data.phone || null,
          cv_url: data.cv_url || null,
          video_url: data.video_url || null,
          zoho_candidate_id: data.zoho_candidate_id || null,
        })
        .eq('id', candidateId);
    } else {
      // Crear nuevo candidato
      const { data: newCandidate, error: createCandidateError } = await supabase
        .from('candidates')
        .insert({
          email: data.email.toLowerCase(),
          full_name: data.candidate_name,
          phone: data.phone || null,
          cv_url: data.cv_url || null,
          video_url: data.video_url || null,
          zoho_candidate_id: data.zoho_candidate_id || null,
          source: 'form',
        })
        .select('id')
        .single();

      if (createCandidateError || !newCandidate) {
        console.error('Error creating candidate:', createCandidateError);
        return NextResponse.json(
          { success: false, error: 'Error al crear candidato' },
          { status: 500 }
        );
      }

      candidateId = newCandidate.id;
    }

    // =====================================================
    // 6. BUSCAR O CREAR APPLICATION
    // =====================================================
    let applicationId: string;

    // Verificar si ya aplicó a este puesto
    const { data: existingApplication } = await supabase
      .from('applications')
      .select('id, status')
      .eq('candidate_id', candidateId)
      .eq('job_position_id', data.job_position_id)
      .single();

    if (existingApplication) {
      applicationId = existingApplication.id;
      
      // Verificar que no esté en un estado avanzado
      const advancedStatuses = ['bot_completed', 'approved_for_human', 'human_scheduled', 'human_completed', 'offer', 'hired'];
      if (advancedStatuses.includes(existingApplication.status)) {
        return NextResponse.json(
          { 
            success: false, 
            error: 'Este candidato ya completó el proceso para este puesto' 
          },
          { status: 400 }
        );
      }

      // Actualizar application
      await supabase
        .from('applications')
        .update({
          initial_score: data.initial_score || null,
          initial_analysis: data.initial_analysis || null,
          status: 'approved_for_bot',
          zoho_application_id: data.zoho_application_id || null,
        })
        .eq('id', applicationId);
    } else {
      // Crear nueva application
      const { data: newApplication, error: createAppError } = await supabase
        .from('applications')
        .insert({
          candidate_id: candidateId,
          job_position_id: data.job_position_id,
          initial_score: data.initial_score || null,
          initial_analysis: data.initial_analysis || null,
          status: 'approved_for_bot',
          zoho_application_id: data.zoho_application_id || null,
        })
        .select('id')
        .single();

      if (createAppError || !newApplication) {
        console.error('Error creating application:', createAppError);
        return NextResponse.json(
          { success: false, error: 'Error al crear aplicación' },
          { status: 500 }
        );
      }

      applicationId = newApplication.id;
    }

    // =====================================================
    // 7. VERIFICAR SI YA EXISTE UNA ENTREVISTA VÁLIDA
    // =====================================================
    const { data: existingInterview } = await supabase
      .from('interviews')
      .select('id, token, status, expires_at')
      .eq('application_id', applicationId)
      .in('status', ['pending', 'in_progress'])
      .gt('expires_at', new Date().toISOString())
      .single();

    if (existingInterview) {
      // Ya tiene una entrevista válida, devolver ese link
      const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://globaltalent.com';
      
      return NextResponse.json({
        success: true,
        data: {
          interview_id: existingInterview.id,
          candidate_id: candidateId,
          application_id: applicationId,
          token: existingInterview.token,
          link: `${baseUrl}/entrevista/${existingInterview.token}`,
          expires_at: existingInterview.expires_at,
        },
        message: 'Ya existía una entrevista pendiente',
      });
    }

    // =====================================================
    // 8. CREAR NUEVA ENTREVISTA
    // =====================================================
    const expiresAt = new Date();
    expiresAt.setHours(expiresAt.getHours() + TOKEN_EXPIRATION_HOURS);

    const { data: newInterview, error: createInterviewError } = await supabase
      .from('interviews')
      .insert({
        application_id: applicationId,
        status: 'pending',
        expires_at: expiresAt.toISOString(),
        elevenlabs_agent_id: jobPosition.elevenlabs_agent_id || process.env.ELEVENLABS_DEFAULT_AGENT_ID,
      })
      .select('id, token, expires_at')
      .single();

    if (createInterviewError || !newInterview) {
      console.error('Error creating interview:', createInterviewError);
      return NextResponse.json(
        { success: false, error: 'Error al crear entrevista' },
        { status: 500 }
      );
    }

    // =====================================================
    // 9. RESPONDER CON EL LINK
    // =====================================================
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://globaltalent.com';

    return NextResponse.json({
      success: true,
      data: {
        interview_id: newInterview.id,
        candidate_id: candidateId,
        application_id: applicationId,
        token: newInterview.token,
        link: `${baseUrl}/entrevista/${newInterview.token}`,
        expires_at: newInterview.expires_at,
      },
    });

  } catch (error) {
    console.error('Unexpected error in create interview:', error);
    return NextResponse.json(
      { success: false, error: 'Error interno del servidor' },
      { status: 500 }
    );
  }
}

// =====================================================
// MÉTODO GET PARA VERIFICAR QUE EL ENDPOINT EXISTE
// =====================================================
export async function GET() {
  return NextResponse.json({
    status: 'ok',
    endpoint: '/api/interviews/create',
    method: 'POST',
    description: 'Crear una nueva entrevista para un candidato',
    required_headers: {
      'Authorization': 'Bearer {API_KEY}',
      'Content-Type': 'application/json',
    },
    body_schema: {
      email: 'string (required)',
      candidate_name: 'string (required)',
      job_position_id: 'uuid (required)',
      phone: 'string (optional)',
      initial_score: 'number 0-100 (optional)',
      initial_analysis: 'object (optional)',
      cv_url: 'string url (optional)',
      video_url: 'string url (optional)',
      zoho_candidate_id: 'string (optional)',
      zoho_application_id: 'string (optional)',
    },
  });
}
</file>

<file path="src/app/api/interviews/register-conversation/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';

// =====================================================
// POST /api/interviews/register-conversation
// Guarda el conversation_id de ElevenLabs cuando el usuario conecta.
// Así el webhook de ElevenLabs puede encontrar la entrevista por conversation_id.
// =====================================================

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { token, conversation_id } = body;

    if (!token || !conversation_id) {
      return NextResponse.json(
        { success: false, error: 'token y conversation_id requeridos' },
        { status: 400 }
      );
    }

    const supabase = createAdminClient();

    const { data, error } = await supabase
      .from('interviews')
      .update({
        elevenlabs_conversation_id: conversation_id,
        updated_at: new Date().toISOString(),
      })
      .eq('token', token)
      .eq('status', 'in_progress')
      .select('id')
      .single();

    if (error || !data) {
      console.warn('register-conversation: no se encontró entrevista in_progress con token', {
        error: error?.message,
      });
      return NextResponse.json(
        { success: false, error: 'Entrevista no encontrada o no está en progreso' },
        { status: 404 }
      );
    }

    console.log('[INDEX 2] conversation_id registrado para entrevista:', data.id);
    return NextResponse.json({ success: true, interview_id: data.id });
  } catch (error) {
    console.error('Unexpected error in register-conversation:', error);
    return NextResponse.json(
      { success: false, error: 'Error interno' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/interviews/start/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';

// =====================================================
// POST /api/interviews/start
// Marca la entrevista como iniciada (quema el token)
// =====================================================

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { token, user_agent } = body;

    if (!token) {
      return NextResponse.json(
        { success: false, error: 'Token requerido' },
        { status: 400 }
      );
    }

    const supabase = createAdminClient();

    // Obtener IP del request
    const forwarded = request.headers.get('x-forwarded-for');
    const ip = forwarded ? forwarded.split(',')[0] : request.headers.get('x-real-ip') || null;

    // Llamar a la función de PostgreSQL
    const { data, error } = await supabase
      .rpc('start_interview', {
        p_token: token,
        p_user_agent: user_agent || null,
        p_ip: ip,
      });

    if (error) {
      console.error('Error starting interview:', error);
      return NextResponse.json(
        { success: false, error: 'Error al iniciar entrevista' },
        { status: 500 }
      );
    }

    const result = data?.[0];

    if (!result?.success) {
      return NextResponse.json(
        { success: false, error: result?.error_message || 'Token inválido' },
        { status: 400 }
      );
    }

    return NextResponse.json({
      success: true,
      data: {
        interview_id: result.interview_id,
      },
    });

  } catch (error) {
    console.error('Unexpected error:', error);
    return NextResponse.json(
      { success: false, error: 'Error interno' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/entrevista/[token]/TokenInvalido.tsx">
'use client';

// =====================================================
// TOKEN INVÁLIDO - Pantalla de error
// =====================================================

import { AlertCircle, Clock, CheckCircle2, XCircle } from 'lucide-react';
import { cn } from '@/lib/utils';

interface TokenInvalidoProps {
  reason: 'expired' | 'used' | 'invalid' | 'error';
  message: string;
}

const reasonConfig = {
  expired: {
    icon: Clock,
    title: 'Enlace expirado',
    description: 'El tiempo para realizar la entrevista ha finalizado.',
    color: 'text-amber-400',
    bgColor: 'bg-amber-500/20',
    borderColor: 'border-amber-500/30',
  },
  used: {
    icon: CheckCircle2,
    title: 'Entrevista ya completada',
    description: 'Ya has completado esta entrevista anteriormente.',
    color: 'text-emerald-400',
    bgColor: 'bg-emerald-500/20',
    borderColor: 'border-emerald-500/30',
  },
  invalid: {
    icon: XCircle,
    title: 'Enlace no válido',
    description: 'Este enlace de entrevista no existe o ha sido revocado.',
    color: 'text-red-400',
    bgColor: 'bg-red-500/20',
    borderColor: 'border-red-500/30',
  },
  error: {
    icon: AlertCircle,
    title: 'Error técnico',
    description: 'Hubo un problema al verificar tu enlace.',
    color: 'text-slate-400',
    bgColor: 'bg-slate-500/20',
    borderColor: 'border-slate-500/30',
  },
};

export function TokenInvalido({ reason, message }: TokenInvalidoProps) {
  const config = reasonConfig[reason];
  const Icon = config.icon;

  return (
    <main className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
      <div className="w-full max-w-md">
        {/* Logo */}
        <div className="flex justify-center mb-8">
          <div className="flex h-14 w-14 items-center justify-center rounded-xl bg-emerald-500 shadow-lg shadow-emerald-500/20">
            <span className="text-xl font-bold text-white">GT</span>
          </div>
        </div>

        {/* Card */}
        <div className={cn(
          'rounded-2xl border p-8 text-center',
          config.bgColor,
          config.borderColor
        )}>
          {/* Icon */}
          <div className={cn(
            'mx-auto flex h-16 w-16 items-center justify-center rounded-full mb-6',
            config.bgColor
          )}>
            <Icon className={cn('h-8 w-8', config.color)} />
          </div>

          {/* Title */}
          <h1 className="text-2xl font-semibold text-white mb-2">
            {config.title}
          </h1>

          {/* Description */}
          <p className="text-slate-400 mb-4">
            {config.description}
          </p>

          {/* Message */}
          {message && message !== config.description && (
            <p className={cn('text-sm', config.color)}>
              {message}
            </p>
          )}
        </div>

        {/* Footer */}
        <div className="mt-8 text-center">
          <p className="text-sm text-slate-500">
            Si crees que esto es un error, contacta al equipo de reclutamiento.
          </p>
          <p className="text-sm text-slate-600 mt-2">
            © {new Date().getFullYear()} Global Talent Platform
          </p>
        </div>
      </div>
    </main>
  );
}
</file>

<file path="src/components/calidad/QualityScoreBar.tsx">
'use client';

import { cn } from '@/lib/utils';

// =====================================================
// QUALITY SCORE BAR
// Barra de calificación: rojo → amarillo → verde
// =====================================================

interface QualityScoreBarProps {
  score: number; // 0-100
  showLabel?: boolean;
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

export function QualityScoreBar({
  score,
  showLabel = true,
  size = 'md',
  className,
}: QualityScoreBarProps) {
  // Clamp score entre 0 y 100
  const clampedScore = Math.min(100, Math.max(0, score));
  
  // Determinar color basado en el score
  const getScoreColor = (value: number) => {
    if (value < 40) return 'text-red-400';
    if (value < 70) return 'text-amber-400';
    return 'text-green-400';
  };
  
  const getScoreLabel = (value: number) => {
    if (value < 40) return 'Necesita mejorar';
    if (value < 70) return 'En progreso';
    if (value < 90) return 'Bueno';
    return 'Excelente';
  };
  
  const heights = {
    sm: 'h-2',
    md: 'h-3',
    lg: 'h-4',
  };
  
  return (
    <div className={cn('w-full', className)}>
      {showLabel && (
        <div className="flex items-center justify-between mb-1">
          <span className="text-xs text-slate-400">{getScoreLabel(clampedScore)}</span>
          <span className={cn('text-sm font-semibold', getScoreColor(clampedScore))}>
            {clampedScore}%
          </span>
        </div>
      )}
      
      <div className={cn('relative rounded-full overflow-hidden', heights[size])}>
        {/* Fondo con gradiente */}
        <div 
          className="absolute inset-0"
          style={{
            background: 'linear-gradient(to right, rgb(239 68 68), rgb(245 158 11), rgb(34 197 94))',
          }}
        />
        
        {/* Overlay oscuro sobre la parte no alcanzada */}
        <div 
          className="absolute inset-0 bg-slate-800/80 transition-all duration-500"
          style={{
            left: `${clampedScore}%`,
          }}
        />
        
        {/* Indicador de posición */}
        <div 
          className="absolute top-0 w-1 h-full bg-white rounded shadow-lg transition-all duration-500"
          style={{
            left: `calc(${clampedScore}% - 2px)`,
          }}
        />
      </div>
    </div>
  );
}

// =====================================================
// SCORE BADGE
// Badge circular con color según score
// =====================================================

interface ScoreBadgeProps {
  score: number;
  size?: 'sm' | 'md' | 'lg';
  showPercentage?: boolean;
}

export function ScoreBadge({
  score,
  size = 'md',
  showPercentage = true,
}: ScoreBadgeProps) {
  const clampedScore = Math.min(100, Math.max(0, score));
  
  const getScoreStyles = (value: number) => {
    if (value < 40) return 'bg-red-500/20 text-red-400 border-red-500/30';
    if (value < 70) return 'bg-amber-500/20 text-amber-400 border-amber-500/30';
    return 'bg-green-500/20 text-green-400 border-green-500/30';
  };
  
  const sizes = {
    sm: 'w-10 h-10 text-xs',
    md: 'w-14 h-14 text-sm',
    lg: 'w-20 h-20 text-lg',
  };
  
  return (
    <div
      className={cn(
        'rounded-full border-2 flex items-center justify-center font-bold',
        getScoreStyles(clampedScore),
        sizes[size]
      )}
    >
      {showPercentage ? `${Math.round(clampedScore)}` : clampedScore >= 70 ? '✓' : '!'}
    </div>
  );
}

// =====================================================
// QUALITY FEEDBACK CARD
// Card para mostrar feedback de calidad
// =====================================================

interface QualityFeedbackCardProps {
  score: number;
  feedback?: string;
  evaluatedBy?: string;
  evaluatedAt?: string;
  className?: string;
}

export function QualityFeedbackCard({
  score,
  feedback,
  evaluatedBy,
  evaluatedAt,
  className,
}: QualityFeedbackCardProps) {
  const getScoreStyles = (value: number) => {
    if (value < 40) return 'border-red-500/30 bg-red-500/5';
    if (value < 70) return 'border-amber-500/30 bg-amber-500/5';
    return 'border-green-500/30 bg-green-500/5';
  };
  
  return (
    <div className={cn('rounded-lg border p-4', getScoreStyles(score), className)}>
      <div className="flex items-start gap-4">
        <ScoreBadge score={score} size="md" />
        
        <div className="flex-1 min-w-0">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium text-white">
              Evaluación de Calidad
            </span>
            {evaluatedAt && (
              <span className="text-xs text-slate-500">
                {new Date(evaluatedAt).toLocaleDateString('es-ES')}
              </span>
            )}
          </div>
          
          <QualityScoreBar score={score} showLabel={false} size="sm" />
          
          {feedback && (
            <p className="mt-3 text-sm text-slate-300">{feedback}</p>
          )}
          
          {evaluatedBy && (
            <p className="mt-2 text-xs text-slate-500">
              Evaluado por: {evaluatedBy}
            </p>
          )}
        </div>
      </div>
    </div>
  );
}

// =====================================================
// MINI QUALITY INDICATOR
// Indicador pequeño para tablas/listas
// =====================================================

interface MiniQualityIndicatorProps {
  score: number;
  className?: string;
}

export function MiniQualityIndicator({ score, className }: MiniQualityIndicatorProps) {
  const getColor = (value: number) => {
    if (value < 40) return 'bg-red-500';
    if (value < 70) return 'bg-amber-500';
    return 'bg-green-500';
  };
  
  return (
    <div className={cn('flex items-center gap-2', className)}>
      <div className={cn('w-2 h-2 rounded-full', getColor(score))} />
      <span className="text-sm text-slate-300">{score}%</span>
    </div>
  );
}

// =====================================================
// EXPORTS
// =====================================================

export default QualityScoreBar;
</file>

<file path="src/components/interview/InterviewRoom.tsx">
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useConversation } from '@elevenlabs/react';
import {
  Mic,
  MicOff,
  PhoneOff,
  Loader2,
  CheckCircle2,
  AlertCircle,
  Clock,
  Briefcase,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import type { InterviewRoomData } from '@/types/interviews.types';

// =====================================================
// TIPOS
// =====================================================

type RoomState = 'welcome' | 'connecting' | 'active' | 'completed' | 'error';

interface InterviewRoomProps {
  data: InterviewRoomData;
  token: string;
}

// =====================================================
// COMPONENTE PRINCIPAL
// =====================================================

export function InterviewRoom({ data, token }: InterviewRoomProps) {
  const [roomState, setRoomState] = useState<RoomState>('welcome');
  const [isMuted, setIsMuted] = useState(false);
  const [duration, setDuration] = useState(0);
  const [error, setError] = useState<string | null>(null);

  // Hook de ElevenLabs
  const conversation = useConversation({
    onConnect: () => {
      console.log('🎙️ Conectado a ElevenLabs');
      setRoomState('active');
    },
    onDisconnect: () => {
      console.log('📴 Desconectado de ElevenLabs');
      if (roomState === 'active') {
        handleComplete();
      }
    },
    onError: (err) => {
      console.error('❌ Error ElevenLabs:', err);
      setError('Error de conexión. Por favor, recarga la página.');
      setRoomState('error');
    },
  });

  // Timer de duración
  useEffect(() => {
    let interval: NodeJS.Timeout;
    if (roomState === 'active') {
      interval = setInterval(() => {
        setDuration((prev) => prev + 1);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [roomState]);

  // Formatear tiempo
  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  // Iniciar entrevista
  const handleStart = async () => {
    setRoomState('connecting');
    setError(null);

    try {
      // 1. Notificar al servidor que inicia
      const startRes = await fetch('/api/interviews/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token }),
      });

      if (!startRes.ok) {
        const errorData = await startRes.json();
        throw new Error(errorData.error || 'Error al iniciar la entrevista');
      }

      // 2. Solicitar permiso de micrófono
      await navigator.mediaDevices.getUserMedia({ audio: true });

      // 3. Conectar con ElevenLabs
      await conversation.startSession({
        agentId: data.agentId,
        connectionType: 'webrtc',
      });

    } catch (err) {
      console.error('Error starting interview:', err);
      setError(err instanceof Error ? err.message : 'Error al iniciar');
      setRoomState('error');
    }
  };

  // Finalizar entrevista
  const handleComplete = useCallback(async () => {
    try {
      // Detener conversación si está activa
      if (conversation.status === 'connected') {
        await conversation.endSession();
      }

      // Notificar al servidor
      await fetch('/api/interviews/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          token,
          conversation_id: conversation.getId() ?? null,
        }),
      });

      setRoomState('completed');
    } catch (err) {
      console.error('Error completing interview:', err);
    }
  }, [conversation, token]);

  // Toggle mute
  const toggleMute = () => {
    setIsMuted((prev) => !prev);
    // ElevenLabs maneja el mute internamente
  };

  // ===== RENDER =====

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-blue-950 flex items-center justify-center p-4">
      <div className="w-full max-w-2xl">

        {/* ===== PANTALLA DE BIENVENIDA ===== */}
        {roomState === 'welcome' && (
          <div className="card text-center animate-fade-in">
            {/* Logo */}
            <div className="flex justify-center mb-6">
              <div className="w-16 h-16 rounded-xl bg-blue-500 flex items-center justify-center">
                <span className="text-2xl font-bold text-white">GT</span>
              </div>
            </div>

            {/* Saludo */}
            <h1 className="text-2xl font-bold text-white mb-2">
              ¡Hola, {data.candidateName}!
            </h1>
            <p className="text-slate-400 mb-6">
              Estás a punto de comenzar tu entrevista técnica
            </p>

            {/* Info del puesto */}
            <div className="bg-slate-800/50 rounded-lg p-4 mb-6">
              <div className="flex items-center justify-center gap-2 text-blue-400 mb-2">
                <Briefcase className="h-5 w-5" />
                <span className="font-medium">{data.jobTitle}</span>
              </div>
              <p className="text-sm text-slate-500">
                Global Talent Connections
              </p>
            </div>

            {/* Instrucciones */}
            <div className="text-left bg-slate-800/30 rounded-lg p-4 mb-6">
              <h3 className="text-sm font-medium text-white mb-3">
                Antes de comenzar:
              </h3>
              <ul className="space-y-2 text-sm text-slate-400">
                <li className="flex items-start gap-2">
                  <span className="text-blue-400 mt-0.5">•</span>
                  <span>Asegurate de estar en un lugar <strong className="text-white">silencioso</strong></span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-400 mt-0.5">•</span>
                  <span>Verificá tu <strong className="text-white">conexión a internet</strong></span>
                </li>
                <li className="flex items-start gap-2">
                  <span className="text-blue-400 mt-0.5">•</span>
                  <span>La entrevista durará aproximadamente <strong className="text-white">5-7 minutos</strong></span>
                </li>
              </ul>
            </div>

            {/* Botón iniciar */}
            <button
              onClick={handleStart}
              className="w-full btn-primary py-4 text-lg font-semibold"
            >
              Comenzar Entrevista
            </button>
          </div>
        )}

        {/* ===== PANTALLA DE CONEXIÓN ===== */}
        {roomState === 'connecting' && (
          <div className="card text-center animate-fade-in">
            <div className="relative w-32 h-32 mx-auto mb-6">
              {/* Anillos animados */}
              <div className="absolute inset-0 rounded-full border-4 border-blue-500/20 animate-pulse" />
              <div className="absolute inset-4 rounded-full border-4 border-blue-500/40 animate-pulse" style={{ animationDelay: '0.2s' }} />
              <div className="absolute inset-8 rounded-full bg-blue-500 flex items-center justify-center">
                <Loader2 className="h-8 w-8 text-white animate-spin" />
              </div>
            </div>

            <h2 className="text-xl font-semibold text-white mb-2">
              Conectando...
            </h2>
            <p className="text-slate-400">
              Por favor, permite el acceso al micrófono
            </p>
          </div>
        )}

        {/* ===== PANTALLA DE ENTREVISTA ACTIVA ===== */}
        {roomState === 'active' && (
          <div className="card text-center animate-fade-in">
            {/* Timer */}
            <div className="flex items-center justify-center gap-2 text-slate-400 mb-6">
              <Clock className="h-4 w-4" />
              <span className="font-mono text-lg">{formatTime(duration)}</span>
            </div>

            {/* Voice Orb */}
            <div className="relative w-40 h-40 mx-auto mb-8">
              {/* Outer glow */}
              <div
                className={cn(
                  'absolute inset-0 rounded-full transition-all duration-300',
                  conversation.isSpeaking
                    ? 'bg-blue-500/20 scale-110'
                    : 'bg-blue-500/10 scale-100'
                )}
              />

              {/* Main orb */}
              <div
                className={cn(
                  'absolute inset-4 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 shadow-lg shadow-blue-500/30 transition-all duration-150',
                  conversation.isSpeaking && 'scale-105'
                )}
              >
                <div className="absolute inset-0 flex items-center justify-center">
                  <Mic className="h-12 w-12 text-white" />
                </div>
              </div>

              {/* Speaking indicator */}
              {conversation.isSpeaking && (
                <div className="absolute inset-0 rounded-full animate-ping bg-blue-500/20" />
              )}
            </div>

            {/* Status */}
            <p className="text-lg text-white mb-2">
              {conversation.isSpeaking ? 'Alexa está hablando...' : 'Escuchando...'}
            </p>
            <p className="text-sm text-slate-500 mb-8">
              Habla con claridad cuando sea tu turno
            </p>

            {/* Controls */}
            <div className="flex items-center justify-center gap-4">
              {/* Mute button */}
              <button
                onClick={toggleMute}
                className={cn(
                  'p-4 rounded-full transition-all duration-200',
                  isMuted
                    ? 'bg-red-500/20 text-red-400 hover:bg-red-500/30'
                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                )}
              >
                {isMuted ? (
                  <MicOff className="h-6 w-6" />
                ) : (
                  <Mic className="h-6 w-6" />
                )}
              </button>

              {/* End call button */}
              <button
                onClick={handleComplete}
                className="p-4 rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors"
              >
                <PhoneOff className="h-6 w-6" />
              </button>
            </div>
          </div>
        )}

        {/* ===== PANTALLA DE COMPLETADO ===== */}
        {roomState === 'completed' && (
          <div className="card text-center animate-fade-in">
            <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-green-500/20 flex items-center justify-center">
              <CheckCircle2 className="h-10 w-10 text-green-400" />
            </div>

            <h2 className="text-2xl font-bold text-white mb-2">
              ¡Entrevista completada!
            </h2>

            <p className="text-slate-400 mb-6">
              Gracias por tu tiempo, {data.candidateName}.<br />
              Nuestro equipo revisará tus respuestas y te contactará pronto.
            </p>

            {/* Duración */}
            <div className="inline-flex items-center gap-2 px-4 py-2 bg-slate-800 rounded-lg text-slate-300">
              <Clock className="h-4 w-4" />
              <span>Duración: {formatTime(duration)}</span>
            </div>

            <p className="mt-8 text-sm text-slate-500">
              Ya podés cerrar esta ventana.
            </p>
          </div>
        )}

        {/* ===== PANTALLA DE ERROR ===== */}
        {roomState === 'error' && (
          <div className="card text-center animate-fade-in">
            <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-red-500/20 flex items-center justify-center">
              <AlertCircle className="h-10 w-10 text-red-400" />
            </div>

            <h2 className="text-2xl font-bold text-white mb-2">
              Ocurrió un error
            </h2>

            <p className="text-slate-400 mb-6">
              {error || 'No se pudo conectar con el sistema de entrevistas.'}
            </p>

            <button
              onClick={() => {
                setError(null);
                setRoomState('welcome');
              }}
              className="btn-primary"
            >
              Intentar de nuevo
            </button>
          </div>
        )}

        {/* Footer */}
        <p className="text-center text-slate-600 text-xs mt-6">
          Global Talent Connections © {new Date().getFullYear()}
        </p>
      </div>
    </div>
  );
}

export default InterviewRoom;
</file>

<file path="src/components/leads/KanbanBoard.tsx">
'use client';

import { useState, useEffect } from 'react';
import {
    DndContext,
    DragOverlay,
    useSensor,
    useSensors,
    PointerSensor,
    DragStartEvent,
    DragEndEvent,
    closestCorners
} from '@dnd-kit/core';
import { Lead, LeadStatus } from '@/types/database.types';
import { KanbanColumn } from './KanbanColumn';
import { LeadCard } from './LeadCard';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { toast } from 'sonner';

interface KanbanBoardProps {
    initialLeads?: Lead[];
}

const COLUMNS: LeadStatus[] = [
    'new',
    'to_contact',
    'contacted',
    'files_sent',
    'negotiating',
    'won',
    'lost'
];

export default function KanbanBoard({ initialLeads = [] }: KanbanBoardProps) {
    // Use local state for immediate UI updates
    const [leads, setLeads] = useState<Lead[]>(initialLeads);
    const [activeId, setActiveId] = useState<string | null>(null);
    const supabase = createClientComponentClient();

    useEffect(() => {
        setLeads(initialLeads);
    }, [initialLeads]);

    const sensors = useSensors(
        useSensor(PointerSensor, {
            activationConstraint: {
                distance: 5, // Requires 5px movement before drag starts
            },
        })
    );

    function handleDragStart(event: DragStartEvent) {
        setActiveId(event.active.id as string);
    }

    async function handleDragEnd(event: DragEndEvent) {
        const { active, over } = event;
        setActiveId(null);

        if (!over) return;

        const leadId = active.id as string;
        const newStatus = over.id as LeadStatus;

        const currentLead = leads.find(l => l.id === leadId);
        if (!currentLead || currentLead.status === newStatus) return;

        // Optimistic Update
        setLeads((prev) =>
            prev.map(item =>
                item.id === leadId
                    ? { ...item, status: newStatus, updated_at: new Date().toISOString() }
                    : item
            )
        );

        try {
            // API Call to Supabase
            const { error } = await supabase
                .from('leads')
                .update({ status: newStatus, updated_at: new Date().toISOString() })
                .eq('id', leadId);

            if (error) throw error;
            toast.success('Estado actualizado correctamente');
        } catch (error) {
            console.error('Error updating status:', error);
            toast.error('Error al actualizar el estado');

            // Rollback on error
            setLeads((prev) =>
                prev.map(item =>
                    item.id === leadId
                        ? { ...item, status: currentLead.status }
                        : item
                )
            );
        }
    }

    // Filter leads by column
    const getLeadsByStatus = (status: LeadStatus) => {
        return leads.filter(lead => lead.status === status);
    };

    const activeLead = activeId ? leads.find(l => l.id === activeId) : null;

    return (
        <div className="h-[calc(100vh-140px)] flex flex-col">
            <div className="flex-1 overflow-x-auto overflow-y-hidden pb-4">
                <div className="flex h-full gap-4 px-4 min-w-max">
                    <DndContext
                        sensors={sensors}
                        collisionDetection={closestCorners}
                        onDragStart={handleDragStart}
                        onDragEnd={handleDragEnd}
                    >
                        {COLUMNS.map((status) => (
                            <KanbanColumn
                                key={status}
                                status={status}
                                leads={getLeadsByStatus(status)}
                            />
                        ))}

                        <DragOverlay>
                            {activeLead ? <LeadCard lead={activeLead} /> : null}
                        </DragOverlay>
                    </DndContext>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/leads/KanbanColumn.tsx">
import { Lead, LeadStatus, LEAD_STATUS_LABELS, LEAD_STATUS_COLORS } from '@/types/database.types';
import { useDroppable } from '@dnd-kit/core';
import { LeadCard } from './LeadCard';

interface KanbanColumnProps {
    status: LeadStatus;
    leads: Lead[];
}

export function KanbanColumn({ status, leads }: KanbanColumnProps) {
    const { setNodeRef, isOver } = useDroppable({
        id: status,
    });

    return (
        <div
            ref={setNodeRef}
            className={`
        flex-shrink-0 w-72 h-full flex flex-col rounded-lg 
        bg-muted/30 border border-transparent
        ${isOver ? 'bg-muted/60 ring-2 ring-primary/20' : ''}
      `}
        >
            <div className="p-3 flex items-center justify-between sticky top-0 bg-background/95 backdrop-blur z-10 rounded-t-lg border-b">
                <div className="flex items-center gap-2">
                    <div className={`w-3 h-3 rounded-full ${LEAD_STATUS_COLORS[status]}`} />
                    <h3 className="font-medium text-sm">{LEAD_STATUS_LABELS[status]}</h3>
                </div>
                <span className="text-xs text-muted-foreground bg-muted px-2 py-0.5 rounded-full">
                    {leads.length}
                </span>
            </div>

            <div className="flex-1 p-2 space-y-2 overflow-y-auto min-h-[150px]">
                {leads.map((lead) => (
                    <LeadCard key={lead.id} lead={lead} />
                ))}

                {leads.length === 0 && (
                    <div className="h-24 flex items-center justify-center text-xs text-muted-foreground border border-dashed rounded-lg">
                        Vacío
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/components/leads/LeadCard.tsx">
import { Lead, LEAD_STATUS_COLORS, LEAD_STATUS_LABELS } from '@/types/database.types';
import { useDraggable } from '@dnd-kit/core';
import { formatDistanceToNow } from 'date-fns';
import { es } from 'date-fns/locale';
import { Building2, Calendar, Mail, Phone, MoreHorizontal } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';

interface LeadCardProps {
    lead: Lead;
}

export function LeadCard({ lead }: LeadCardProps) {
    const { attributes, listeners, setNodeRef, transform, isDragging } = useDraggable({
        id: lead.id,
        data: lead,
    });

    const style = transform ? {
        transform: `translate3d(${transform.x}js, ${transform.y}px, 0)`,
    } : undefined;

    // Use inline style for transform to avoid Tailwind issues with dynamic values during drag
    // But for the card structure, use Tailwind

    return (
        <div
            ref={setNodeRef}
            style={style}
            {...listeners}
            {...attributes}
            className={`
        bg-card border rounded-lg p-3 shadow-sm hover:shadow-md transition-all 
        cursor-grab active:cursor-grabbing group relative
        ${isDragging ? 'opacity-50 rotate-2 scale-105 z-50' : 'opacity-100'}
      `}
        >
            <div className="flex justify-between items-start mb-2">
                <div>
                    <h4 className="font-semibold text-sm truncate max-w-[180px]" title={lead.company_name}>
                        {lead.company_name}
                    </h4>
                    <p className="text-xs text-muted-foreground truncate max-w-[180px]">
                        {lead.contact_name || 'Sin contacto'}
                    </p>
                </div>

                {/* Actions Menu (Prevent drag when clicking menu) */}
                <div onPointerDown={(e) => e.stopPropagation()}>
                    <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                            <Button variant="ghost" size="icon" className="h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity">
                                <MoreHorizontal className="h-4 w-4" />
                            </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="end">
                            <DropdownMenuItem>Ver detalles</DropdownMenuItem>
                            <DropdownMenuItem>Editar</DropdownMenuItem>
                            <DropdownMenuItem className="text-destructive">Eliminar</DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                </div>
            </div>

            <div className="space-y-1 mb-3">
                {lead.assistant_type && (
                    <Badge variant="outline" className="text-[10px] px-1 py-0 h-5 font-normal">
                        {lead.assistant_type.replace('_', ' ')}
                    </Badge>
                )}
            </div>

            <div className="flex flex-col gap-1 text-xs text-muted-foreground">
                {(lead.contact_email || lead.contact_phone) && (
                    <div className="flex items-center gap-2">
                        {lead.contact_email && <Mail className="h-3 w-3" />}
                        {lead.contact_phone && <Phone className="h-3 w-3" />}
                    </div>
                )}

                <div className="flex items-center gap-1 mt-1">
                    <Calendar className="h-3 w-3" />
                    <span>
                        {formatDistanceToNow(new Date(lead.created_at), { addSuffix: true, locale: es })}
                    </span>
                </div>
            </div>

            {/* Status Bar (Color stripe) */}
            <div className={`absolute left-0 top-0 bottom-0 w-1 rounded-l-lg ${LEAD_STATUS_COLORS[lead.status] || 'bg-gray-300'}`} />
        </div>
    );
}
</file>

<file path="src/components/mensual/index.ts">
// =====================================================
// MENSUAL - Exports
// =====================================================

export { MonthlyReportForm } from './MonthlyReportForm';
</file>

<file path="src/components/mensual/MonthlyReportForm.tsx">
'use client';

// =====================================================
// MONTHLY REPORT FORM - Formulario de informe mensual
// =====================================================

import { useState, useCallback, useEffect, useTransition, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import {
  Plus,
  Save,
  Send,
  Loader2,
  CheckCircle2,
  AlertCircle,
  Clock,
  FileText,
  Target,
  Lightbulb,
  BarChart3,
  Trash2,
  Lock,
  ChevronDown,
  ChevronUp,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { saveMonthlyDraft, submitMonthlyReport } from '@/lib/actions/monthly-reports';
import {
  DEFAULT_ACTIVITY,
  DEFAULT_OBJECTIVE,
  DEFAULT_SUGGESTION,
  DEFAULT_METRIC,
  monthlyReportFormSchema,
  getFormErrors,
} from '@/lib/validations/monthly-reports';
import type {
  MonthlyReportWithEntries,
  ActivityFormData,
  ObjectiveFormData,
  SuggestionFormData,
  MetricFormData,
  MonthlyReportStatus,
} from '@/types/monthly-reports.types';
import {
  MONTH_NAMES,
  MONTHLY_STATUS_LABELS,
  MONTHLY_STATUS_COLORS,
  getMonthDeadlineStatus,
} from '@/types/monthly-reports.types';

interface MonthlyReportFormProps {
  report: MonthlyReportWithEntries;
}

export function MonthlyReportForm({ report }: MonthlyReportFormProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  // Estado del formulario
  const [activities, setActivities] = useState<ActivityFormData[]>(() =>
    report.activities.length > 0
      ? report.activities.map((a) => ({
          id: a.id,
          title: a.title,
          description: a.description ?? '',
        }))
      : [{ ...DEFAULT_ACTIVITY }]
  );

  const [objectives, setObjectives] = useState<ObjectiveFormData[]>(() =>
    report.objectives.length > 0
      ? report.objectives.map((o) => ({
          id: o.id,
          objective: o.objective,
          achieved: o.achieved,
          notes: o.notes ?? '',
        }))
      : [{ ...DEFAULT_OBJECTIVE }]
  );

  const [suggestions, setSuggestions] = useState<SuggestionFormData[]>(() =>
    report.suggestions.length > 0
      ? report.suggestions.map((s) => ({
          id: s.id,
          suggestion: s.suggestion,
        }))
      : []
  );

  const [metrics, setMetrics] = useState<MetricFormData[]>(() =>
    report.metrics.length > 0
      ? report.metrics.map((m) => ({
          id: m.id,
          metric_name: m.metric_name,
          metric_value: m.metric_value,
          metric_unit: m.metric_unit ?? '',
        }))
      : []
  );

  // UI State
  const [errors, setErrors] = useState<Record<string, string[]>>({});
  const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'saved' | 'error'>('idle');
  const [lastSaved, setLastSaved] = useState<Date | null>(null);
  const [showSubmitDialog, setShowSubmitDialog] = useState(false);
  const [submitError, setSubmitError] = useState<string | null>(null);

  const isLocked = report.is_locked;
  const monthName = MONTH_NAMES[report.report_month_number - 1] ?? '';
  const deadline = getMonthDeadlineStatus(report.report_month_number, report.report_year);

  // Auto-save cada 30 segundos
  useEffect(() => {
    if (isLocked) return;

    const interval = setInterval(() => {
      handleSaveDraft();
    }, 30000);

    return () => clearInterval(interval);
  }, [activities, objectives, suggestions, metrics, isLocked]);

  // Guardar borrador
  const handleSaveDraft = useCallback(async () => {
    if (isLocked) return;

    setSaveStatus('saving');
    
    const result = await saveMonthlyDraft(report.id, {
      activities,
      objectives,
      suggestions,
      metrics,
    });

    if (result.success) {
      setSaveStatus('saved');
      setLastSaved(new Date());
      setTimeout(() => setSaveStatus('idle'), 2000);
    } else {
      setSaveStatus('error');
      setTimeout(() => setSaveStatus('idle'), 3000);
    }
  }, [report.id, activities, objectives, suggestions, metrics, isLocked]);

  // Validar
  const validateForm = useCallback(() => {
    const validation = monthlyReportFormSchema.safeParse({
      activities,
      objectives,
      suggestions,
      metrics,
    });

    if (!validation.success) {
      const formErrors = getFormErrors(validation.error);
      setErrors(formErrors);
      return false;
    }

    setErrors({});
    return true;
  }, [activities, objectives, suggestions, metrics]);

  // Enviar
  const handleSubmit = useCallback(async () => {
    if (!validateForm()) {
      setShowSubmitDialog(false);
      return;
    }

    setSubmitError(null);

    startTransition(async () => {
      const result = await submitMonthlyReport(report.id, {
        activities,
        objectives,
        suggestions,
        metrics,
      });

      if (result.success) {
        setShowSubmitDialog(false);
        router.refresh();
      } else {
        setSubmitError(result.error ?? 'Error al enviar el informe');
      }
    });
  }, [report.id, activities, objectives, suggestions, metrics, validateForm, router]);

  // Handlers para Activities
  const handleUpdateActivity = useCallback(
    (index: number, field: keyof ActivityFormData, value: string) => {
      setActivities((prev) =>
        prev.map((entry, i) => (i === index ? { ...entry, [field]: value } : entry))
      );
    },
    []
  );

  const handleAddActivity = useCallback(() => {
    setActivities((prev) => [...prev, { ...DEFAULT_ACTIVITY }]);
  }, []);

  const handleRemoveActivity = useCallback((index: number) => {
    setActivities((prev) => prev.filter((_, i) => i !== index));
  }, []);

  // Handlers para Objectives
  const handleUpdateObjective = useCallback(
    (index: number, field: keyof ObjectiveFormData, value: string | boolean) => {
      setObjectives((prev) =>
        prev.map((entry, i) => (i === index ? { ...entry, [field]: value } : entry))
      );
    },
    []
  );

  const handleAddObjective = useCallback(() => {
    setObjectives((prev) => [...prev, { ...DEFAULT_OBJECTIVE }]);
  }, []);

  const handleRemoveObjective = useCallback((index: number) => {
    setObjectives((prev) => prev.filter((_, i) => i !== index));
  }, []);

  // Handlers para Suggestions
  const handleUpdateSuggestion = useCallback(
    (index: number, value: string) => {
      setSuggestions((prev) =>
        prev.map((entry, i) => (i === index ? { ...entry, suggestion: value } : entry))
      );
    },
    []
  );

  const handleAddSuggestion = useCallback(() => {
    setSuggestions((prev) => [...prev, { ...DEFAULT_SUGGESTION }]);
  }, []);

  const handleRemoveSuggestion = useCallback((index: number) => {
    setSuggestions((prev) => prev.filter((_, i) => i !== index));
  }, []);

  // Handlers para Metrics
  const handleUpdateMetric = useCallback(
    (index: number, field: keyof MetricFormData, value: string) => {
      setMetrics((prev) =>
        prev.map((entry, i) => (i === index ? { ...entry, [field]: value } : entry))
      );
    },
    []
  );

  const handleAddMetric = useCallback(() => {
    setMetrics((prev) => [...prev, { ...DEFAULT_METRIC }]);
  }, []);

  const handleRemoveMetric = useCallback((index: number) => {
    setMetrics((prev) => prev.filter((_, i) => i !== index));
  }, []);

  const achievedCount = useMemo(
    () => objectives.filter((o) => o.achieved).length,
    [objectives]
  );

  const hasErrors = Object.keys(errors).length > 0;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-100">
            Informe Mensual
          </h1>
          <p className="text-slate-400 mt-1">
            {monthName} {report.report_year}
          </p>
        </div>

        <div className="flex items-center gap-3">
          <Badge
            variant="outline"
            className={cn(MONTHLY_STATUS_COLORS[report.status as MonthlyReportStatus])}
          >
            {isLocked && <Lock className="h-3 w-3 mr-1" />}
            {MONTHLY_STATUS_LABELS[report.status as MonthlyReportStatus]}
          </Badge>

          {!isLocked && (
            <Badge
              variant="outline"
              className={cn(
                deadline.isOverdue
                  ? 'bg-red-500/20 text-red-400 border-red-500/30'
                  : deadline.daysUntil <= 3
                  ? 'bg-amber-500/20 text-amber-400 border-amber-500/30'
                  : 'bg-slate-500/20 text-slate-400 border-slate-500/30'
              )}
            >
              <Clock className="h-3 w-3 mr-1" />
              {deadline.label}
            </Badge>
          )}
        </div>
      </div>

      {/* Mensaje de bloqueado */}
      {isLocked && (
        <div className="flex items-center gap-3 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
          <Lock className="h-5 w-5 text-blue-400" />
          <div>
            <p className="text-sm font-medium text-blue-400">Informe enviado</p>
            <p className="text-sm text-blue-400/80">
              Este informe fue enviado el{' '}
              {report.submitted_at
                ? new Date(report.submitted_at).toLocaleDateString('es-ES', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                  })
                : 'fecha desconocida'}{' '}
              y ya no puede ser modificado.
            </p>
          </div>
        </div>
      )}

      {/* Errores */}
      {hasErrors && (
        <div className="flex items-start gap-3 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
          <AlertCircle className="h-5 w-5 text-red-400 shrink-0 mt-0.5" />
          <div>
            <p className="text-sm font-medium text-red-400">Hay errores en el formulario</p>
            <p className="text-sm text-red-400/80">Revisa los campos marcados en rojo.</p>
          </div>
        </div>
      )}

      {/* =====================================================
          SECCIÓN: ACTIVIDADES
          ===================================================== */}
      <Card className="border-slate-700 bg-slate-900/50">
        <CardHeader className="pb-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-500/20">
                <FileText className="h-5 w-5 text-emerald-400" />
              </div>
              <div>
                <CardTitle className="text-lg text-slate-100">Actividades</CardTitle>
                <p className="text-sm text-slate-400">{activities.length} actividad{activities.length !== 1 && 'es'}</p>
              </div>
            </div>
            {!isLocked && (
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={handleAddActivity}
                className="border-emerald-500/30 text-emerald-400 hover:bg-emerald-500/10"
              >
                <Plus className="h-4 w-4 mr-1" />
                Agregar
              </Button>
            )}
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {activities.map((activity, index) => (
            <div
              key={activity.id ?? `activity-${index}`}
              className="group p-4 rounded-lg border border-slate-700 bg-slate-800/30"
            >
              <div className="flex items-start gap-3">
                <div className="flex h-7 w-7 items-center justify-center rounded-full bg-slate-700 text-sm font-medium text-slate-300">
                  {index + 1}
                </div>
                <div className="flex-1 space-y-3">
                  <div className="space-y-2">
                    <Label className="text-slate-300">
                      Título <span className="text-red-400">*</span>
                    </Label>
                    <Input
                      value={activity.title}
                      onChange={(e) => handleUpdateActivity(index, 'title', e.target.value)}
                      disabled={isLocked}
                      placeholder="Ej: Optimización del clasificador de candidatos"
                      className="bg-slate-900/50 border-slate-700"
                    />
                  </div>
                  <div className="space-y-2">
                    <Label className="text-slate-300">Descripción</Label>
                    <textarea
                      value={activity.description}
                      onChange={(e) => handleUpdateActivity(index, 'description', e.target.value)}
                      disabled={isLocked}
                      rows={3}
                      placeholder="Describe la actividad en detalle..."
                      className={cn(
                        'w-full rounded-md bg-slate-900/50 border border-slate-700 px-3 py-2 text-sm text-slate-100',
                        'placeholder:text-slate-500 focus:border-emerald-500/50 focus:outline-none',
                        'disabled:cursor-not-allowed disabled:opacity-50'
                      )}
                    />
                  </div>
                </div>
                {!isLocked && activities.length > 1 && (
                  <Button
                    type="button"
                    variant="ghost"
                    size="sm"
                    onClick={() => handleRemoveActivity(index)}
                    className="h-8 w-8 p-0 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100"
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                )}
              </div>
            </div>
          ))}
        </CardContent>
      </Card>

      {/* =====================================================
          SECCIÓN: OBJETIVOS
          ===================================================== */}
      <Card className="border-slate-700 bg-slate-900/50">
        <CardHeader className="pb-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-blue-500/20">
                <Target className="h-5 w-5 text-blue-400" />
              </div>
              <div>
                <CardTitle className="text-lg text-slate-100">Objetivos</CardTitle>
                <p className="text-sm text-slate-400">
                  {objectives.length} objetivo{objectives.length !== 1 && 's'} • {achievedCount} logrado{achievedCount !== 1 && 's'}
                </p>
              </div>
            </div>
            {!isLocked && (
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={handleAddObjective}
                className="border-blue-500/30 text-blue-400 hover:bg-blue-500/10"
              >
                <Plus className="h-4 w-4 mr-1" />
                Agregar
              </Button>
            )}
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {objectives.map((objective, index) => (
            <div
              key={objective.id ?? `objective-${index}`}
              className="group p-4 rounded-lg border border-slate-700 bg-slate-800/30"
            >
              <div className="flex items-start gap-3">
                <label className="flex items-center cursor-pointer mt-1">
                  <input
                    type="checkbox"
                    checked={objective.achieved}
                    onChange={(e) => handleUpdateObjective(index, 'achieved', e.target.checked)}
                    disabled={isLocked}
                    className="sr-only"
                  />
                  <div
                    className={cn(
                      'h-6 w-6 rounded-full border-2 flex items-center justify-center transition-colors',
                      objective.achieved
                        ? 'bg-emerald-500 border-emerald-500'
                        : 'border-slate-600 hover:border-slate-500'
                    )}
                  >
                    {objective.achieved && <CheckCircle2 className="h-4 w-4 text-white" />}
                  </div>
                </label>
                <div className="flex-1 space-y-3">
                  <div className="space-y-2">
                    <Label className="text-slate-300">
                      Objetivo <span className="text-red-400">*</span>
                    </Label>
                    <Input
                      value={objective.objective}
                      onChange={(e) => handleUpdateObjective(index, 'objective', e.target.value)}
                      disabled={isLocked}
                      placeholder="Ej: Garantizar un flujo completo y trazable del candidato"
                      className={cn(
                        'bg-slate-900/50 border-slate-700',
                        objective.achieved && 'line-through text-slate-500'
                      )}
                    />
                  </div>
                  <div className="space-y-2">
                    <Label className="text-slate-300">Notas</Label>
                    <Input
                      value={objective.notes}
                      onChange={(e) => handleUpdateObjective(index, 'notes', e.target.value)}
                      disabled={isLocked}
                      placeholder="Comentarios adicionales..."
                      className="bg-slate-900/50 border-slate-700"
                    />
                  </div>
                </div>
                {!isLocked && objectives.length > 1 && (
                  <Button
                    type="button"
                    variant="ghost"
                    size="sm"
                    onClick={() => handleRemoveObjective(index)}
                    className="h-8 w-8 p-0 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100"
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                )}
              </div>
            </div>
          ))}
        </CardContent>
      </Card>

      {/* =====================================================
          SECCIÓN: SUGERENCIAS
          ===================================================== */}
      <Card className="border-slate-700 bg-slate-900/50">
        <CardHeader className="pb-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-500/20">
                <Lightbulb className="h-5 w-5 text-amber-400" />
              </div>
              <div>
                <CardTitle className="text-lg text-slate-100">Sugerencias</CardTitle>
                <p className="text-sm text-slate-400">
                  {suggestions.length} sugerencia{suggestions.length !== 1 && 's'} (opcional)
                </p>
              </div>
            </div>
            {!isLocked && (
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={handleAddSuggestion}
                className="border-amber-500/30 text-amber-400 hover:bg-amber-500/10"
              >
                <Plus className="h-4 w-4 mr-1" />
                Agregar
              </Button>
            )}
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {suggestions.length === 0 ? (
            <p className="text-center text-slate-500 py-4">
              No hay sugerencias agregadas
            </p>
          ) : (
            suggestions.map((suggestion, index) => (
              <div
                key={suggestion.id ?? `suggestion-${index}`}
                className="group flex items-start gap-3"
              >
                <div className="flex h-7 w-7 items-center justify-center rounded-full bg-amber-500/20 text-sm text-amber-400">
                  {index + 1}
                </div>
                <textarea
                  value={suggestion.suggestion}
                  onChange={(e) => handleUpdateSuggestion(index, e.target.value)}
                  disabled={isLocked}
                  rows={2}
                  placeholder="Escribe tu sugerencia..."
                  className={cn(
                    'flex-1 rounded-md bg-slate-900/50 border border-slate-700 px-3 py-2 text-sm text-slate-100',
                    'placeholder:text-slate-500 focus:border-amber-500/50 focus:outline-none',
                    'disabled:cursor-not-allowed disabled:opacity-50'
                  )}
                />
                {!isLocked && (
                  <Button
                    type="button"
                    variant="ghost"
                    size="sm"
                    onClick={() => handleRemoveSuggestion(index)}
                    className="h-8 w-8 p-0 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100"
                  >
                    <Trash2 className="h-4 w-4" />
                  </Button>
                )}
              </div>
            ))
          )}
        </CardContent>
      </Card>

      {/* =====================================================
          SECCIÓN: MÉTRICAS
          ===================================================== */}
      <Card className="border-slate-700 bg-slate-900/50">
        <CardHeader className="pb-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-purple-500/20">
                <BarChart3 className="h-5 w-5 text-purple-400" />
              </div>
              <div>
                <CardTitle className="text-lg text-slate-100">Métricas</CardTitle>
                <p className="text-sm text-slate-400">
                  {metrics.length} métrica{metrics.length !== 1 && 's'} (opcional)
                </p>
              </div>
            </div>
            {!isLocked && (
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={handleAddMetric}
                className="border-purple-500/30 text-purple-400 hover:bg-purple-500/10"
              >
                <Plus className="h-4 w-4 mr-1" />
                Agregar
              </Button>
            )}
          </div>
        </CardHeader>
        <CardContent>
          {metrics.length === 0 ? (
            <p className="text-center text-slate-500 py-4">
              No hay métricas agregadas
            </p>
          ) : (
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {metrics.map((metric, index) => (
                <div
                  key={metric.id ?? `metric-${index}`}
                  className="group p-4 rounded-lg border border-slate-700 bg-slate-800/30"
                >
                  <div className="space-y-3">
                    <Input
                      value={metric.metric_name}
                      onChange={(e) => handleUpdateMetric(index, 'metric_name', e.target.value)}
                      disabled={isLocked}
                      placeholder="Nombre (ej: Candidatos)"
                      className="bg-slate-900/50 border-slate-700 text-sm"
                    />
                    <div className="flex gap-2">
                      <Input
                        value={metric.metric_value}
                        onChange={(e) => handleUpdateMetric(index, 'metric_value', e.target.value)}
                        disabled={isLocked}
                        placeholder="Valor"
                        className="bg-slate-900/50 border-slate-700 text-sm flex-1"
                      />
                      <Input
                        value={metric.metric_unit}
                        onChange={(e) => handleUpdateMetric(index, 'metric_unit', e.target.value)}
                        disabled={isLocked}
                        placeholder="Unidad"
                        className="bg-slate-900/50 border-slate-700 text-sm w-24"
                      />
                    </div>
                    {!isLocked && (
                      <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        onClick={() => handleRemoveMetric(index)}
                        className="w-full text-slate-400 hover:text-red-400 hover:bg-red-500/10"
                      >
                        <Trash2 className="h-4 w-4 mr-1" />
                        Eliminar
                      </Button>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Footer con acciones */}
      {!isLocked && (
        <div className="sticky bottom-0 -mx-4 sm:-mx-6 px-4 sm:px-6 py-4 bg-slate-950/95 backdrop-blur border-t border-slate-800">
          <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
            {/* Estado de guardado */}
            <div className="flex items-center gap-2 text-sm">
              {saveStatus === 'saving' && (
                <>
                  <Loader2 className="h-4 w-4 animate-spin text-slate-400" />
                  <span className="text-slate-400">Guardando...</span>
                </>
              )}
              {saveStatus === 'saved' && (
                <>
                  <CheckCircle2 className="h-4 w-4 text-emerald-400" />
                  <span className="text-emerald-400">Guardado</span>
                </>
              )}
              {saveStatus === 'error' && (
                <>
                  <AlertCircle className="h-4 w-4 text-red-400" />
                  <span className="text-red-400">Error al guardar</span>
                </>
              )}
              {saveStatus === 'idle' && lastSaved && (
                <span className="text-slate-500">
                  Último guardado: {lastSaved.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                </span>
              )}
            </div>

            {/* Botones */}
            <div className="flex items-center gap-3">
              <Button
                type="button"
                variant="outline"
                onClick={handleSaveDraft}
                disabled={saveStatus === 'saving'}
                className="border-slate-700"
              >
                <Save className="h-4 w-4 mr-2" />
                Guardar borrador
              </Button>

              <Button
                type="button"
                onClick={() => setShowSubmitDialog(true)}
                disabled={isPending}
                className="bg-emerald-600 hover:bg-emerald-700 text-white"
              >
                {isPending ? (
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <Send className="h-4 w-4 mr-2" />
                )}
                Enviar informe
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Dialog de confirmación */}
      {showSubmitDialog && (
        <div
          className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm"
          onClick={() => !isPending && setShowSubmitDialog(false)}
        >
          <div
            className="w-full max-w-md rounded-xl border border-slate-700 bg-slate-900 shadow-2xl p-6"
            onClick={(e) => e.stopPropagation()}
          >
            <h2 className="text-xl font-semibold text-slate-100 mb-2">
              ¿Enviar informe mensual?
            </h2>
            <p className="text-slate-400 mb-4">
              Una vez enviado, el informe de <strong>{monthName} {report.report_year}</strong> no podrá ser modificado.
            </p>

            <div className="space-y-2 mb-6">
              <div className="flex justify-between p-2 rounded bg-slate-800/50">
                <span className="text-slate-400">Actividades</span>
                <span className="text-slate-200">{activities.length}</span>
              </div>
              <div className="flex justify-between p-2 rounded bg-slate-800/50">
                <span className="text-slate-400">Objetivos</span>
                <span className="text-slate-200">{objectives.length}</span>
              </div>
              <div className="flex justify-between p-2 rounded bg-slate-800/50">
                <span className="text-slate-400">Sugerencias</span>
                <span className="text-slate-200">{suggestions.length}</span>
              </div>
              <div className="flex justify-between p-2 rounded bg-slate-800/50">
                <span className="text-slate-400">Métricas</span>
                <span className="text-slate-200">{metrics.length}</span>
              </div>
            </div>

            {submitError && (
              <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/30 mb-4">
                <p className="text-sm text-red-400">{submitError}</p>
              </div>
            )}

            <div className="flex gap-3">
              <Button
                variant="outline"
                onClick={() => setShowSubmitDialog(false)}
                disabled={isPending}
                className="flex-1 border-slate-700"
              >
                Cancelar
              </Button>
              <Button
                onClick={handleSubmit}
                disabled={isPending}
                className="flex-1 bg-emerald-600 hover:bg-emerald-700"
              >
                {isPending ? (
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <Send className="h-4 w-4 mr-2" />
                )}
                Enviar
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/profile/AssistantProfileForm.tsx">
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import {
  User,
  Mail,
  Phone,
  Globe,
  Clock,
  Building2,
  Briefcase,
  Calendar,
  Target,
  Save,
  Plus,
  Trash2,
  CheckCircle2,
  AlertCircle,
} from 'lucide-react';

import { Button } from '@/components/ui/button';
import { createClient } from '@/lib/supabase/client';
import { cn } from '@/lib/utils';
import type { 
  Assistant, 
  AssistantType, 
  ContractType,
  WeeklyObjective,
  MonthlyObjective,
} from '@/types/database.types';
import { 
  ASSISTANT_TYPE_LABELS, 
  CONTRACT_TYPE_LABELS 
} from '@/types/database.types';

// =====================================================
// TIPOS
// =====================================================

interface ProfileFormData {
  full_name: string;
  email: string;
  phone: string;
  country: string;
  timezone: string;
  assistant_type: AssistantType | '';
  contract_type: ContractType;
  work_schedule: string;
  start_date: string;
  skills: string[];
  languages: string[];
  weekly_objectives: WeeklyObjective[];
  monthly_objectives: MonthlyObjective[];
}

interface AssistantProfileFormProps {
  assistantId: string;
  initialData?: Partial<Assistant>;
  clientName?: string;
}

// =====================================================
// CONSTANTES
// =====================================================

const TIMEZONES = [
  { value: 'America/New_York', label: 'Nueva York (EST)' },
  { value: 'America/Chicago', label: 'Chicago (CST)' },
  { value: 'America/Denver', label: 'Denver (MST)' },
  { value: 'America/Los_Angeles', label: 'Los Angeles (PST)' },
  { value: 'America/Mexico_City', label: 'Ciudad de México' },
  { value: 'America/Bogota', label: 'Bogotá' },
  { value: 'America/Lima', label: 'Lima' },
  { value: 'America/Santiago', label: 'Santiago' },
  { value: 'America/Buenos_Aires', label: 'Buenos Aires' },
  { value: 'America/Sao_Paulo', label: 'São Paulo' },
  { value: 'Europe/Madrid', label: 'Madrid' },
  { value: 'Europe/London', label: 'Londres' },
];

const PRIORITY_OPTIONS = [
  { value: 'alta', label: 'Alta', color: 'text-red-400' },
  { value: 'media', label: 'Media', color: 'text-amber-400' },
  { value: 'baja', label: 'Baja', color: 'text-blue-400' },
];

const STATUS_OPTIONS = [
  { value: 'pendiente', label: 'Pendiente', color: 'bg-slate-500' },
  { value: 'en_progreso', label: 'En progreso', color: 'bg-amber-500' },
  { value: 'completado', label: 'Completado', color: 'bg-green-500' },
];

// =====================================================
// COMPONENTE PRINCIPAL
// =====================================================

export function AssistantProfileForm({
  assistantId,
  initialData,
  clientName,
}: AssistantProfileFormProps) {
  const router = useRouter();
  const supabase = createClient();
  
  const [isLoading, setIsLoading] = useState(false);
  const [isSaving, setIsSaving] = useState(false);
  const [message, setMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);
  
  const [formData, setFormData] = useState<ProfileFormData>({
    full_name: initialData?.full_name || '',
    email: initialData?.email || '',
    phone: initialData?.phone || '',
    country: initialData?.country || '',
    timezone: initialData?.timezone || 'America/New_York',
    assistant_type: initialData?.assistant_type || '',
    contract_type: initialData?.contract_type || 'tiempo_completo',
    work_schedule: initialData?.work_schedule || '10:30-19:30',
    start_date: initialData?.start_date || '',
    skills: initialData?.skills || [],
    languages: initialData?.languages || [],
    weekly_objectives: initialData?.weekly_objectives || [],
    monthly_objectives: initialData?.monthly_objectives || [],
  });

  const [newSkill, setNewSkill] = useState('');
  const [newLanguage, setNewLanguage] = useState('');

  // ===== HANDLERS =====
  
  const handleChange = (field: keyof ProfileFormData) => (
    e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement>
  ) => {
    setFormData((prev) => ({
      ...prev,
      [field]: e.target.value,
    }));
  };

  const addSkill = () => {
    if (newSkill.trim() && !formData.skills.includes(newSkill.trim())) {
      setFormData((prev) => ({
        ...prev,
        skills: [...prev.skills, newSkill.trim()],
      }));
      setNewSkill('');
    }
  };

  const removeSkill = (skill: string) => {
    setFormData((prev) => ({
      ...prev,
      skills: prev.skills.filter((s) => s !== skill),
    }));
  };

  const addLanguage = () => {
    if (newLanguage.trim() && !formData.languages.includes(newLanguage.trim())) {
      setFormData((prev) => ({
        ...prev,
        languages: [...prev.languages, newLanguage.trim()],
      }));
      setNewLanguage('');
    }
  };

  const removeLanguage = (lang: string) => {
    setFormData((prev) => ({
      ...prev,
      languages: prev.languages.filter((l) => l !== lang),
    }));
  };

  // ===== OBJETIVOS SEMANALES =====
  
  const addWeeklyObjective = () => {
    const newObjective: WeeklyObjective = {
      id: crypto.randomUUID(),
      objective: '',
      description: '',
      key_result: '',
      priority: 'media',
      status: 'pendiente',
      due_date: '',
      comments: '',
    };
    setFormData((prev) => ({
      ...prev,
      weekly_objectives: [...prev.weekly_objectives, newObjective],
    }));
  };

  const updateWeeklyObjective = (id: string, field: keyof WeeklyObjective, value: string) => {
    setFormData((prev) => ({
      ...prev,
      weekly_objectives: prev.weekly_objectives.map((obj) =>
        obj.id === id ? { ...obj, [field]: value } : obj
      ),
    }));
  };

  const removeWeeklyObjective = (id: string) => {
    setFormData((prev) => ({
      ...prev,
      weekly_objectives: prev.weekly_objectives.filter((obj) => obj.id !== id),
    }));
  };

  // ===== OBJETIVOS MENSUALES =====
  
  const addMonthlyObjective = () => {
    const newObjective: MonthlyObjective = {
      id: crypto.randomUUID(),
      objective: '',
      description: '',
      key_result: '',
      progress: 0,
      status: 'pendiente',
    };
    setFormData((prev) => ({
      ...prev,
      monthly_objectives: [...prev.monthly_objectives, newObjective],
    }));
  };

  const updateMonthlyObjective = (id: string, field: keyof MonthlyObjective, value: string | number) => {
    setFormData((prev) => ({
      ...prev,
      monthly_objectives: prev.monthly_objectives.map((obj) =>
        obj.id === id ? { ...obj, [field]: value } : obj
      ),
    }));
  };

  const removeMonthlyObjective = (id: string) => {
    setFormData((prev) => ({
      ...prev,
      monthly_objectives: prev.monthly_objectives.filter((obj) => obj.id !== id),
    }));
  };

  // ===== GUARDAR =====
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSaving(true);
    setMessage(null);

    try {
      const { error } = await supabase
        .from('assistants')
        .update({
          full_name: formData.full_name,
          phone: formData.phone || null,
          country: formData.country || null,
          timezone: formData.timezone,
          assistant_type: formData.assistant_type || null,
          contract_type: formData.contract_type,
          work_schedule: formData.work_schedule,
          start_date: formData.start_date || null,
          skills: formData.skills,
          languages: formData.languages,
          weekly_objectives: formData.weekly_objectives,
          monthly_objectives: formData.monthly_objectives,
          updated_at: new Date().toISOString(),
        })
        .eq('id', assistantId);

      if (error) throw error;

      setMessage({ type: 'success', text: 'Perfil actualizado correctamente' });
      
      // Limpiar mensaje después de 3 segundos
      setTimeout(() => setMessage(null), 3000);
    } catch (error) {
      console.error('Error saving profile:', error);
      setMessage({ type: 'error', text: 'Error al guardar el perfil' });
    } finally {
      setIsSaving(false);
    }
  };

  // ===== RENDER =====
  
  return (
    <form onSubmit={handleSubmit} className="space-y-8">
      {/* Mensaje de estado */}
      {message && (
        <div
          className={cn(
            'flex items-center gap-2 rounded-lg p-4',
            message.type === 'success' ? 'bg-green-500/10 text-green-400' : 'bg-red-500/10 text-red-400'
          )}
        >
          {message.type === 'success' ? (
            <CheckCircle2 className="h-5 w-5" />
          ) : (
            <AlertCircle className="h-5 w-5" />
          )}
          <span>{message.text}</span>
        </div>
      )}

      {/* ===== DATOS PERSONALES ===== */}
      <section className="card">
        <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <User className="h-5 w-5 text-blue-400" />
          Datos Personales
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="label">Nombre completo *</label>
            <input
              type="text"
              value={formData.full_name}
              onChange={handleChange('full_name')}
              className="input"
              required
            />
          </div>
          
          <div>
            <label className="label">Email</label>
            <input
              type="email"
              value={formData.email}
              className="input bg-slate-800/50"
              disabled
            />
          </div>
          
          <div>
            <label className="label">Teléfono</label>
            <input
              type="tel"
              value={formData.phone}
              onChange={handleChange('phone')}
              className="input"
              placeholder="+1 234 567 8900"
            />
          </div>
          
          <div>
            <label className="label">País</label>
            <input
              type="text"
              value={formData.country}
              onChange={handleChange('country')}
              className="input"
              placeholder="Venezuela, Colombia, México..."
            />
          </div>
          
          <div>
            <label className="label">Zona horaria</label>
            <select
              value={formData.timezone}
              onChange={handleChange('timezone')}
              className="select"
            >
              {TIMEZONES.map((tz) => (
                <option key={tz.value} value={tz.value}>
                  {tz.label}
                </option>
              ))}
            </select>
          </div>
        </div>
      </section>

      {/* ===== DATOS LABORALES ===== */}
      <section className="card">
        <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <Briefcase className="h-5 w-5 text-blue-400" />
          Datos Laborales
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {clientName && (
            <div>
              <label className="label">Cliente asignado</label>
              <div className="input bg-slate-800/50 flex items-center gap-2">
                <Building2 className="h-4 w-4 text-slate-400" />
                <span>{clientName}</span>
              </div>
            </div>
          )}
          
          <div>
            <label className="label">Tipo de asistente</label>
            <select
              value={formData.assistant_type}
              onChange={handleChange('assistant_type')}
              className="select"
            >
              <option value="">Seleccionar...</option>
              {Object.entries(ASSISTANT_TYPE_LABELS).map(([value, label]) => (
                <option key={value} value={value}>
                  {label}
                </option>
              ))}
            </select>
          </div>
          
          <div>
            <label className="label">Tipo de contrato</label>
            <select
              value={formData.contract_type}
              onChange={handleChange('contract_type')}
              className="select"
            >
              {Object.entries(CONTRACT_TYPE_LABELS).map(([value, label]) => (
                <option key={value} value={value}>
                  {label}
                </option>
              ))}
            </select>
          </div>
          
          <div>
            <label className="label">Horario de trabajo</label>
            <input
              type="text"
              value={formData.work_schedule}
              onChange={handleChange('work_schedule')}
              className="input"
              placeholder="10:30-19:30"
            />
          </div>
          
          <div>
            <label className="label">Fecha de inicio</label>
            <input
              type="date"
              value={formData.start_date}
              onChange={handleChange('start_date')}
              className="input"
            />
          </div>
        </div>
      </section>

      {/* ===== HABILIDADES ===== */}
      <section className="card">
        <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
          <Target className="h-5 w-5 text-blue-400" />
          Habilidades e Idiomas
        </h2>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Skills */}
          <div>
            <label className="label">Habilidades técnicas</label>
            <div className="flex gap-2 mb-2">
              <input
                type="text"
                value={newSkill}
                onChange={(e) => setNewSkill(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addSkill())}
                className="input flex-1"
                placeholder="Ej: Excel avanzado, n8n, React..."
              />
              <Button type="button" onClick={addSkill} className="btn-primary">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
            <div className="flex flex-wrap gap-2">
              {formData.skills.map((skill) => (
                <span
                  key={skill}
                  className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 text-sm"
                >
                  {skill}
                  <button
                    type="button"
                    onClick={() => removeSkill(skill)}
                    className="hover:text-red-400"
                  >
                    <Trash2 className="h-3 w-3" />
                  </button>
                </span>
              ))}
            </div>
          </div>
          
          {/* Languages */}
          <div>
            <label className="label">Idiomas</label>
            <div className="flex gap-2 mb-2">
              <input
                type="text"
                value={newLanguage}
                onChange={(e) => setNewLanguage(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addLanguage())}
                className="input flex-1"
                placeholder="Ej: Español nativo, Inglés B2..."
              />
              <Button type="button" onClick={addLanguage} className="btn-primary">
                <Plus className="h-4 w-4" />
              </Button>
            </div>
            <div className="flex flex-wrap gap-2">
              {formData.languages.map((lang) => (
                <span
                  key={lang}
                  className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-emerald-500/20 text-emerald-400 text-sm"
                >
                  {lang}
                  <button
                    type="button"
                    onClick={() => removeLanguage(lang)}
                    className="hover:text-red-400"
                  >
                    <Trash2 className="h-3 w-3" />
                  </button>
                </span>
              ))}
            </div>
          </div>
        </div>
      </section>

      {/* ===== OBJETIVOS SEMANALES ===== */}
      <section className="card">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold text-white flex items-center gap-2">
            <Calendar className="h-5 w-5 text-blue-400" />
            Objetivos Semanales (PLAN_GTC)
          </h2>
          <Button type="button" onClick={addWeeklyObjective} className="btn-outline">
            <Plus className="h-4 w-4 mr-2" />
            Agregar objetivo
          </Button>
        </div>
        
        <div className="space-y-4">
          {formData.weekly_objectives.length === 0 ? (
            <p className="text-slate-500 text-center py-8">
              No hay objetivos semanales. Haz clic en "Agregar objetivo" para comenzar.
            </p>
          ) : (
            formData.weekly_objectives.map((obj, index) => (
              <div key={obj.id} className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                <div className="flex items-start justify-between mb-3">
                  <span className="text-xs text-slate-500">Objetivo #{index + 1}</span>
                  <button
                    type="button"
                    onClick={() => removeWeeklyObjective(obj.id)}
                    className="text-slate-500 hover:text-red-400"
                  >
                    <Trash2 className="h-4 w-4" />
                  </button>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="md:col-span-2">
                    <input
                      type="text"
                      value={obj.objective}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'objective', e.target.value)}
                      className="input"
                      placeholder="Título del objetivo"
                    />
                  </div>
                  
                  <div className="md:col-span-2">
                    <textarea
                      value={obj.description}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'description', e.target.value)}
                      className="input min-h-[80px]"
                      placeholder="Descripción detallada..."
                    />
                  </div>
                  
                  <div>
                    <input
                      type="text"
                      value={obj.key_result}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'key_result', e.target.value)}
                      className="input"
                      placeholder="Resultado clave esperado"
                    />
                  </div>
                  
                  <div className="flex gap-2">
                    <select
                      value={obj.priority}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'priority', e.target.value)}
                      className="select flex-1"
                    >
                      {PRIORITY_OPTIONS.map((opt) => (
                        <option key={opt.value} value={opt.value}>
                          {opt.label}
                        </option>
                      ))}
                    </select>
                    
                    <select
                      value={obj.status}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'status', e.target.value)}
                      className="select flex-1"
                    >
                      {STATUS_OPTIONS.map((opt) => (
                        <option key={opt.value} value={opt.value}>
                          {opt.label}
                        </option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <input
                      type="date"
                      value={obj.due_date}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'due_date', e.target.value)}
                      className="input"
                    />
                  </div>
                  
                  <div>
                    <input
                      type="text"
                      value={obj.comments}
                      onChange={(e) => updateWeeklyObjective(obj.id, 'comments', e.target.value)}
                      className="input"
                      placeholder="Comentarios..."
                    />
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
      </section>

      {/* ===== OBJETIVOS MENSUALES ===== */}
      <section className="card">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold text-white flex items-center gap-2">
            <Target className="h-5 w-5 text-blue-400" />
            Objetivos Mensuales
          </h2>
          <Button type="button" onClick={addMonthlyObjective} className="btn-outline">
            <Plus className="h-4 w-4 mr-2" />
            Agregar objetivo
          </Button>
        </div>
        
        <div className="space-y-4">
          {formData.monthly_objectives.length === 0 ? (
            <p className="text-slate-500 text-center py-8">
              No hay objetivos mensuales definidos.
            </p>
          ) : (
            formData.monthly_objectives.map((obj, index) => (
              <div key={obj.id} className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                <div className="flex items-start justify-between mb-3">
                  <span className="text-xs text-slate-500">Objetivo mensual #{index + 1}</span>
                  <button
                    type="button"
                    onClick={() => removeMonthlyObjective(obj.id)}
                    className="text-slate-500 hover:text-red-400"
                  >
                    <Trash2 className="h-4 w-4" />
                  </button>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                  <div className="md:col-span-2">
                    <input
                      type="text"
                      value={obj.objective}
                      onChange={(e) => updateMonthlyObjective(obj.id, 'objective', e.target.value)}
                      className="input"
                      placeholder="Título del objetivo"
                    />
                  </div>
                  
                  <div className="md:col-span-2">
                    <textarea
                      value={obj.description}
                      onChange={(e) => updateMonthlyObjective(obj.id, 'description', e.target.value)}
                      className="input min-h-[80px]"
                      placeholder="Descripción..."
                    />
                  </div>
                  
                  <div>
                    <input
                      type="text"
                      value={obj.key_result}
                      onChange={(e) => updateMonthlyObjective(obj.id, 'key_result', e.target.value)}
                      className="input"
                      placeholder="Resultado clave"
                    />
                  </div>
                  
                  <div>
                    <label className="label text-xs">Progreso: {obj.progress}%</label>
                    <input
                      type="range"
                      min="0"
                      max="100"
                      value={obj.progress}
                      onChange={(e) => updateMonthlyObjective(obj.id, 'progress', parseInt(e.target.value))}
                      className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                    />
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
      </section>

      {/* ===== BOTÓN GUARDAR ===== */}
      <div className="flex justify-end">
        <Button type="submit" disabled={isSaving} className="btn-primary">
          {isSaving ? (
            <>
              <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent mr-2" />
              Guardando...
            </>
          ) : (
            <>
              <Save className="h-4 w-4 mr-2" />
              Guardar cambios
            </>
          )}
        </Button>
      </div>
    </form>
  );
}

export default AssistantProfileForm;
</file>

<file path="src/components/reportes/AssistantStatusCard.tsx">
'use client';

// =====================================================
// ASSISTANT STATUS CARD - Card de estado por asistente
// =====================================================

import { memo } from 'react';
import Link from 'next/link';
import {
  CheckCircle2,
  Clock,
  AlertCircle,
  FileText,
  AlertTriangle,
  ExternalLink,
  Star,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import type { AssistantSubmissionStatus } from '@/types/reports.types';

interface AssistantStatusCardProps {
  assistant: AssistantSubmissionStatus;
  onSendReminder?: (assistantId: string) => void;
}

function AssistantStatusCardComponent({
  assistant,
  onSendReminder,
}: AssistantStatusCardProps) {
  const getInitials = (name: string): string => {
    return name
      .split(' ')
      .map((n) => n[0])
      .join('')
      .toUpperCase()
      .slice(0, 2);
  };

  const getStatusIcon = () => {
    if (assistant.has_submitted) {
      return <CheckCircle2 className="h-5 w-5 text-emerald-400" />;
    }
    if (assistant.days_late > 0) {
      return <AlertCircle className="h-5 w-5 text-red-400" />;
    }
    return <Clock className="h-5 w-5 text-amber-400" />;
  };

  const getStatusBadge = () => {
    if (assistant.has_submitted) {
      return (
        <Badge
          variant="outline"
          className="bg-emerald-500/20 text-emerald-400 border-emerald-500/30"
        >
          Entregado
        </Badge>
      );
    }
    if (assistant.days_late > 0) {
      return (
        <Badge
          variant="outline"
          className="bg-red-500/20 text-red-400 border-red-500/30"
        >
          {assistant.days_late} día{assistant.days_late !== 1 && 's'} de retraso
        </Badge>
      );
    }
    return (
      <Badge
        variant="outline"
        className="bg-amber-500/20 text-amber-400 border-amber-500/30"
      >
        Pendiente
      </Badge>
    );
  };

  return (
    <div
      className={cn(
        'group relative rounded-lg border p-4 transition-all duration-200',
        assistant.has_submitted
          ? 'border-slate-700 bg-slate-800/30 hover:bg-slate-800/50'
          : assistant.days_late > 0
          ? 'border-red-500/30 bg-red-500/5 hover:bg-red-500/10'
          : 'border-amber-500/30 bg-amber-500/5 hover:bg-amber-500/10'
      )}
    >
      <div className="flex items-start gap-4">
        {/* Avatar */}
        <Avatar className="h-12 w-12 border-2 border-slate-700">
          <AvatarImage src={assistant.avatar_url ?? undefined} />
          <AvatarFallback className="bg-slate-700 text-slate-300">
            {getInitials(assistant.full_name)}
          </AvatarFallback>
        </Avatar>

        {/* Info */}
        <div className="flex-1 min-w-0">
          <div className="flex items-start justify-between gap-2">
            <div>
              <h3 className="font-medium text-slate-100 truncate">
                {assistant.full_name}
              </h3>
              <p className="text-sm text-slate-400 truncate">
                {assistant.position ?? assistant.email}
              </p>
            </div>
            {getStatusIcon()}
          </div>

          {/* Detalles según estado */}
          <div className="mt-3 flex flex-wrap items-center gap-2">
            {getStatusBadge()}

            {assistant.has_submitted && (
              <>
                {/* Contadores */}
                <div className="flex items-center gap-1 text-sm text-slate-400">
                  <FileText className="h-3.5 w-3.5" />
                  <span>{assistant.plan_count}</span>
                </div>
                <div className="flex items-center gap-1 text-sm text-slate-400">
                  <AlertTriangle className="h-3.5 w-3.5" />
                  <span>{assistant.rupture_count}</span>
                </div>

                {/* Score si existe */}
                {assistant.quality_score !== null && (
                  <div className="flex items-center gap-1 text-sm">
                    <Star className="h-3.5 w-3.5 text-amber-400" />
                    <span className="text-amber-400 font-medium">
                      {assistant.quality_score.toFixed(1)}
                    </span>
                  </div>
                )}

                {/* Fecha de envío */}
                {assistant.submitted_at && (
                  <span className="text-xs text-slate-500">
                    {new Date(assistant.submitted_at).toLocaleDateString('es-ES', {
                      weekday: 'short',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                    })}
                  </span>
                )}
              </>
            )}
          </div>
        </div>

        {/* Actions */}
        <div className="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
          {assistant.has_submitted && assistant.submission_id ? (
            <Link href={`/reportes/semanal/${assistant.submission_id}`}>
              <Button
                variant="ghost"
                size="sm"
                className="text-slate-400 hover:text-slate-200"
              >
                <ExternalLink className="h-4 w-4 mr-1" />
                Ver
              </Button>
            </Link>
          ) : (
            onSendReminder && (
              <Button
                variant="ghost"
                size="sm"
                onClick={() => onSendReminder(assistant.assistant_id)}
                className="text-amber-400 hover:text-amber-300 hover:bg-amber-500/10"
              >
                Recordar
              </Button>
            )
          )}
        </div>
      </div>
    </div>
  );
}

export const AssistantStatusCard = memo(AssistantStatusCardComponent);
</file>

<file path="src/components/reportes/index.ts">
// =====================================================
// REPORTES - Exports
// =====================================================

export { PlanEntryCard } from './PlanEntryCard';
export { RuptureEntryCard } from './RuptureEntryCard';
export { WeeklyReportForm } from './WeeklyReportForm';
export { SubmitConfirmDialog } from './SubmitConfirmDialog';
export { QualityDashboard } from './QualityDashboard';
export { AssistantStatusCard } from './AssistantStatusCard';
export { WeekSelector } from './WeekSelector';
export { ProgressRing } from './ProgressRing';
</file>

<file path="src/components/reportes/monthly/ActivitiesTab.tsx">
'use client';

import { Plus, Trash2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent } from '@/components/ui/card';
import type { MonthlyActivity } from '@/types/database.types';

interface ActivitiesTabProps {
    data: MonthlyActivity[];
    onChange: (data: MonthlyActivity[]) => void;
    readOnly?: boolean;
}

export function ActivitiesTab({ data, onChange, readOnly }: ActivitiesTabProps) {

    const handleAdd = () => {
        onChange([
            ...data,
            { id: crypto.randomUUID(), category: '', description: '' }
        ]);
    };

    const handleUpdate = (index: number, field: keyof MonthlyActivity, value: string) => {
        const newData = [...data];
        newData[index] = { ...newData[index], [field]: value };
        onChange(newData);
    };

    const handleRemove = (index: number) => {
        onChange(data.filter((_, i) => i !== index));
    };

    return (
        <div className="space-y-6">
            <div className="bg-slate-800/50 p-6 rounded-lg text-center space-y-2">
                <h3 className="text-lg font-medium text-slate-200">Añadir actividades realizadas</h3>
                {!readOnly && (
                    <div className="space-y-4 max-w-3xl mx-auto mt-4">
                        <div className="bg-slate-900 border border-slate-700 rounded-lg p-4 space-y-4">
                            <Input
                                placeholder="Categoría de la actividad"
                                className="bg-slate-800 border-slate-700"
                                // Note: This is a simplified UI. Ideally we have a form to add new, 
                                // but per screenshot it looks like a list. 
                                // Actually the screenshot shows a form to "Añadir". 
                                // Let's implement the list rendering below and a separate add form if we want to match strictly, 
                                // or just edit in place. Editing in place is faster for users.
                                // Let's stick to "Add Rule" style: Click Add -> New Row appears.
                                disabled // Just a placeholder visual to match "Añadir actividades" header concept?
                            // Actually, let's implement the "Add" button properly.
                            />
                            <Textarea
                                placeholder="Descripción detallada de la actividad"
                                className="bg-slate-800 border-slate-700 min-h-[100px]"
                                disabled
                            />
                            <div className="flex justify-end">
                                <Button onClick={handleAdd} className="bg-blue-600 hover:bg-blue-700">
                                    <Plus className="h-4 w-4 mr-2" />
                                    Añadir (Nueva fila)
                                </Button>
                            </div>
                        </div>
                    </div>
                )}
            </div>

            <div className="space-y-4">
                {/* Header Row */}
                <div className="grid grid-cols-12 gap-4 px-4 py-2 bg-slate-800 rounded-t-lg font-medium text-xs text-slate-400 uppercase tracking-wider">
                    <div className="col-span-3">Categoría</div>
                    <div className="col-span-8">Descripción</div>
                    <div className="col-span-1 text-center">Acciones</div>
                </div>

                {/* List */}
                {data.length === 0 ? (
                    <div className="text-center py-10 text-slate-500 border border-dashed border-slate-800 rounded-b-lg">
                        No hay actividades registradas. Haz clic en Añadir.
                    </div>
                ) : (
                    <div className="space-y-2">
                        {data.map((item, index) => (
                            <div key={item.id} className="grid grid-cols-12 gap-4 p-4 bg-slate-800/30 border border-slate-700/50 rounded-lg items-start hover:bg-slate-800/50 transition-colors">
                                <div className="col-span-3">
                                    <Input
                                        value={item.category}
                                        onChange={(e) => handleUpdate(index, 'category', e.target.value)}
                                        placeholder="Ej: Desarrollo"
                                        className="bg-slate-900/50 border-slate-700 h-8 text-sm"
                                        disabled={readOnly}
                                    />
                                </div>
                                <div className="col-span-8">
                                    <Textarea
                                        value={item.description}
                                        onChange={(e) => handleUpdate(index, 'description', e.target.value)}
                                        placeholder="Descripción..."
                                        className="bg-slate-900/50 border-slate-700 min-h-[60px] text-sm"
                                        disabled={readOnly}
                                    />
                                </div>
                                <div className="col-span-1 flex justify-center pt-2">
                                    {!readOnly && (
                                        <Button variant="ghost" size="icon" onClick={() => handleRemove(index)} className="h-8 w-8 text-slate-500 hover:text-red-400">
                                            <Trash2 className="h-4 w-4" />
                                        </Button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/components/reportes/monthly/MetricsTab.tsx">
'use client';

import { useState } from 'react';
import { UploadCloud, FileIcon, Trash2, ExternalLink } from 'lucide-react';
import { createClient } from '@/lib/supabase/client';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import type { MonthlyMetric } from '@/types/database.types';
import { toast } from 'sonner';

interface MetricsTabProps {
    data: MonthlyMetric[];
    onChange: (data: MonthlyMetric[]) => void;
    readOnly?: boolean;
}

export function MetricsTab({ data, onChange, readOnly }: MetricsTabProps) {
    const [uploading, setUploading] = useState(false);
    const supabase = createClient();

    const handleUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (!file || readOnly) return;

        try {
            setUploading(true);
            const fileExt = file.name.split('.').pop();
            const fileName = `${Math.random().toString(36).substring(2)}_${Date.now()}.${fileExt}`;
            const filePath = `${fileName}`;

            const { error: uploadError } = await supabase.storage
                .from('monthly_reports')
                .upload(filePath, file);

            if (uploadError) throw uploadError;

            const { data: { publicUrl } } = supabase.storage
                .from('monthly_reports')
                .getPublicUrl(filePath);

            toast.success('Archivo subido correctamente');

            onChange([
                ...data,
                {
                    id: crypto.randomUUID(),
                    name: file.name,
                    url: publicUrl,
                    size: file.size,
                    type: file.type
                }
            ]);
        } catch (error: any) {
            console.error('Error uploading file:', error);
            toast.error('Error al subir archivo: ' + error.message);
        } finally {
            setUploading(false);
            // Reset input
            e.target.value = '';
        }
    };

    const handleRemove = (index: number) => {
        onChange(data.filter((_, i) => i !== index));
    };

    return (
        <div className="space-y-6">
            <div className="bg-slate-800/50 p-8 rounded-lg text-center border-2 border-dashed border-slate-700 hover:border-slate-600 transition-colors">
                <div className="flex flex-col items-center gap-4">
                    <div className="h-12 w-12 rounded-full bg-slate-900 flex items-center justify-center">
                        <UploadCloud className="h-6 w-6 text-slate-400" />
                    </div>
                    <div>
                        <h3 className="text-lg font-medium text-slate-200">Métricas</h3>
                        <p className="text-sm text-slate-400 mt-1">Sube tus archivos (PNG, JPG, PDF)</p>
                    </div>
                    {!readOnly && (
                        <div className="relative">
                            <input
                                type="file"
                                onChange={handleUpload}
                                className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                accept=".png,.jpg,.jpeg,.pdf"
                                disabled={uploading}
                            />
                            <Button variant="secondary" disabled={uploading}>
                                {uploading ? 'Subiendo...' : 'Seleccionar archivo'}
                            </Button>
                        </div>
                    )}
                </div>
            </div>

            <div className="space-y-4">
                {data.length > 0 && <h4 className="text-sm font-medium text-slate-400 uppercase tracking-wider px-2">Archivos Subidos</h4>}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {data.map((file, index) => (
                        <Card key={file.id} className="p-4 bg-slate-800 border-slate-700 flex items-center justify-between group">
                            <div className="flex items-center gap-3 overflow-hidden">
                                <div className="h-10 w-10 rounded bg-slate-900 flex items-center justify-center shrink-0">
                                    <FileIcon className="h-5 w-5 text-blue-400" />
                                </div>
                                <div className="min-w-0">
                                    <p className="text-sm font-medium text-slate-200 truncate">{file.name}</p>
                                    <p className="text-xs text-slate-500">{(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-1">
                                <Button variant="ghost" size="icon" asChild className="h-8 w-8 text-slate-400 hover:text-white">
                                    <a href={file.url} target="_blank" rel="noopener noreferrer">
                                        <ExternalLink className="h-4 w-4" />
                                    </a>
                                </Button>
                                {!readOnly && (
                                    <Button variant="ghost" size="icon" onClick={() => handleRemove(index)} className="h-8 w-8 text-slate-500 hover:text-red-400">
                                        <Trash2 className="h-4 w-4" />
                                    </Button>
                                )}
                            </div>
                        </Card>
                    ))}
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/components/reportes/monthly/MonthlyReportForm.tsx">
'use client';

import { useState, useEffect } from 'react';
import { createClient } from '@/lib/supabase/client';
import { toast } from 'sonner';
import {
    FileText,
    Target,
    Lightbulb,
    BarChart3,
    Save,
    Send,
    Loader2,
    AlertCircle
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from '@/components/ui/tooltip';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import type { MonthlyReport, Assistant, Profile } from '@/types/database.types';
import { useReportBackup } from '../../../hooks/useReportBackup';

// Placeholder Tabs - Will be replaced by real components later
import { ActivitiesTab } from './ActivitiesTab';
import { ObjectivesTab } from './ObjectivesTab';
import { SuggestionsTab } from './SuggestionsTab';
import { MetricsTab } from './MetricsTab';
import { SummaryTab } from './SummaryTab';

export function MonthlyReportForm() {
    const [loading, setLoading] = useState(true);
    const [saving, setSaving] = useState(false);
    const [report, setReport] = useState<MonthlyReport | null>(null);
    const [assistant, setAssistant] = useState<Assistant | null>(null);
    const [profile, setProfile] = useState<Profile | null>(null);
    const [currentDate] = useState(new Date());



    // ... inside component
    // Backup hook
    const backupKey = `monthly_report_draft_${assistant?.id}_${currentDate.getMonth() + 1}_${currentDate.getFullYear()}`;
    useReportBackup(backupKey, report);

    const supabase = createClient();

    useEffect(() => {
        fetchReport();
    }, [assistant?.id]); // Add dependency

    async function fetchReport() {
        try {
            setLoading(true);

            // 1. Get User
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;

            // Fetch Profile (to check role/permissions)
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();

            setProfile(profile);

            // 2. Get Assistant
            const { data: assistantData, error: assistantError } = await supabase
                .from('assistants')
                .select('*')
                .eq('user_id', user.id)
                .single();

            if (assistantError) {
                console.error('Assistant not found', assistantError);
                setLoading(false);
                return;
            }
            setAssistant(assistantData);

            // 3. Try to load from LocalStorage first (if no report loaded yet)
            // effectiveBackupKey needed because assistant might not be set in outer scope initially
            const effectiveKey = `monthly_report_draft_${assistantData.id}_${currentDate.getMonth() + 1}_${currentDate.getFullYear()}`;
            const localBackup = window.localStorage.getItem(effectiveKey);

            // 4. Get Current Month Report from DB
            const month = currentDate.getMonth() + 1;
            const year = currentDate.getFullYear();

            const { data: reportData, error: reportError } = await supabase
                .from('monthly_reports')
                .select('*')
                .eq('assistant_id', assistantData.id)
                .eq('month', month)
                .eq('year', year)
                .single();

            if (reportData) {
                // If DB has data, use it. 
                // Context: Usually DB is source of truth. 
                // But if user was working offline? For now, DB wins if exists.
                setReport(reportData);
            } else {
                if (reportError && reportError.code !== 'PGRST116') {
                    // Log error but don't show toast if it looks like "relation does not exist" type errors (e.g. 42P01) 
                    // checking code might be tricky client side without full error obj details, 
                    // but usually 400/500 series.
                    // For now, suppress the toast if we can fallback to a draft.
                    console.warn('Error fetching report (might be missing table):', reportError);
                }

                // If no DB data, check local backup
                if (localBackup) {
                    try {
                        const parsed = JSON.parse(localBackup);
                        if (parsed) {
                            setReport(parsed);
                            toast.success('Borrador recuperado del almacenamiento local');
                            setLoading(false);
                            return;
                        }
                    } catch (e) {
                        console.error('Error parsing backup', e);
                    }
                }

                // If nothing, init new draft
                const newReport: MonthlyReport = {
                    id: crypto.randomUUID(),
                    assistant_id: assistantData.id,
                    month,
                    year,
                    status: 'borrador',
                    activities: [],
                    objectives: [],
                    suggestions: [],
                    metrics_files: [],
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                setReport(newReport);
            }

        } catch (error) {
            console.error('Error:', error);
            // toast.error('Error desconocido'); // Suppress general error to avoid scaring user on first load
        } finally {
            setLoading(false);
        }
    }

    async function handleSave(isSubmit = false) {
        if (!report || !assistant) return;
        setSaving(true);

        try {
            const payload = {
                assistant_id: report.assistant_id,
                month: report.month,
                year: report.year,
                status: isSubmit ? 'enviado' : 'borrador',
                activities: report.activities,
                objectives: report.objectives,
                suggestions: report.suggestions,
                metrics_files: report.metrics_files,
                updated_at: new Date().toISOString()
            };

            // Check if exists really in DB
            const { data: existing } = await supabase
                .from('monthly_reports')
                .select('id')
                .eq('assistant_id', report.assistant_id)
                .eq('month', report.month)
                .eq('year', report.year)
                .single();

            let error;
            if (existing) {
                const { error: updateError } = await supabase
                    .from('monthly_reports')
                    .update(payload)
                    .eq('id', existing.id);
                error = updateError;
            } else {
                const { error: insertError } = await supabase
                    .from('monthly_reports')
                    .insert(payload as any);
                error = insertError;
            }

            if (error) throw error;

            toast.success(isSubmit ? 'Reporte enviado correctamente' : 'Borrador guardado');
            if (isSubmit) {
                setReport(prev => prev ? { ...prev, status: 'enviado' } : null);
            }
        } catch (err: any) {
            console.error(err);
            toast.error('Error al guardar: ' + err.message);
        } finally {
            setSaving(false);
        }
    }

    if (loading) {
        return <div className="flex justify-center p-12"><Loader2 className="h-8 w-8 animate-spin text-slate-500" /></div>;
    }

    if (!assistant) {
        return (
            <Alert variant="destructive" className="m-6 max-w-2xl">
                <AlertCircle className="h-4 w-4" />
                <AlertTitle>Error de Acceso</AlertTitle>
                <AlertDescription>No se encontró un perfil de asistente asociado a tu usuario.</AlertDescription>
            </Alert>
        );
    }

    return (
        <div className="space-y-6 max-w-6xl mx-auto pb-10">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight text-white mb-1">Informe Mensual</h1>
                    <p className="text-slate-400">
                        {currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}
                    </p>
                </div>

                <div className="flex items-center gap-2">
                    {report?.status === 'borrador' && (
                        <>
                            <Button variant="outline" onClick={() => handleSave(false)} disabled={saving}>
                                <Save className="h-4 w-4 mr-2" />
                                Guardar Borrador
                            </Button>

                            {/* Logic for submission locking */}
                            {(() => {
                                const dayOfMonth = currentDate.getDate();
                                const isSubmissionPeriod = dayOfMonth >= 23 && dayOfMonth <= 25;
                                const isAutomationDirector = profile?.department === 'automation' && profile?.position === 'director';
                                const isAdmin = profile?.role === 'admin';

                                const canSubmit = isSubmissionPeriod || isAutomationDirector || isAdmin;

                                const SubmitButton = (
                                    <Button
                                        onClick={() => handleSave(true)}
                                        disabled={saving || !canSubmit}
                                        className={cn(
                                            "bg-blue-600 hover:bg-blue-700",
                                            !canSubmit && "opacity-50 cursor-not-allowed"
                                        )}
                                    >
                                        <Send className="h-4 w-4 mr-2" />
                                        Enviar Reporte
                                    </Button>
                                );

                                if (!canSubmit) {
                                    return (
                                        <TooltipProvider>
                                            <Tooltip>
                                                <TooltipTrigger asChild>
                                                    <div className="cursor-not-allowed">
                                                        {SubmitButton}
                                                    </div>
                                                </TooltipTrigger>
                                                <TooltipContent>
                                                    <p>El envío de reportes solo está habilitado del 23 al 25 de cada mes.</p>
                                                </TooltipContent>
                                            </Tooltip>
                                        </TooltipProvider>
                                    );
                                }

                                return SubmitButton;
                            })()}
                        </>
                    )}
                    {report?.status === 'enviado' && (
                        <Badge className="bg-green-500/10 text-green-500 border-green-500/20 px-3 py-1">
                            Enviado
                        </Badge>
                    )}
                </div>
            </div>

            <Tabs defaultValue="activities" className="w-full">
                <TabsList className="grid w-full grid-cols-5 bg-slate-900/50 border border-slate-800 h-14 p-1">
                    <TabsTrigger value="activities" className="data-[state=active]:bg-slate-800 h-full">
                        <FileText className="h-4 w-4 mr-2" />
                        Actividades
                    </TabsTrigger>
                    <TabsTrigger value="objectives" className="data-[state=active]:bg-slate-800 h-full">
                        <Target className="h-4 w-4 mr-2" />
                        Objetivos
                    </TabsTrigger>
                    <TabsTrigger value="suggestions" className="data-[state=active]:bg-slate-800 h-full">
                        <Lightbulb className="h-4 w-4 mr-2" />
                        Sugerencias
                    </TabsTrigger>
                    <TabsTrigger value="metrics" className="data-[state=active]:bg-slate-800 h-full">
                        <BarChart3 className="h-4 w-4 mr-2" />
                        Métricas
                    </TabsTrigger>
                    <TabsTrigger value="summary" className="data-[state=active]:bg-slate-800 h-full">
                        Ver Datos
                    </TabsTrigger>
                </TabsList>

                <Card className="mt-4 border-slate-800 bg-slate-900/30 backdrop-blur-sm min-h-[500px]">
                    <CardContent className="p-6">
                        <TabsContent value="activities" className="mt-0">
                            <ActivitiesTab
                                data={report?.activities || []}
                                onChange={val => setReport(prev => prev ? { ...prev, activities: val } : null)}
                                readOnly={report?.status === 'enviado'}
                            />
                        </TabsContent>

                        <TabsContent value="objectives" className="mt-0">
                            <ObjectivesTab
                                data={report?.objectives || []}
                                onChange={val => setReport(prev => prev ? { ...prev, objectives: val } : null)}
                                readOnly={report?.status === 'enviado'}
                            />
                        </TabsContent>

                        <TabsContent value="suggestions" className="mt-0">
                            <SuggestionsTab
                                data={report?.suggestions || []}
                                onChange={val => setReport(prev => prev ? { ...prev, suggestions: val } : null)}
                                readOnly={report?.status === 'enviado'}
                            />
                        </TabsContent>

                        <TabsContent value="metrics" className="mt-0">
                            <MetricsTab
                                data={report?.metrics_files || []}
                                onChange={val => setReport(prev => prev ? { ...prev, metrics_files: val } : null)}
                                readOnly={report?.status === 'enviado'}
                            />
                        </TabsContent>

                        <TabsContent value="summary" className="mt-0">
                            <SummaryTab report={report} />
                        </TabsContent>
                    </CardContent>
                </Card>
            </Tabs>
        </div>
    );
}
</file>

<file path="src/components/reportes/monthly/ObjectivesTab.tsx">
'use client';

import { Plus, Trash2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import type { MonthlyObjectiveEntry } from '@/types/database.types';

interface ObjectivesTabProps {
    data: MonthlyObjectiveEntry[];
    onChange: (data: MonthlyObjectiveEntry[]) => void;
    readOnly?: boolean;
}

export function ObjectivesTab({ data, onChange, readOnly }: ObjectivesTabProps) {

    const handleAdd = () => {
        onChange([
            ...data,
            { id: crypto.randomUUID(), established: '', achieved: '' }
        ]);
    };

    const handleUpdate = (index: number, field: keyof MonthlyObjectiveEntry, value: string) => {
        const newData = [...data];
        newData[index] = { ...newData[index], [field]: value };
        onChange(newData);
    };

    const handleRemove = (index: number) => {
        onChange(data.filter((_, i) => i !== index));
    };

    return (
        <div className="space-y-6">
            <div className="bg-slate-800/50 p-6 rounded-lg text-center space-y-2">
                <h3 className="text-lg font-medium text-slate-200">Añadir Objetivos</h3>
                {!readOnly && (
                    <div className="flex justify-center mt-4">
                        <Button onClick={handleAdd} className="bg-blue-600 hover:bg-blue-700">
                            <Plus className="h-4 w-4 mr-2" />
                            Añadir Nuevo Objetivo
                        </Button>
                    </div>
                )}
            </div>

            <div className="space-y-4">
                {/* Header */}
                <div className="grid grid-cols-12 gap-4 px-4 py-2 bg-slate-800 rounded-t-lg font-medium text-xs text-slate-400 uppercase tracking-wider">
                    <div className="col-span-5">Objetivo Establecido</div>
                    <div className="col-span-6">Objetivo Alcanzado (Descripción)</div>
                    <div className="col-span-1 text-center">Acciones</div>
                </div>

                {/* List */}
                {data.length === 0 ? (
                    <div className="text-center py-10 text-slate-500 border border-dashed border-slate-800 rounded-b-lg">
                        No hay objetivos registrados.
                    </div>
                ) : (
                    <div className="space-y-2">
                        {data.map((item, index) => (
                            <div key={item.id} className="grid grid-cols-12 gap-4 p-4 bg-slate-800/30 border border-slate-700/50 rounded-lg items-start hover:bg-slate-800/50 transition-colors">
                                <div className="col-span-5">
                                    <Input
                                        value={item.established}
                                        onChange={(e) => handleUpdate(index, 'established', e.target.value)}
                                        placeholder="Ej: Aumentar ventas 10%"
                                        className="bg-slate-900/50 border-slate-700 h-8 text-sm"
                                        disabled={readOnly}
                                    />
                                </div>
                                <div className="col-span-6">
                                    <Textarea
                                        value={item.achieved}
                                        onChange={(e) => handleUpdate(index, 'achieved', e.target.value)}
                                        placeholder="Se logró un aumento del 12%..."
                                        className="bg-slate-900/50 border-slate-700 min-h-[60px] text-sm"
                                        disabled={readOnly}
                                    />
                                </div>
                                <div className="col-span-1 flex justify-center pt-2">
                                    {!readOnly && (
                                        <Button variant="ghost" size="icon" onClick={() => handleRemove(index)} className="h-8 w-8 text-slate-500 hover:text-red-400">
                                            <Trash2 className="h-4 w-4" />
                                        </Button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/components/reportes/monthly/SuggestionsTab.tsx">
'use client';

import { Plus, Trash2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import type { MonthlySuggestion } from '@/types/database.types';

interface SuggestionsTabProps {
    data: MonthlySuggestion[];
    onChange: (data: MonthlySuggestion[]) => void;
    readOnly?: boolean;
}

export function SuggestionsTab({ data, onChange, readOnly }: SuggestionsTabProps) {

    const handleAdd = () => {
        onChange([
            ...data,
            { id: crypto.randomUUID(), description: '' }
        ]);
    };

    const handleUpdate = (index: number, value: string) => {
        const newData = [...data];
        newData[index] = { ...newData[index], description: value };
        onChange(newData);
    };

    const handleRemove = (index: number) => {
        onChange(data.filter((_, i) => i !== index));
    };

    return (
        <div className="space-y-6">
            <div className="bg-slate-800/50 p-6 rounded-lg text-center space-y-2">
                <h3 className="text-lg font-medium text-slate-200">Añadir Sugerencias</h3>
                {!readOnly && (
                    <div className="flex justify-center mt-4">
                        <Button onClick={handleAdd} className="bg-blue-600 hover:bg-blue-700">
                            <Plus className="h-4 w-4 mr-2" />
                            Añadir Sugerencia
                        </Button>
                    </div>
                )}
            </div>

            <div className="space-y-4">
                <div className="grid grid-cols-12 gap-4 px-4 py-2 bg-slate-800 rounded-t-lg font-medium text-xs text-slate-400 uppercase tracking-wider">
                    <div className="col-span-11">Sugerencia</div>
                    <div className="col-span-1 text-center">Acciones</div>
                </div>

                {data.length === 0 ? (
                    <div className="text-center py-10 text-slate-500 border border-dashed border-slate-800 rounded-b-lg">
                        No hay sugerencias registradas.
                    </div>
                ) : (
                    <div className="space-y-2">
                        {data.map((item, index) => (
                            <div key={item.id} className="grid grid-cols-12 gap-4 p-4 bg-slate-800/30 border border-slate-700/50 rounded-lg items-start hover:bg-slate-800/50 transition-colors">
                                <div className="col-span-11">
                                    <Textarea
                                        value={item.description}
                                        onChange={(e) => handleUpdate(index, e.target.value)}
                                        placeholder="Describe tu sugerencia técnica aquí..."
                                        className="bg-slate-900/50 border-slate-700 min-h-[80px] text-sm"
                                        disabled={readOnly}
                                    />
                                </div>
                                <div className="col-span-1 flex justify-center pt-2">
                                    {!readOnly && (
                                        <Button variant="ghost" size="icon" onClick={() => handleRemove(index)} className="h-8 w-8 text-slate-500 hover:text-red-400">
                                            <Trash2 className="h-4 w-4" />
                                        </Button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="src/components/reportes/monthly/SummaryTab.tsx">
'use client';

import type { MonthlyReport } from '@/types/database.types';
import { Badge } from '@/components/ui/badge';

interface SummaryTabProps {
    report: MonthlyReport | null;
}

export function SummaryTab({ report }: SummaryTabProps) {
    if (!report) return null;

    const activities = report.activities || [];
    const objectives = report.objectives || [];
    const suggestions = report.suggestions || [];
    const metrics_files = report.metrics_files || [];

    const sections = [
        {
            title: 'Actividades',
            items: activities,
            renderItem: (item: any) => (
                <li key={item.id} className="text-sm text-slate-300 leading-relaxed">
                    <strong className="text-slate-100">{item.category}:</strong> {item.description}
                </li>
            )
        },
        {
            title: 'Objetivos',
            items: objectives,
            renderItem: (item: any) => (
                <li key={item.id} className="text-sm text-slate-300 leading-relaxed">
                    <strong className="text-slate-100">{item.established}</strong>
                    <br />
                    <span className="text-slate-400">Resultado: {item.achieved}</span>
                </li>
            )
        },
        {
            title: 'Sugerencias',
            items: suggestions,
            renderItem: (item: any) => (
                <li key={item.id} className="text-sm text-slate-300 leading-relaxed">
                    {item.description}
                </li>
            )
        },
        {
            title: 'Métricas',
            items: metrics_files,
            renderItem: (item: any) => (
                <li key={item.id} className="text-sm text-slate-400 italic">
                    {item.name} ({(item.size / 1024 / 1024).toFixed(2)} MB)
                </li>
            )
        }
    ];

    return (
        <div className="space-y-8 bg-white p-8 rounded-lg shadow-sm text-slate-900 max-w-4xl mx-auto">
            <div className="border-b pb-4 mb-6 flex justify-between items-end">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800">Reporte {report.month}/{report.year}</h2>
                    <p className="text-sm text-slate-500 mt-1">Estado: <Badge variant="outline" className="uppercase text-xs">{report.status}</Badge> · Fecha: {new Date(report.updated_at).toLocaleDateString()} </p>
                </div>
                <div className="text-right">
                    <p className="text-xs text-slate-400">Global Talent Connections</p>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                {/* Left Column: Activities */}
                <div className="space-y-6">
                    <div>
                        <h3 className="text-lg font-bold text-slate-800 mb-3 border-b border-slate-200 pb-1">Actividades</h3>
                        {report.activities.length > 0 ? (
                            <ul className="space-y-4 list-disc pl-5 marker:text-slate-400">
                                {sections[0].items.map(sections[0].renderItem)}
                            </ul>
                        ) : <p className="text-sm text-slate-400 italic">Sin actividades.</p>}
                    </div>

                    <div>
                        <h3 className="text-lg font-bold text-slate-800 mb-3 border-b border-slate-200 pb-1">Sugerencias</h3>
                        {report.suggestions.length > 0 ? (
                            <ul className="space-y-4 list-disc pl-5 marker:text-slate-400">
                                {sections[2].items.map(sections[2].renderItem)}
                            </ul>
                        ) : <p className="text-sm text-slate-400 italic">Sin sugerencias.</p>}
                    </div>
                </div>

                {/* Right Column: Objectives & Metrics */}
                <div className="space-y-6">
                    <div>
                        <h3 className="text-lg font-bold text-slate-800 mb-3 border-b border-slate-200 pb-1">Objetivos</h3>
                        {report.objectives.length > 0 ? (
                            <ul className="space-y-4 list-disc pl-5 marker:text-slate-400">
                                {sections[1].items.map(sections[1].renderItem)}
                            </ul>
                        ) : <p className="text-sm text-slate-400 italic">Sin objetivos.</p>}
                    </div>

                    <div>
                        <h3 className="text-lg font-bold text-slate-800 mb-3 border-b border-slate-200 pb-1">Métricas</h3>
                        {report.metrics_files.length > 0 ? (
                            <ul className="space-y-2 list-none">
                                {sections[3].items.map(sections[3].renderItem)}
                            </ul>
                        ) : <p className="text-sm text-slate-400 italic">Sin métricas adjuntas.</p>}
                    </div>
                </div>
            </div>

        </div>
    );
}
</file>

<file path="src/components/reportes/ProgressRing.tsx">
'use client';

// =====================================================
// PROGRESS RING - Anillo de progreso SVG animado
// =====================================================

import { useMemo } from 'react';
import { cn } from '@/lib/utils';

interface ProgressRingProps {
  progress: number; // 0-100
  size?: number;
  strokeWidth?: number;
  className?: string;
  showPercentage?: boolean;
  colorClass?: string;
}

export function ProgressRing({
  progress,
  size = 120,
  strokeWidth = 8,
  className,
  showPercentage = true,
  colorClass,
}: ProgressRingProps) {
  const radius = (size - strokeWidth) / 2;
  const circumference = radius * 2 * Math.PI;
  const clampedProgress = Math.min(100, Math.max(0, progress));
  const strokeDashoffset = circumference - (clampedProgress / 100) * circumference;

  const colorByProgress = useMemo(() => {
    if (colorClass) return colorClass;
    if (clampedProgress >= 80) return 'text-emerald-500';
    if (clampedProgress >= 50) return 'text-amber-500';
    return 'text-red-500';
  }, [clampedProgress, colorClass]);

  return (
    <div className={cn('relative inline-flex', className)}>
      <svg
        width={size}
        height={size}
        className="transform -rotate-90"
      >
        {/* Background circle */}
        <circle
          cx={size / 2}
          cy={size / 2}
          r={radius}
          stroke="currentColor"
          strokeWidth={strokeWidth}
          fill="transparent"
          className="text-slate-700"
        />
        {/* Progress circle */}
        <circle
          cx={size / 2}
          cy={size / 2}
          r={radius}
          stroke="currentColor"
          strokeWidth={strokeWidth}
          fill="transparent"
          strokeDasharray={circumference}
          strokeDashoffset={strokeDashoffset}
          strokeLinecap="round"
          className={cn(colorByProgress, 'transition-all duration-500 ease-out')}
        />
      </svg>
      {showPercentage && (
        <div className="absolute inset-0 flex items-center justify-center">
          <span className={cn('text-2xl font-bold', colorByProgress)}>
            {Math.round(clampedProgress)}%
          </span>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/reportes/QualityDashboard.tsx">
'use client';

// =====================================================
// QUALITY DASHBOARD - Dashboard de seguimiento de Calidad
// =====================================================

import { useState, useCallback, useEffect, useTransition } from 'react';
import {
  Users,
  CheckCircle2,
  Clock,
  AlertCircle,
  TrendingUp,
  RefreshCw,
  Download,
  Filter,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { ProgressRing } from './ProgressRing';
import { WeekSelector } from './WeekSelector';
import { AssistantStatusCard } from './AssistantStatusCard';
import { getWeekSummary, getAssistantStatuses } from '@/lib/actions/reports';
import type { WeekSummary, AssistantSubmissionStatus } from '@/types/reports.types';

interface QualityDashboardProps {
  initialSummary: WeekSummary;
  initialStatuses: AssistantSubmissionStatus[];
}

type FilterType = 'all' | 'submitted' | 'pending' | 'late';

export function QualityDashboard({
  initialSummary,
  initialStatuses,
}: QualityDashboardProps) {
  const [isPending, startTransition] = useTransition();
  const [summary, setSummary] = useState<WeekSummary>(initialSummary);
  const [statuses, setStatuses] = useState<AssistantSubmissionStatus[]>(initialStatuses);
  const [currentWeekStart, setCurrentWeekStart] = useState(initialSummary.week_start);
  const [filter, setFilter] = useState<FilterType>('all');

  // Cargar datos para la semana seleccionada
  const loadWeekData = useCallback(async (weekStart: string) => {
    startTransition(async () => {
      const [summaryResult, statusesResult] = await Promise.all([
        getWeekSummary(weekStart),
        getAssistantStatuses(weekStart),
      ]);

      if (summaryResult.success && summaryResult.data) {
        setSummary(summaryResult.data);
      }
      if (statusesResult.success && statusesResult.data) {
        setStatuses(statusesResult.data);
      }
    });
  }, []);

  // Cambiar semana
  const handleWeekChange = useCallback((weekStart: string) => {
    setCurrentWeekStart(weekStart);
    loadWeekData(weekStart);
  }, [loadWeekData]);

  // Refrescar datos
  const handleRefresh = useCallback(() => {
    loadWeekData(currentWeekStart);
  }, [currentWeekStart, loadWeekData]);

  // Filtrar asistentes
  const filteredStatuses = statuses.filter((s) => {
    switch (filter) {
      case 'submitted':
        return s.has_submitted;
      case 'pending':
        return !s.has_submitted && s.days_late === 0;
      case 'late':
        return !s.has_submitted && s.days_late > 0;
      default:
        return true;
    }
  });

  // Contar por estado
  const counts = {
    submitted: statuses.filter((s) => s.has_submitted).length,
    pending: statuses.filter((s) => !s.has_submitted && s.days_late === 0).length,
    late: statuses.filter((s) => !s.has_submitted && s.days_late > 0).length,
  };

  // Enviar recordatorio (placeholder)
  const handleSendReminder = useCallback((assistantId: string) => {
    // TODO: Implementar envío de recordatorio por email/notificación
    console.log('Send reminder to:', assistantId);
    alert('Funcionalidad de recordatorios próximamente');
  }, []);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-100">
            Dashboard de Reportes
          </h1>
          <p className="text-slate-400 mt-1">
            Seguimiento semanal de entregas
          </p>
        </div>

        <div className="flex items-center gap-3">
          <WeekSelector
            currentWeekStart={currentWeekStart}
            onChange={handleWeekChange}
          />
          <Button
            variant="outline"
            size="icon"
            onClick={handleRefresh}
            disabled={isPending}
            className="border-slate-700"
            title="Refrescar"
          >
            <RefreshCw className={cn('h-4 w-4', isPending && 'animate-spin')} />
          </Button>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {/* Progreso general */}
        <Card className="border-slate-700 bg-slate-900/50 col-span-1 md:col-span-2 lg:col-span-1">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-slate-400">Progreso</p>
                <p className="text-3xl font-bold text-slate-100 mt-1">
                  {summary.progress_percentage}%
                </p>
                <p className="text-sm text-slate-500 mt-1">
                  {summary.submitted_count} de {summary.total_assistants}
                </p>
              </div>
              <ProgressRing
                progress={summary.progress_percentage}
                size={80}
                strokeWidth={6}
              />
            </div>
          </CardContent>
        </Card>

        {/* Entregados */}
        <Card className="border-slate-700 bg-slate-900/50">
          <CardContent className="p-6">
            <div className="flex items-center gap-4">
              <div className="flex h-12 w-12 items-center justify-center rounded-lg bg-emerald-500/20">
                <CheckCircle2 className="h-6 w-6 text-emerald-400" />
              </div>
              <div>
                <p className="text-sm text-slate-400">Entregados</p>
                <p className="text-2xl font-bold text-emerald-400">
                  {counts.submitted}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Pendientes */}
        <Card className="border-slate-700 bg-slate-900/50">
          <CardContent className="p-6">
            <div className="flex items-center gap-4">
              <div className="flex h-12 w-12 items-center justify-center rounded-lg bg-amber-500/20">
                <Clock className="h-6 w-6 text-amber-400" />
              </div>
              <div>
                <p className="text-sm text-slate-400">Pendientes</p>
                <p className="text-2xl font-bold text-amber-400">
                  {counts.pending}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Atrasados */}
        <Card className="border-slate-700 bg-slate-900/50">
          <CardContent className="p-6">
            <div className="flex items-center gap-4">
              <div className="flex h-12 w-12 items-center justify-center rounded-lg bg-red-500/20">
                <AlertCircle className="h-6 w-6 text-red-400" />
              </div>
              <div>
                <p className="text-sm text-slate-400">Con retraso</p>
                <p className="text-2xl font-bold text-red-400">
                  {counts.late}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Lista de asistentes */}
      <Card className="border-slate-700 bg-slate-900/50">
        <CardHeader className="pb-4">
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <CardTitle className="text-lg text-slate-100">
              Estado por Asistente
            </CardTitle>

            {/* Filtros */}
            <div className="flex items-center gap-2">
              <div className="flex items-center rounded-lg border border-slate-700 p-1">
                <button
                  onClick={() => setFilter('all')}
                  className={cn(
                    'px-3 py-1.5 text-sm rounded-md transition-colors',
                    filter === 'all'
                      ? 'bg-slate-700 text-slate-100'
                      : 'text-slate-400 hover:text-slate-200'
                  )}
                >
                  Todos ({statuses.length})
                </button>
                <button
                  onClick={() => setFilter('submitted')}
                  className={cn(
                    'px-3 py-1.5 text-sm rounded-md transition-colors',
                    filter === 'submitted'
                      ? 'bg-emerald-500/20 text-emerald-400'
                      : 'text-slate-400 hover:text-slate-200'
                  )}
                >
                  Entregados ({counts.submitted})
                </button>
                <button
                  onClick={() => setFilter('pending')}
                  className={cn(
                    'px-3 py-1.5 text-sm rounded-md transition-colors',
                    filter === 'pending'
                      ? 'bg-amber-500/20 text-amber-400'
                      : 'text-slate-400 hover:text-slate-200'
                  )}
                >
                  Pendientes ({counts.pending})
                </button>
                <button
                  onClick={() => setFilter('late')}
                  className={cn(
                    'px-3 py-1.5 text-sm rounded-md transition-colors',
                    filter === 'late'
                      ? 'bg-red-500/20 text-red-400'
                      : 'text-slate-400 hover:text-slate-200'
                  )}
                >
                  Atrasados ({counts.late})
                </button>
              </div>
            </div>
          </div>
        </CardHeader>

        <CardContent className="space-y-3">
          {isPending ? (
            <div className="text-center py-12">
              <RefreshCw className="h-8 w-8 animate-spin text-slate-500 mx-auto mb-4" />
              <p className="text-slate-400">Cargando...</p>
            </div>
          ) : filteredStatuses.length === 0 ? (
            <div className="text-center py-12">
              <Users className="h-8 w-8 text-slate-500 mx-auto mb-4" />
              <p className="text-slate-400">
                No hay asistentes {filter !== 'all' && 'en esta categoría'}
              </p>
            </div>
          ) : (
            filteredStatuses.map((assistant) => (
              <AssistantStatusCard
                key={assistant.assistant_id}
                assistant={assistant}
                onSendReminder={handleSendReminder}
              />
            ))
          )}
        </CardContent>
      </Card>

      {/* Acciones globales */}
      {counts.late > 0 && (
        <div className="flex items-center justify-between p-4 rounded-lg bg-red-500/10 border border-red-500/30">
          <div className="flex items-center gap-3">
            <AlertCircle className="h-5 w-5 text-red-400" />
            <div>
              <p className="text-sm font-medium text-red-400">
                {counts.late} asistente{counts.late !== 1 && 's'} con retraso
              </p>
              <p className="text-sm text-red-400/70">
                Considera enviar un recordatorio
              </p>
            </div>
          </div>
          <Button
            variant="outline"
            size="sm"
            className="border-red-500/30 text-red-400 hover:bg-red-500/10"
            onClick={() => {
              // TODO: Enviar recordatorio masivo
              alert('Enviar recordatorio a todos los atrasados');
            }}
          >
            Recordar a todos
          </Button>
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/reportes/SubmitConfirmDialog.tsx">
'use client';

// =====================================================
// SUBMIT CONFIRM DIALOG - Confirmación antes de enviar
// =====================================================

import { useEffect, useRef } from 'react';
import { AlertTriangle, Send, X, Loader2, Lock, FileText } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';

interface SubmitConfirmDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void;
  isSubmitting: boolean;
  error: string | null;
  planCount: number;
  ruptureCount: number;
  weekRange: string;
}

export function SubmitConfirmDialog({
  isOpen,
  onClose,
  onConfirm,
  isSubmitting,
  error,
  planCount,
  ruptureCount,
  weekRange,
}: SubmitConfirmDialogProps) {
  const dialogRef = useRef<HTMLDivElement>(null);

  // Cerrar con Escape
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && !isSubmitting) {
        onClose();
      }
    };

    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
      document.body.style.overflow = 'hidden';
    }

    return () => {
      document.removeEventListener('keydown', handleEscape);
      document.body.style.overflow = '';
    };
  }, [isOpen, isSubmitting, onClose]);

  // Click fuera para cerrar
  const handleBackdropClick = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget && !isSubmitting) {
      onClose();
    }
  };

  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm"
      onClick={handleBackdropClick}
    >
      <div
        ref={dialogRef}
        role="dialog"
        aria-modal="true"
        aria-labelledby="dialog-title"
        className={cn(
          'relative w-full max-w-md rounded-xl border border-slate-700 bg-slate-900 shadow-2xl',
          'animate-in fade-in-0 zoom-in-95 duration-200'
        )}
      >
        {/* Close button */}
        {!isSubmitting && (
          <button
            onClick={onClose}
            className="absolute right-4 top-4 p-1 rounded-md text-slate-400 hover:text-slate-200 hover:bg-slate-800 transition-colors"
            aria-label="Cerrar"
          >
            <X className="h-5 w-5" />
          </button>
        )}

        {/* Content */}
        <div className="p-6">
          {/* Icon */}
          <div className="flex justify-center mb-4">
            <div className="flex h-14 w-14 items-center justify-center rounded-full bg-amber-500/20">
              <AlertTriangle className="h-7 w-7 text-amber-400" />
            </div>
          </div>

          {/* Title */}
          <h2
            id="dialog-title"
            className="text-xl font-semibold text-center text-slate-100 mb-2"
          >
            ¿Enviar reporte semanal?
          </h2>

          {/* Description */}
          <p className="text-center text-slate-400 mb-6">
            Una vez enviado, el reporte no podrá ser modificado.
          </p>

          {/* Summary */}
          <div className="space-y-3 mb-6">
            <div className="flex items-center justify-between p-3 rounded-lg bg-slate-800/50 border border-slate-700">
              <div className="flex items-center gap-2">
                <FileText className="h-4 w-4 text-emerald-400" />
                <span className="text-sm text-slate-300">Plan GTC</span>
              </div>
              <span className="text-sm font-medium text-slate-100">
                {planCount} objetivo{planCount !== 1 && 's'}
              </span>
            </div>

            <div className="flex items-center justify-between p-3 rounded-lg bg-slate-800/50 border border-slate-700">
              <div className="flex items-center gap-2">
                <AlertTriangle className="h-4 w-4 text-amber-400" />
                <span className="text-sm text-slate-300">Rupturas de valor</span>
              </div>
              <span className="text-sm font-medium text-slate-100">
                {ruptureCount} ruptura{ruptureCount !== 1 && 's'}
              </span>
            </div>

            <div className="flex items-center justify-between p-3 rounded-lg bg-slate-800/50 border border-slate-700">
              <div className="flex items-center gap-2">
                <Lock className="h-4 w-4 text-slate-400" />
                <span className="text-sm text-slate-300">Semana</span>
              </div>
              <span className="text-sm font-medium text-slate-100">{weekRange}</span>
            </div>
          </div>

          {/* Warning */}
          <div className="p-3 rounded-lg bg-amber-500/10 border border-amber-500/30 mb-6">
            <p className="text-sm text-amber-400/90 text-center">
              <Lock className="h-4 w-4 inline mr-1" />
              Esta acción es irreversible. El reporte quedará bloqueado.
            </p>
          </div>

          {/* Error */}
          {error && (
            <div className="p-3 rounded-lg bg-red-500/10 border border-red-500/30 mb-6">
              <p className="text-sm text-red-400 text-center">{error}</p>
            </div>
          )}

          {/* Actions */}
          <div className="flex gap-3">
            <Button
              type="button"
              variant="outline"
              onClick={onClose}
              disabled={isSubmitting}
              className="flex-1 border-slate-700"
            >
              Cancelar
            </Button>
            <Button
              type="button"
              onClick={onConfirm}
              disabled={isSubmitting}
              className="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white"
            >
              {isSubmitting ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Enviando...
                </>
              ) : (
                <>
                  <Send className="h-4 w-4 mr-2" />
                  Enviar reporte
                </>
              )}
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/reportes/WeekSelector.tsx">
'use client';

// =====================================================
// WEEK SELECTOR - Selector de semana para dashboard
// =====================================================

import { useCallback, useMemo } from 'react';
import { ChevronLeft, ChevronRight, Calendar } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';

interface WeekSelectorProps {
  currentWeekStart: string;
  onChange: (weekStart: string) => void;
  className?: string;
}

export function WeekSelector({
  currentWeekStart,
  onChange,
  className,
}: WeekSelectorProps) {
  // Calcular rango de la semana actual
  const weekRange = useMemo(() => {
    const start = new Date(currentWeekStart);
    const end = new Date(start);
    end.setDate(start.getDate() + 6);

    return {
      start,
      end,
      label: `${start.toLocaleDateString('es-ES', {
        day: 'numeric',
        month: 'short',
      })} - ${end.toLocaleDateString('es-ES', {
        day: 'numeric',
        month: 'short',
        year: 'numeric',
      })}`,
    };
  }, [currentWeekStart]);

  // Verificar si es la semana actual
  const isCurrentWeek = useMemo(() => {
    const now = new Date();
    const dayOfWeek = now.getDay();
    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const thisMonday = new Date(now);
    thisMonday.setDate(now.getDate() + diffToMonday);
    thisMonday.setHours(0, 0, 0, 0);

    const selected = new Date(currentWeekStart);
    selected.setHours(0, 0, 0, 0);

    return thisMonday.getTime() === selected.getTime();
  }, [currentWeekStart]);

  // Navegar a semana anterior
  const goToPreviousWeek = useCallback(() => {
    const start = new Date(currentWeekStart);
    start.setDate(start.getDate() - 7);
    onChange(start.toISOString().split('T')[0]!);
  }, [currentWeekStart, onChange]);

  // Navegar a semana siguiente
  const goToNextWeek = useCallback(() => {
    const start = new Date(currentWeekStart);
    start.setDate(start.getDate() + 7);
    onChange(start.toISOString().split('T')[0]!);
  }, [currentWeekStart, onChange]);

  // Ir a semana actual
  const goToCurrentWeek = useCallback(() => {
    const now = new Date();
    const dayOfWeek = now.getDay();
    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const monday = new Date(now);
    monday.setDate(now.getDate() + diffToMonday);
    onChange(monday.toISOString().split('T')[0]!);
  }, [onChange]);

  // No permitir navegar al futuro más allá de la semana actual
  const canGoNext = useMemo(() => {
    const now = new Date();
    const dayOfWeek = now.getDay();
    const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
    const thisMonday = new Date(now);
    thisMonday.setDate(now.getDate() + diffToMonday);

    const selected = new Date(currentWeekStart);
    return selected < thisMonday;
  }, [currentWeekStart]);

  return (
    <div className={cn('flex items-center gap-2', className)}>
      {/* Botón semana anterior */}
      <Button
        variant="ghost"
        size="icon"
        onClick={goToPreviousWeek}
        className="h-9 w-9 text-slate-400 hover:text-slate-200"
        title="Semana anterior"
      >
        <ChevronLeft className="h-5 w-5" />
      </Button>

      {/* Rango de fechas */}
      <div className="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-800/50 border border-slate-700 min-w-[200px] justify-center">
        <Calendar className="h-4 w-4 text-slate-400" />
        <span className="text-sm font-medium text-slate-200">
          {weekRange.label}
        </span>
        {isCurrentWeek && (
          <span className="ml-1 px-1.5 py-0.5 text-xs rounded bg-emerald-500/20 text-emerald-400">
            Esta semana
          </span>
        )}
      </div>

      {/* Botón semana siguiente */}
      <Button
        variant="ghost"
        size="icon"
        onClick={goToNextWeek}
        disabled={!canGoNext}
        className={cn(
          'h-9 w-9',
          canGoNext
            ? 'text-slate-400 hover:text-slate-200'
            : 'text-slate-600 cursor-not-allowed'
        )}
        title="Semana siguiente"
      >
        <ChevronRight className="h-5 w-5" />
      </Button>

      {/* Botón ir a hoy */}
      {!isCurrentWeek && (
        <Button
          variant="outline"
          size="sm"
          onClick={goToCurrentWeek}
          className="ml-2 border-slate-700 text-slate-300 hover:text-slate-100"
        >
          Hoy
        </Button>
      )}
    </div>
  );
}
</file>

<file path="src/components/shared/AlertBell.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { Bell, Check, AlertTriangle, Clock, TrendingDown } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { cn, formatRelativeTime } from '@/lib/utils';
import type { AlertType } from '@/types/database.types';

interface Alert {
  id: string;
  title: string;
  message: string | null;
  alert_type: AlertType | null;
  priority: string;
  created_at: string;
  is_read: boolean;
}

interface AlertBellProps {
  unreadCount?: number;
  alerts?: Alert[];
}

const alertIcons: Record<string, React.ElementType> = {
  reporte_pendiente: Clock,
  proceso_estancado: AlertTriangle,
  deadline_proximo: Bell,
  bajo_rendimiento: TrendingDown,
  otro: Bell,
};

const alertColors: Record<string, string> = {
  critica: 'text-red-400',
  alta: 'text-amber-400',
  media: 'text-blue-400',
  baja: 'text-slate-400',
};

export function AlertBell({ unreadCount = 0, alerts = [] }: AlertBellProps) {
  const [isOpen, setIsOpen] = useState(false);

  // Alertas de ejemplo para el UI (en producción vendrían de props o hook)
  const displayAlerts: Alert[] = alerts.length > 0 ? alerts : [
    {
      id: '1',
      title: 'Reporte pendiente',
      message: 'María García no ha entregado su reporte semanal',
      alert_type: 'reporte_pendiente',
      priority: 'alta',
      created_at: new Date(Date.now() - 3600000).toISOString(), // hace 1 hora
      is_read: false,
    },
    {
      id: '2',
      title: 'Deadline próximo',
      message: 'Búsqueda "Full Stack Developer" vence en 2 días',
      alert_type: 'deadline_proximo',
      priority: 'media',
      created_at: new Date(Date.now() - 7200000).toISOString(), // hace 2 horas
      is_read: false,
    },
  ];

  const displayCount = unreadCount || displayAlerts.filter((a) => !a.is_read).length;

  return (
    <DropdownMenu open={isOpen} onOpenChange={setIsOpen}>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          className="relative text-slate-400 hover:text-white hover:bg-slate-800"
        >
          <Bell className="h-5 w-5" />
          {displayCount > 0 && (
            <span className="notification-dot notification-dot--pulse">
              <span className="sr-only">{displayCount} alertas sin leer</span>
            </span>
          )}
        </Button>
      </DropdownMenuTrigger>

      <DropdownMenuContent className="w-80" align="end" forceMount>
        <DropdownMenuLabel className="flex items-center justify-between">
          <span>Notificaciones</span>
          {displayCount > 0 && (
            <span className="text-xs font-normal text-muted-foreground">
              {displayCount} sin leer
            </span>
          )}
        </DropdownMenuLabel>

        <DropdownMenuSeparator />

        <div className="max-h-[300px] overflow-y-auto">
          {displayAlerts.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-8 text-center">
              <Check className="h-8 w-8 text-emerald-500 mb-2" />
              <p className="text-sm text-muted-foreground">
                No hay notificaciones
              </p>
            </div>
          ) : (
            displayAlerts.map((alert) => {
              const Icon = alertIcons[alert.alert_type || 'otro'] || Bell;
              const colorClass = alertColors[alert.priority] || 'text-slate-400';

              return (
                <DropdownMenuItem
                  key={alert.id}
                  className={cn(
                    'flex items-start gap-3 p-3 cursor-pointer',
                    !alert.is_read && 'bg-slate-800/50'
                  )}
                >
                  <div
                    className={cn(
                      'mt-0.5 flex h-8 w-8 shrink-0 items-center justify-center rounded-full bg-slate-800',
                      colorClass
                    )}
                  >
                    <Icon className="h-4 w-4" />
                  </div>
                  <div className="flex-1 space-y-1">
                    <p className="text-sm font-medium leading-none">
                      {alert.title}
                    </p>
                    {alert.message && (
                      <p className="text-xs text-muted-foreground line-clamp-2">
                        {alert.message}
                      </p>
                    )}
                    <p className="text-xs text-slate-500">
                      {formatRelativeTime(alert.created_at)}
                    </p>
                  </div>
                  {!alert.is_read && (
                    <div className="h-2 w-2 rounded-full bg-emerald-500" />
                  )}
                </DropdownMenuItem>
              );
            })
          )}
        </div>

        <DropdownMenuSeparator />

        <DropdownMenuItem asChild className="cursor-pointer">
          <Link
            href="/calidad"
            className="flex w-full items-center justify-center text-sm text-emerald-400 hover:text-emerald-300"
          >
            Ver todas las alertas
          </Link>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
</file>

<file path="src/components/shared/ComingSoon.tsx">
'use client';

import { Construction, ArrowLeft } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';

interface ComingSoonProps {
    title: string;
    description?: string;
}

export default function ComingSoon({
    title,
    description = "Estamos construyendo este módulo. Pronto estará disponible."
}: ComingSoonProps) {
    const router = useRouter();

    return (
        <div className="flex flex-col items-center justify-center min-h-[60vh] text-center p-8">
            <div className="bg-slate-800/50 p-6 rounded-full mb-6 border border-slate-700/50">
                <Construction className="h-16 w-16 text-blue-500 animate-pulse" />
            </div>

            <h1 className="text-3xl font-bold text-white mb-3">{title}</h1>
            <p className="text-slate-400 max-w-md mb-8 text-lg">
                {description}
            </p>

            <Button
                variant="outline"
                onClick={() => router.back()}
                className="border-slate-700 hover:bg-slate-800 text-slate-300"
            >
                <ArrowLeft className="mr-2 h-4 w-4" />
                Volver
            </Button>
        </div>
    );
}
</file>

<file path="src/components/shared/index.ts">
export { Sidebar } from './Sidebar';
export { Navbar } from './Navbar';
export { UserMenu } from './UserMenu';
export { AlertBell } from './AlertBell';
</file>

<file path="src/components/shared/Navbar.tsx">
'use client';

import { usePathname } from 'next/navigation';
import Link from 'next/link';
import { ChevronRight, Home } from 'lucide-react';
import { cn } from '@/lib/utils';
import { UserMenu } from './UserMenu';
import { AlertBell } from './AlertBell';
import type { Profile } from '@/types/database.types';

interface NavbarProps {
  user: Profile;
  unreadAlerts?: number;
}

// Mapa de rutas a nombres legibles
const routeNames: Record<string, string> = {
  dashboard: 'Dashboard',
  calidad: 'Calidad',
  reportes: 'Reportes',
  nuevo: 'Nuevo',
  calendario: 'Calendario',
  metricas: 'Métricas',
  busquedas: 'Búsquedas',
  candidatos: 'Candidatos',
  clientes: 'Clientes',
  asistentes: 'Asistentes',
  configuracion: 'Configuración',
  usuarios: 'Usuarios',
};

export function Navbar({ user, unreadAlerts = 0 }: NavbarProps) {
  const pathname = usePathname();

  // Generar breadcrumbs desde el pathname
  const pathSegments = pathname.split('/').filter(Boolean);
  const breadcrumbs = pathSegments.map((segment, index) => {
    const href = '/' + pathSegments.slice(0, index + 1).join('/');
    const name = routeNames[segment] || segment;
    const isLast = index === pathSegments.length - 1;

    return { name, href, isLast };
  });

  return (
    <header className="sticky top-0 z-30 flex h-16 items-center justify-between border-b border-slate-800 bg-slate-950/80 px-6 backdrop-blur-sm">
      {/* Breadcrumbs */}
      <nav className="flex items-center space-x-1 text-sm">
        <Link
          href="/dashboard"
          className="flex items-center text-slate-400 hover:text-white transition-colors"
        >
          <Home className="h-4 w-4" />
        </Link>

        {breadcrumbs.map((crumb, index) => (
          <div key={crumb.href} className="flex items-center">
            <ChevronRight className="h-4 w-4 text-slate-600 mx-1" />
            {crumb.isLast ? (
              <span className="font-medium text-white">{crumb.name}</span>
            ) : (
              <Link
                href={crumb.href}
                className="text-slate-400 hover:text-white transition-colors"
              >
                {crumb.name}
              </Link>
            )}
          </div>
        ))}
      </nav>

      {/* Acciones */}
      <div className="flex items-center gap-2">
        <AlertBell unreadCount={unreadAlerts} />
        <UserMenu user={user} />
      </div>
    </header>
  );
}
</file>

<file path="src/components/shared/UserMenu.tsx">
'use client';

import { useRouter } from 'next/navigation';
import { LogOut, User, Settings, HelpCircle } from 'lucide-react';
import { createClient } from '@/lib/supabase/client';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Badge } from '@/components/ui/badge';
import { getInitials } from '@/lib/utils';
import type { Profile } from '@/types/database.types';

interface UserMenuProps {
  user: Profile;
}

const roleLabels: Record<string, string> = {
  admin: 'Administrador',
  calidad: 'Calidad',
  rrhh: 'RRHH',
  marketing: 'Marketing',
  asistente: 'Asistente',
};

const roleBadgeVariants: Record<string, 'default' | 'success' | 'warning' | 'info'> = {
  admin: 'default',
  calidad: 'success',
  rrhh: 'info',
  marketing: 'warning',
  asistente: 'info',
};

export function UserMenu({ user }: UserMenuProps) {
  const router = useRouter();
  const supabase = createClient();

  const handleLogout = async () => {
    await supabase.auth.signOut();
    router.push('/login');
    router.refresh();
  };

  const displayName = user.full_name || user.email.split('@')[0] || 'Usuario';
  const initials = getInitials(displayName);

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          className="relative flex items-center gap-2 px-2 hover:bg-slate-800"
        >
          <Avatar className="h-8 w-8">
            <AvatarImage src={user.avatar_url || undefined} alt={displayName} />
            <AvatarFallback className="bg-emerald-600 text-white text-xs">
              {initials}
            </AvatarFallback>
          </Avatar>
          <div className="hidden flex-col items-start md:flex">
            <span className="text-sm font-medium text-white">{displayName}</span>
            <span className="text-xs text-slate-400">{user.email}</span>
          </div>
        </Button>
      </DropdownMenuTrigger>

      <DropdownMenuContent className="w-56" align="end" forceMount>
        <DropdownMenuLabel className="font-normal">
          <div className="flex flex-col space-y-2">
            <p className="text-sm font-medium leading-none">{displayName}</p>
            <p className="text-xs leading-none text-muted-foreground">
              {user.email}
            </p>
            <Badge variant={roleBadgeVariants[user.role] || 'default'} className="w-fit">
              {roleLabels[user.role] || user.role}
            </Badge>
          </div>
        </DropdownMenuLabel>

        <DropdownMenuSeparator />

        <DropdownMenuGroup>
          <DropdownMenuItem
            onClick={() => router.push('/perfil')}
            className="cursor-pointer"
          >
            <User className="mr-2 h-4 w-4" />
            <span>Mi Perfil</span>
          </DropdownMenuItem>

          {user.role === 'admin' && (
            <DropdownMenuItem
              onClick={() => router.push('/configuracion')}
              className="cursor-pointer"
            >
              <Settings className="mr-2 h-4 w-4" />
              <span>Configuración</span>
            </DropdownMenuItem>
          )}

          <DropdownMenuItem
            onClick={() => window.open('/ayuda', '_blank')}
            className="cursor-pointer"
          >
            <HelpCircle className="mr-2 h-4 w-4" />
            <span>Ayuda</span>
          </DropdownMenuItem>
        </DropdownMenuGroup>

        <DropdownMenuSeparator />

        <DropdownMenuItem
          onClick={handleLogout}
          className="cursor-pointer text-red-400 focus:bg-red-500/10 focus:text-red-400"
        >
          <LogOut className="mr-2 h-4 w-4" />
          <span>Cerrar Sesión</span>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
</file>

<file path="src/components/ui/alert.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils"

const alertVariants = cva(
    "relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",
    {
        variants: {
            variant: {
                default: "bg-background text-foreground",
                destructive:
                    "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
            },
        },
        defaultVariants: {
            variant: "default",
        },
    }
)

const Alert = React.forwardRef<
    HTMLDivElement,
    React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
    <div
        ref={ref}
        role="alert"
        className={cn(alertVariants({ variant }), className)}
        {...props}
    />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
    HTMLParagraphElement,
    React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
    <h5
        ref={ref}
        className={cn("mb-1 font-medium leading-none tracking-tight", className)}
        {...props}
    />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
    HTMLParagraphElement,
    React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
    <div
        ref={ref}
        className={cn("text-sm [&_p]:leading-relaxed", className)}
        {...props}
    />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="src/components/ui/avatar.tsx">
'use client';

import * as React from 'react';
import * as AvatarPrimitive from '@radix-ui/react-avatar';

import { cn } from '@/lib/utils';

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      'relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full',
      className
    )}
    {...props}
  />
));
Avatar.displayName = AvatarPrimitive.Root.displayName;

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn('aspect-square h-full w-full', className)}
    {...props}
  />
));
AvatarImage.displayName = AvatarPrimitive.Image.displayName;

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      'flex h-full w-full items-center justify-center rounded-full bg-muted',
      className
    )}
    {...props}
  />
));
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName;

export { Avatar, AvatarImage, AvatarFallback };
</file>

<file path="src/components/ui/badge.tsx">
import * as React from 'react';
import { cva, type VariantProps } from 'class-variance-authority';

import { cn } from '@/lib/utils';

const badgeVariants = cva(
  'inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2',
  {
    variants: {
      variant: {
        default:
          'border-transparent bg-primary text-primary-foreground hover:bg-primary/80',
        secondary:
          'border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80',
        destructive:
          'border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80',
        outline: 'text-foreground',
        success:
          'border-transparent bg-emerald-500/20 text-emerald-400 ring-1 ring-emerald-500/30',
        warning:
          'border-transparent bg-amber-500/20 text-amber-400 ring-1 ring-amber-500/30',
        error:
          'border-transparent bg-red-500/20 text-red-400 ring-1 ring-red-500/30',
        info:
          'border-transparent bg-blue-500/20 text-blue-400 ring-1 ring-blue-500/30',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  }
);

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  );
}

export { Badge, badgeVariants };
</file>

<file path="src/components/ui/button.tsx">
import * as React from 'react';
import { Slot } from '@radix-ui/react-slot';
import { cva, type VariantProps } from 'class-variance-authority';

import { cn } from '@/lib/utils';

const buttonVariants = cva(
  'inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50',
  {
    variants: {
      variant: {
        default: 'bg-primary text-primary-foreground hover:bg-primary/90',
        destructive:
          'bg-destructive text-destructive-foreground hover:bg-destructive/90',
        outline:
          'border border-input bg-background hover:bg-accent hover:text-accent-foreground',
        secondary:
          'bg-secondary text-secondary-foreground hover:bg-secondary/80',
        ghost: 'hover:bg-accent hover:text-accent-foreground',
        link: 'text-primary underline-offset-4 hover:underline',
        success: 'bg-emerald-600 text-white hover:bg-emerald-700',
        warning: 'bg-amber-600 text-white hover:bg-amber-700',
      },
      size: {
        default: 'h-10 px-4 py-2',
        sm: 'h-9 rounded-md px-3',
        lg: 'h-11 rounded-md px-8',
        icon: 'h-10 w-10',
      },
    },
    defaultVariants: {
      variant: 'default',
      size: 'default',
    },
  }
);

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : 'button';
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    );
  }
);
Button.displayName = 'Button';

export { Button, buttonVariants };
</file>

<file path="src/components/ui/card.tsx">
import * as React from 'react';

import { cn } from '@/lib/utils';

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      'rounded-lg border border-slate-800 bg-card text-card-foreground shadow-sm',
      className
    )}
    {...props}
  />
));
Card.displayName = 'Card';

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn('flex flex-col space-y-1.5 p-6', className)}
    {...props}
  />
));
CardHeader.displayName = 'CardHeader';

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      'text-2xl font-semibold leading-none tracking-tight',
      className
    )}
    {...props}
  />
));
CardTitle.displayName = 'CardTitle';

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn('text-sm text-muted-foreground', className)}
    {...props}
  />
));
CardDescription.displayName = 'CardDescription';

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn('p-6 pt-0', className)} {...props} />
));
CardContent.displayName = 'CardContent';

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn('flex items-center p-6 pt-0', className)}
    {...props}
  />
));
CardFooter.displayName = 'CardFooter';

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };
</file>

<file path="src/components/ui/dropdown-menu.tsx">
'use client';

import * as React from 'react';
import * as DropdownMenuPrimitive from '@radix-ui/react-dropdown-menu';
import { Check, ChevronRight, Circle } from 'lucide-react';

import { cn } from '@/lib/utils';

const DropdownMenu = DropdownMenuPrimitive.Root;

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;

const DropdownMenuGroup = DropdownMenuPrimitive.Group;

const DropdownMenuPortal = DropdownMenuPrimitive.Portal;

const DropdownMenuSub = DropdownMenuPrimitive.Sub;

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean;
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      'flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent',
      inset && 'pl-8',
      className
    )}
    {...props}
  >
    {children}
    <ChevronRight className="ml-auto h-4 w-4" />
  </DropdownMenuPrimitive.SubTrigger>
));
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName;

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      'z-50 min-w-[8rem] overflow-hidden rounded-md border border-slate-800 bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2',
      className
    )}
    {...props}
  />
));
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName;

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        'z-50 min-w-[8rem] overflow-hidden rounded-md border border-slate-800 bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2',
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
));
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      'relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50',
      inset && 'pl-8',
      className
    )}
    {...props}
  />
));
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      'relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50',
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
));
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName;

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      'relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50',
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <Circle className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
));
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean;
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      'px-2 py-1.5 text-sm font-semibold',
      inset && 'pl-8',
      className
    )}
    {...props}
  />
));
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn('-mx-1 my-1 h-px bg-slate-800', className)}
    {...props}
  />
));
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn('ml-auto text-xs tracking-widest opacity-60', className)}
      {...props}
    />
  );
};
DropdownMenuShortcut.displayName = 'DropdownMenuShortcut';

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
};
</file>

<file path="src/components/ui/input.tsx">
import * as React from 'react';

import { cn } from '@/lib/utils';

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {}

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          'flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50',
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Input.displayName = 'Input';

export { Input };
</file>

<file path="src/components/ui/label.tsx">
'use client';

import * as React from 'react';
import * as LabelPrimitive from '@radix-ui/react-label';
import { cva, type VariantProps } from 'class-variance-authority';

import { cn } from '@/lib/utils';

const labelVariants = cva(
  'text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70'
);

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
));
Label.displayName = LabelPrimitive.Root.displayName;

export { Label };
</file>

<file path="src/components/ui/separator.tsx">
'use client';

import * as React from 'react';
import * as SeparatorPrimitive from '@radix-ui/react-separator';

import { cn } from '@/lib/utils';

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = 'horizontal', decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        'shrink-0 bg-border',
        orientation === 'horizontal' ? 'h-[1px] w-full' : 'h-full w-[1px]',
        className
      )}
      {...props}
    />
  )
);
Separator.displayName = SeparatorPrimitive.Root.displayName;

export { Separator };
</file>

<file path="src/components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"
import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
    React.ElementRef<typeof TabsPrimitive.List>,
    React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
    <TabsPrimitive.List
        ref={ref}
        className={cn(
            "inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground",
            className
        )}
        {...props}
    />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
    React.ElementRef<typeof TabsPrimitive.Trigger>,
    React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
    <TabsPrimitive.Trigger
        ref={ref}
        className={cn(
            "inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow",
            className
        )}
        {...props}
    />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
    React.ElementRef<typeof TabsPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
    <TabsPrimitive.Content
        ref={ref}
        className={cn(
            "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",
            className
        )}
        {...props}
    />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="src/components/ui/textarea.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"

export interface TextareaProps
    extends React.TextareaHTMLAttributes<HTMLTextAreaElement> { }

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
    ({ className, ...props }, ref) => {
        return (
            <textarea
                className={cn(
                    "flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",
                    className
                )}
                ref={ref}
                {...props}
            />
        )
    }
)
Textarea.displayName = "Textarea"

export { Textarea }
</file>

<file path="src/components/ui/tooltip.tsx">
'use client';

import * as React from 'react';
import * as TooltipPrimitive from '@radix-ui/react-tooltip';

import { cn } from '@/lib/utils';

const TooltipProvider = TooltipPrimitive.Provider;

const Tooltip = TooltipPrimitive.Root;

const TooltipTrigger = TooltipPrimitive.Trigger;

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Content
    ref={ref}
    sideOffset={sideOffset}
    className={cn(
      'z-50 overflow-hidden rounded-md border border-slate-800 bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2',
      className
    )}
    {...props}
  />
));
TooltipContent.displayName = TooltipPrimitive.Content.displayName;

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider };
</file>

<file path="src/hooks/useReportBackup.ts">
import { useState, useEffect } from 'react';

export function useReportBackup<T>(key: string, value: T) {
    const [isRestored, setIsRestored] = useState(false);

    // Load from local storage on mount - Simplified to just return, allow component to decide usage
    // Actually, this hook is primarily for SAVING in this context since we restore manually in fetchReport
    // But we keep the read logic for completeness or other components
    useEffect(() => {
        try {
            const item = window.localStorage.getItem(key);
            if (item) {
                const parsed = JSON.parse(item);
                if (parsed) {
                    setIsRestored(true);
                }
            }
        } catch (error) {
            console.warn('Error reading from localStorage', error);
        }
    }, [key]);

    // Save to local storage on change
    useEffect(() => {
        try {
            if (value) {
                window.localStorage.setItem(key, JSON.stringify(value));
            }
        } catch (error) {
            console.warn('Error saving to localStorage', error);
        }
    }, [key, value]);

    return { isRestored };
}
</file>

<file path="src/lib/actions/monthly-reports.ts">
'use server';

// =====================================================
// GLOBAL TALENT PLATFORM - SERVER ACTIONS MENSUALES
// =====================================================

import { revalidatePath } from 'next/cache';
import { createServerSupabaseClient } from '@/lib/supabase/server';
import {
  monthlyReportFormSchema,
  draftMonthlyReportSchema,
  type MonthlyReportFormInput,
  type DraftMonthlyReportInput,
} from '@/lib/validations/monthly-reports';
import type {
  MonthlyReport,
  MonthlyReportWithEntries,
  MonthSummary,
  MonthlyProgressItem,
} from '@/types/monthly-reports.types';

// =====================================================
// UTILIDADES
// =====================================================

function getCurrentMonth(): { month: number; year: number; reportMonth: string } {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;
  const reportMonth = `${year}-${String(month).padStart(2, '0')}-01`;
  return { month, year, reportMonth };
}

async function getCurrentUserAssistantId(): Promise<string | null> {
  const supabase = await createServerSupabaseClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) return null;
  
  const { data: assistant } = await supabase
    .from('assistants')
    .select('id')
    .eq('user_id', user.id)
    .single();
  
  return assistant?.id ?? null;
}

// =====================================================
// OBTENER DATOS
// =====================================================

export async function getOrCreateCurrentMonthReport(): Promise<{
  success: boolean;
  data?: MonthlyReportWithEntries;
  error?: string;
}> {
  try {
    const supabase = await createServerSupabaseClient();
    const assistantId = await getCurrentUserAssistantId();
    
    if (!assistantId) {
      return { success: false, error: 'No se encontró el asistente asociado a tu cuenta' };
    }
    
    const { month, year, reportMonth } = getCurrentMonth();
    
    // Intentar obtener el reporte existente
    const { data: existing, error: fetchError } = await supabase
      .from('monthly_reports')
      .select(`
        *,
        activities:monthly_activities (*),
        objectives:monthly_objectives (*),
        suggestions:monthly_suggestions (*),
        metrics:monthly_metrics (*)
      `)
      .eq('assistant_id', assistantId)
      .eq('report_month', reportMonth)
      .single();
    
    if (existing && !fetchError) {
      return {
        success: true,
        data: {
          ...existing,
          attachments: [],
        } as MonthlyReportWithEntries,
      };
    }
    
    // Crear nuevo reporte si no existe
    const { data: newReport, error: createError } = await supabase
      .from('monthly_reports')
      .insert({
        assistant_id: assistantId,
        report_month: reportMonth,
        report_year: year,
        report_month_number: month,
        status: 'draft',
      })
      .select()
      .single();
    
    if (createError) {
      console.error('Error creating monthly report:', createError);
      return { success: false, error: 'Error al crear el informe mensual' };
    }
    
    return {
      success: true,
      data: {
        ...newReport,
        activities: [],
        objectives: [],
        suggestions: [],
        metrics: [],
        attachments: [],
      } as MonthlyReportWithEntries,
    };
  } catch (error) {
    console.error('getOrCreateCurrentMonthReport error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

export async function getMonthlyReportById(id: string): Promise<{
  success: boolean;
  data?: MonthlyReportWithEntries;
  error?: string;
}> {
  try {
    const supabase = await createServerSupabaseClient();
    
    const { data, error } = await supabase
      .from('monthly_reports')
      .select(`
        *,
        activities:monthly_activities (*),
        objectives:monthly_objectives (*),
        suggestions:monthly_suggestions (*),
        metrics:monthly_metrics (*),
        assistant:assistants (
          id,
          full_name,
          email,
          position,
          avatar_url
        )
      `)
      .eq('id', id)
      .single();
    
    if (error || !data) {
      return { success: false, error: 'Informe no encontrado' };
    }
    
    return {
      success: true,
      data: {
        ...data,
        attachments: [],
      } as MonthlyReportWithEntries,
    };
  } catch (error) {
    console.error('getMonthlyReportById error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

// =====================================================
// GUARDAR BORRADOR
// =====================================================

export async function saveMonthlyDraft(
  reportId: string,
  formData: DraftMonthlyReportInput
): Promise<{ success: boolean; data?: { saved_at: string }; error?: string }> {
  try {
    const supabase = await createServerSupabaseClient();
    
    // Verificar que el reporte existe y no está bloqueado
    const { data: report, error: checkError } = await supabase
      .from('monthly_reports')
      .select('id, is_locked')
      .eq('id', reportId)
      .single();
    
    if (checkError || !report) {
      return { success: false, error: 'Informe no encontrado' };
    }
    
    if (report.is_locked) {
      return { success: false, error: 'Este informe ya fue enviado y no puede ser modificado' };
    }
    
    // Validar
    const validation = draftMonthlyReportSchema.safeParse(formData);
    if (!validation.success) {
      return { success: false, error: 'Datos inválidos' };
    }
    
    // Eliminar entradas existentes
    await Promise.all([
      supabase.from('monthly_activities').delete().eq('monthly_report_id', reportId),
      supabase.from('monthly_objectives').delete().eq('monthly_report_id', reportId),
      supabase.from('monthly_suggestions').delete().eq('monthly_report_id', reportId),
      supabase.from('monthly_metrics').delete().eq('monthly_report_id', reportId),
    ]);
    
    // Insertar actividades
    if (validation.data.activities && validation.data.activities.length > 0) {
      const activities = validation.data.activities
        .filter(a => a.title && a.title.trim() !== '')
        .map((a, i) => ({
          monthly_report_id: reportId,
          title: a.title || '',
          description: a.description || null,
          sort_order: i,
        }));
      
      if (activities.length > 0) {
        await supabase.from('monthly_activities').insert(activities);
      }
    }
    
    // Insertar objetivos
    if (validation.data.objectives && validation.data.objectives.length > 0) {
      const objectives = validation.data.objectives
        .filter(o => o.objective && o.objective.trim() !== '')
        .map((o, i) => ({
          monthly_report_id: reportId,
          objective: o.objective || '',
          achieved: o.achieved || false,
          notes: o.notes || null,
          sort_order: i,
        }));
      
      if (objectives.length > 0) {
        await supabase.from('monthly_objectives').insert(objectives);
      }
    }
    
    // Insertar sugerencias
    if (validation.data.suggestions && validation.data.suggestions.length > 0) {
      const suggestions = validation.data.suggestions
        .filter(s => s.suggestion && s.suggestion.trim() !== '')
        .map((s, i) => ({
          monthly_report_id: reportId,
          suggestion: s.suggestion || '',
          sort_order: i,
        }));
      
      if (suggestions.length > 0) {
        await supabase.from('monthly_suggestions').insert(suggestions);
      }
    }
    
    // Insertar métricas
    if (validation.data.metrics && validation.data.metrics.length > 0) {
      const metrics = validation.data.metrics
        .filter(m => m.metric_name && m.metric_name.trim() !== '')
        .map((m, i) => ({
          monthly_report_id: reportId,
          metric_name: m.metric_name || '',
          metric_value: m.metric_value || '',
          metric_unit: m.metric_unit || null,
          sort_order: i,
        }));
      
      if (metrics.length > 0) {
        await supabase.from('monthly_metrics').insert(metrics);
      }
    }
    
    // Actualizar timestamp
    await supabase
      .from('monthly_reports')
      .update({ updated_at: new Date().toISOString() })
      .eq('id', reportId);
    
    revalidatePath('/reportes/mensual');
    
    return {
      success: true,
      data: { saved_at: new Date().toISOString() },
    };
  } catch (error) {
    console.error('saveMonthlyDraft error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

// =====================================================
// ENVIAR INFORME
// =====================================================

export async function submitMonthlyReport(
  reportId: string,
  formData: MonthlyReportFormInput
): Promise<{ success: boolean; data?: { submitted_at: string }; error?: string }> {
  try {
    const supabase = await createServerSupabaseClient();
    
    // Verificar
    const { data: report, error: checkError } = await supabase
      .from('monthly_reports')
      .select('id, is_locked, status')
      .eq('id', reportId)
      .single();
    
    if (checkError || !report) {
      return { success: false, error: 'Informe no encontrado' };
    }
    
    if (report.is_locked) {
      return { success: false, error: 'Este informe ya fue enviado' };
    }
    
    // Validar con esquema estricto
    const validation = monthlyReportFormSchema.safeParse(formData);
    if (!validation.success) {
      const firstError = validation.error.errors[0];
      return { 
        success: false, 
        error: firstError?.message ?? 'Datos inválidos. Revisa todos los campos requeridos.' 
      };
    }
    
    // Guardar datos finales
    await Promise.all([
      supabase.from('monthly_activities').delete().eq('monthly_report_id', reportId),
      supabase.from('monthly_objectives').delete().eq('monthly_report_id', reportId),
      supabase.from('monthly_suggestions').delete().eq('monthly_report_id', reportId),
      supabase.from('monthly_metrics').delete().eq('monthly_report_id', reportId),
    ]);
    
    // Insertar actividades
    const activities = validation.data.activities.map((a, i) => ({
      monthly_report_id: reportId,
      title: a.title,
      description: a.description || null,
      sort_order: i,
    }));
    await supabase.from('monthly_activities').insert(activities);
    
    // Insertar objetivos
    const objectives = validation.data.objectives.map((o, i) => ({
      monthly_report_id: reportId,
      objective: o.objective,
      achieved: o.achieved,
      notes: o.notes || null,
      sort_order: i,
    }));
    await supabase.from('monthly_objectives').insert(objectives);
    
    // Insertar sugerencias si hay
    if (validation.data.suggestions && validation.data.suggestions.length > 0) {
      const suggestions = validation.data.suggestions.map((s, i) => ({
        monthly_report_id: reportId,
        suggestion: s.suggestion,
        sort_order: i,
      }));
      await supabase.from('monthly_suggestions').insert(suggestions);
    }
    
    // Insertar métricas si hay
    if (validation.data.metrics && validation.data.metrics.length > 0) {
      const metrics = validation.data.metrics.map((m, i) => ({
        monthly_report_id: reportId,
        metric_name: m.metric_name,
        metric_value: m.metric_value,
        metric_unit: m.metric_unit || null,
        sort_order: i,
      }));
      await supabase.from('monthly_metrics').insert(metrics);
    }
    
    // Marcar como enviado
    const submittedAt = new Date().toISOString();
    await supabase
      .from('monthly_reports')
      .update({
        status: 'submitted',
        submitted_at: submittedAt,
        is_locked: true,
      })
      .eq('id', reportId);
    
    revalidatePath('/reportes/mensual');
    revalidatePath('/calidad/mensuales');
    
    return {
      success: true,
      data: { submitted_at: submittedAt },
    };
  } catch (error) {
    console.error('submitMonthlyReport error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

// =====================================================
// DASHBOARD DE CALIDAD - MENSUALES
// =====================================================

export async function getMonthSummary(month?: number, year?: number): Promise<{
  success: boolean;
  data?: MonthSummary;
  error?: string;
}> {
  try {
    const supabase = await createServerSupabaseClient();
    const current = getCurrentMonth();
    const targetMonth = month ?? current.month;
    const targetYear = year ?? current.year;
    const reportMonth = `${targetYear}-${String(targetMonth).padStart(2, '0')}-01`;
    
    const MONTH_NAMES = [
      'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];
    
    // Contar asistentes activos
    const { count: totalAssistants } = await supabase
      .from('assistants')
      .select('*', { count: 'exact', head: true })
      .eq('status', 'activo');
    
    // Contar envíos del mes
    const { count: submittedCount } = await supabase
      .from('monthly_reports')
      .select('*', { count: 'exact', head: true })
      .eq('report_month', reportMonth)
      .in('status', ['submitted', 'reviewed', 'approved']);
    
    const total = totalAssistants ?? 0;
    const submitted = submittedCount ?? 0;
    const pending = total - submitted;
    const percentage = total > 0 ? Math.round((submitted / total) * 100 * 10) / 10 : 0;
    
    return {
      success: true,
      data: {
        report_month: reportMonth,
        report_year: targetYear,
        report_month_number: targetMonth,
        month_name: MONTH_NAMES[targetMonth - 1] ?? '',
        total_assistants: total,
        submitted_count: submitted,
        pending_count: pending,
        progress_percentage: percentage,
      },
    };
  } catch (error) {
    console.error('getMonthSummary error:', error);
    return { success: false, error: 'Error al obtener resumen' };
  }
}

export async function getMonthlyAssistantStatuses(month?: number, year?: number): Promise<{
  success: boolean;
  data?: MonthlyProgressItem[];
  error?: string;
}> {
  try {
    const supabase = await createServerSupabaseClient();
    const current = getCurrentMonth();
    const targetMonth = month ?? current.month;
    const targetYear = year ?? current.year;
    const reportMonth = `${targetYear}-${String(targetMonth).padStart(2, '0')}-01`;
    
    // Obtener asistentes activos
    const { data: assistants, error: assistantsError } = await supabase
      .from('assistants')
      .select('id, full_name, email, avatar_url, position')
      .eq('status', 'activo')
      .order('full_name');
    
    if (assistantsError || !assistants) {
      return { success: false, error: 'Error al obtener asistentes' };
    }
    
    // Obtener reportes del mes
    const { data: reports, error: reportsError } = await supabase
      .from('monthly_reports')
      .select(`
        id,
        assistant_id,
        status,
        submitted_at,
        quality_score,
        activities:monthly_activities (id),
        objectives:monthly_objectives (id)
      `)
      .eq('report_month', reportMonth);
    
    if (reportsError) {
      return { success: false, error: 'Error al obtener reportes' };
    }
    
    // Mapear
    const statuses: MonthlyProgressItem[] = assistants.map((assistant) => {
      const report = reports?.find((r) => r.assistant_id === assistant.id);
      const hasSubmitted = report?.status !== 'draft' && report?.status !== undefined;
      
      return {
        assistant_id: assistant.id,
        full_name: assistant.full_name,
        email: assistant.email,
        avatar_url: assistant.avatar_url,
        position: assistant.position,
        report_id: report?.id ?? null,
        status: report?.status ?? null,
        has_submitted: hasSubmitted,
        submitted_at: report?.submitted_at ?? null,
        quality_score: report?.quality_score ?? null,
        activities_count: Array.isArray(report?.activities) ? report.activities.length : 0,
        objectives_count: Array.isArray(report?.objectives) ? report.objectives.length : 0,
      };
    });
    
    // Ordenar: pendientes primero
    statuses.sort((a, b) => {
      if (a.has_submitted === b.has_submitted) {
        return a.full_name.localeCompare(b.full_name);
      }
      return a.has_submitted ? 1 : -1;
    });
    
    return { success: true, data: statuses };
  } catch (error) {
    console.error('getMonthlyAssistantStatuses error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}
</file>

<file path="src/lib/hooks/index.ts">
export { useUser, useHasRole, useIsAdmin } from './useUser';
</file>

<file path="src/lib/supabase/client.ts">
'use client';

import { createBrowserClient } from '@supabase/ssr';
import type { Database } from '@/types/database.types';

/**
 * Cliente de Supabase para uso en componentes del cliente (browser)
 * 
 * @example
 * // En un Client Component
 * const supabase = createClient();
 * const { data } = await supabase.from('profiles').select('*');
 */
export function createClient() {
  return createBrowserClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}

/**
 * Singleton del cliente para evitar múltiples instancias
 * Útil para hooks y contextos
 */
let browserClient: ReturnType<typeof createClient> | null = null;

export function getSupabaseClient() {
  if (!browserClient) {
    browserClient = createClient();
  }
  return browserClient;
}
</file>

<file path="src/lib/supabase/index.ts">
// Re-exportar clientes de Supabase
export { createClient, getSupabaseClient } from './client';
export {
  createServerSupabaseClient,
  createAdminClient,
  getServerUser,
  getServerUserProfile,
} from './server';
</file>

<file path="src/lib/supabase/server.ts">
import { createServerClient, type CookieOptions } from '@supabase/ssr';
import { cookies } from 'next/headers';
import type { Database } from '@/types/database.types';

/**
 * Cliente de Supabase para Server Components
 * Maneja cookies automáticamente para mantener la sesión
 * 
 * @example
 * // En un Server Component
 * const supabase = createServerSupabaseClient();
 * const { data } = await supabase.from('profiles').select('*');
 */
export function createServerSupabaseClient() {
  const cookieStore = cookies();

  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        get(name: string) {
          return cookieStore.get(name)?.value;
        },
        set(name: string, value: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value, ...options });
          } catch {
            // El método `set` puede fallar si se llama desde un Server Component
            // Esto es esperado y se puede ignorar
          }
        },
        remove(name: string, options: CookieOptions) {
          try {
            cookieStore.set({ name, value: '', ...options });
          } catch {
            // Similar al set, puede fallar en Server Components
          }
        },
      },
    }
  );
}

/**
 * Cliente de Supabase con Service Role para operaciones admin
 * SOLO usar en server-side (API routes, server actions)
 * NUNCA exponer al cliente
 * 
 * @example
 * // En una API route o Server Action
 * const supabase = createAdminClient();
 * // Puede hacer operaciones que bypass RLS
 */
export function createAdminClient() {
  return createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      cookies: {
        get() {
          return undefined;
        },
        set() {},
        remove() {},
      },
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    }
  );
}

/**
 * Obtiene el usuario actual desde el servidor
 * Útil para validar autenticación en Server Components
 */
export async function getServerUser() {
  const supabase = createServerSupabaseClient();
  
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser();

  if (error || !user) {
    return null;
  }

  return user;
}

/**
 * Obtiene el perfil completo del usuario actual
 * Incluye el rol y otros datos
 */
export async function getServerUserProfile() {
  const supabase = createServerSupabaseClient();
  
  const {
    data: { user },
    error: authError,
  } = await supabase.auth.getUser();

  if (authError || !user) {
    return null;
  }

  const { data: profile, error: profileError } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (profileError || !profile) {
    return null;
  }

  return {
    ...user,
    profile,
  };
}
</file>

<file path="src/lib/utils/index.ts">
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

/**
 * Combina clases de Tailwind de forma inteligente
 * Usa clsx para condicionales y twMerge para resolver conflictos
 *
 * @example
 * cn('px-4 py-2', isActive && 'bg-emerald-500', className)
 */
export function cn(...inputs: ClassValue[]): string {
  return twMerge(clsx(inputs));
}

/**
 * Formatea una fecha en formato legible
 */
export function formatDate(
  date: Date | string,
  options: Intl.DateTimeFormatOptions = {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
  }
): string {
  const d = typeof date === 'string' ? new Date(date) : date;
  return new Intl.DateTimeFormat('es-ES', options).format(d);
}

/**
 * Formatea una fecha relativa (hace X tiempo)
 */
export function formatRelativeTime(date: Date | string): string {
  const d = typeof date === 'string' ? new Date(date) : date;
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - d.getTime()) / 1000);

  if (diffInSeconds < 60) return 'hace un momento';
  if (diffInSeconds < 3600) return `hace ${Math.floor(diffInSeconds / 60)} min`;
  if (diffInSeconds < 86400) return `hace ${Math.floor(diffInSeconds / 3600)}h`;
  if (diffInSeconds < 604800) return `hace ${Math.floor(diffInSeconds / 86400)}d`;

  return formatDate(d);
}

/**
 * Formatea un número como moneda
 */
export function formatCurrency(
  amount: number,
  currency = 'USD',
  locale = 'en-US'
): string {
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 2,
  }).format(amount);
}

/**
 * Formatea un número con separadores de miles
 */
export function formatNumber(num: number, locale = 'es-ES'): string {
  return new Intl.NumberFormat(locale).format(num);
}

/**
 * Trunca un string a una longitud máxima
 */
export function truncate(str: string, maxLength: number): string {
  if (str.length <= maxLength) return str;
  return `${str.slice(0, maxLength - 3)}...`;
}

/**
 * Genera las iniciales de un nombre
 */
export function getInitials(name: string): string {
  return name
    .split(' ')
    .map((part) => part[0])
    .join('')
    .toUpperCase()
    .slice(0, 2);
}

/**
 * Capitaliza la primera letra de cada palabra
 */
export function capitalize(str: string): string {
  return str
    .toLowerCase()
    .split(' ')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

/**
 * Genera un color de fondo consistente basado en un string (para avatares)
 */
export function stringToColor(str: string): string {
  const colors = [
    'bg-emerald-500',
    'bg-blue-500',
    'bg-purple-500',
    'bg-amber-500',
    'bg-rose-500',
    'bg-cyan-500',
    'bg-indigo-500',
    'bg-teal-500',
  ];

  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }

  return colors[Math.abs(hash) % colors.length] ?? colors[0]!;
}

/**
 * Debounce function
 */
export function debounce<T extends (...args: unknown[]) => unknown>(
  func: T,
  wait: number
): (...args: Parameters<T>) => void {
  let timeout: NodeJS.Timeout | null = null;

  return (...args: Parameters<T>) => {
    if (timeout) clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
}

/**
 * Sleep function para delays
 */
export function sleep(ms: number): Promise<void> {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

/**
 * Valida si un email es válido
 */
export function isValidEmail(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

/**
 * Obtiene el rango de fechas de la semana actual
 */
export function getCurrentWeekRange(): { start: Date; end: Date } {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);

  const start = new Date(now.setDate(diff));
  start.setHours(0, 0, 0, 0);

  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  end.setHours(23, 59, 59, 999);

  return { start, end };
}
</file>

<file path="src/lib/validations/monthly-reports.ts">
// =====================================================
// GLOBAL TALENT PLATFORM - VALIDACIONES INFORMES MENSUALES
// =====================================================

import { z } from 'zod';

// =====================================================
// ESQUEMAS INDIVIDUALES
// =====================================================

export const activitySchema = z.object({
  id: z.string().uuid().optional(),
  title: z
    .string()
    .min(5, 'El título debe tener al menos 5 caracteres')
    .max(300, 'El título no puede exceder 300 caracteres'),
  description: z
    .string()
    .max(2000, 'La descripción no puede exceder 2000 caracteres')
    .optional()
    .default(''),
});

export const objectiveSchema = z.object({
  id: z.string().uuid().optional(),
  objective: z
    .string()
    .min(5, 'El objetivo debe tener al menos 5 caracteres')
    .max(500, 'El objetivo no puede exceder 500 caracteres'),
  achieved: z.boolean().default(false),
  notes: z
    .string()
    .max(1000, 'Las notas no pueden exceder 1000 caracteres')
    .optional()
    .default(''),
});

export const suggestionSchema = z.object({
  id: z.string().uuid().optional(),
  suggestion: z
    .string()
    .min(10, 'La sugerencia debe tener al menos 10 caracteres')
    .max(2000, 'La sugerencia no puede exceder 2000 caracteres'),
});

export const metricSchema = z.object({
  id: z.string().uuid().optional(),
  metric_name: z
    .string()
    .min(2, 'El nombre de la métrica es requerido')
    .max(100, 'El nombre no puede exceder 100 caracteres'),
  metric_value: z
    .string()
    .min(1, 'El valor es requerido')
    .max(50, 'El valor no puede exceder 50 caracteres'),
  metric_unit: z
    .string()
    .max(30, 'La unidad no puede exceder 30 caracteres')
    .optional()
    .default(''),
});

// =====================================================
// FORMULARIO COMPLETO (para enviar)
// =====================================================

export const monthlyReportFormSchema = z.object({
  activities: z
    .array(activitySchema)
    .min(1, 'Debes agregar al menos 1 actividad'),
  objectives: z
    .array(objectiveSchema)
    .min(1, 'Debes agregar al menos 1 objetivo'),
  suggestions: z
    .array(suggestionSchema)
    .optional()
    .default([]),
  metrics: z
    .array(metricSchema)
    .optional()
    .default([]),
});

// =====================================================
// BORRADOR (más flexible)
// =====================================================

export const draftActivitySchema = z.object({
  id: z.string().uuid().optional(),
  title: z.string().max(300).optional().default(''),
  description: z.string().max(2000).optional().default(''),
});

export const draftObjectiveSchema = z.object({
  id: z.string().uuid().optional(),
  objective: z.string().max(500).optional().default(''),
  achieved: z.boolean().optional().default(false),
  notes: z.string().max(1000).optional().default(''),
});

export const draftSuggestionSchema = z.object({
  id: z.string().uuid().optional(),
  suggestion: z.string().max(2000).optional().default(''),
});

export const draftMetricSchema = z.object({
  id: z.string().uuid().optional(),
  metric_name: z.string().max(100).optional().default(''),
  metric_value: z.string().max(50).optional().default(''),
  metric_unit: z.string().max(30).optional().default(''),
});

export const draftMonthlyReportSchema = z.object({
  activities: z.array(draftActivitySchema).optional().default([]),
  objectives: z.array(draftObjectiveSchema).optional().default([]),
  suggestions: z.array(draftSuggestionSchema).optional().default([]),
  metrics: z.array(draftMetricSchema).optional().default([]),
});

// =====================================================
// TIPOS
// =====================================================

export type ActivityInput = z.infer<typeof activitySchema>;
export type ObjectiveInput = z.infer<typeof objectiveSchema>;
export type SuggestionInput = z.infer<typeof suggestionSchema>;
export type MetricInput = z.infer<typeof metricSchema>;
export type MonthlyReportFormInput = z.infer<typeof monthlyReportFormSchema>;
export type DraftMonthlyReportInput = z.infer<typeof draftMonthlyReportSchema>;

// =====================================================
// VALORES POR DEFECTO
// =====================================================

export const DEFAULT_ACTIVITY: ActivityInput = {
  title: '',
  description: '',
};

export const DEFAULT_OBJECTIVE: ObjectiveInput = {
  objective: '',
  achieved: false,
  notes: '',
};

export const DEFAULT_SUGGESTION: SuggestionInput = {
  suggestion: '',
};

export const DEFAULT_METRIC: MetricInput = {
  metric_name: '',
  metric_value: '',
  metric_unit: '',
};

// =====================================================
// FUNCIONES DE VALIDACIÓN
// =====================================================

export function validateMonthlyReport(data: unknown): {
  success: boolean;
  data?: MonthlyReportFormInput;
  errors?: z.ZodError;
} {
  const result = monthlyReportFormSchema.safeParse(data);
  if (result.success) {
    return { success: true, data: result.data };
  }
  return { success: false, errors: result.error };
}

export function getFormErrors(error: z.ZodError): Record<string, string[]> {
  const errors: Record<string, string[]> = {};
  
  error.errors.forEach((err) => {
    const path = err.path.join('.');
    if (!errors[path]) {
      errors[path] = [];
    }
    errors[path].push(err.message);
  });
  
  return errors;
}
</file>

<file path="src/types/interviews.types.ts">
// =====================================================
// GLOBAL TALENT PLATFORM - TIPOS DE ENTREVISTAS
// =====================================================

// =====================================================
// ENUMS Y TIPOS BASE
// =====================================================

export type ClientStatus = 'active' | 'inactive' | 'prospect';

export type JobRemoteType = 'onsite' | 'hybrid' | 'remote';

export type JobStatus = 'draft' | 'open' | 'paused' | 'closed' | 'filled';

export type ApplicationStatus = 
  | 'new'
  | 'screening'
  | 'approved_for_bot'
  | 'bot_pending'
  | 'bot_completed'
  | 'approved_for_human'
  | 'human_scheduled'
  | 'human_completed'
  | 'offer'
  | 'hired'
  | 'rejected'
  | 'withdrawn';

export type InterviewStatus = 
  | 'pending'
  | 'in_progress'
  | 'completed'
  | 'expired'
  | 'abandoned';

// =====================================================
// INTERFACES DE TABLAS
// =====================================================

export interface Client {
  id: string;
  name: string;
  legal_name: string | null;
  tax_id: string | null;
  contact_name: string | null;
  contact_email: string | null;
  contact_phone: string | null;
  logo_url: string | null;
  primary_color: string;
  status: ClientStatus;
  zoho_account_id: string | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}

export interface JobPosition {
  id: string;
  client_id: string;
  title: string;
  description: string | null;
  requirements: string | null;
  location: string | null;
  remote_type: JobRemoteType;
  salary_min: number | null;
  salary_max: number | null;
  salary_currency: string;
  status: JobStatus;
  elevenlabs_agent_id: string | null;
  interview_questions: Record<string, unknown> | null;
  zoho_job_id: string | null;
  assigned_to: string | null;
  opened_at: string | null;
  closed_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface Candidate {
  id: string;
  email: string;
  full_name: string;
  phone: string | null;
  cv_url: string | null;
  video_url: string | null;
  linkedin_url: string | null;
  portfolio_url: string | null;
  zoho_candidate_id: string | null;
  source: string;
  created_at: string;
  updated_at: string;
}

export interface Application {
  id: string;
  candidate_id: string;
  job_position_id: string;
  initial_score: number | null;
  initial_analysis: Record<string, unknown> | null;
  status: ApplicationStatus;
  approved_by: string | null;
  approved_at: string | null;
  recruiter_notes: string | null;
  zoho_application_id: string | null;
  applied_at: string;
  updated_at: string;
}

export interface Interview {
  id: string;
  application_id: string;
  token: string;
  status: InterviewStatus;
  expires_at: string;
  elevenlabs_conversation_id: string | null;
  elevenlabs_agent_id: string | null;
  transcript: string | null;
  analysis: Record<string, unknown> | null;
  bot_score: number | null;
  started_at: string | null;
  completed_at: string | null;
  user_agent: string | null;
  ip_address: string | null;
  created_at: string;
  updated_at: string;
}

// =====================================================
// TIPOS COMPUESTOS (con relaciones)
// =====================================================

export interface JobPositionWithClient extends JobPosition {
  client: Client;
}

export interface ApplicationWithDetails extends Application {
  candidate: Candidate;
  job_position: JobPositionWithClient;
  interviews?: Interview[];
}

export interface InterviewWithDetails extends Interview {
  application: ApplicationWithDetails;
}

// =====================================================
// TIPOS PARA LA SALA DE ENTREVISTA (público)
// =====================================================

export interface InterviewValidationResult {
  interview_id: string | null;
  status: string;
  is_valid: boolean;
  candidate_name: string | null;
  candidate_email: string | null;
  job_title: string | null;
  client_name: string | null;
  elevenlabs_agent_id: string | null;
  error_message: string | null;
}

export interface InterviewRoomData {
  interviewId: string;
  candidateName: string;
  jobTitle: string;
  clientName: string;
  agentId: string;
  status: InterviewStatus;
}

// =====================================================
// TIPOS PARA API (n8n)
// =====================================================

export interface CreateInterviewRequest {
  email: string;
  candidate_name: string;
  phone?: string;
  job_position_id: string;
  initial_score?: number;
  initial_analysis?: Record<string, unknown>;
  cv_url?: string;
  video_url?: string;
  zoho_candidate_id?: string;
  zoho_application_id?: string;
}

export interface CreateInterviewResponse {
  success: boolean;
  data?: {
    interview_id: string;
    candidate_id: string;
    application_id: string;
    token: string;
    link: string;
    expires_at: string;
  };
  error?: string;
}

// =====================================================
// TIPOS PARA DASHBOARD
// =====================================================

export interface InterviewStats {
  total: number;
  pending: number;
  in_progress: number;
  completed: number;
  expired: number;
  completion_rate: number;
}

export interface CandidatePipelineItem {
  application_id: string;
  candidate_name: string;
  candidate_email: string;
  job_title: string;
  client_name: string;
  status: ApplicationStatus;
  initial_score: number | null;
  bot_score: number | null;
  applied_at: string;
  interview_status: InterviewStatus | null;
}

// =====================================================
// CONSTANTES Y HELPERS
// =====================================================

export const APPLICATION_STATUS_LABELS: Record<ApplicationStatus, string> = {
  new: 'Nuevo',
  screening: 'En revisión',
  approved_for_bot: 'Aprobado para entrevista',
  bot_pending: 'Entrevista pendiente',
  bot_completed: 'Entrevista completada',
  approved_for_human: 'Aprobado (humano)',
  human_scheduled: 'Entrevista agendada',
  human_completed: 'Entrevista completada',
  offer: 'En oferta',
  hired: 'Contratado',
  rejected: 'Rechazado',
  withdrawn: 'Retirado',
};

export const APPLICATION_STATUS_COLORS: Record<ApplicationStatus, string> = {
  new: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
  screening: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
  approved_for_bot: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
  bot_pending: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  bot_completed: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
  approved_for_human: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
  human_scheduled: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
  human_completed: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
  offer: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  hired: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
  rejected: 'bg-red-500/20 text-red-400 border-red-500/30',
  withdrawn: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
};

export const INTERVIEW_STATUS_LABELS: Record<InterviewStatus, string> = {
  pending: 'Pendiente',
  in_progress: 'En curso',
  completed: 'Completada',
  expired: 'Expirada',
  abandoned: 'Abandonada',
};

export const INTERVIEW_STATUS_COLORS: Record<InterviewStatus, string> = {
  pending: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  in_progress: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
  completed: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
  expired: 'bg-red-500/20 text-red-400 border-red-500/30',
  abandoned: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
};

// Helper para calcular tiempo restante
export function getTimeRemaining(expiresAt: string): {
  expired: boolean;
  hours: number;
  minutes: number;
  label: string;
} {
  const now = new Date();
  const expires = new Date(expiresAt);
  const diffMs = expires.getTime() - now.getTime();
  
  if (diffMs <= 0) {
    return { expired: true, hours: 0, minutes: 0, label: 'Expirado' };
  }
  
  const hours = Math.floor(diffMs / (1000 * 60 * 60));
  const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
  
  if (hours > 24) {
    const days = Math.floor(hours / 24);
    return { expired: false, hours, minutes, label: `${days} día${days !== 1 ? 's' : ''}` };
  }
  
  if (hours > 0) {
    return { expired: false, hours, minutes, label: `${hours}h ${minutes}m` };
  }
  
  return { expired: false, hours, minutes, label: `${minutes} minutos` };
}
</file>

<file path="src/types/monthly-reports.types.ts">
// =====================================================
// GLOBAL TALENT PLATFORM - TIPOS DE INFORMES MENSUALES
// =====================================================

// =====================================================
// TIPOS BASE
// =====================================================

export interface MonthlyReport {
  id: string;
  assistant_id: string;
  report_month: string;
  report_year: number;
  report_month_number: number;
  status: MonthlyReportStatus;
  is_locked: boolean;
  submitted_at: string | null;
  reviewed_at: string | null;
  reviewed_by: string | null;
  quality_score: number | null;
  quality_feedback: string | null;
  created_at: string;
  updated_at: string;
}

export interface MonthlyActivity {
  id: string;
  monthly_report_id: string;
  title: string;
  description: string | null;
  sort_order: number;
  created_at: string;
  updated_at: string;
}

export interface MonthlyObjective {
  id: string;
  monthly_report_id: string;
  objective: string;
  achieved: boolean;
  notes: string | null;
  sort_order: number;
  created_at: string;
  updated_at: string;
}

export interface MonthlySuggestion {
  id: string;
  monthly_report_id: string;
  suggestion: string;
  sort_order: number;
  created_at: string;
}

export interface MonthlyMetric {
  id: string;
  monthly_report_id: string;
  metric_name: string;
  metric_value: string;
  metric_unit: string | null;
  sort_order: number;
  created_at: string;
}

export interface MonthlyAttachment {
  id: string;
  monthly_report_id: string;
  activity_id: string | null;
  file_name: string;
  file_type: string;
  file_size: number;
  file_url: string;
  description: string | null;
  uploaded_by: string;
  created_at: string;
}

// =====================================================
// ENUMS Y CONSTANTES
// =====================================================

export type MonthlyReportStatus = 'draft' | 'submitted' | 'reviewed' | 'approved';

export const MONTHLY_STATUS_LABELS: Record<MonthlyReportStatus, string> = {
  draft: 'Borrador',
  submitted: 'Enviado',
  reviewed: 'Revisado',
  approved: 'Aprobado',
};

export const MONTHLY_STATUS_COLORS: Record<MonthlyReportStatus, string> = {
  draft: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
  submitted: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
  reviewed: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  approved: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
};

export const MONTH_NAMES: string[] = [
  'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

// =====================================================
// TIPOS COMPUESTOS
// =====================================================

export interface MonthlyReportWithEntries extends MonthlyReport {
  activities: MonthlyActivity[];
  objectives: MonthlyObjective[];
  suggestions: MonthlySuggestion[];
  metrics: MonthlyMetric[];
  attachments: MonthlyAttachment[];
  assistant?: {
    id: string;
    full_name: string;
    email: string;
    position: string | null;
    avatar_url: string | null;
  };
}

export interface MonthlyProgressItem {
  assistant_id: string;
  full_name: string;
  email: string;
  position: string | null;
  avatar_url: string | null;
  report_id: string | null;
  status: MonthlyReportStatus | null;
  has_submitted: boolean;
  submitted_at: string | null;
  quality_score: number | null;
  activities_count: number;
  objectives_count: number;
}

export interface MonthSummary {
  report_month: string;
  report_year: number;
  report_month_number: number;
  month_name: string;
  total_assistants: number;
  submitted_count: number;
  pending_count: number;
  progress_percentage: number;
}

// =====================================================
// TIPOS PARA FORMULARIOS
// =====================================================

export interface ActivityFormData {
  id?: string;
  title: string;
  description: string;
}

export interface ObjectiveFormData {
  id?: string;
  objective: string;
  achieved: boolean;
  notes: string;
}

export interface SuggestionFormData {
  id?: string;
  suggestion: string;
}

export interface MetricFormData {
  id?: string;
  metric_name: string;
  metric_value: string;
  metric_unit: string;
}

export interface MonthlyReportFormData {
  activities: ActivityFormData[];
  objectives: ObjectiveFormData[];
  suggestions: SuggestionFormData[];
  metrics: MetricFormData[];
}

// =====================================================
// UTILIDADES
// =====================================================

export function getCurrentMonthInfo(): { month: number; year: number; monthName: string } {
  const now = new Date();
  const month = now.getMonth() + 1;
  const year = now.getFullYear();
  const monthName = MONTH_NAMES[month - 1] ?? '';
  return { month, year, monthName };
}

export function formatMonthYear(month: number, year: number): string {
  const monthName = MONTH_NAMES[month - 1] ?? '';
  return `${monthName} ${year}`;
}

export function getMonthDeadline(month: number, year: number): Date {
  // Deadline: día 5 del mes siguiente
  const nextMonth = month === 12 ? 1 : month + 1;
  const nextYear = month === 12 ? year + 1 : year;
  return new Date(nextYear, nextMonth - 1, 5, 18, 0, 0);
}

export function getMonthDeadlineStatus(month: number, year: number): {
  isOverdue: boolean;
  daysUntil: number;
  label: string;
} {
  const now = new Date();
  const deadline = getMonthDeadline(month, year);
  
  const diffMs = deadline.getTime() - now.getTime();
  const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
  
  if (diffDays < 0) {
    return {
      isOverdue: true,
      daysUntil: Math.abs(diffDays),
      label: `${Math.abs(diffDays)} día${Math.abs(diffDays) !== 1 ? 's' : ''} de retraso`,
    };
  }
  
  if (diffDays === 0) {
    return {
      isOverdue: false,
      daysUntil: 0,
      label: 'Vence hoy',
    };
  }
  
  return {
    isOverdue: false,
    daysUntil: diffDays,
    label: `${diffDays} día${diffDays !== 1 ? 's' : ''} restante${diffDays !== 1 ? 's' : ''}`,
  };
}
</file>

<file path="tailwind.config.ts">
import type { Config } from 'tailwindcss';

const config: Config = {
  darkMode: ['class'],
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    container: {
      center: true,
      padding: '2rem',
      screens: {
        '2xl': '1400px',
      },
    },
    extend: {
      colors: {
        // Colores base del sistema
        border: 'hsl(var(--border))',
        input: 'hsl(var(--input))',
        ring: 'hsl(var(--ring))',
        background: 'hsl(var(--background))',
        foreground: 'hsl(var(--foreground))',
        
        primary: {
          DEFAULT: 'hsl(var(--primary))',
          foreground: 'hsl(var(--primary-foreground))',
        },
        secondary: {
          DEFAULT: 'hsl(var(--secondary))',
          foreground: 'hsl(var(--secondary-foreground))',
        },
        destructive: {
          DEFAULT: 'hsl(var(--destructive))',
          foreground: 'hsl(var(--destructive-foreground))',
        },
        muted: {
          DEFAULT: 'hsl(var(--muted))',
          foreground: 'hsl(var(--muted-foreground))',
        },
        accent: {
          DEFAULT: 'hsl(var(--accent))',
          foreground: 'hsl(var(--accent-foreground))',
        },
        popover: {
          DEFAULT: 'hsl(var(--popover))',
          foreground: 'hsl(var(--popover-foreground))',
        },
        card: {
          DEFAULT: 'hsl(var(--card))',
          foreground: 'hsl(var(--card-foreground))',
        },

        // Colores personalizados de la plataforma
        // Emerald para success/acciones positivas
        success: {
          50: '#ecfdf5',
          100: '#d1fae5',
          200: '#a7f3d0',
          300: '#6ee7b7',
          400: '#34d399',
          500: '#10b981',
          600: '#059669',
          700: '#047857',
          800: '#065f46',
          900: '#064e3b',
        },
        // Amber para warnings
        warning: {
          50: '#fffbeb',
          100: '#fef3c7',
          200: '#fde68a',
          300: '#fcd34d',
          400: '#fbbf24',
          500: '#f59e0b',
          600: '#d97706',
          700: '#b45309',
          800: '#92400e',
          900: '#78350f',
        },
        // Slate personalizado para dark mode
        slate: {
          850: '#172033',
          950: '#020617',
        },
      },
      fontFamily: {
        sans: ['var(--font-geist-sans)', 'system-ui', 'sans-serif'],
        mono: ['var(--font-geist-mono)', 'monospace'],
      },
      fontSize: {
        '2xs': ['0.625rem', { lineHeight: '0.75rem' }],
      },
      spacing: {
        '18': '4.5rem',
        '88': '22rem',
        '128': '32rem',
      },
      borderRadius: {
        lg: 'var(--radius)',
        md: 'calc(var(--radius) - 2px)',
        sm: 'calc(var(--radius) - 4px)',
      },
      boxShadow: {
        'glow-emerald': '0 0 20px rgba(16, 185, 129, 0.3)',
        'glow-amber': '0 0 20px rgba(245, 158, 11, 0.3)',
        'inner-light': 'inset 0 1px 0 0 rgba(255, 255, 255, 0.05)',
      },
      backgroundImage: {
        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
        'gradient-conic': 'conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))',
        'grid-pattern': `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23334155' fill-opacity='0.1'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`,
      },
      keyframes: {
        'accordion-down': {
          from: { height: '0' },
          to: { height: 'var(--radix-accordion-content-height)' },
        },
        'accordion-up': {
          from: { height: 'var(--radix-accordion-content-height)' },
          to: { height: '0' },
        },
        'fade-in': {
          from: { opacity: '0', transform: 'translateY(10px)' },
          to: { opacity: '1', transform: 'translateY(0)' },
        },
        'slide-in-from-left': {
          from: { transform: 'translateX(-100%)' },
          to: { transform: 'translateX(0)' },
        },
        'pulse-soft': {
          '0%, 100%': { opacity: '1' },
          '50%': { opacity: '0.7' },
        },
        shimmer: {
          '0%': { backgroundPosition: '-200% 0' },
          '100%': { backgroundPosition: '200% 0' },
        },
      },
      animation: {
        'accordion-down': 'accordion-down 0.2s ease-out',
        'accordion-up': 'accordion-up 0.2s ease-out',
        'fade-in': 'fade-in 0.3s ease-out',
        'slide-in-from-left': 'slide-in-from-left 0.3s ease-out',
        'pulse-soft': 'pulse-soft 2s ease-in-out infinite',
        shimmer: 'shimmer 2s infinite linear',
      },
    },
  },
  plugins: [require('tailwindcss-animate')],
};

export default config;
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./src/*"],
      "@/components/*": ["./src/components/*"],
      "@/lib/*": ["./src/lib/*"],
      "@/types/*": ["./src/types/*"],
      "@/hooks/*": ["./src/lib/hooks/*"],
      "@/utils/*": ["./src/lib/utils/*"]
    },
    "target": "ES2017",
    "forceConsistentCasingInFileNames": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "exactOptionalPropertyTypes": false,
    "noUncheckedIndexedAccess": true
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="update-leads-access.sql">
-- =====================================================
-- UPDATE PERMISOS LEADS PARA CALIDAD
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- Actualizar la política de acceso total para incluir el departamento 'quality'
DROP POLICY IF EXISTS "Full access for authorized roles" ON leads;

CREATE POLICY "Full access for authorized roles" ON leads
  USING (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND (
        profiles.role = 'admin' 
        OR profiles.department IN ('sales', 'c_level', 'marketing', 'quality')
      )
    )
  )
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE profiles.id = auth.uid()
      AND (
        profiles.role = 'admin' 
        OR profiles.department IN ('sales', 'c_level', 'marketing', 'quality')
      )
    )
  );

COMMENT ON POLICY "Full access for authorized roles" ON leads IS 'Permite acceso total a admins, ventas, c-level, marketing y calidad';
</file>

<file path="VERIFICACION-COMPLETA.md">
# ✅ Verificación Completa - Módulo de Entrevistas

## 📋 Resumen de lo Completado

### ✅ Instalación Base
- [x] Dependencia `@elevenlabs/react` instalada
- [x] Middleware actualizado (`src/middleware.ts`)
- [x] Script de migración creado (`migration-interviews-module.sql`)
- [x] Migración ejecutada en Supabase

### ✅ Archivos Copiados
- [x] Tipos TypeScript: `src/types/interviews.types.ts`
- [x] Rutas de API: `src/app/api/interviews/*` (4 archivos)
- [x] Páginas públicas: `src/app/entrevista/[token]/*` (3 archivos)

### ✅ Configuración
- [x] Variables de entorno agregadas en `.env.local`
- [x] `ELEVENLABS_DEFAULT_AGENT_ID` configurado
- [x] `INTERVIEWS_API_KEY` configurado
- [x] `ELEVENLABS_WEBHOOK_SECRET` comentado (opcional)

---

## 🔍 Instrucciones de Verificación

### PASO 1: Verificar que el servidor inicia sin errores

```bash
# En la terminal, ejecuta:
npm run dev
```

**Qué buscar:**
- ✅ No debe haber errores de compilación
- ✅ Debe mostrar "Ready" en algún momento
- ✅ No debe haber errores de TypeScript

**Si hay errores:**
- Copia el mensaje de error completo
- Revisa qué archivo está causando el problema

---

### PASO 2: Probar los endpoints de API

Abre en tu navegador (o usa Postman/curl):

#### 2.1 Endpoint GET (debe mostrar schema):
```
http://localhost:3000/api/interviews/create
```

**Resultado esperado:**
```json
{
  "status": "ok",
  "endpoint": "/api/interviews/create",
  "method": "POST",
  ...
}
```

#### 2.2 Endpoint de webhook:
```
http://localhost:3000/api/interviews/webhook
```

**Resultado esperado:**
```json
{
  "status": "ok",
  "endpoint": "/api/interviews/webhook",
  ...
}
```

#### 2.3 Probar POST con API Key (desde terminal o Postman):
```bash
curl -X POST http://localhost:3000/api/interviews/create \
  -H "Authorization: Bearer 48d5e45849279a48ccd37c0a98523f0c02e1ffcc61089d3f541dc4ce41bfd858" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "candidate_name": "Juan Pérez",
    "job_position_id": "uuid-de-un-puesto-existente"
  }'
```

**Nota:** Necesitas un `job_position_id` válido de tu base de datos.

---

### PASO 3: Probar rutas públicas

#### 3.1 Ruta con token inválido:
```
http://localhost:3000/entrevista/token-invalido
```

**Resultado esperado:**
- ✅ Debe mostrar pantalla de error "Enlace no válido"
- ✅ No debe pedir login
- ✅ Debe tener el diseño correcto

#### 3.2 Ruta con formato UUID inválido:
```
http://localhost:3000/entrevista/123
```

**Resultado esperado:**
- ✅ Debe mostrar pantalla de error
- ✅ No debe crashear

---

### PASO 4: Verificar que las tablas existen en Supabase

Ejecuta en Supabase SQL Editor:

```sql
-- Verificar que la columna 'name' existe en clients
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'clients' 
AND column_name IN ('name', 'company_name');

-- Verificar que las nuevas tablas existen
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('job_positions', 'applications', 'interviews')
ORDER BY table_name;
```

**Resultado esperado:**
- ✅ Debe mostrar `name` y `company_name` en clients
- ✅ Debe mostrar las 3 tablas: `job_positions`, `applications`, `interviews`

---

### PASO 5: Verificar funciones de PostgreSQL

Ejecuta en Supabase SQL Editor:

```sql
-- Verificar que las funciones existen
SELECT routine_name, routine_type
FROM information_schema.routines
WHERE routine_schema = 'public'
AND routine_name IN (
  'validate_interview_token',
  'start_interview',
  'complete_interview'
)
ORDER BY routine_name;
```

**Resultado esperado:**
- ✅ Debe mostrar las 3 funciones

---

### PASO 6: Verificar tipos de TypeScript (opcional pero recomendado)

Si tienes Supabase CLI instalado:

```bash
# Opción 1: Con npx (si no está instalado globalmente)
npx supabase gen types typescript --project-id hxnnettudbgprzprrmdp > src/types/database.types.ts

# Opción 2: Si está instalado globalmente
supabase gen types typescript --project-id hxnnettudbgprzprrmdp > src/types/database.types.ts
```

**Nota:** Si no puedes ejecutar este comando, no es crítico. Los tipos manuales funcionan.

---

### PASO 7: Verificar que el middleware funciona

1. **Sin login, intenta acceder a una ruta protegida:**
   ```
   http://localhost:3000/dashboard
   ```
   - ✅ Debe redirigir a `/login`

2. **Con login, intenta acceder a `/entrevista/*`:**
   - ✅ Debe permitir acceso (es ruta pública)

3. **Prueba una ruta de API pública:**
   ```
   http://localhost:3000/api/interviews/create
   ```
   - ✅ Debe responder sin pedir autenticación

---

## 🐛 Problemas Comunes y Soluciones

### Error: "Cannot find module '@elevenlabs/react'"
**Solución:**
```bash
npm install @elevenlabs/react --legacy-peer-deps
```

### Error: "column 'name' does not exist"
**Causa:** La migración no se ejecutó correctamente.

**Solución:**
1. Ve a Supabase SQL Editor
2. Ejecuta solo esta parte:
```sql
ALTER TABLE clients ADD COLUMN IF NOT EXISTS name TEXT;
UPDATE clients SET name = company_name WHERE name IS NULL OR name = '';
```

### Error: "Table 'job_positions' does not exist"
**Causa:** Las nuevas tablas no se crearon.

**Solución:**
1. Ejecuta el script de migración completo nuevamente
2. O ejecuta solo la sección "PASO 2" del script

### Error: "Function validate_interview_token does not exist"
**Causa:** Las funciones de PostgreSQL no se crearon.

**Solución:**
1. Ejecuta el script de migración completo nuevamente
2. O ejecuta solo la sección "PASO 8" del script

### Error: "Unauthorized" en `/api/interviews/create`
**Causa:** API Key incorrecta o faltante.

**Solución:**
1. Verifica que `INTERVIEWS_API_KEY` en `.env.local` coincide
2. Verifica el header: `Authorization: Bearer {tu-api-key}`
3. Reinicia el servidor después de cambiar `.env.local`

---

## 📊 Checklist Final

Antes de considerar todo listo, verifica:

- [ ] Servidor inicia sin errores (`npm run dev`)
- [ ] Endpoint `/api/interviews/create` responde (GET)
- [ ] Endpoint `/api/interviews/webhook` responde (GET)
- [ ] Ruta `/entrevista/token-invalido` muestra pantalla de error
- [ ] Tabla `clients` tiene columna `name`
- [ ] Tablas `job_positions`, `applications`, `interviews` existen
- [ ] Funciones PostgreSQL existen (validate_interview_token, etc.)
- [ ] Middleware redirige correctamente a login
- [ ] Rutas públicas funcionan sin autenticación

---

## 🎯 Próximos Pasos (Después de Verificar)

1. **Crear datos de prueba:**
   - Crear un cliente en `clients`
   - Crear un `job_position` para ese cliente
   - Probar crear una entrevista desde la API

2. **Integrar con n8n:**
   - Configurar webhook en n8n que llame a `/api/interviews/create`
   - Probar el flujo completo

3. **Configurar ElevenLabs:**
   - Verificar que el Agent ID es correcto
   - Probar la conexión desde la sala de entrevista

4. **Dashboard de entrevistas (Fase 2):**
   - Crear página `/entrevistas` para RRHH
   - Mostrar lista de entrevistas pendientes/completadas

---

## 📝 Información para el Próximo Chat

Cuando inicies un nuevo chat, copia esta información:

```
✅ Módulo de entrevistas instalado
✅ Migración ejecutada en Supabase
✅ Variables de entorno configuradas:
   - ELEVENLABS_DEFAULT_AGENT_ID=agent_3301kf0s7m79fq78742kp9c4qp5b
   - INTERVIEWS_API_KEY=48d5e45849279a48ccd37c0a98523f0c02e1ffcc61089d3f541dc4ce41bfd858
✅ Archivos copiados a src/
✅ Middleware actualizado

Necesito verificar que todo funciona correctamente.
```

---

## 🔗 Archivos Importantes

- **Script de migración:** `migration-interviews-module.sql`
- **Guía de migración:** `MIGRACION-COMPLETA.md`
- **Variables de entorno:** `.env.local`
- **Middleware:** `src/middleware.ts`
- **Tipos:** `src/types/interviews.types.ts`

---

## 💡 Tips

1. **Siempre reinicia el servidor** después de cambiar `.env.local`
2. **Los errores de TypeScript** pueden aparecer en el editor pero no impedir que funcione
3. **Las funciones de PostgreSQL** pueden tardar unos segundos en crearse
4. **El webhook secret es opcional** - puedes configurarlo más adelante

---

¡Todo listo para verificar! 🚀
</file>

<file path="verificar-constraint-clients.sql">
-- =====================================================
-- VERIFICAR CONSTRAINT DE STATUS EN CLIENTS
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- Ver el constraint exacto de la tabla clients
SELECT 
  conname AS constraint_name,
  pg_get_constraintdef(oid) AS constraint_definition
FROM pg_constraint
WHERE conrelid = 'clients'::regclass
AND contype = 'c';  -- 'c' = CHECK constraint

-- También verificar la definición de la columna status
SELECT 
  column_name,
  data_type,
  column_default,
  is_nullable
FROM information_schema.columns
WHERE table_name = 'clients'
AND column_name = 'status';
</file>

<file path="verificar-supabase.sql">
-- =====================================================
-- SCRIPT DE VERIFICACIÓN - MÓDULO DE ENTREVISTAS
-- Ejecutar en Supabase SQL Editor
-- =====================================================

-- =====================================================
-- 1. VERIFICAR COLUMNA 'name' EN clients
-- =====================================================
SELECT 
  column_name, 
  data_type,
  is_nullable
FROM information_schema.columns 
WHERE table_name = 'clients' 
AND column_name IN ('name', 'company_name')
ORDER BY column_name;

-- =====================================================
-- 2. VERIFICAR TABLAS NUEVAS
-- =====================================================
SELECT 
  table_name,
  (SELECT COUNT(*) 
   FROM information_schema.columns 
   WHERE table_name = t.table_name) as column_count
FROM information_schema.tables t
WHERE table_schema = 'public' 
AND table_name IN ('job_positions', 'applications', 'interviews', 'candidates')
ORDER BY table_name;

-- =====================================================
-- 3. VERIFICAR FUNCIONES DE POSTGRESQL
-- =====================================================
SELECT 
  routine_name, 
  routine_type,
  data_type as return_type
FROM information_schema.routines
WHERE routine_schema = 'public'
AND routine_name IN (
  'validate_interview_token',
  'start_interview',
  'complete_interview'
)
ORDER BY routine_name;

-- =====================================================
-- 4. VERIFICAR ESTRUCTURA DE TABLA job_positions
-- =====================================================
SELECT 
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'job_positions'
ORDER BY ordinal_position;

-- =====================================================
-- 5. VERIFICAR ESTRUCTURA DE TABLA interviews
-- =====================================================
SELECT 
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'interviews'
ORDER BY ordinal_position;

-- =====================================================
-- 6. VERIFICAR ÍNDICES Y CONSTRAINTS
-- =====================================================
SELECT 
  table_name,
  constraint_name,
  constraint_type
FROM information_schema.table_constraints
WHERE table_schema = 'public'
AND table_name IN ('job_positions', 'applications', 'interviews', 'candidates')
ORDER BY table_name, constraint_type;

-- =====================================================
-- 7. VERIFICAR DATOS EXISTENTES (si hay)
-- =====================================================
SELECT 
  'clients' as tabla, COUNT(*) as registros FROM clients
UNION ALL
SELECT 
  'job_positions' as tabla, COUNT(*) as registros FROM job_positions
UNION ALL
SELECT 
  'candidates' as tabla, COUNT(*) as registros FROM candidates
UNION ALL
SELECT 
  'applications' as tabla, COUNT(*) as registros FROM applications
UNION ALL
SELECT 
  'interviews' as tabla, COUNT(*) as registros FROM interviews;

-- =====================================================
-- RESULTADO ESPERADO:
-- =====================================================
-- ✅ Debe mostrar 'name' y 'company_name' en clients
-- ✅ Debe mostrar las 4 tablas: job_positions, applications, interviews, candidates
-- ✅ Debe mostrar las 3 funciones: validate_interview_token, start_interview, complete_interview
-- ✅ Debe mostrar la estructura completa de cada tabla
-- ✅ Debe mostrar los constraints (foreign keys, checks, etc.)
</file>

<file path="docs/WORKFLOW.md">
# Metodología de Trabajo y Colaboración

Para trabajar de manera eficiente entre dos personas y evitar conflictos ("carrera de postas"), utilizaremos la metodología de **Feature Branches**. Esto nos permite desarrollar funcionalidades en paralelo sin afectar la estabilidad del proyecto.

## 1. Ramas Principales

### `main` (Rama Protegida)
- Contiene el código en **producción** (o estable).
- **Nunca** se debe trabajar directamente sobre esta rama.
- Todo cambio llega aquí a través de un **Pull Request (PR)**.
- Se deploya automáticamente a Vercel (Production Environment).

## 2. Flujo de Trabajo (Paso a Paso)

### Paso 1: Crear una rama para tu tarea
Antes de empezar a programar, crea una rama nueva desde `main`. Usa nombres descriptivos.

**Convención de Nombres:**
- `feat/nombre-funcionalidad` (para nuevas características)
- `fix/nombre-bug` (para correcciones de errores)
- `style/nombre-cambio` (para cambios visuales)

```bash
# Asegúrate de estar en main y actualizado
git checkout main
git pull origin main

# Crea tu rama (ejemplo: tablero kanban)
git checkout -b feat/tablero-leads
```

### Ejemplos Prácticos para tu Equipo

**Situación:** Tu compañero va a trabajar en Entrevistas y tú en Reportes.

**1. Tu Compañero (Entrevistas):**
```bash
# Desde main actualizado
git checkout main
git pull origin main
git checkout -b feat/entrevistas
# ... trabaja, hace commits ...
git push origin feat/entrevistas
```

**2. Tú (Reportes):**
```bash
# Desde main actualizado
git checkout main
git pull origin main
git checkout -b feat/reportes
# ... trabajas, haces commits ...
git push origin feat/reportes
```

**Resultado:** Ambos trabajan en paralelo sin molestarse. Luego, cada uno crea un PR hacia `main` y se unen los cambios.

### Paso 2: Desarrollar y Guardar Cambios (Commits)
Trabaja en tu rama. Haz commits pequeños y descriptivos.

```bash
git add .
git commit -m "feat: agrega componente de tarjeta de lead"
```

### Paso 3: Subir Cambios y Crear Pull Request
Cuando termines (o quieras compartir avance), sube tu rama a GitHub.

```bash
git push origin feat/tablero-leads
```

1. Ve a GitHub.
2. Verás un botón "Compare & pull request".
3. Crea el PR describiendo tus cambios.
4. **IMPORTANTE:** Avisa a tu compañero para que revise el código (Code Review).

### Paso 4: Revisión y Merge
- Tu compañero revisa el código en GitHub.
- Si hay comentarios, haces los cambios en tu misma rama y vuelves a hacer push (el PR se actualiza solo).
- Una vez aprobado, se hace **Merge** a `main`.

### Paso 5: Sincronización
Una vez que el cambio de tu compañero está en `main`, debes actualizar tu local.

```bash
git checkout main
git pull origin main
```

## 3. Despliegue en Vercel

### Deploy Automático (Recomendado)
Vercel se conecta a tu repositorio GitHub.
- **Producción:** Cada vez que se hace merge a `main`, Vercel despliega automáticamente.
- **Preview:** Cada vez que subes una rama (Pull Request), Vercel genera una URL de previsualización única para probar esos cambios antes de hacer merge.
</file>

<file path="src/app/(auth)/layout.tsx">
import type { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Iniciar Sesión',
};

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="relative min-h-screen flex items-center justify-center bg-slate-950">
      {/* Fondo con gradiente sutil */}
      <div className="absolute inset-0 bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950" />

      {/* Patrón de fondo */}
      <div className="absolute inset-0 bg-grid-pattern opacity-5" />

      {/* Efecto de brillo */}
      <div className="absolute top-1/4 left-1/2 -translate-x-1/2 h-64 w-64 rounded-full bg-blue-500/10 blur-3xl" />

      {/* Contenido */}
      <div className="relative z-10 w-full">
        {children}
      </div>
    </div>
  );
}
</file>

<file path="src/app/(auth)/register/page.tsx">
'use client';

import { useState, Suspense } from 'react';
import Link from 'next/link';
import { Eye, EyeOff, Loader2, AlertCircle, UserPlus, MailCheck } from 'lucide-react';
import { createClient } from '@/lib/supabase/client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import { cn } from '@/lib/utils';

function RegisterForm() {
  const [formData, setFormData] = useState({
    fullName: '',
    email: '',
    password: '',
  });
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState(false);
  const [registeredEmail, setRegisteredEmail] = useState<string>('');

  const supabase = createClient();

  const handleRegister = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError(null);
    setSuccess(false);

    try {
      // 1. Crear usuario en Supabase
      const { data, error: signUpError } = await supabase.auth.signUp({
        email: formData.email,
        password: formData.password,
        options: {
          // Esto envía el nombre al trigger de SQL para crear el perfil
          data: {
            full_name: formData.fullName,
          },
        },
      });

      if (signUpError) {
        setError(signUpError.message);
        return;
      }

      if (data.user) {
        // 2. Guardar email antes de limpiar y mostrar mensaje de éxito
        setRegisteredEmail(formData.email);
        setSuccess(true);
        setFormData({
          fullName: '',
          email: '',
          password: '',
        });
      }
    } catch {
      setError('Ocurrió un error inesperado. Intenta de nuevo.');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Card className="border-slate-800 bg-slate-900/50 backdrop-blur">
      <CardHeader className="space-y-1 text-center">
        <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-xl bg-indigo-500 shadow-glow-indigo">
          <UserPlus className="h-6 w-6 text-white" />
        </div>
        <CardTitle className="text-2xl font-semibold tracking-tight text-white">
          Crear Cuenta
        </CardTitle>
        <CardDescription className="text-slate-400">
          Registro para nuevos asistentes
        </CardDescription>
      </CardHeader>

      <form onSubmit={handleRegister}>
        <CardContent className="space-y-4">
          {error && (
            <div className="flex items-center gap-2 rounded-lg border border-red-500/30 bg-red-500/10 p-3 text-sm text-red-400">
              <AlertCircle className="h-4 w-4 shrink-0" />
              <span>{error}</span>
            </div>
          )}

          {success && (
            <div className="flex flex-col gap-3 rounded-lg border border-indigo-500/30 bg-indigo-500/10 p-4 text-sm">
              <div className="flex items-start gap-2 text-indigo-400">
                <MailCheck className="h-5 w-5 shrink-0 mt-0.5" />
                <div className="flex-1 space-y-1">
                  <p className="font-semibold text-indigo-300">
                    ¡Registro exitoso!
                  </p>
                  <p className="text-indigo-400/90">
                    Te hemos enviado un correo de confirmación a <span className="font-medium text-indigo-300">{registeredEmail}</span>. 
                    Por favor, revisa tu bandeja de entrada y haz clic en el enlace para activar tu cuenta.
                  </p>
                  <p className="text-xs text-indigo-400/70 mt-2">
                    Si no encuentras el correo, revisa tu carpeta de spam o correo no deseado.
                  </p>
                </div>
              </div>
            </div>
          )}

          {!success && (
            <>
              {/* Nombre Completo */}
              <div className="space-y-2">
                <Label htmlFor="fullName" className="text-slate-300">Nombre Completo</Label>
                <Input
                  id="fullName"
                  placeholder="Ej: Juan Pérez"
                  value={formData.fullName}
                  onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}
                  required
                  disabled={isLoading}
                  className="border-slate-700 bg-slate-800/50 text-white focus:border-indigo-500/50"
                />
              </div>

              {/* Email */}
              <div className="space-y-2">
                <Label htmlFor="email" className="text-slate-300">Email Profesional</Label>
                <Input
                  id="email"
                  type="email"
                  placeholder="juan@globaltalent.com"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                  required
                  disabled={isLoading}
                  className="border-slate-700 bg-slate-800/50 text-white focus:border-indigo-500/50"
                />
              </div>

              {/* Password */}
              <div className="space-y-2">
                <Label htmlFor="password" className="text-slate-300">Contraseña</Label>
                <div className="relative">
                  <Input
                    id="password"
                    type={showPassword ? 'text' : 'password'}
                    placeholder="Mínimo 6 caracteres"
                    value={formData.password}
                    onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                    required
                    minLength={6}
                    disabled={isLoading}
                    className="border-slate-700 bg-slate-800/50 pr-10 text-white focus:border-indigo-500/50"
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    disabled={isLoading}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white"
                  >
                    {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                  </button>
                </div>
              </div>
            </>
          )}
        </CardContent>

        <CardFooter className="flex flex-col gap-4">
          {!success && (
            <>
              <Button
                type="submit"
                disabled={isLoading}
                className={cn(
                  'w-full bg-indigo-600 hover:bg-indigo-700 text-white',
                  isLoading && 'opacity-70'
                )}
              >
                {isLoading ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Registrando...
                  </>
                ) : (
                  'Crear mi cuenta'
                )}
              </Button>

              <p className="text-center text-xs text-slate-500">
                ¿Ya tienes cuenta?{' '}
                <Link href="/login" className="text-indigo-400 hover:underline">
                  Inicia sesión aquí
                </Link>
              </p>
            </>
          )}

          {success && (
            <div className="w-full space-y-3">
              <Link href="/login" className="block">
                <Button
                  type="button"
                  variant="outline"
                  className="w-full border-indigo-500/50 text-indigo-400 hover:bg-indigo-500/10"
                >
                  Ir al Login
                </Button>
              </Link>
              <p className="text-center text-xs text-slate-500">
                ¿Necesitas crear otra cuenta?{' '}
                <button
                  type="button"
                  onClick={() => {
                    setSuccess(false);
                    setRegisteredEmail('');
                    setFormData({ fullName: '', email: '', password: '' });
                  }}
                  className="text-indigo-400 hover:underline"
                >
                  Regístrate aquí
                </button>
              </p>
            </div>
          )}
        </CardFooter>
      </form>
    </Card>
  );
}

export default function RegisterPage() {
  return (
    <div className="mx-auto flex w-full flex-col justify-center space-y-6 px-4 sm:w-[400px]">
      <Suspense fallback={<div>Cargando...</div>}>
        <RegisterForm />
      </Suspense>
      <p className="text-center text-xs text-slate-600">
        Global Talent Platform © {new Date().getFullYear()}
      </p>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/calidad/reportes/page.tsx">
// =====================================================
// /calidad/reportes - Dashboard de seguimiento de reportes
// =====================================================

import { Suspense } from 'react';
import { redirect } from 'next/navigation';
import { Loader2 } from 'lucide-react';
import { getServerUserProfile } from '@/lib/supabase/server';
import { getWeekSummary, getAssistantStatuses } from '@/lib/actions/reports';
import { QualityDashboard } from '@/components/reportes/QualityDashboard';
import { hasAccess } from '@/types/database.types';

export const metadata = {
  title: 'Dashboard de Reportes | Global Talent Platform',
  description: 'Seguimiento de entregas semanales de asistentes',
};

function LoadingState() {
  return (
    <div className="flex items-center justify-center min-h-[400px]">
      <div className="text-center">
        <Loader2 className="h-8 w-8 animate-spin text-emerald-500 mx-auto mb-4" />
        <p className="text-slate-400">Cargando dashboard...</p>
      </div>
    </div>
  );
}

async function DashboardContent() {
  // Verificar permisos
  const userProfile = await getServerUserProfile();

  if (!userProfile) {
    redirect('/login');
  }

  // Verificar acceso para departamento 'quality' o 'c_level'
  const canAccess = hasAccess(
    userProfile.profile.department,
    userProfile.profile.position,
    userProfile.profile.role,
    { departments: ['quality', 'c_level'] }
  );

  if (!canAccess) {
    redirect('/dashboard?error=unauthorized');
  }

  // Cargar datos
  const [summaryResult, statusesResult] = await Promise.all([
    getWeekSummary(),
    getAssistantStatuses(),
  ]);

  if (!summaryResult.success || !summaryResult.data) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center max-w-md">
          <div className="flex h-16 w-16 items-center justify-center rounded-full bg-red-500/20 mx-auto mb-4">
            <span className="text-2xl">⚠️</span>
          </div>
          <h2 className="text-xl font-semibold text-slate-100 mb-2">
            Error al cargar el dashboard
          </h2>
          <p className="text-slate-400">
            {summaryResult.error ?? 'No se pudieron cargar los datos.'}
          </p>
        </div>
      </div>
    );
  }

  return (
    <QualityDashboard
      initialSummary={summaryResult.data}
      initialStatuses={statusesResult.data ?? []}
    />
  );
}

export default function QualityReportsDashboardPage() {
  return (
    <div className="container max-w-6xl py-6">
      <Suspense fallback={<LoadingState />}>
        <DashboardContent />
      </Suspense>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/dashboard/page.tsx">
import { Suspense } from 'react';
import { redirect } from 'next/navigation';
import { createServerSupabaseClient } from '@/lib/supabase/server';
import {
  Users,
  FileText,
  Briefcase,
  TrendingUp,
  Clock,
  CheckCircle2,
  AlertTriangle,
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { cn } from '@/lib/utils';

// IMPORTANTE: Esto evita errores de compilación en Vercel
export const dynamic = 'force-dynamic';

// Componente de Skeleton para loading
function MetricCardSkeleton() {
  return (
    <Card className="border-slate-800 bg-slate-900/50">
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <div className="h-4 w-24 skeleton rounded bg-slate-700" />
        <div className="h-8 w-8 skeleton rounded-lg bg-slate-700" />
      </CardHeader>
      <CardContent>
        <div className="h-8 w-16 skeleton rounded mb-1 bg-slate-700" />
        <div className="h-3 w-32 skeleton rounded bg-slate-700" />
      </CardContent>
    </Card>
  );
}

// Helper para obtener saludo según la hora
function getGreeting(): string {
  const hour = new Date().getHours();
  if (hour < 12) return 'Buenos días';
  if (hour < 18) return 'Buenas tardes';
  return 'Buenas noches';
}

export default async function DashboardPage() {
  // 1. Inicializar Supabase
  const supabase = createServerSupabaseClient();

  // 2. Verificar Usuario Autenticado
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    redirect('/login');
  }

  // 3. Obtener Perfil y ROL (Seguridad)
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  // --- LÓGICA DE ROLES ---
  // Si es asistente, NO puede ver este dashboard, va directo a sus reportes
  // Verificamos por posición 'assistant' O rol 'asistente' (legacy)
  if (profile?.position === 'assistant' || profile?.role === 'asistente') {
    redirect('/reportes/semanal');
  }

  // 4. OBTENER MÉTRICAS REALES (Solo si es Admin/Manager)
  // NOTA: Algunas tablas no existen aún, usamos placeholders o tablas que sí existen
  const [
    { count: totalAssistants },
    { count: totalCompletions }, // Usamos weekly_submissions real
  ] = await Promise.all([
    supabase.from('assistants').select('*', { count: 'exact', head: true }).eq('status', 'activo'),
    supabase.from('weekly_submissions').select('*', { count: 'exact', head: true }), // Corregido: weekly_reports -> weekly_submissions
  ]);

  // Datos procesados para la vista
  const metricsData = {
    totalAssistants: totalAssistants || 0,
    assistantsTrend: 'Ver lista',
    weeklyReports: totalCompletions || 0,
    reportsPending: 0,
    activeSearches: 0, // Placeholder hasta que exista job_positions
    searchesCritical: 0,
    hireRate: 85,
    hireRateTrend: '+5%',
  };

  const userName = profile?.full_name?.split(' ')[0] || user.email?.split('@')[0] || 'Usuario';
  const greeting = getGreeting();

  // Alertas de ejemplo (Para visualización inicial)
  const recentAlerts = [
    {
      id: '1',
      title: 'Sistema Actualizado',
      description: 'Permisos y perfil azul integrados',
      type: 'success',
      time: 'Ahora',
    },
  ];

  const recentActivity = [
    {
      id: '1',
      action: 'Sesión Iniciada',
      user: userName,
      time: 'Reciente',
    },
  ];

  return (
    <div className="page-container page-enter space-y-6 p-6">
      {/* Header */}
      <div className="page-header">
        <h1 className="text-3xl font-bold tracking-tight text-white">
          {greeting}, {userName} 👋
        </h1>
        <p className="text-slate-400 mt-2">
          Resumen de actividad en tiempo real
        </p>
      </div>

      {/* Métricas principales */}
      <Suspense
        fallback={
          <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
            {[...Array(4)].map((_, i) => (
              <MetricCardSkeleton key={i} />
            ))}
          </div>
        }
      >
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-8">
          {/* Asistentes */}
          <Card className="border-slate-800 bg-slate-900/50 hover:bg-slate-900/70 transition-colors">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium text-slate-400">
                Asistentes Activos
              </CardTitle>
              <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-500/20">
                <Users className="h-4 w-4 text-blue-400" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-white">
                {metricsData.totalAssistants}
              </div>
              <p className="text-xs text-blue-400">
                En base de datos
              </p>
            </CardContent>
          </Card>

          {/* Reportes */}
          <Card className="border-slate-800 bg-slate-900/50 hover:bg-slate-900/70 transition-colors">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium text-slate-400">
                Reportes Totales
              </CardTitle>
              <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-500/20">
                <FileText className="h-4 w-4 text-blue-400" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-white">
                {metricsData.weeklyReports}
              </div>
              <p className="text-xs text-slate-500">
                Histórico total
              </p>
            </CardContent>
          </Card>

          {/* Búsquedas */}
          <Card className="border-slate-800 bg-slate-900/50 hover:bg-slate-900/70 transition-colors">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium text-slate-400">
                Búsquedas Activas
              </CardTitle>
              <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-500/20">
                <Briefcase className="h-4 w-4 text-blue-400" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-white">
                {metricsData.activeSearches}
              </div>
              <p className="text-xs text-blue-400">
                En proceso
              </p>
            </CardContent>
          </Card>

          {/* Alertas */}
          <Card className="border-slate-800 bg-slate-900/50 hover:bg-slate-900/70 transition-colors">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium text-slate-400">
                Alertas Activas
              </CardTitle>
              <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-500/20">
                <AlertTriangle className="h-4 w-4 text-blue-400" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-white">
                0
              </div>
              <p className="text-xs text-blue-400">
                Sistema monitoreando
              </p>
            </CardContent>
          </Card>
        </div>
      </Suspense>

      {/* Sección inferior: Alertas + Actividad */}
      <div className="grid gap-6 lg:grid-cols-2">
        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-lg text-white">
              <AlertTriangle className="h-5 w-5 text-amber-400" />
              Estado del Sistema
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {recentAlerts.map((alert) => (
              <div
                key={alert.id}
                className="flex items-start gap-3 rounded-lg border border-slate-800 bg-slate-800/30 p-3"
              >
                <div
                  className={cn(
                    'mt-0.5 h-2 w-2 rounded-full shrink-0',
                    alert.type === 'warning' && 'bg-amber-400',
                    alert.type === 'error' && 'bg-red-400',
                    alert.type === 'success' && 'bg-emerald-400'
                  )}
                />
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-white">{alert.title}</p>
                  <p className="text-xs text-slate-400 truncate">
                    {alert.description}
                  </p>
                </div>
                <span className="text-xs text-slate-500 shrink-0">
                  {alert.time}
                </span>
              </div>
            ))}
          </CardContent>
        </Card>

        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-lg text-white">
              <Clock className="h-5 w-5 text-blue-400" />
              Tu Actividad
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {recentActivity.map((activity) => (
              <div
                key={activity.id}
                className="flex items-center gap-3 rounded-lg border border-slate-800 bg-slate-800/30 p-3"
              >
                <div className="flex h-8 w-8 items-center justify-center rounded-full bg-emerald-500/20">
                  <CheckCircle2 className="h-4 w-4 text-emerald-400" />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-white">
                    {activity.action}
                  </p>
                  <p className="text-xs text-slate-400">{activity.user}</p>
                </div>
                <span className="text-xs text-slate-500">{activity.time}</span>
              </div>
            ))}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/layout.tsx">
import { redirect } from 'next/navigation';
import { getServerUserProfile } from '@/lib/supabase/server';
import { Sidebar } from '@/components/shared/Sidebar';
import { Navbar } from '@/components/shared/Navbar';

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // Obtener usuario y perfil del servidor
  const userWithProfile = await getServerUserProfile();

  // Si no hay usuario, redirigir a login
  if (!userWithProfile || !userWithProfile.profile) {
    redirect('/login');
  }

  const { profile } = userWithProfile;

  // TODO: Obtener conteo de alertas sin leer
  const unreadAlerts = 3; // Placeholder

  return (
    <div className="min-h-screen bg-background">
      {/* Sidebar */}
      <Sidebar 
        userRole={profile.role} 
        userDepartment={profile.department}
        userPosition={profile.position}
      />

      {/* Main content area */}
      <div className="pl-64 transition-all duration-300">
        {/* Navbar */}
        <Navbar user={profile} unreadAlerts={unreadAlerts} />

        {/* Page content */}
        <main className="min-h-[calc(100vh-4rem)]">
          {children}
        </main>
      </div>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/page.tsx">
import { Suspense } from 'react';
import { redirect } from 'next/navigation';
import { createServerSupabaseClient } from '@/lib/supabase/server'; // Asegúrate que esta ruta sea correcta, o usa @/lib/supabase/server según tu estructura
import {
  Users,
  FileText,
  Briefcase,
  TrendingUp,
  Clock,
  CheckCircle2,
  AlertTriangle,
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { cn } from '@/lib/utils';

// ESTO ES CRUCIAL PARA VERCEL: Evita el error "Dynamic server usage"
export const dynamic = 'force-dynamic';

// Componente de Skeleton para loading
function MetricCardSkeleton() {
  return (
    <Card className="border-slate-800 bg-slate-900/50">
      <CardHeader className="flex flex-row items-center justify-between pb-2">
        <div className="h-4 w-24 skeleton rounded bg-slate-700" />
        <div className="h-8 w-8 skeleton rounded-lg bg-slate-700" />
      </CardHeader>
      <CardContent>
        <div className="h-8 w-16 skeleton rounded mb-1 bg-slate-700" />
        <div className="h-3 w-32 skeleton rounded bg-slate-700" />
      </CardContent>
    </Card>
  );
}

// Helper para obtener saludo según la hora
function getGreeting(): string {
  const hour = new Date().getHours();
  if (hour < 12) return 'Buenos días';
  if (hour < 18) return 'Buenas tardes';
  return 'Buenas noches';
}

export default async function DashboardPage() {
  // 1. Inicializar Supabase
  const supabase = createServerSupabaseClient();

  // 2. Verificar Usuario Autenticado
  const { data: { user }, error: authError } = await supabase.auth.getUser();
  if (authError || !user) {
    redirect('/login');
  }

  // 3. Obtener Perfil y ROL (Seguridad)
  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  // --- LÓGICA DE ROLES ---
  // Si es asistente, NO puede ver este dashboard, va directo a sus reportes
  if (profile?.role === 'asistente') {
    redirect('/reportes/semanal');
  }

  // 4. OBTENER MÉTRICAS REALES (Solo si es Admin/Manager)
  // Usamos Promise.all para que cargue todo junto rápido
  const [
    { count: totalAssistants },
    { count: activeSearches },
    { count: weeklyReports },
    { count: alertsCount } // Ejemplo: Alertas pendientes
  ] = await Promise.all([
    supabase.from('assistants').select('*', { count: 'exact', head: true }).eq('status', 'activo'),
    supabase.from('job_searches').select('*', { count: 'exact', head: true }).eq('status', 'abierta'),
    supabase.from('weekly_reports').select('*', { count: 'exact', head: true }), // Aquí podrías filtrar por fecha actual
    supabase.from('alerts').select('*', { count: 'exact', head: true }).eq('is_resolved', false),
  ]);

  // Datos procesados para la vista
  const metricsData = {
    totalAssistants: totalAssistants || 0,
    assistantsTrend: 'Ver lista', // Placeholder hasta tener histórica
    weeklyReports: weeklyReports || 0,
    reportsPending: 0, // Necesitaríamos filtrar reportes por status 'pendiente'
    activeSearches: activeSearches || 0,
    searchesCritical: 0, // Necesitaríamos filtrar por prioridad 'alta'
    hireRate: 85, // Dato calculado complejo, lo dejamos fijo por ahora
    hireRateTrend: '+5%',
  };

  const userName = profile?.full_name?.split(' ')[0] || user.email?.split('@')[0] || 'Usuario';
  const greeting = getGreeting();

  // Alertas de ejemplo (Para no romper el diseño mientras no haya alertas reales)
  // Mas adelante las cargaremos de supabase.from('alerts')
  const recentAlerts = [
    {
      id: '1',
      title: 'Sistema Funcionando',
      description: 'Conectado a Supabase correctamente',
      type: 'success',
      time: 'Ahora',
    },
  ];

  const recentActivity = [
    {
      id: '1',
      action: 'Sesión Iniciada',
      user: userName,
      time: 'Reciente',
    },
  ];

  return (
    <div className="page-container page-enter space-y-6 p-6">
      {/* Header */}
      <div className="page-header">
        <h1 className="text-3xl font-bold tracking-tight text-white">
          {greeting}, {userName} 👋
        </h1>
        <p className="text-slate-400 mt-2">
          Resumen de actividad en tiempo real (Modo Admin)
        </p>
      </div>

      {/* Métricas principales */}
      <Suspense
        fallback={
          <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
            {[...Array(4)].map((_, i) => (
              <MetricCardSkeleton key={i} />
            ))}
          </div>
        }
      >
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4 mb-8">
          {/* Asistentes */}
          <Card className="border-slate-800 bg-slate-900/50 hover:bg-slate-900/70 transition-colors">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium text-slate-400">
                Asistentes Activos
              </CardTitle>
              <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-blue-500/20">
                <Users className="h-4 w-4 text-blue-400" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-white">
                {metricsData.totalAssistants}
              </div>
              <p className="text-xs text-emerald-400">
                Datos reales de DB
              </p>
            </CardContent>
          </Card>

          {/* Reportes */}
          <Card className="border-slate-800 bg-slate-900/50 hover:bg-slate-900/70 transition-colors">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium text-slate-400">
                Reportes Totales
              </CardTitle>
              <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-500/20">
                <FileText className="h-4 w-4 text-emerald-400" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-white">
                {metricsData.weeklyReports}
              </div>
              <p className="text-xs text-slate-500">
                Histórico total
              </p>
            </CardContent>
          </Card>

          {/* Búsquedas */}
          <Card className="border-slate-800 bg-slate-900/50 hover:bg-slate-900/70 transition-colors">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium text-slate-400">
                Búsquedas Activas
              </CardTitle>
              <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-purple-500/20">
                <Briefcase className="h-4 w-4 text-purple-400" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-white">
                {metricsData.activeSearches}
              </div>
              <p className="text-xs text-red-400">
                En proceso
              </p>
            </CardContent>
          </Card>

          {/* Alertas / Hiring (Datos estáticos por ahora) */}
          <Card className="border-slate-800 bg-slate-900/50 hover:bg-slate-900/70 transition-colors">
            <CardHeader className="flex flex-row items-center justify-between pb-2">
              <CardTitle className="text-sm font-medium text-slate-400">
                Alertas Activas
              </CardTitle>
              <div className="flex h-8 w-8 items-center justify-center rounded-lg bg-amber-500/20">
                <AlertTriangle className="h-4 w-4 text-amber-400" />
              </div>
            </CardHeader>
            <CardContent>
              <div className="text-2xl font-bold text-white">
                {alertsCount || 0}
              </div>
              <p className="text-xs text-emerald-400">
                Sistema monitoreando
              </p>
            </CardContent>
          </Card>
        </div>
      </Suspense>

      {/* Sección inferior: Alertas + Actividad */}
      <div className="grid gap-6 lg:grid-cols-2">
        {/* Alertas recientes */}
        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-lg text-white">
              <AlertTriangle className="h-5 w-5 text-amber-400" />
              Estado del Sistema
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {recentAlerts.map((alert) => (
              <div
                key={alert.id}
                className="flex items-start gap-3 rounded-lg border border-slate-800 bg-slate-800/30 p-3"
              >
                <div
                  className={cn(
                    'mt-0.5 h-2 w-2 rounded-full shrink-0',
                    alert.type === 'warning' && 'bg-amber-400',
                    alert.type === 'error' && 'bg-red-400',
                    alert.type === 'success' && 'bg-emerald-400'
                  )}
                />
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-white">{alert.title}</p>
                  <p className="text-xs text-slate-400 truncate">
                    {alert.description}
                  </p>
                </div>
                <span className="text-xs text-slate-500 shrink-0">
                  {alert.time}
                </span>
              </div>
            ))}
          </CardContent>
        </Card>

        {/* Actividad reciente */}
        <Card className="border-slate-800 bg-slate-900/50">
          <CardHeader>
            <CardTitle className="flex items-center gap-2 text-lg text-white">
              <Clock className="h-5 w-5 text-blue-400" />
              Tu Actividad
            </CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            {recentActivity.map((activity) => (
              <div
                key={activity.id}
                className="flex items-center gap-3 rounded-lg border border-slate-800 bg-slate-800/30 p-3"
              >
                <div className="flex h-8 w-8 items-center justify-center rounded-full bg-emerald-500/20">
                  <CheckCircle2 className="h-4 w-4 text-emerald-400" />
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-white">
                    {activity.action}
                  </p>
                  <p className="text-xs text-slate-400">{activity.user}</p>
                </div>
                <span className="text-xs text-slate-500">{activity.time}</span>
              </div>
            ))}
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/reportes/page.tsx">
import Link from 'next/link';
import {
  Plus,
  FileText,
  Clock,
  CheckCircle2,
  MessageSquare,
  ChevronRight,
  AlertCircle,
  XCircle,
} from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { cn, formatDate } from '@/lib/utils';

// Datos de ejemplo
const myReports = [
  {
    id: 'current',
    weekStart: '2026-02-02',
    weekEnd: '2026-02-08',
    status: 'pendiente',
    score: null,
    feedback: null,
    submittedAt: null,
  },
  {
    id: '1',
    weekStart: '2026-01-26',
    weekEnd: '2026-02-01',
    status: 'aprobado', // Green
    score: 9.8,
    feedback: 'Excelente desempeño, cumpliste con todos los objetivos y superaste las expectativas.',
    submittedAt: '2026-02-01T18:30:00',
  },
  {
    id: '2',
    weekStart: '2026-01-19',
    weekStart: '2026-01-19T12:00:00',
    weekEnd: '2026-01-25T12:00:00',
    status: 'regular',
    score: 7.5,
    feedback: 'Buen trabajo, pero faltó detalle en la sección de métricas.',
    submittedAt: '2026-01-25T17:00:00',
  },
  {
    id: '3',
    weekStart: '2026-01-12T12:00:00',
    weekEnd: '2026-01-18T12:00:00',
    status: 'insuficiente', // Red
    score: 5.0,
    feedback: 'Reporte incompleto. Faltan las evidencias de las reuniones y los métricas no cuadran.',
    submittedAt: '2026-01-18T19:15:00',
  },
];

const statusConfig = {
  pendiente: {
    label: 'Pendiente',
    variant: 'warning' as const,
    icon: Clock,
    color: 'text-amber-400',
  },
  entregado: {
    label: 'Entregado',
    variant: 'info' as const,
    icon: FileText,
    color: 'text-blue-400',
  },
  revisado: {
    label: 'Revisado',
    variant: 'default' as const,
    icon: MessageSquare,
    color: 'text-slate-400',
  },
  aprobado: {
    label: 'Aprobado',
    variant: 'success' as const,
    icon: CheckCircle2,
    color: 'text-emerald-400',
  },
  regular: {
    label: 'Regular',
    variant: 'warning' as const, // Yellow
    icon: AlertCircle,
    color: 'text-yellow-400',
  },
  insuficiente: {
    label: 'Insuficiente',
    variant: 'error' as const, // Red
    icon: XCircle,
    color: 'text-red-400',
  },
};

export default function ReportesPage() {
  // Reporte actual (pendiente de esta semana)
  const currentReport = myReports.find((r) => r.status === 'pendiente');
  const pastReports = myReports.filter((r) => r.status !== 'pendiente');

  return (
    <div className="page-container page-enter">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="page-title">Mis Reportes</h1>
          <p className="page-description">
            Gestiona tus reportes semanales
          </p>
        </div>
        <Button asChild>
          <Link href="/reportes/nuevo">
            <Plus className="h-4 w-4 mr-2" />
            Nuevo Reporte
          </Link>
        </Button>
      </div>

      {/* Reporte actual */}
      {currentReport && (
        <Card className="mb-8 border-amber-500/30 bg-amber-500/5">
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle className="flex items-center gap-2 text-lg">
                <Clock className="h-5 w-5 text-amber-400" />
                Reporte de esta semana
              </CardTitle>
              <Badge variant="warning">Pendiente de envío</Badge>
            </div>
          </CardHeader>
          <CardContent>
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-slate-400">
                  Semana del{' '}
                  <span className="text-white">
                    {formatDate(currentReport.weekStart)}
                  </span>{' '}
                  al{' '}
                  <span className="text-white">
                    {formatDate(currentReport.weekEnd)}
                  </span>
                </p>
                <p className="text-xs text-amber-400 mt-1">
                  Fecha límite: {formatDate(currentReport.weekEnd)} a las 23:59
                </p>
              </div>
              <Button asChild>
                <Link href={`/reportes/nuevo?week=${currentReport.weekStart}`}>
                  Completar Reporte
                  <ChevronRight className="h-4 w-4 ml-1" />
                </Link>
              </Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Historial de reportes */}
      <Card className="border-slate-800 bg-slate-900/50">
        <CardHeader>
          <CardTitle className="text-lg">Historial de Reportes</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {pastReports.map((report) => {
              const config = statusConfig[report.status as keyof typeof statusConfig];
              const Icon = config.icon;

              return (
                <Link
                  key={report.id}
                  href={`/reportes/${report.id}`}
                  className="flex items-start gap-4 rounded-lg border border-slate-800 bg-slate-800/30 p-4 hover:bg-slate-800/50 transition-colors"
                >
                  {/* Icono de estado */}
                  <div
                    className={cn(
                      'flex h-10 w-10 items-center justify-center rounded-lg shrink-0',
                      report.status === 'aprobado' && 'bg-emerald-500/20',
                      report.status === 'revisado' && 'bg-slate-500/20',
                      report.status === 'entregado' && 'bg-blue-500/20'
                    )}
                  >
                    <Icon className={cn('h-5 w-5', config.color)} />
                  </div>

                  {/* Info del reporte */}
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                      <p className="text-sm font-medium text-white">
                        Semana {formatDate(report.weekStart, { day: 'numeric', month: 'short' })} -{' '}
                        {formatDate(report.weekEnd, { day: 'numeric', month: 'short' })}
                      </p>
                      <Badge variant={config.variant}>{config.label}</Badge>
                    </div>

                    {report.submittedAt && (
                      <p className="text-xs text-slate-400">
                        Enviado el {formatDate(report.submittedAt)}
                      </p>
                    )}

                    {report.feedback && (
                      <div className="mt-2 rounded bg-slate-800/50 p-2">
                        <p className="text-xs text-slate-400">
                          <span className="text-emerald-400">Feedback:</span>{' '}
                          {report.feedback}
                        </p>
                      </div>
                    )}
                  </div>

                  {/* Score */}
                  <div className="text-right shrink-0">
                    {report.score ? (
                      <div>
                        <p className="text-lg font-semibold text-white">
                          {report.score}
                        </p>
                        <p className="text-xs text-slate-500">/10</p>
                      </div>
                    ) : (
                      <p className="text-xs text-slate-500">Sin calificar</p>
                    )}
                  </div>

                  <ChevronRight className="h-5 w-5 text-slate-500 shrink-0 self-center" />
                </Link>
              );
            })}
          </div>

          {pastReports.length === 0 && (
            <div className="text-center py-8">
              <FileText className="h-12 w-12 text-slate-600 mx-auto mb-3" />
              <p className="text-slate-400">No tienes reportes anteriores</p>
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/reportes/semanal/page.tsx">
// =====================================================
// /reportes/semanal - Página del reporte semanal
// =====================================================

import { redirect } from 'next/navigation';
import { Suspense } from 'react';
import { getOrCreateCurrentWeekSubmission, getCatalogs } from '@/lib/actions/reports';
import { WeeklyReportForm } from '@/components/reportes/WeeklyReportForm';
import { Loader2 } from 'lucide-react';

export const dynamic = 'force-dynamic';
export const metadata = {
  title: 'Reporte Semanal | Global Talent Platform',
  description: 'Carga tu reporte semanal con Plan GTC y Rupturas de Valor',
};

function LoadingState() {
  return (
    <div className="flex items-center justify-center min-h-[400px]">
      <div className="text-center">
        <Loader2 className="h-8 w-8 animate-spin text-emerald-500 mx-auto mb-4" />
        <p className="text-slate-400">Cargando reporte...</p>
      </div>
    </div>
  );
}

async function WeeklyReportContent() {
  const [submissionResult, catalogsResult] = await Promise.all([
    getOrCreateCurrentWeekSubmission(),
    getCatalogs(),
  ]);

  if (!submissionResult.success || !submissionResult.data) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center max-w-md">
          <div className="flex h-16 w-16 items-center justify-center rounded-full bg-red-500/20 mx-auto mb-4">
            <span className="text-2xl">⚠️</span>
          </div>
          <h2 className="text-xl font-semibold text-slate-100 mb-2">
            Error al cargar el reporte
          </h2>
          <p className="text-slate-400 mb-4">
            {submissionResult.error ?? 'No se pudo cargar el reporte semanal.'}
          </p>
          <p className="text-sm text-slate-500">
            Si el problema persiste, contacta al equipo de soporte.
          </p>
        </div>
      </div>
    );
  }

  const catalogs = catalogsResult.success ? catalogsResult.data : { departments: [], companyValues: [] };

  return (
    <WeeklyReportForm
      submission={submissionResult.data}
      departments={catalogs?.departments ?? []}
      companyValues={catalogs?.companyValues ?? []}
    />
  );
}

export default function WeeklyReportPage() {
  return (
    <div className="container max-w-4xl py-6">
      <Suspense fallback={<LoadingState />}>
        <WeeklyReportContent />
      </Suspense>
    </div>
  );
}
</file>

<file path="src/app/api/ai/improve/route.ts">
import { NextResponse } from 'next/server';
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';
import { improveTextWithGemini } from '@/lib/ai/gemini';
import type { Database } from '@/types/database.types';

export async function POST(request: Request) {
    try {
        const cookieStore = cookies();

        // 1. Crear cliente Supabase (SSR)
        const supabase = createServerClient<Database>(
            process.env.NEXT_PUBLIC_SUPABASE_URL!,
            process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
            {
                cookies: {
                    getAll() {
                        return cookieStore.getAll();
                    },
                    setAll(cookiesToSet) {
                        try {
                            cookiesToSet.forEach(({ name, value, options }) =>
                                cookieStore.set(name, value, options)
                            );
                        } catch {
                            // The `setAll` method was called from a Server Component.
                            // This can be ignored if you have middleware refreshing
                            // user sessions.
                        }
                    },
                },
            }
        );

        // 2. Verificar sesión
        const { data: { user }, error } = await supabase.auth.getUser();

        if (error || !user) {
            console.error('AI Route Auth Error:', error);
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // 3. Obtener datos del body
        const body = await request.json();
        const { text, context } = body;

        if (!text || typeof text !== 'string') {
            return NextResponse.json({ error: 'Text validation failed' }, { status: 400 });
        }

        // 4. Llamar a Gemini IA
        const improvedText = await improveTextWithGemini(text, context);

        // 5. Devolver resultado
        return NextResponse.json({ improvedText });

    } catch (error) {
        console.error('Error in AI route:', error);
        return NextResponse.json(
            { error: 'Internal Server Error' },
            { status: 500 }
        );
    }
}
</file>

<file path="src/app/api/interviews/complete/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';

// --- FUNCIÓN DE NOTIFICACIÓN (Copiada del webhook) ---
async function notificarAlClasificador(datos: any) {
  // Apunta a tu Index 1 local
  const URL_DESTINO = process.env.INDEX1_WEBHOOK_URL || 'http://localhost:3001/webhooks/resultado-entrevista';

  console.log('🚨 [INDEX 2] Enviando datos manuales al Clasificador...');
  console.log(`📍 Destino: ${URL_DESTINO}`);

  try {
    const response = await fetch(URL_DESTINO, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(datos),
    });

    if (!response.ok) {
      console.error(`❌ Error respuesta Index 1: ${response.status}`);
      return false;
    }

    const resultado = await response.json();
    console.log('✅ Index 1 respondió:', resultado);
    return true;
  } catch (error) {
    console.error('❌ Error conectando con Index 1:', error);
    return false;
  }
}

// =====================================================
// POST /api/interviews/complete
// =====================================================
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { token, conversation_id, transcript } = body;

    if (!token) {
      return NextResponse.json({ success: false, error: 'Token requerido' }, { status: 400 });
    }

    const supabase = createAdminClient();

    // 1. Obtener entrevista
    const { data: interview, error: fetchError } = await supabase
      .from('interviews')
      .select('id, status, application_id')
      .eq('token', token)
      .single();

    if (fetchError || !interview) {
      return NextResponse.json({ success: false, error: 'Entrevista no encontrada' }, { status: 404 });
    }

    // 2. Completar en Supabase
    const { error } = await supabase
      .rpc('complete_interview', {
        p_interview_id: interview.id,
        p_conversation_id: conversation_id || null,
        p_transcript: transcript || null,
      });

    if (error) {
      console.error('Error completing interview:', error);
      return NextResponse.json({ success: false, error: 'Error DB' }, { status: 500 });
    }

    // 3. 🔥 NOTIFICAR AL INDEX 1 (LA PIEZA FALTANTE) 🔥
    // Nota: Como estamos en local, es posible que el 'transcript' venga vacío si ElevenLabs no lo mandó todavía.
    // Enviamos lo que tenemos para cerrar el ciclo.
    await notificarAlClasificador({
      interview_id: interview.id,
      transcript: transcript || 'Transcripción pendiente (Modo Local: ElevenLabs webhook no accesible)',
      audio_url: '',
      summary: 'Entrevista finalizada manualmente por el usuario',
    });

    return NextResponse.json({
      success: true,
      data: { interview_id: interview.id, status: 'completed' },
    });
  } catch (error) {
    console.error('Unexpected error:', error);
    return NextResponse.json({ success: false, error: 'Error interno' }, { status: 500 });
  }
}
</file>

<file path="src/app/entrevista/[token]/page.tsx">
// =====================================================
// /entrevista/[token]/page.tsx
// Sala de entrevista pública para candidatos
// =====================================================

import { Metadata } from 'next';
import { createAdminClient } from '@/lib/supabase/server';
import { InterviewRoom } from '@/components/interview/InterviewRoom';
import { TokenInvalido } from './TokenInvalido';
import type { InterviewValidationResult, InterviewRoomData } from '@/types/interviews.types';

// =====================================================
// METADATA DINÁMICA
// =====================================================

export async function generateMetadata({
  params,
}: {
  params: { token: string };
}): Promise<Metadata> {
  return {
    title: 'Entrevista | Global Talent',
    description: 'Sala de entrevista técnica automatizada',
    robots: 'noindex, nofollow', // No indexar páginas de entrevista
  };
}

// =====================================================
// VALIDAR TOKEN
// =====================================================

async function validateToken(token: string): Promise<InterviewValidationResult | null> {
  try {
    const supabase = createAdminClient();

    // Llamar a la función de validación de PostgreSQL
    const { data, error } = await supabase
      .rpc('validate_interview_token', { p_token: token } as any);

    if (error) {
      console.error('Error validating token:', error);
      return null;
    }

    // La función retorna un array con un solo elemento
    return data?.[0] as InterviewValidationResult || null;
  } catch (error) {
    console.error('Unexpected error validating token:', error);
    return null;
  }
}

// =====================================================
// PAGE COMPONENT (Server)
// =====================================================

export default async function InterviewPage({
  params,
}: {
  params: { token: string };
}) {
  const { token } = params;

  // Validar formato del token (UUID)
  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (!uuidRegex.test(token)) {
    return (
      <TokenInvalido
        reason="invalid"
        message="El enlace no es válido"
      />
    );
  }

  // Validar token contra la base de datos
  const validation = await validateToken(token);

  if (!validation) {
    return (
      <TokenInvalido
        reason="error"
        message="Error al verificar el enlace. Por favor, intenta nuevamente."
      />
    );
  }

  // Token no válido
  if (!validation.is_valid) {
    let reason: 'expired' | 'used' | 'invalid' = 'invalid';

    if (validation.status === 'expired') {
      reason = 'expired';
    } else if (['completed', 'abandoned'].includes(validation.status)) {
      reason = 'used';
    }

    return (
      <TokenInvalido
        reason={reason}
        message={validation.error_message || 'El enlace no es válido'}
      />
    );
  }

  // Token válido - preparar datos para la sala
  const interviewData: InterviewRoomData = {
    interviewId: validation.interview_id!,
    candidateName: validation.candidate_name || 'Candidato',
    jobTitle: validation.job_title || 'Puesto',
    clientName: validation.client_name || '',
    agentId: validation.elevenlabs_agent_id || process.env.ELEVENLABS_DEFAULT_AGENT_ID || '',
    status: validation.status as InterviewRoomData['status'],
  };

  // Renderizar la sala de entrevista
  return (
    <main className="min-h-screen bg-slate-950">
      <InterviewRoom
        data={interviewData}
        token={token}
      />
    </main>
  );
}
</file>

<file path="src/app/globals.css">
/* =====================================================
   src/app/globals.css
   COLORES CORPORATIVOS AZUL TECNOLÓGICO
   ===================================================== */

@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  /* ===== COLORES PRINCIPALES (AZUL TECNOLÓGICO) ===== */
  --color-primary: 59 130 246;
  /* blue-500 */
  --color-primary-dark: 37 99 235;
  /* blue-600 */
  --color-primary-light: 96 165 250;
  /* blue-400 */
  --color-primary-50: 239 246 255;
  /* blue-50 */
  --color-primary-100: 219 234 254;
  /* blue-100 */
  --color-primary-900: 30 58 138;
  /* blue-900 */

  /* ===== COLORES DE ESTADO ===== */
  --color-success: 34 197 94;
  /* green-500 */
  --color-warning: 245 158 11;
  /* amber-500 */
  --color-error: 239 68 68;
  /* red-500 */
  --color-info: 59 130 246;
  /* blue-500 */

  /* ===== FONDO OSCURO (PREMIUM BLACK) ===== */
  --background: 0 0 0;
  /* pure black */
  --foreground: 248 250 252;
  /* slate-50 */

  /* ===== BORDES Y SEPARADORES ===== */
  --border: 30 41 59;
  /* slate-800 */
  --border-light: 51 65 85;
  /* slate-700 */
}

/* ===== ESTILOS BASE ===== */
body {
  background-color: rgb(var(--background));
  background-image: radial-gradient(circle at 50% 0%, rgb(18, 26, 43) 0%, rgb(0, 0, 0) 60%);
  background-attachment: fixed;
  color: rgb(var(--foreground));
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* ===== SCROLLBAR PERSONALIZADO ===== */
.custom-scrollbar::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: rgb(15 23 42);
  /* slate-900 */
  border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: rgb(51 65 85);
  /* slate-700 */
  border-radius: 3px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: rgb(71 85 105);
  /* slate-600 */
}

/* ===== COMPONENTES REUTILIZABLES ===== */
@layer components {

  /* Botón primario (azul) */
  .btn-primary {
    @apply bg-blue-500 hover:bg-blue-600 text-white font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }

  .btn-primary:disabled {
    @apply bg-blue-500/50 cursor-not-allowed;
  }

  /* Botón secundario */
  .btn-secondary {
    @apply bg-slate-700 hover:bg-slate-600 text-white font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }

  /* Botón outline */
  .btn-outline {
    @apply border border-blue-500 text-blue-500 hover:bg-blue-500/10 font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }

  /* Botón ghost */
  .btn-ghost {
    @apply text-slate-400 hover:text-white hover:bg-slate-800 font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }

  /* Botón danger */
  .btn-danger {
    @apply bg-red-500 hover:bg-red-600 text-white font-medium px-4 py-2 rounded-lg transition-colors duration-200;
  }

  /* Card base */
  .card {
    @apply bg-slate-900 border border-slate-800 rounded-xl p-6;
  }

  .card-hover {
    @apply card hover:border-blue-500/50 transition-colors duration-200 cursor-pointer;
  }

  /* Input base */
  .input {
    @apply w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white placeholder:text-slate-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors;
  }

  /* Select base */
  .select {
    @apply w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors appearance-none cursor-pointer;
  }

  /* Label base */
  .label {
    @apply block text-sm font-medium text-slate-300 mb-1.5;
  }

  /* Badge base */
  .badge {
    @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium;
  }

  .badge-primary {
    @apply badge bg-blue-500/20 text-blue-400;
  }

  .badge-success {
    @apply badge bg-green-500/20 text-green-400;
  }

  .badge-warning {
    @apply badge bg-amber-500/20 text-amber-400;
  }

  .badge-error {
    @apply badge bg-red-500/20 text-red-400;
  }

  .badge-gray {
    @apply badge bg-slate-500/20 text-slate-400;
  }

  /* Sidebar link */
  .sidebar-link {
    @apply flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800/50 transition-all duration-200;
  }

  .sidebar-link--active {
    @apply bg-blue-500/10 text-blue-400 border-l-2 border-blue-500;
  }

  /* Table */
  .table-container {
    @apply overflow-x-auto rounded-lg border border-slate-800;
  }

  .table {
    @apply w-full text-sm;
  }

  .table th {
    @apply px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider bg-slate-900/50;
  }

  .table td {
    @apply px-4 py-3 border-t border-slate-800;
  }

  .table tr:hover td {
    @apply bg-slate-800/30;
  }

  /* Progress bar */
  .progress-bar {
    @apply h-2 bg-slate-700 rounded-full overflow-hidden;
  }

  .progress-bar-fill {
    @apply h-full bg-blue-500 transition-all duration-300;
  }

  /* Quality score bar (rojo → amarillo → verde) */
  .quality-bar {
    @apply h-3 rounded-full overflow-hidden;
    background: linear-gradient(to right,
        rgb(239 68 68) 0%,
        rgb(245 158 11) 50%,
        rgb(34 197 94) 100%);
  }

  .quality-bar-indicator {
    @apply absolute top-0 w-1 h-full bg-white rounded shadow-lg transition-all duration-300;
  }
}

/* ===== GLASSMORPHISM ===== */
.glass-panel {
  @apply backdrop-blur-xl bg-slate-900/60 border border-white/10 shadow-xl;
}

.glass-card {
  @apply backdrop-blur-md bg-slate-800/40 border border-white/5 hover:bg-slate-800/60 transition-all duration-200;
}

.glass-input {
  @apply bg-slate-900/50 border-b border-slate-700 focus:border-blue-500/50 focus:bg-slate-900/80 transition-all duration-200 placeholder:text-slate-600;
}

/* ===== GLOW EFFECTS (Tech Look) ===== */
.glow-blue {
  box-shadow: 0 0 25px -5px rgba(59, 130, 246, 0.4);
}

.glow-green {
  box-shadow: 0 0 25px -5px rgba(34, 197, 94, 0.4);
}

.glow-text {
  text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
}

/* ===== ANIMACIONES (Faster & Snappier) ===== */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(5px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateX(-10px);
  }

  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.animate-fast {
  animation-duration: 0.2s;
}

.animate-fade-in {
  animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

.animate-slide-in {
  animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
}

/* ===== VOICE ORB (para entrevistas) ===== */
.voice-orb {
  @apply relative w-32 h-32 rounded-full bg-gradient-to-br from-blue-400 to-blue-600;
  box-shadow:
    0 0 60px rgba(59, 130, 246, 0.4),
    0 0 100px rgba(59, 130, 246, 0.2);
}

.voice-orb.speaking {
  animation: voice-pulse 0.5s ease-in-out infinite;
}

@keyframes voice-pulse {

  0%,
  100% {
    transform: scale(1);
    box-shadow:
      0 0 60px rgba(59, 130, 246, 0.4),
      0 0 100px rgba(59, 130, 246, 0.2);
  }

  50% {
    transform: scale(1.05);
    box-shadow:
      0 0 80px rgba(59, 130, 246, 0.5),
      0 0 120px rgba(59, 130, 246, 0.3);
  }
}

/* ===== TOOLTIP ===== */
.tooltip {
  @apply absolute z-50 px-2 py-1 text-xs font-medium text-white bg-slate-800 rounded shadow-lg;
  @apply invisible opacity-0 transition-all duration-200;
}

.tooltip-trigger:hover .tooltip {
  @apply visible opacity-100;
}

/* ===== FOCUS VISIBLE ===== */
.focus-visible:focus-visible {
  @apply outline-none ring-2 ring-blue-500 ring-offset-2 ring-offset-slate-900;
}

/* ===== DARK MODE FORM ELEMENTS ===== */
input[type="date"],
input[type="time"],
input[type="datetime-local"] {
  color-scheme: dark;
}

select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 2.5rem;
}

/* ===== STATUS INDICATORS ===== */
.status-dot {
  @apply w-2 h-2 rounded-full;
}

.status-dot--active {
  @apply bg-green-500 animate-pulse;
}

.status-dot--inactive {
  @apply bg-slate-500;
}

.status-dot--warning {
  @apply bg-amber-500;
}

.status-dot--error {
  @apply bg-red-500;
}
</file>

<file path="src/components/reportes/RuptureEntryCard.tsx">
'use client';

// =====================================================
// RUPTURE ENTRY - Componente de entrada individual
// =====================================================

import { memo, useCallback, useState } from 'react';
import { Trash2, GripVertical, ChevronDown, ChevronUp, AlertTriangle } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { MagicWandButton } from '@/components/ui/MagicWandButton';
import type { RuptureEntryFormData, Department, CompanyValue } from '@/types/reports.types';

interface RuptureEntryCardProps {
  entry: RuptureEntryFormData;
  index: number;
  isExpanded: boolean;
  isLocked: boolean;
  departments: Department[];
  companyValues: CompanyValue[];
  errors?: Record<string, string[]>;
  onUpdate: (index: number, field: keyof RuptureEntryFormData, value: string) => void;
  onRemove: (index: number) => void;
  onToggleExpand: (index: number) => void;
}

function RuptureEntryCardComponent({
  entry,
  index,
  isExpanded,
  isLocked,
  departments,
  companyValues,
  errors = {},
  onUpdate,
  onRemove,
  onToggleExpand,
}: RuptureEntryCardProps) {
  const [improvingField, setImprovingField] = useState<keyof RuptureEntryFormData | null>(null);

  const handleImprove = async (field: keyof RuptureEntryFormData) => {
    const text = entry[field];
    if (typeof text !== 'string' || text.length < 3) return;

    setImprovingField(field);
    try {
      const response = await fetch('/api/ai/improve', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text,
          context: `Ruptura de Valor - Campo: ${field} - Dept: ${entry.department}`
        }),
      });

      if (!response.ok) throw new Error('Error improving text');

      const data = await response.json();
      if (data.improvedText) {
        onUpdate(index, field, data.improvedText);
      }
    } catch (error) {
      console.error('Failed to improve text:', error);
    } finally {
      setImprovingField(null);
    }
  };

  const handleChange = useCallback(
    (field: keyof RuptureEntryFormData) =>
      (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        onUpdate(index, field, e.target.value);
      },
    [index, onUpdate]
  );

  const getFieldError = (field: string): string | undefined => {
    const key = `rupture_entries.${index}.${field}`;
    return errors[key]?.[0];
  };

  const hasAnyError = Object.keys(errors).some((key) =>
    key.startsWith(`rupture_entries.${index}.`)
  );

  // Formatear fecha para preview
  const formatDate = (dateStr: string): string => {
    if (!dateStr) return '';
    try {
      const date = new Date(dateStr);
      return date.toLocaleDateString('es-ES', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
      });
    } catch {
      return dateStr;
    }
  };

  return (
    <div
      className={cn(
        'group relative rounded-lg border transition-all duration-200',
        hasAnyError
          ? 'border-red-500/50 bg-red-500/5'
          : 'border-slate-700 bg-slate-800/50',
        isExpanded && 'ring-1 ring-amber-500/30'
      )}
    >
      {/* Header */}
      <div
        className={cn(
          'flex items-center gap-3 p-4',
          !isLocked && 'cursor-pointer'
        )}
        onClick={() => !isLocked && onToggleExpand(index)}
      >
        {/* Drag handle */}
        {!isLocked && (
          <div className="cursor-grab opacity-0 group-hover:opacity-50 transition-opacity">
            <GripVertical className="h-5 w-5 text-slate-500" />
          </div>
        )}

        {/* Icono */}
        <div className="flex h-8 w-8 items-center justify-center rounded-full bg-amber-500/20">
          <AlertTriangle className="h-4 w-4 text-amber-400" />
        </div>

        {/* Preview */}
        <div className="flex-1 min-w-0">
          {entry.rupture_description ? (
            <p className="text-sm font-medium text-slate-200 truncate">
              {entry.rupture_description.substring(0, 80)}
              {entry.rupture_description.length > 80 && '...'}
            </p>
          ) : (
            <p className="text-sm text-slate-500 italic">
              Sin descripción de ruptura
            </p>
          )}
          <div className="flex items-center gap-2 mt-1">
            {entry.department && (
              <span className="text-xs text-slate-400">{entry.department}</span>
            )}
            {entry.department && entry.rupture_date && (
              <span className="text-xs text-slate-600">•</span>
            )}
            {entry.rupture_date && (
              <span className="text-xs text-slate-500">
                {formatDate(entry.rupture_date)}
              </span>
            )}
          </div>
        </div>

        {/* Value badge */}
        {entry.company_value && (
          <span className="hidden sm:inline-flex items-center px-2 py-1 rounded-full text-xs bg-slate-700 text-slate-300 truncate max-w-[150px]">
            {entry.company_value}
          </span>
        )}

        {/* Expand/Collapse */}
        {!isLocked && (
          <Button
            type="button"
            variant="ghost"
            size="sm"
            className="h-8 w-8 p-0 text-slate-400 hover:text-slate-200"
            onClick={(e) => {
              e.stopPropagation();
              onToggleExpand(index);
            }}
          >
            {isExpanded ? (
              <ChevronUp className="h-4 w-4" />
            ) : (
              <ChevronDown className="h-4 w-4" />
            )}
          </Button>
        )}

        {/* Delete */}
        {!isLocked && (
          <Button
            type="button"
            variant="ghost"
            size="sm"
            className="h-8 w-8 p-0 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
            onClick={(e) => {
              e.stopPropagation();
              onRemove(index);
            }}
          >
            <Trash2 className="h-4 w-4" />
          </Button>
        )}
      </div>

      {/* Contenido expandido */}
      {isExpanded && (
        <div className="border-t border-slate-700 p-4 space-y-4">
          {/* Row: Departamento + Valor + Fecha */}
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            {/* Departamento */}
            <div className="space-y-2">
              <Label htmlFor={`rupture-${index}-department`} className="text-slate-300">
                Departamento <span className="text-red-400">*</span>
              </Label>
              <select
                id={`rupture-${index}-department`}
                value={entry.department}
                onChange={handleChange('department')}
                disabled={isLocked}
                className={cn(
                  'w-full h-10 rounded-md bg-slate-900/50 border border-slate-700 px-3 text-sm text-slate-100',
                  'focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                  'disabled:cursor-not-allowed disabled:opacity-50',
                  getFieldError('department') && 'border-red-500'
                )}
              >
                <option value="">Seleccionar...</option>
                {departments.map((dept) => (
                  <option key={dept.id} value={dept.name}>
                    {dept.name}
                  </option>
                ))}
              </select>
              {getFieldError('department') && (
                <p className="text-xs text-red-400">{getFieldError('department')}</p>
              )}
            </div>

            {/* Valor de la empresa */}
            <div className="space-y-2">
              <Label htmlFor={`rupture-${index}-company_value`} className="text-slate-300">
                Valor afectado <span className="text-red-400">*</span>
              </Label>
              <select
                id={`rupture-${index}-company_value`}
                value={entry.company_value}
                onChange={handleChange('company_value')}
                disabled={isLocked}
                className={cn(
                  'w-full h-10 rounded-md bg-slate-900/50 border border-slate-700 px-3 text-sm text-slate-100',
                  'focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                  'disabled:cursor-not-allowed disabled:opacity-50',
                  getFieldError('company_value') && 'border-red-500'
                )}
              >
                <option value="">Seleccionar...</option>
                {companyValues.map((val) => (
                  <option key={val.id} value={val.name}>
                    {val.name}
                  </option>
                ))}
              </select>
              {getFieldError('company_value') && (
                <p className="text-xs text-red-400">{getFieldError('company_value')}</p>
              )}
            </div>

            {/* Fecha */}
            <div className="space-y-2">
              <Label htmlFor={`rupture-${index}-rupture_date`} className="text-slate-300">
                Fecha <span className="text-red-400">*</span>
              </Label>
              <Input
                id={`rupture-${index}-rupture_date`}
                type="date"
                value={entry.rupture_date}
                onChange={handleChange('rupture_date')}
                disabled={isLocked}
                className={cn(
                  'bg-slate-900/50 border-slate-700',
                  getFieldError('rupture_date') && 'border-red-500'
                )}
              />
              {getFieldError('rupture_date') && (
                <p className="text-xs text-red-400">{getFieldError('rupture_date')}</p>
              )}
            </div>
          </div>

          {/* Ruptura de valor (descripción) */}
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <Label htmlFor={`rupture-${index}-rupture_description`} className="text-slate-300">
                Ruptura de valor <span className="text-red-400">*</span>
              </Label>
              {!isLocked && (
                <MagicWandButton
                  onClick={() => handleImprove('rupture_description')}
                  isLoading={improvingField === 'rupture_description'}
                />
              )}
            </div>
            <textarea
              id={`rupture-${index}-rupture_description`}
              value={entry.rupture_description}
              onChange={handleChange('rupture_description')}
              disabled={isLocked}
              rows={3}
              placeholder="Describe qué pasó, qué salió mal o qué valor se vio afectado..."
              className={cn(
                'w-full rounded-md bg-slate-900/50 border border-slate-700 px-3 py-2 text-sm text-slate-100',
                'placeholder:text-slate-500 focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                'disabled:cursor-not-allowed disabled:opacity-50',
                getFieldError('rupture_description') && 'border-red-500'
              )}
            />
            {getFieldError('rupture_description') && (
              <p className="text-xs text-red-400">{getFieldError('rupture_description')}</p>
            )}
          </div>

          {/* Motivo de la ruptura */}
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <Label htmlFor={`rupture-${index}-rupture_cause`} className="text-slate-300">
                Motivo de la ruptura <span className="text-red-400">*</span>
              </Label>
              {!isLocked && (
                <MagicWandButton
                  onClick={() => handleImprove('rupture_cause')}
                  isLoading={improvingField === 'rupture_cause'}
                />
              )}
            </div>
            <textarea
              id={`rupture-${index}-rupture_cause`}
              value={entry.rupture_cause}
              onChange={handleChange('rupture_cause')}
              disabled={isLocked}
              rows={3}
              placeholder="¿Por qué pasó? ¿Cuál fue la causa raíz?"
              className={cn(
                'w-full rounded-md bg-slate-900/50 border border-slate-700 px-3 py-2 text-sm text-slate-100',
                'placeholder:text-slate-500 focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                'disabled:cursor-not-allowed disabled:opacity-50',
                getFieldError('rupture_cause') && 'border-red-500'
              )}
            />
            {getFieldError('rupture_cause') && (
              <p className="text-xs text-red-400">{getFieldError('rupture_cause')}</p>
            )}
          </div>

          {/* Plan de mejora */}
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <Label htmlFor={`rupture-${index}-improvement_plan`} className="text-slate-300">
                Plan de mejora <span className="text-red-400">*</span>
              </Label>
              {!isLocked && (
                <MagicWandButton
                  onClick={() => handleImprove('improvement_plan')}
                  isLoading={improvingField === 'improvement_plan'}
                />
              )}
            </div>
            <textarea
              id={`rupture-${index}-improvement_plan`}
              value={entry.improvement_plan}
              onChange={handleChange('improvement_plan')}
              disabled={isLocked}
              rows={3}
              placeholder="¿Qué se va a hacer para evitar que vuelva a pasar?"
              className={cn(
                'w-full rounded-md bg-slate-900/50 border border-slate-700 px-3 py-2 text-sm text-slate-100',
                'placeholder:text-slate-500 focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                'disabled:cursor-not-allowed disabled:opacity-50',
                getFieldError('improvement_plan') && 'border-red-500'
              )}
            />
            {getFieldError('improvement_plan') && (
              <p className="text-xs text-red-400">{getFieldError('improvement_plan')}</p>
            )}
          </div>

          {/* Gasto generado */}
          <div className="space-y-2">
            <Label htmlFor={`rupture-${index}-generated_cost`} className="text-slate-300">
              Gasto generado <span className="text-red-400">*</span>
            </Label>
            <textarea
              id={`rupture-${index}-generated_cost`}
              value={entry.generated_cost}
              onChange={handleChange('generated_cost')}
              disabled={isLocked}
              rows={2}
              placeholder="Impacto en tiempo, recursos, dinero..."
              className={cn(
                'w-full rounded-md bg-slate-900/50 border border-slate-700 px-3 py-2 text-sm text-slate-100',
                'placeholder:text-slate-500 focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                'disabled:cursor-not-allowed disabled:opacity-50',
                getFieldError('generated_cost') && 'border-red-500'
              )}
            />
            {getFieldError('generated_cost') && (
              <p className="text-xs text-red-400">{getFieldError('generated_cost')}</p>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

export const RuptureEntryCard = memo(RuptureEntryCardComponent);
</file>

<file path="src/components/reportes/WeeklyReportForm.tsx">
'use client';

// =====================================================
// WEEKLY REPORT FORM - Formulario principal completo
// =====================================================

import { useState, useCallback, useEffect, useTransition, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import {
  Plus,
  Save,
  Send,
  Loader2,
  CheckCircle2,
  AlertCircle,
  Clock,
  FileText,
  AlertTriangle,
  Lock,
} from 'lucide-react';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { PlanEntryCard } from './PlanEntryCard';
import { RuptureEntryCard } from './RuptureEntryCard';
import { SubmitConfirmDialog } from './SubmitConfirmDialog';
import { saveDraft, submitReport } from '@/lib/actions/reports';
import {
  weeklyReportFormSchema,
  DEFAULT_PLAN_ENTRY,
  DEFAULT_RUPTURE_ENTRY,
  getFormErrors,
} from '@/lib/validations/reports';
import type {
  WeeklySubmissionWithEntries,
  PlanEntryFormData,
  RuptureEntryFormData,
  Department,
  CompanyValue,
  SubmissionStatus,
} from '@/types/reports.types';
import { formatWeekRange, getDeadlineStatus, STATUS_COLORS, SUBMISSION_STATUS_LABELS } from '@/types/reports.types';

interface WeeklyReportFormProps {
  submission: WeeklySubmissionWithEntries;
  departments: Department[];
  companyValues: CompanyValue[];
}

export function WeeklyReportForm({
  submission,
  departments,
  companyValues,
}: WeeklyReportFormProps) {
  const router = useRouter();
  const [isPending, startTransition] = useTransition();

  // Estado del formulario
  const [planEntries, setPlanEntries] = useState<PlanEntryFormData[]>(() =>
    submission.plan_entries.length > 0
      ? submission.plan_entries.map((e) => ({
        id: e.id,
        objective: e.objective,
        description: e.description ?? '',
        key_result: e.key_result ?? '',
        responsible: e.responsible ?? '',
        priority: e.priority,
        status: e.status,
        target_date: e.target_date ?? '',
        comments: e.comments ?? '',
      }))
      : [{ ...DEFAULT_PLAN_ENTRY }]
  );

  const [ruptureEntries, setRuptureEntries] = useState<RuptureEntryFormData[]>(() =>
    submission.rupture_entries.length > 0
      ? submission.rupture_entries.map((e) => ({
        id: e.id,
        department: e.department,
        company_value: e.company_value,
        rupture_date: e.rupture_date,
        rupture_description: e.rupture_description,
        rupture_cause: e.rupture_cause ?? '',
        improvement_plan: e.improvement_plan ?? '',
        generated_cost: e.generated_cost ?? '',
      }))
      : [{ ...DEFAULT_RUPTURE_ENTRY }]
  );

  // UI State - Inicializar en null (todo colapsado) para interfaz más limpia
  const [expandedPlanIndex, setExpandedPlanIndex] = useState<number | null>(null);
  const [expandedRuptureIndex, setExpandedRuptureIndex] = useState<number | null>(null);
  const [errors, setErrors] = useState<Record<string, string[]>>({});
  const [saveStatus, setSaveStatus] = useState<'idle' | 'saving' | 'saved' | 'error'>('idle');
  const [lastSaved, setLastSaved] = useState<Date | null>(null);
  const [showSubmitDialog, setShowSubmitDialog] = useState(false);
  const [submitError, setSubmitError] = useState<string | null>(null);
  const [restoredFromBackup, setRestoredFromBackup] = useState(false);

  // Verificar si es viernes (Día 5)
  // Usamos un estado montado para evitar hydration mismatch con fechas del servidor
  const [isFriday, setIsFriday] = useState(false);
  useEffect(() => {
    const today = new Date();
    // getDay(): 0 = Domingo, 1 = Lunes, ..., 5 = Viernes, 6 = Sábado
    setIsFriday(today.getDay() === 5);
  }, []);

  const isLocked = submission.is_locked;
  const deadline = getDeadlineStatus(submission.week_end);

  // LOCAL STORAGE BACKUP
  const backupKey = `report_backup_${submission.id}`;

  // 1. Cargar backup al montar si existe
  useEffect(() => {
    if (isLocked) return; // No restaurar si ya está enviado

    try {
      const saved = localStorage.getItem(backupKey);
      if (saved) {
        const { plan, rupture, timestamp } = JSON.parse(saved);

        // Solo restaurar si el backup es más reciente que la carga inicial 
        // O si la carga inicial está vacía (default) y el backup tiene datos reales
        // Por simplicidad en este caso, si hay backup local y el usuario está editando, 
        // asumimos que el backup es lo más "fresco" antes del refresh.
        // Para evitar sobrescribir datos del servidor si el usuario entra de otro dispositivo,
        // idealmente compararíamos timestamps, pero aquí priorizamos la sesión local del usuario.

        if (plan && plan.length > 0) setPlanEntries(plan);
        if (rupture && rupture.length > 0) setRuptureEntries(rupture);

        setRestoredFromBackup(true);
        // Ocultar mensaje de restaurado después de unos segundos
        setTimeout(() => setRestoredFromBackup(false), 5000);
      }
    } catch (e) {
      console.error("Error restoring backup", e);
    }
  }, [backupKey, isLocked]);

  // 2. Guardar en backup cada vez que cambia algo (Optimizado: Debounce 2s)
  useEffect(() => {
    if (isLocked) return;

    const timeoutId = setTimeout(() => {
      try {
        const backupData = {
          plan: planEntries,
          rupture: ruptureEntries,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem(backupKey, JSON.stringify(backupData));
      } catch (e) {
        console.error("Error saving backup", e);
      }
    }, 2000); // Debounce aumentado a 2s para evitar micro-cortes

    return () => clearTimeout(timeoutId);
  }, [planEntries, ruptureEntries, backupKey, isLocked]);

  // 3. Limpiar backup al guardar exitosamente o enviar
  useEffect(() => {
    if (saveStatus === 'saved') {
      // Opcional: ¿Borrar backup al guardar en servidor? 
      // Mejor NO borrarlo hasta que se envíe (Submit), 
      // así sigue sirviendo de caché rápida.
    }
  }, [saveStatus]);

  // Auto-save cada 30 segundos si hay cambios
  useEffect(() => {
    if (isLocked) return;

    const interval = setInterval(() => {
      handleSaveDraft();
    }, 30000);

    return () => clearInterval(interval);
  }, [planEntries, ruptureEntries, isLocked]);

  // Guardar borrador
  const handleSaveDraft = useCallback(async () => {
    if (isLocked) return;

    setSaveStatus('saving');

    const result = await saveDraft(submission.id, {
      plan_entries: planEntries,
      rupture_entries: ruptureEntries,
    });

    if (result.success) {
      setSaveStatus('saved');
      setLastSaved(new Date());
      setTimeout(() => setSaveStatus('idle'), 2000);
    } else {
      setSaveStatus('error');
      setTimeout(() => setSaveStatus('idle'), 3000);
    }
  }, [submission.id, planEntries, ruptureEntries, isLocked]);

  // Validar antes de enviar
  const validateForm = useCallback(() => {
    const validation = weeklyReportFormSchema.safeParse({
      plan_entries: planEntries,
      rupture_entries: ruptureEntries,
    });

    if (!validation.success) {
      const formErrors = getFormErrors(validation.error);
      setErrors(formErrors);
      return false;
    }

    setErrors({});
    return true;
  }, [planEntries, ruptureEntries]);

  // Enviar reporte
  const handleSubmit = useCallback(async () => {
    if (!validateForm()) {
      setShowSubmitDialog(false);
      return;
    }

    setSubmitError(null);

    startTransition(async () => {
      const result = await submitReport(submission.id, {
        plan_entries: planEntries,
        rupture_entries: ruptureEntries,
      });

      if (result.success) {
        // Limpiar backup local al enviar exitosamente
        localStorage.removeItem(backupKey);
        setShowSubmitDialog(false);
        router.refresh();
      } else {
        setSubmitError(result.error ?? 'Error al enviar el reporte');
      }
    });
  }, [submission.id, planEntries, ruptureEntries, validateForm, router]);

  // Handlers para Plan entries
  const handleUpdatePlanEntry = useCallback(
    (index: number, field: keyof PlanEntryFormData, value: string) => {
      setPlanEntries((prev) =>
        prev.map((entry, i) =>
          i === index ? { ...entry, [field]: value } : entry
        )
      );
    },
    []
  );

  const handleAddPlanEntry = useCallback(() => {
    setPlanEntries((prev) => [...prev, { ...DEFAULT_PLAN_ENTRY }]);
    setExpandedPlanIndex(planEntries.length);
  }, [planEntries.length]);

  const handleRemovePlanEntry = useCallback((index: number) => {
    setPlanEntries((prev) => prev.filter((_, i) => i !== index));
    setExpandedPlanIndex(null);
  }, []);

  // Handlers para Rupture entries
  const handleUpdateRuptureEntry = useCallback(
    (index: number, field: keyof RuptureEntryFormData, value: string) => {
      setRuptureEntries((prev) =>
        prev.map((entry, i) =>
          i === index ? { ...entry, [field]: value } : entry
        )
      );
    },
    []
  );

  const handleAddRuptureEntry = useCallback(() => {
    setRuptureEntries((prev) => [...prev, { ...DEFAULT_RUPTURE_ENTRY }]);
    setExpandedRuptureIndex(ruptureEntries.length);
  }, [ruptureEntries.length]);

  const handleRemoveRuptureEntry = useCallback((index: number) => {
    setRuptureEntries((prev) => prev.filter((_, i) => i !== index));
    setExpandedRuptureIndex(null);
  }, []);

  // Handlers para Toggle (Expandir/Colapsar)
  const handleTogglePlanEntry = useCallback((index: number) => {
    setExpandedPlanIndex(prev => prev === index ? null : index);
  }, []);

  const handleToggleRuptureEntry = useCallback((index: number) => {
    setExpandedRuptureIndex(prev => prev === index ? null : index);
  }, []);

  // Contadores para UI
  const completedPlans = useMemo(
    () => planEntries.filter((e) => e.status === 'completado').length,
    [planEntries]
  );

  const hasErrors = Object.keys(errors).length > 0;

  return (
    <div className="space-y-6">
      {/* Header con estado y semana */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-slate-100">
            Reporte Semanal
          </h1>
          <p className="text-slate-400 mt-1">
            {formatWeekRange(submission.week_start, submission.week_end)}
          </p>
        </div>

        <div className="flex items-center gap-3">
          {/* Estado */}
          <Badge
            variant="outline"
            className={cn(STATUS_COLORS[submission.status as SubmissionStatus])}
          >
            {isLocked && <Lock className="h-3 w-3 mr-1" />}
            {SUBMISSION_STATUS_LABELS[submission.status as SubmissionStatus]}
          </Badge>

          {/* Deadline */}
          {!isLocked && (
            <Badge
              variant="outline"
              className={cn(
                deadline.isOverdue
                  ? 'bg-red-500/20 text-red-400 border-red-500/30'
                  : deadline.daysUntil <= 1
                    ? 'bg-amber-500/20 text-amber-400 border-amber-500/30'
                    : 'bg-slate-500/20 text-slate-400 border-slate-500/30'
              )}
            >
              <Clock className="h-3 w-3 mr-1" />
              {deadline.label}
            </Badge>
          )}
        </div>
      </div>

      {/* Mensaje de bloqueado */}
      {isLocked && (
        <div className="flex items-center gap-3 p-4 rounded-lg bg-blue-500/10 border border-blue-500/30">
          <Lock className="h-5 w-5 text-blue-400" />
          <div>
            <p className="text-sm font-medium text-blue-400">
              Reporte enviado
            </p>
            <p className="text-sm text-blue-400/80">
              Este reporte fue enviado el{' '}
              {submission.submitted_at
                ? new Date(submission.submitted_at).toLocaleDateString('es-ES', {
                  weekday: 'long',
                  day: 'numeric',
                  month: 'long',
                  hour: '2-digit',
                  minute: '2-digit',
                })
                : 'fecha desconocida'}{' '}
              y ya no puede ser modificado.
            </p>
          </div>
        </div>
      )}

      {/* Errores de validación global */}
      {hasErrors && (
        <div className="flex items-start gap-3 p-4 rounded-lg bg-red-500/10 border border-red-500/30">
          <AlertCircle className="h-5 w-5 text-red-400 shrink-0 mt-0.5" />
          <div>
            <p className="text-sm font-medium text-red-400">
              Hay errores en el formulario
            </p>
            <p className="text-sm text-red-400/80">
              Revisa los campos marcados en rojo antes de enviar.
            </p>
          </div>
        </div>
      )}

      {/* Sección: Plan GTC */}
      <Card className="border-slate-700 bg-slate-900/50">
        <CardHeader className="pb-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-500/20">
                <FileText className="h-5 w-5 text-emerald-400" />
              </div>
              <div>
                <CardTitle className="text-lg text-slate-100">
                  Plan GTC <span className="text-slate-400 font-normal">- {new Date(submission.week_start).toLocaleDateString('es-ES', { month: 'long' }).replace(/^\w/, c => c.toUpperCase())}</span>
                </CardTitle>
                <p className="text-sm text-slate-400">
                  {planEntries.length} objetivo{planEntries.length !== 1 && 's'} •{' '}
                  {completedPlans} completado{completedPlans !== 1 && 's'}
                </p>
              </div>
            </div>

            {!isLocked && (
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={handleAddPlanEntry}
                className="border-emerald-500/30 text-emerald-400 hover:bg-emerald-500/10"
              >
                <Plus className="h-4 w-4 mr-1" />
                Agregar
              </Button>
            )}
          </div>
        </CardHeader>

        <CardContent className="space-y-3">
          {planEntries.map((entry, index) => (
            <PlanEntryCard
              key={entry.id ?? `plan-${index}`}
              entry={entry}
              index={index}
              isExpanded={expandedPlanIndex === index}
              isLocked={isLocked}
              errors={errors}
              onUpdate={handleUpdatePlanEntry}
              onRemove={handleRemovePlanEntry}
              onToggleExpand={handleTogglePlanEntry}
            />
          ))}

          {planEntries.length === 0 && (
            <div className="text-center py-8 text-slate-500">
              <FileText className="h-8 w-8 mx-auto mb-2 opacity-50" />
              <p>No hay objetivos agregados</p>
              {!isLocked && (
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  onClick={handleAddPlanEntry}
                  className="mt-2 text-emerald-400"
                >
                  <Plus className="h-4 w-4 mr-1" />
                  Agregar primer objetivo
                </Button>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Sección: Ruptura de Cadena de Valor */}
      <Card className="border-slate-700 bg-slate-900/50">
        <CardHeader className="pb-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-500/20">
                <AlertTriangle className="h-5 w-5 text-amber-400" />
              </div>
              <div>
                <CardTitle className="text-lg text-slate-100">
                  Ruptura de Cadena de Valor
                </CardTitle>
                <p className="text-sm text-slate-400">
                  {ruptureEntries.length} ruptura{ruptureEntries.length !== 1 && 's'} registrada{ruptureEntries.length !== 1 && 's'}
                </p>
              </div>
            </div>

            {!isLocked && (
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={handleAddRuptureEntry}
                className="border-amber-500/30 text-amber-400 hover:bg-amber-500/10"
              >
                <Plus className="h-4 w-4 mr-1" />
                Agregar
              </Button>
            )}
          </div>
        </CardHeader>

        <CardContent className="space-y-3">
          {ruptureEntries.map((entry, index) => (
            <RuptureEntryCard
              key={entry.id ?? `rupture-${index}`}
              entry={entry}
              index={index}
              isExpanded={expandedRuptureIndex === index}
              isLocked={isLocked}
              departments={departments}
              companyValues={companyValues}
              errors={errors}
              onUpdate={handleUpdateRuptureEntry}
              onRemove={handleRemoveRuptureEntry}
              onToggleExpand={handleToggleRuptureEntry}
            />
          ))}

          {ruptureEntries.length === 0 && (
            <div className="text-center py-8 text-slate-500">
              <AlertTriangle className="h-8 w-8 mx-auto mb-2 opacity-50" />
              <p>No hay rupturas registradas</p>
              {!isLocked && (
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  onClick={handleAddRuptureEntry}
                  className="mt-2 text-amber-400"
                >
                  <Plus className="h-4 w-4 mr-1" />
                  Agregar primera ruptura
                </Button>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Footer con acciones */}
      {!isLocked && (
        <div className="sticky bottom-0 -mx-4 sm:-mx-6 px-4 sm:px-6 py-4 bg-slate-950/95 backdrop-blur border-t border-slate-800">
          <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
            {/* Estado de guardado */}
            <div className="flex items-center gap-2 text-sm">
              {restoredFromBackup && (
                <span className="text-amber-400 flex items-center gap-1 bg-amber-500/10 px-2 py-0.5 rounded text-xs">
                  <AlertCircle className="h-3 w-3" />
                  Restaurado de copia local
                </span>
              )}
              {saveStatus === 'saving' && (
                <>
                  <Loader2 className="h-4 w-4 animate-spin text-slate-400" />
                  <span className="text-slate-400">Guardando...</span>
                </>
              )}
              {saveStatus === 'saved' && (
                <>
                  <CheckCircle2 className="h-4 w-4 text-emerald-400" />
                  <span className="text-emerald-400">Guardado</span>
                </>
              )}
              {saveStatus === 'error' && (
                <>
                  <AlertCircle className="h-4 w-4 text-red-400" />
                  <span className="text-red-400">Error al guardar</span>
                </>
              )}
              {saveStatus === 'idle' && lastSaved && (
                <span className="text-slate-500">
                  Último guardado:{' '}
                  {lastSaved.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                  })}
                </span>
              )}
            </div>

            {/* Botones */}
            <div className="flex items-center gap-3">
              <Button
                type="button"
                variant="outline"
                onClick={handleSaveDraft}
                disabled={saveStatus === 'saving'}
                className="border-slate-700"
              >
                <Save className="h-4 w-4 mr-2" />
                Guardar borrador
              </Button>

              <Button
                type="button"
                onClick={() => setShowSubmitDialog(true)}
                disabled={isPending || !isFriday}
                className={cn(
                  "text-white",
                  !isFriday ? "bg-slate-600 cursor-not-allowed opacity-70" : "bg-emerald-600 hover:bg-emerald-700"
                )}
                title={!isFriday ? "El reporte solo se puede enviar los días viernes" : "Enviar reporte para revisión"}
              >
                {isPending ? (
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <Send className="h-4 w-4 mr-2" />
                )}
                Enviar reporte
              </Button>
              {!isFriday && (
                <span className="text-xs text-slate-500 hidden sm:inline-block">
                  (Solo viernes)
                </span>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Dialog de confirmación */}
      <SubmitConfirmDialog
        isOpen={showSubmitDialog}
        onClose={() => setShowSubmitDialog(false)}
        onConfirm={handleSubmit}
        isSubmitting={isPending}
        error={submitError}
        planCount={planEntries.length}
        ruptureCount={ruptureEntries.length}
        weekRange={formatWeekRange(submission.week_start, submission.week_end)}
      />
    </div>
  );
}
</file>

<file path="src/components/ui/MagicWandButton.tsx">
'use client';

import { Sparkles } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
    Tooltip,
    TooltipContent,
    TooltipProvider,
    TooltipTrigger,
} from '@/components/ui/tooltip';

interface MagicWandButtonProps {
    onClick?: () => void;
    isLoading?: boolean;
    className?: string;
    tooltip?: string;
}

export function MagicWandButton({
    onClick,
    isLoading = false,
    className,
    tooltip = "Mejorar redacción con Gemini IA",
}: MagicWandButtonProps) {
    return (
        <TooltipProvider delayDuration={0}>
            <Tooltip>
                <TooltipTrigger asChild>
                    <Button
                        type="button"
                        variant="ghost"
                        size="sm"
                        className={`h-7 px-2 text-xs font-medium text-indigo-400 hover:text-indigo-300 hover:bg-indigo-500/10 ${className}`}
                        onClick={onClick}
                        disabled={isLoading}
                    >
                        <Sparkles className={`h-3.5 w-3.5 mr-1.5 ${isLoading ? 'animate-pulse' : ''}`} />
                        Mejorar (IA)
                    </Button>
                </TooltipTrigger>
                <TooltipContent side="top">
                    <p className="max-w-xs">{tooltip}</p>
                </TooltipContent>
            </Tooltip>
        </TooltipProvider>
    );
}
</file>

<file path="src/lib/actions/reports.ts">
'use server';

// =====================================================
// GLOBAL TALENT PLATFORM - SERVER ACTIONS
// Operaciones de datos para reportes semanales
// =====================================================

import { revalidatePath } from 'next/cache';
import { createServerSupabaseClient } from '@/lib/supabase/server';
import {
  weeklyReportFormSchema,
  draftReportFormSchema,
  qualityReviewSchema,
  type WeeklyReportFormInput,
  type DraftReportFormInput,
  type QualityReviewInput,
} from '@/lib/validations/reports';
import type {
  ActionResult,
  WeeklySubmission,
  WeeklySubmissionWithEntries,
  PlanEntry,
  RuptureEntry,
  CompanyValue,
  Department,
  WeekSummary,
  AssistantSubmissionStatus,
} from '@/types/reports.types';

// =====================================================
// UTILIDADES
// =====================================================

function getWeekDates(date: Date = new Date()): { start: string; end: string } {
  const d = new Date(date);
  const day = d.getDay();
  const diffToMonday = day === 0 ? -6 : 1 - day;

  const monday = new Date(d);
  monday.setDate(d.getDate() + diffToMonday);
  monday.setHours(0, 0, 0, 0);

  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);

  return {
    start: monday.toISOString().split('T')[0]!,
    end: sunday.toISOString().split('T')[0]!,
  };
}

async function getCurrentUserAssistantId(): Promise<string | null> {
  const supabase = await createServerSupabaseClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return null;

  const { data: assistant } = await supabase
    .from('assistants')
    .select('id')
    .eq('user_id', user.id)
    .single();

  return assistant?.id ?? null;
}

// =====================================================
// OBTENER DATOS
// =====================================================

export async function getOrCreateCurrentWeekSubmission(referenceDate?: string): Promise<ActionResult<WeeklySubmissionWithEntries>> {
  try {
    const supabase = await createServerSupabaseClient();
    const assistantId = await getCurrentUserAssistantId();

    if (!assistantId) {
      return { success: false, error: 'No se encontró el asistente asociado a tu cuenta' };
    }

    // Si viene una fecha, la usamos para calcular la semana
    // Si no, usamos la fecha actual
    const targetDate = referenceDate ? new Date(referenceDate) : new Date();
    // Ajustar por timezone si es necesario, pero por ahora asumimos fecha string YYYY-MM-DD
    // que new Date() parsea como UTC o Local dependiendo del formato. 
    // Para asegurar consistencia 'YYYY-MM-DD' + 'T12:00:00' evita desfaces por zona horaria al calcular lunes.
    if (referenceDate) {
      targetDate.setHours(12, 0, 0, 0);
    }

    const { start, end } = getWeekDates(targetDate);

    // Intentar obtener el submission existente
    const { data: existing, error: fetchError } = await supabase
      .from('weekly_submissions')
      .select(`
        *,
        plan_entries (*),
        rupture_entries (*)
      `)
      .eq('assistant_id', assistantId)
      .eq('week_start', start)
      .single();

    if (existing && !fetchError) {
      return {
        success: true,
        data: {
          ...existing,
          attachments: [],
        } as WeeklySubmissionWithEntries,
      };
    }

    // Crear nuevo submission si no existe
    const { data: newSubmission, error: createError } = await supabase
      .from('weekly_submissions')
      .insert({
        assistant_id: assistantId,
        week_start: start,
        week_end: end,
        status: 'draft',
      })
      .select()
      .single();

    if (createError) {
      console.error('Error creating submission:', createError);
      return { success: false, error: 'Error al crear el reporte semanal' };
    }

    return {
      success: true,
      data: {
        ...newSubmission,
        plan_entries: [],
        rupture_entries: [],
        attachments: [],
      } as WeeklySubmissionWithEntries,
    };
  } catch (error) {
    console.error('getOrCreateCurrentWeekSubmission error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

export async function getSubmissionById(id: string): Promise<ActionResult<WeeklySubmissionWithEntries>> {
  try {
    const supabase = await createServerSupabaseClient();

    const { data, error } = await supabase
      .from('weekly_submissions')
      .select(`
        *,
        plan_entries (*),
        rupture_entries (*),
        assistant:assistants (
          id,
          full_name,
          email,
          position,
          avatar_url
        )
      `)
      .eq('id', id)
      .single();

    if (error || !data) {
      return { success: false, error: 'Reporte no encontrado' };
    }

    return {
      success: true,
      data: {
        ...data,
        attachments: [],
      } as WeeklySubmissionWithEntries,
    };
  } catch (error) {
    console.error('getSubmissionById error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

export async function getCatalogs(): Promise<ActionResult<{
  departments: Department[];
  companyValues: CompanyValue[];
}>> {
  try {
    const supabase = await createServerSupabaseClient();

    const [deptResult, valuesResult] = await Promise.all([
      supabase
        .from('departments')
        .select('*')
        .eq('is_active', true)
        .order('sort_order'),
      supabase
        .from('company_values')
        .select('*')
        .eq('is_active', true)
        .order('sort_order'),
    ]);

    return {
      success: true,
      data: {
        departments: (deptResult.data ?? []) as Department[],
        companyValues: (valuesResult.data ?? []) as CompanyValue[],
      },
    };
  } catch (error) {
    console.error('getCatalogs error:', error);
    return { success: false, error: 'Error al cargar catálogos' };
  }
}

// =====================================================
// GUARDAR BORRADOR
// =====================================================

export async function saveDraft(
  submissionId: string,
  formData: DraftReportFormInput
): Promise<ActionResult<{ saved_at: string }>> {
  try {
    const supabase = await createServerSupabaseClient();

    // Validar que el submission existe y no está bloqueado
    const { data: submission, error: checkError } = await supabase
      .from('weekly_submissions')
      .select('id, is_locked')
      .eq('id', submissionId)
      .single();

    if (checkError || !submission) {
      return { success: false, error: 'Reporte no encontrado' };
    }

    if (submission.is_locked) {
      return { success: false, error: 'Este reporte ya fue enviado y no puede ser modificado' };
    }

    // Validar datos con esquema flexible
    const validation = draftReportFormSchema.safeParse(formData);
    if (!validation.success) {
      return { success: false, error: 'Datos inválidos' };
    }

    // Eliminar entradas existentes y crear nuevas (upsert)
    await supabase
      .from('plan_entries')
      .delete()
      .eq('submission_id', submissionId);

    await supabase
      .from('rupture_entries')
      .delete()
      .eq('submission_id', submissionId);

    // Insertar nuevas entradas de plan
    if (validation.data.plan_entries && validation.data.plan_entries.length > 0) {
      const planEntries = validation.data.plan_entries.map((entry, index) => ({
        submission_id: submissionId,
        objective: entry.objective || '',
        description: entry.description || null,
        key_result: entry.key_result || null,
        responsible: entry.responsible || null,
        priority: entry.priority || 'media',
        status: entry.status || 'no_iniciado',
        target_date: entry.target_date || null,
        comments: entry.comments || null,
        sort_order: index,
      }));

      const { error: planError } = await supabase
        .from('plan_entries')
        .insert(planEntries);

      if (planError) {
        console.error('Error saving plan entries:', planError);
        return { success: false, error: 'Error al guardar el Plan GTC' };
      }
    }

    // Insertar nuevas entradas de ruptura
    if (validation.data.rupture_entries && validation.data.rupture_entries.length > 0) {
      const ruptureEntries = validation.data.rupture_entries.map((entry, index) => ({
        submission_id: submissionId,
        department: entry.department || '',
        company_value: entry.company_value || '',
        rupture_date: entry.rupture_date || new Date().toISOString().split('T')[0],
        rupture_description: entry.rupture_description || '',
        rupture_cause: entry.rupture_cause || null,
        improvement_plan: entry.improvement_plan || null,
        generated_cost: entry.generated_cost || null,
        sort_order: index,
      }));

      const { error: ruptureError } = await supabase
        .from('rupture_entries')
        .insert(ruptureEntries);

      if (ruptureError) {
        console.error('Error saving rupture entries:', ruptureError);
        return { success: false, error: 'Error al guardar las Rupturas de Valor' };
      }
    }

    // Actualizar timestamp del submission
    await supabase
      .from('weekly_submissions')
      .update({ updated_at: new Date().toISOString() })
      .eq('id', submissionId);

    revalidatePath('/reportes/semanal');

    return {
      success: true,
      data: { saved_at: new Date().toISOString() },
    };
  } catch (error) {
    console.error('saveDraft error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

// =====================================================
// ENVIAR REPORTE (SUBMIT)
// =====================================================

export async function submitReport(
  submissionId: string,
  formData: WeeklyReportFormInput
): Promise<ActionResult<{ submitted_at: string }>> {
  try {
    const supabase = await createServerSupabaseClient();

    // Verificar que el submission existe y no está bloqueado
    const { data: submission, error: checkError } = await supabase
      .from('weekly_submissions')
      .select('id, is_locked, status')
      .eq('id', submissionId)
      .single();

    if (checkError || !submission) {
      return { success: false, error: 'Reporte no encontrado' };
    }

    if (submission.is_locked) {
      return { success: false, error: 'Este reporte ya fue enviado' };
    }

    // Validar datos con esquema estricto
    const validation = weeklyReportFormSchema.safeParse(formData);
    if (!validation.success) {
      const firstError = validation.error.errors[0];
      return {
        success: false,
        error: firstError?.message ?? 'Datos inválidos. Revisa todos los campos requeridos.'
      };
    }

    // Guardar datos finales
    await supabase
      .from('plan_entries')
      .delete()
      .eq('submission_id', submissionId);

    await supabase
      .from('rupture_entries')
      .delete()
      .eq('submission_id', submissionId);

    // Insertar entradas de plan
    const planEntries = validation.data.plan_entries.map((entry, index) => ({
      submission_id: submissionId,
      objective: entry.objective,
      description: entry.description || null,
      key_result: entry.key_result || null,
      responsible: entry.responsible || null,
      priority: entry.priority,
      status: entry.status,
      target_date: entry.target_date || null,
      comments: entry.comments || null,
      sort_order: index,
    }));

    const { error: planError } = await supabase
      .from('plan_entries')
      .insert(planEntries);

    if (planError) {
      console.error('Error saving plan entries:', planError);
      return { success: false, error: 'Error al guardar el Plan GTC' };
    }

    // Insertar entradas de ruptura
    const ruptureEntries = validation.data.rupture_entries.map((entry, index) => ({
      submission_id: submissionId,
      department: entry.department,
      company_value: entry.company_value,
      rupture_date: entry.rupture_date,
      rupture_description: entry.rupture_description,
      rupture_cause: entry.rupture_cause || null,
      improvement_plan: entry.improvement_plan || null,
      generated_cost: entry.generated_cost || null,
      sort_order: index,
    }));

    const { error: ruptureError } = await supabase
      .from('rupture_entries')
      .insert(ruptureEntries);

    if (ruptureError) {
      console.error('Error saving rupture entries:', ruptureError);
      return { success: false, error: 'Error al guardar las Rupturas de Valor' };
    }

    // Marcar como enviado (esto dispara el trigger que bloquea)
    const submittedAt = new Date().toISOString();
    const { error: submitError } = await supabase
      .from('weekly_submissions')
      .update({
        status: 'submitted',
        submitted_at: submittedAt,
        is_locked: true,
      })
      .eq('id', submissionId);

    if (submitError) {
      console.error('Error submitting:', submitError);
      return { success: false, error: 'Error al enviar el reporte' };
    }

    revalidatePath('/reportes/semanal');
    revalidatePath('/calidad/reportes');

    return {
      success: true,
      data: { submitted_at: submittedAt },
    };
  } catch (error) {
    console.error('submitReport error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

// =====================================================
// DASHBOARD DE CALIDAD
// =====================================================

export async function getWeekSummary(weekStart?: string): Promise<ActionResult<WeekSummary>> {
  try {
    const supabase = await createServerSupabaseClient();
    const { start, end } = weekStart
      ? { start: weekStart, end: '' }
      : getWeekDates();

    // Contar asistentes activos
    const { count: totalAssistants } = await supabase
      .from('assistants')
      .select('*', { count: 'exact', head: true })
      .eq('status', 'activo');

    // Contar envíos de esta semana
    const { count: submittedCount } = await supabase
      .from('weekly_submissions')
      .select('*', { count: 'exact', head: true })
      .eq('week_start', start)
      .in('status', ['submitted', 'reviewed', 'approved']);

    const total = totalAssistants ?? 0;
    const submitted = submittedCount ?? 0;
    const pending = total - submitted;
    const percentage = total > 0 ? Math.round((submitted / total) * 100 * 10) / 10 : 0;

    // Calcular fin de semana
    const weekEndDate = new Date(start);
    weekEndDate.setDate(weekEndDate.getDate() + 6);

    return {
      success: true,
      data: {
        week_start: start,
        week_end: weekEndDate.toISOString().split('T')[0]!,
        total_assistants: total,
        submitted_count: submitted,
        pending_count: pending,
        progress_percentage: percentage,
      },
    };
  } catch (error) {
    console.error('getWeekSummary error:', error);
    return { success: false, error: 'Error al obtener resumen' };
  }
}

export async function getAssistantStatuses(weekStart?: string): Promise<ActionResult<AssistantSubmissionStatus[]>> {
  try {
    const supabase = await createServerSupabaseClient();
    const { start, end } = weekStart
      ? { start: weekStart, end: '' }
      : getWeekDates();

    // Obtener todos los asistentes activos
    const { data: assistants, error: assistantsError } = await supabase
      .from('assistants')
      .select('id, full_name, email, avatar_url, position')
      .eq('status', 'activo')
      .order('full_name');

    if (assistantsError || !assistants) {
      return { success: false, error: 'Error al obtener asistentes' };
    }

    // Obtener submissions de esta semana
    const { data: submissions, error: submissionsError } = await supabase
      .from('weekly_submissions')
      .select(`
        id,
        assistant_id,
        status,
        submitted_at,
        quality_score,
        plan_entries (id),
        rupture_entries (id)
      `)
      .eq('week_start', start);

    if (submissionsError) {
      return { success: false, error: 'Error al obtener envíos' };
    }

    // Calcular deadline (lunes siguiente a las 18:00)
    const weekEndDate = new Date(start);
    weekEndDate.setDate(weekEndDate.getDate() + 7); // Lunes siguiente
    weekEndDate.setHours(18, 0, 0, 0);

    const now = new Date();

    // Mapear asistentes con su estado de envío
    const statuses: AssistantSubmissionStatus[] = assistants.map((assistant) => {
      const submission = submissions?.find((s) => s.assistant_id === assistant.id);
      const hasSubmitted = submission?.status !== 'draft' && submission?.status !== undefined;

      let daysLate = 0;
      if (!hasSubmitted && now > weekEndDate) {
        const diffMs = now.getTime() - weekEndDate.getTime();
        daysLate = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      }

      return {
        assistant_id: assistant.id,
        full_name: assistant.full_name,
        email: assistant.email,
        avatar_url: assistant.avatar_url,
        position: assistant.position,
        has_submitted: hasSubmitted,
        submission_id: submission?.id ?? null,
        submitted_at: submission?.submitted_at ?? null,
        plan_count: Array.isArray(submission?.plan_entries) ? submission.plan_entries.length : 0,
        rupture_count: Array.isArray(submission?.rupture_entries) ? submission.rupture_entries.length : 0,
        quality_score: submission?.quality_score ?? null,
        days_late: daysLate,
      };
    });

    // Ordenar: primero pendientes (por días de retraso), luego enviados
    statuses.sort((a, b) => {
      if (a.has_submitted === b.has_submitted) {
        if (!a.has_submitted) {
          return b.days_late - a.days_late; // Más retraso primero
        }
        return (b.submitted_at ?? '').localeCompare(a.submitted_at ?? ''); // Más reciente primero
      }
      return a.has_submitted ? 1 : -1; // Pendientes primero
    });

    return { success: true, data: statuses };
  } catch (error) {
    console.error('getAssistantStatuses error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

export async function reviewSubmission(
  input: QualityReviewInput
): Promise<ActionResult<void>> {
  try {
    const supabase = await createServerSupabaseClient();

    const validation = qualityReviewSchema.safeParse(input);
    if (!validation.success) {
      return { success: false, error: 'Datos de revisión inválidos' };
    }

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      return { success: false, error: 'No autorizado' };
    }

    const updateData: Record<string, unknown> = {
      reviewed_at: new Date().toISOString(),
      reviewed_by: user.id,
    };

    if (validation.data.quality_score !== undefined) {
      updateData.quality_score = validation.data.quality_score;
    }

    if (validation.data.quality_feedback !== undefined) {
      updateData.quality_feedback = validation.data.quality_feedback;
    }

    if (validation.data.new_status) {
      updateData.status = validation.data.new_status;
    }

    const { error } = await supabase
      .from('weekly_submissions')
      .update(updateData)
      .eq('id', validation.data.submission_id);

    if (error) {
      console.error('Error reviewing:', error);
      return { success: false, error: 'Error al guardar la revisión' };
    }

    revalidatePath('/calidad/reportes');

    return { success: true };
  } catch (error) {
    console.error('reviewSubmission error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}

// =====================================================
// HISTORIAL DE REPORTES
// =====================================================

export async function getMySubmissionHistory(): Promise<ActionResult<WeeklySubmission[]>> {
  try {
    const supabase = await createServerSupabaseClient();
    const assistantId = await getCurrentUserAssistantId();

    if (!assistantId) {
      return { success: false, error: 'No se encontró el asistente' };
    }

    const { data, error } = await supabase
      .from('weekly_submissions')
      .select('*')
      .eq('assistant_id', assistantId)
      .order('week_start', { ascending: false })
      .limit(20);

    if (error) {
      return { success: false, error: 'Error al obtener historial' };
    }

    return { success: true, data: data as WeeklySubmission[] };
  } catch (error) {
    console.error('getMySubmissionHistory error:', error);
    return { success: false, error: 'Error interno del servidor' };
  }
}
</file>

<file path="src/lib/ai/gemini.ts">
import { GoogleGenerativeAI } from '@google/generative-ai';

// Inicializar el cliente de Gemini
// Asegúrate de tener GEMINI_API_KEY en tu archivo .env.local
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY || '');

// Usamos el modelo Flash por su velocidad y eficiencia para tareas de redacción
// Si sale la 2.0 Flash oficial, cambiaríamos aquí el string.
const model = genAI.getGenerativeModel({
    model: 'gemini-2.5-flash',
    systemInstruction: `Actúa como un Senior Project Manager obsesionado con la claridad, la estructura y los objetivos S.M.A.R.T.
  Tu tarea es reescribir y profesionalizar los reportes semanales de tu equipo.

  Reglas de Estilo:
  1. Usa un tono ejecutivo, directo y profesional.
  2. Comienza siempre con un verbo de acción en pasado o infinitivo según el contexto (ej: "Implementado", "Desarrollar").
  3. Estructura la respuesta para que sea legible y de alto impacto.

  Reglas de Contenido:
  1. Si el input es vago (ej: "avancé con el proyecto"), NO inventes datos. Mejora la redacción pero mantén la vaguedad o devuelve una pregunta entre corchetes sugiriendo qué falta: "[Falta detalle: ¿Qué módulo específico? ¿Qué % de avance?]".
  2. Si el input tiene datos, estructúralos: Acción + Contexto + Resultado/Métrica (si existe).
  
  Ejemplos:
  
  Input: "arregle el bug del login"
  Output: "Corregido error crítico en el módulo de autenticación (Login), restableciendo el acceso seguro para los usuarios."

  Input: "hice entrevistas"
  Output: "Ejecutadas entrevistas iniciales a candidatos. [Falta detalle: ¿Cuántas entrevistas? ¿Para qué roles?]"
  
  Tu respuesta debe ser SOLAMENTE el texto mejorado (o con la sugerencia entre corchetes). NO saludes.`
});

export async function improveTextWithGemini(text: string, context?: string): Promise<string> {
    if (!process.env.GEMINI_API_KEY) {
        console.warn('GEMINI_API_KEY is missing');
        return text; // Fallback
    }

    try {
        const prompt = context
            ? `Contexto: ${context}\nTexto a mejorar: "${text}"`
            : `Texto a mejorar: "${text}"`;

        const result = await model.generateContent(prompt);
        const response = await result.response;
        const improvedText = response.text();

        return improvedText.trim();
    } catch (error) {
        console.error('Error improving text with Gemini:', error);
        throw new Error('Failed to improve text');
    }
}

// Nueva función para mejorar una entrada completa (JSON)
export async function improveEntryWithGemini(entry: any, type: 'plan' | 'rupture'): Promise<any> {
    if (!process.env.GEMINI_API_KEY) {
        throw new Error('GEMINI_API_KEY is missing');
    }

    try {
        const isPlan = type === 'plan';

        const systemPrompt = `Actúa como un Senior Project Manager. Tu tarea es reescribir y profesionalizar una entrada de reporte semanal.
        
        Reglas:
        1. Mantén la coherencia entre los campos.
        2. Usa tono ejecutivo y profesional.
        3. Devuelve SOLAMENTE un objeto JSON válido.
        
        Campos a mejorar ${isPlan ? '(Plan)' : '(Ruptura)'}:
        ${isPlan
                ? '- objective: Breve pero impactante.\n- description: Detallada con acciones.\n- key_result: Métricas claras o definibles.'
                : '- rupture_description: Qué pasó.\n- rupture_cause: Causa raíz profesional.\n- improvement_plan: Solución o mitigación.'
            }
        
        Output esperado (JSON puro):
        {
            ${isPlan
                ? '"objective": "...", "description": "...", "key_result": "..."'
                : '"rupture_description": "...", "rupture_cause": "...", "improvement_plan": "..."'
            }
        }`;

        const userPrompt = `Mejora esta entrada JSON:
        ${JSON.stringify(entry)}
        
        Responde solo con el JSON mejorado.`;

        // Crear modelo específico para esta llamada o reusar con nueva instrucción
        const entryModel = genAI.getGenerativeModel({
            model: 'gemini-2.5-flash',
            systemInstruction: systemPrompt,
            generationConfig: { responseMimeType: "application/json" }
        });

        const result = await entryModel.generateContent(userPrompt);
        const response = await result.response;
        const text = response.text();

        return JSON.parse(text);
    } catch (error) {
        console.error('Error improving entry with Gemini:', error);
        throw new Error('Failed to improve entry');
    }
}
</file>

<file path="src/lib/hooks/useUser.ts">
'use client';

import { useEffect, useState, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import type { User } from '@supabase/supabase-js';
import { createClient } from '@/lib/supabase/client';
import type { Profile } from '@/types/database.types';

interface UseUserReturn {
  user: User | null;
  profile: Profile | null;
  isLoading: boolean;
  error: Error | null;
  signOut: () => Promise<void>;
  refreshUser: () => Promise<void>;
}

/**
 * Hook para acceder al usuario y perfil actual
 * Maneja autenticación en componentes del cliente
 */
export function useUser(): UseUserReturn {
  const [user, setUser] = useState<User | null>(null);
  const [profile, setProfile] = useState<Profile | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  const router = useRouter();
  const supabase = createClient();

  const fetchUserAndProfile = useCallback(async () => {
    try {
      setIsLoading(true);
      setError(null);

      // Obtener usuario de la sesión
      const {
        data: { user: authUser },
        error: authError,
      } = await supabase.auth.getUser();

      if (authError) {
        throw authError;
      }

      if (!authUser) {
        setUser(null);
        setProfile(null);
        return;
      }

      setUser(authUser);

      // Obtener perfil del usuario
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', authUser.id)
        .single();

      if (profileError) {
        console.error('Error fetching profile:', profileError);
        // No lanzamos error aquí, el usuario podría existir sin perfil
      }

      setProfile(profileData);
    } catch (err) {
      console.error('Error in useUser:', err);
      setError(err instanceof Error ? err : new Error('Error desconocido'));
    } finally {
      setIsLoading(false);
    }
  }, [supabase]);

  // Cargar usuario al montar
  useEffect(() => {
    fetchUserAndProfile();

    // Escuchar cambios de autenticación
    const {
      data: { subscription },
    } = supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN') {
        fetchUserAndProfile();
      } else if (event === 'SIGNED_OUT') {
        setUser(null);
        setProfile(null);
        router.push('/login');
      } else if (event === 'TOKEN_REFRESHED') {
        fetchUserAndProfile();
      }
    });

    return () => {
      subscription.unsubscribe();
    };
  }, [fetchUserAndProfile, router, supabase.auth]);

  const signOut = useCallback(async () => {
    try {
      await supabase.auth.signOut();
      setUser(null);
      setProfile(null);
      router.push('/login');
      router.refresh();
    } catch (err) {
      console.error('Error signing out:', err);
      throw err;
    }
  }, [supabase.auth, router]);

  const refreshUser = useCallback(async () => {
    await fetchUserAndProfile();
  }, [fetchUserAndProfile]);

  return {
    user,
    profile,
    isLoading,
    error,
    signOut,
    refreshUser,
  };
}

import { hasAccess, UserDepartment, UserPosition } from '@/types/database.types';

// ... (UseUserReturn interface stays same)

// ... (useUser hook stays same)

/**
 * Hook para verificar acceso basado en sistema de permisos granular
 */
export function useHasAccess(
  allowedDepartments?: UserDepartment[],
  allowedPositions?: UserPosition[]
): boolean {
  const { profile } = useUser();

  if (!profile) return false;

  // Utilizar la función centralizada de permisos
  return hasAccess(
    profile.department,
    profile.position,
    profile.role,
    { departments: allowedDepartments, positions: allowedPositions }
  );
}

/**
 * Hook simplificado para verificar acceso por departamento
 */
export function useHasDepartmentAccess(allowedDepartments: UserDepartment[]): boolean {
  return useHasAccess(allowedDepartments);
}

/**
 * Hook para verificar si el usuario es admin (compatibilidad)
 */
export function useIsAdmin(): boolean {
  return useHasAccess(['c_level']);
}
</file>

<file path="src/lib/validations/reports.ts">
// =====================================================
// GLOBAL TALENT PLATFORM - VALIDACIONES ZOD
// Esquemas de validación para reportes semanales
// =====================================================

import { z } from 'zod';

// =====================================================
// ESQUEMAS BASE
// =====================================================

export const prioritySchema = z.enum(['alta', 'media', 'baja'], {
  required_error: 'Selecciona una prioridad',
  invalid_type_error: 'Prioridad inválida',
});

export const planStatusSchema = z.enum(['no_iniciado', 'en_progreso', 'completado'], {
  required_error: 'Selecciona un estado',
  invalid_type_error: 'Estado inválido',
});

// =====================================================
// PLAN GTC - ENTRADA INDIVIDUAL
// =====================================================

export const planEntrySchema = z.object({
  id: z.string().uuid().optional(),
  objective: z
    .string()
    .min(10, 'El objetivo debe tener al menos 10 caracteres')
    .max(500, 'El objetivo no puede exceder 500 caracteres'),
  description: z
    .string()
    .min(30, 'La descripción debe tener al menos 30 caracteres para ser útil')
    .max(2000, 'La descripción no puede exceder 2000 caracteres'),
  key_result: z
    .string()
    .min(20, 'El resultado clave debe detallar métricas (mínimo 20 caracteres)')
    .max(1000, 'El resultado clave no puede exceder 1000 caracteres'),
  responsible: z
    .string()
    .min(3, 'Debes indicar un responsable')
    .max(200, 'El responsable no puede exceder 200 caracteres'),
  priority: prioritySchema,
  status: planStatusSchema,
  target_date: z
    .string()
    .min(1, 'La fecha límite es obligatoria')
    .refine(
      (val) => !isNaN(Date.parse(val)),
      'Fecha inválida'
    ),
  comments: z
    .string()
    .max(1000, 'Los comentarios no pueden exceder 1000 caracteres')
    .optional()
    .default(''),
});

// =====================================================
// RUPTURA DE VALOR - ENTRADA INDIVIDUAL
// =====================================================

export const ruptureEntrySchema = z.object({
  id: z.string().uuid().optional(),
  department: z
    .string()
    .min(1, 'Selecciona un departamento'),
  company_value: z
    .string()
    .min(1, 'Selecciona un valor de la empresa'),
  rupture_date: z
    .string()
    .min(1, 'La fecha es requerida')
    .refine(
      (val) => !isNaN(Date.parse(val)),
      'Fecha inválida'
    ),
  rupture_description: z
    .string()
    .min(30, 'La descripción debe detallar qué pasó (mínimo 30 caracteres)')
    .max(3000, 'La descripción no puede exceder 3000 caracteres'),
  rupture_cause: z
    .string()
    .min(30, 'Debes explicar la causa raíz (mínimo 30 caracteres)')
    .max(2000, 'El motivo no puede exceder 2000 caracteres'),
  improvement_plan: z
    .string()
    .min(30, 'El plan de acción es obligatorio (mínimo 30 caracteres)')
    .max(2000, 'El plan de mejora no puede exceder 2000 caracteres'),
  generated_cost: z
    .string()
    .min(1, 'Indica el impacto económico (o "0" si no hubo)')
    .max(1000, 'El gasto generado no puede exceder 1000 caracteres'),
});

// =====================================================
// FORMULARIO COMPLETO DEL REPORTE SEMANAL
// =====================================================

export const weeklyReportFormSchema = z.object({
  plan_entries: z
    .array(planEntrySchema)
    .min(1, 'Debes agregar al menos 1 entrada en el Plan GTC')
    .max(10, 'No puedes agregar más de 10 entradas en el Plan GTC'),
  rupture_entries: z
    .array(ruptureEntrySchema)
    .min(1, 'Debes agregar al menos 1 ruptura de valor')
    .max(10, 'No puedes agregar más de 10 rupturas'),
});

// =====================================================
// ESQUEMA PARA GUARDAR BORRADOR (más flexible)
// =====================================================

export const draftPlanEntrySchema = z.object({
  id: z.string().uuid().optional(),
  objective: z.string().max(500).optional().default(''),
  description: z.string().max(2000).optional().default(''),
  key_result: z.string().max(1000).optional().default(''),
  responsible: z.string().max(200).optional().default(''),
  priority: prioritySchema.optional().default('media'),
  status: planStatusSchema.optional().default('no_iniciado'),
  target_date: z.string().optional().default(''),
  comments: z.string().max(1000).optional().default(''),
});

export const draftRuptureEntrySchema = z.object({
  id: z.string().uuid().optional(),
  department: z.string().optional().default(''),
  company_value: z.string().optional().default(''),
  rupture_date: z.string().optional().default(''),
  rupture_description: z.string().max(3000).optional().default(''),
  rupture_cause: z.string().max(2000).optional().default(''),
  improvement_plan: z.string().max(2000).optional().default(''),
  generated_cost: z.string().max(1000).optional().default(''),
});

export const draftReportFormSchema = z.object({
  plan_entries: z.array(draftPlanEntrySchema).optional().default([]),
  rupture_entries: z.array(draftRuptureEntrySchema).optional().default([]),
});

// =====================================================
// ESQUEMAS PARA REVISIÓN DE CALIDAD
// =====================================================

export const qualityReviewSchema = z.object({
  submission_id: z.string().uuid(),
  quality_score: z
    .number()
    .min(0, 'El puntaje mínimo es 0')
    .max(10, 'El puntaje máximo es 10')
    .optional(),
  quality_feedback: z
    .string()
    .max(2000, 'El feedback no puede exceder 2000 caracteres')
    .optional(),
  new_status: z.enum(['reviewed', 'approved']).optional(),
});

// =====================================================
// TIPOS INFERIDOS DE LOS ESQUEMAS
// =====================================================

export type PlanEntryInput = z.infer<typeof planEntrySchema>;
export type RuptureEntryInput = z.infer<typeof ruptureEntrySchema>;
export type WeeklyReportFormInput = z.infer<typeof weeklyReportFormSchema>;
export type DraftReportFormInput = z.infer<typeof draftReportFormSchema>;
export type QualityReviewInput = z.infer<typeof qualityReviewSchema>;

// =====================================================
// FUNCIONES DE VALIDACIÓN
// =====================================================

export function validateWeeklyReport(data: unknown): {
  success: boolean;
  data?: WeeklyReportFormInput;
  errors?: z.ZodError;
} {
  const result = weeklyReportFormSchema.safeParse(data);
  if (result.success) {
    return { success: true, data: result.data };
  }
  return { success: false, errors: result.error };
}

export function validateDraft(data: unknown): {
  success: boolean;
  data?: DraftReportFormInput;
  errors?: z.ZodError;
} {
  const result = draftReportFormSchema.safeParse(data);
  if (result.success) {
    return { success: true, data: result.data };
  }
  return { success: false, errors: result.error };
}

export function getFormErrors(error: z.ZodError): Record<string, string[]> {
  const errors: Record<string, string[]> = {};

  error.errors.forEach((err) => {
    const path = err.path.join('.');
    if (!errors[path]) {
      errors[path] = [];
    }
    errors[path].push(err.message);
  });

  return errors;
}

// =====================================================
// VALORES POR DEFECTO
// =====================================================

export const DEFAULT_PLAN_ENTRY: PlanEntryInput = {
  objective: '',
  description: '',
  key_result: '',
  responsible: '',
  priority: 'media',
  status: 'no_iniciado',
  target_date: '',
  comments: '',
};

export const DEFAULT_RUPTURE_ENTRY: RuptureEntryInput = {
  department: '',
  company_value: '',
  rupture_date: new Date().toISOString().split('T')[0] ?? '',
  rupture_description: '',
  rupture_cause: '',
  improvement_plan: '',
  generated_cost: '',
};
</file>

<file path="src/types/reports.types.ts">
// =====================================================
// GLOBAL TALENT PLATFORM - TIPOS DEL SISTEMA DE REPORTES
// =====================================================

import type { Database } from './database.types';

// =====================================================
// TIPOS BASE DE TABLAS
// =====================================================

export interface WeeklySubmission {
  id: string;
  assistant_id: string;
  week_start: string;
  week_end: string;
  status: SubmissionStatus;
  is_locked: boolean;
  submitted_at: string | null;
  reviewed_at: string | null;
  reviewed_by: string | null;
  quality_score: number | null;
  quality_feedback: string | null;
  created_at: string;
  updated_at: string;
}

export interface PlanEntry {
  id: string;
  submission_id: string;
  objective: string;
  description: string | null;
  key_result: string | null;
  responsible: string | null;
  priority: Priority;
  status: PlanStatus;
  target_date: string | null;
  comments: string | null;
  sort_order: number;
  created_at: string;
  updated_at: string;
}

export interface RuptureEntry {
  id: string;
  submission_id: string;
  department: string;
  company_value: string;
  rupture_date: string;
  rupture_description: string;
  rupture_cause: string | null;
  improvement_plan: string | null;
  generated_cost: string | null;
  sort_order: number;
  created_at: string;
  updated_at: string;
}

export interface SubmissionAttachment {
  id: string;
  submission_id: string;
  plan_entry_id: string | null;
  rupture_entry_id: string | null;
  file_name: string;
  file_type: string;
  file_size: number;
  file_url: string;
  description: string | null;
  uploaded_by: string;
  created_at: string;
}

export interface CompanyValue {
  id: string;
  name: string;
  description: string | null;
  is_active: boolean;
  sort_order: number;
}

export interface Department {
  id: string;
  name: string;
  is_active: boolean;
  sort_order: number;
}

// =====================================================
// ENUMS Y TIPOS AUXILIARES
// =====================================================

export type SubmissionStatus = 'draft' | 'submitted' | 'reviewed' | 'approved';
export type Priority = 'alta' | 'media' | 'baja';
export type PlanStatus = 'no_iniciado' | 'en_progreso' | 'completado';

export const SUBMISSION_STATUS_LABELS: Record<SubmissionStatus, string> = {
  draft: 'Borrador',
  submitted: 'Enviado',
  reviewed: 'Revisado',
  approved: 'Aprobado',
};

export const PRIORITY_LABELS: Record<Priority, string> = {
  alta: 'Alta',
  media: 'Media',
  baja: 'Baja',
};

export const PLAN_STATUS_LABELS: Record<PlanStatus, string> = {
  no_iniciado: 'No iniciado',
  en_progreso: 'En progreso',
  completado: 'Completado',
};

export const PRIORITY_COLORS: Record<Priority, string> = {
  alta: 'bg-red-500/20 text-red-400 border-red-500/30',
  media: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  baja: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
};

export const STATUS_COLORS: Record<SubmissionStatus, string> = {
  draft: 'bg-slate-500/20 text-slate-400 border-slate-500/30',
  submitted: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
  reviewed: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
  approved: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
};

// =====================================================
// TIPOS COMPUESTOS Y VISTAS
// =====================================================

export interface WeeklySubmissionWithEntries extends WeeklySubmission {
  plan_entries: PlanEntry[];
  rupture_entries: RuptureEntry[];
  attachments: SubmissionAttachment[];
  assistant?: {
    id: string;
    full_name: string;
    email: string;
    position: string | null;
    avatar_url: string | null;
  };
}

export interface WeeklyProgressItem {
  assistant_id: string;
  full_name: string;
  email: string;
  position: string | null;
  submission_id: string | null;
  week_start: string;
  week_end: string;
  status: SubmissionStatus | null;
  is_locked: boolean;
  submitted_at: string | null;
  quality_score: number | null;
  plan_count: number;
  rupture_count: number;
}

export interface WeekSummary {
  week_start: string;
  week_end: string;
  total_assistants: number;
  submitted_count: number;
  pending_count: number;
  progress_percentage: number;
}

export interface AssistantSubmissionStatus {
  assistant_id: string;
  full_name: string;
  email: string;
  avatar_url: string | null;
  position: string | null;
  has_submitted: boolean;
  submission_id: string | null;
  submitted_at: string | null;
  plan_count: number;
  rupture_count: number;
  quality_score: number | null;
  days_late: number;
}

// =====================================================
// TIPOS PARA FORMULARIOS
// =====================================================

export interface PlanEntryFormData {
  id?: string;
  objective: string;
  description: string;
  key_result: string;
  responsible: string;
  priority: Priority;
  status: PlanStatus;
  target_date: string;
  comments: string;
}

export interface RuptureEntryFormData {
  id?: string;
  department: string;
  company_value: string;
  rupture_date: string;
  rupture_description: string;
  rupture_cause: string;
  improvement_plan: string;
  generated_cost: string;
}

export interface WeeklyReportFormData {
  plan_entries: PlanEntryFormData[];
  rupture_entries: RuptureEntryFormData[];
}

// =====================================================
// TIPOS PARA ACCIONES DEL SERVIDOR
// =====================================================

export interface ActionResult<T = void> {
  success: boolean;
  data?: T;
  error?: string;
}

export interface CreateSubmissionResult {
  submission_id: string;
}

export interface SaveDraftResult {
  saved_at: string;
}

export interface SubmitReportResult {
  submitted_at: string;
}

// =====================================================
// UTILIDADES DE FECHAS
// =====================================================

export function getCurrentWeekRange(): { start: Date; end: Date } {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const diffToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;

  const monday = new Date(now);
  monday.setDate(now.getDate() + diffToMonday);
  monday.setHours(0, 0, 0, 0);

  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  sunday.setHours(23, 59, 59, 999);

  return { start: monday, end: sunday };
}

export function formatWeekRange(start: string, end: string): string {
  const startDate = new Date(start);
  const endDate = new Date(end);

  // Ajustar visualmente para mostrar Viernes en lugar de Domingo
  // Si la fecha fin es domingo, restamos 2 días para mostrar viernes
  if (endDate.getDay() === 0) {
    endDate.setDate(endDate.getDate() - 2);
  }

  const options: Intl.DateTimeFormatOptions = {
    day: 'numeric',
    month: 'short'
  };

  const startStr = startDate.toLocaleDateString('es-ES', options);
  const endStr = endDate.toLocaleDateString('es-ES', {
    ...options,
    year: 'numeric'
  });

  return `${startStr} - ${endStr}`;
}

export function getDeadlineStatus(weekEnd: string): {
  isOverdue: boolean;
  daysUntil: number;
  label: string;
} {
  const now = new Date();
  const deadline = new Date(weekEnd);

  // El deadline es el Viernes a las 18:00
  // weekEnd viene como Domingo, restamos 2 días
  if (deadline.getDay() === 0) {
    deadline.setDate(deadline.getDate() - 2);
  }

  deadline.setHours(18, 0, 0, 0); // 6 PM del Viernes

  const diffMs = deadline.getTime() - now.getTime();
  // Math.floor para ser más precisa con ciclos completos de 24h, 
  // pero Math.ceil es mejor para UX de "quedan X días" (ej: si queda 1.5 d, mejor decir 2d).
  const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays < 0) {
    return {
      isOverdue: true,
      daysUntil: Math.abs(diffDays),
      label: `${Math.abs(diffDays)} día${Math.abs(diffDays) !== 1 ? 's' : ''} de retraso`,
    };
  }

  if (diffDays === 0) {
    // Verificar si ya pasó la hora
    if (diffMs < 0) {
      return {
        isOverdue: true,
        daysUntil: 0,
        label: 'Venció hoy',
      };
    }
    return {
      isOverdue: false,
      daysUntil: 0,
      label: 'Vence hoy',
    };
  }

  return {
    isOverdue: false,
    daysUntil: diffDays,
    label: `${diffDays} día${diffDays !== 1 ? 's' : ''} restante${diffDays !== 1 ? 's' : ''}`,
  };
}
</file>

<file path="next.config.js">
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Habilitar React Strict Mode para detectar problemas
  reactStrictMode: true,

  eslint: {
    // Esto permite el deploy aunque haya warnings de estilo
    ignoreDuringBuilds: true,
  },
  typescript: {
    // Esto permite el deploy aunque haya errores de tipado
    ignoreBuildErrors: true,
  },

  // Configuración de imágenes para Supabase Storage
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: '*.supabase.co',
        port: '',
        pathname: '/storage/v1/object/public/**',
      },
      {
        protocol: 'https',
        hostname: 'avatars.githubusercontent.com',
        port: '',
        pathname: '/**',
      },
    ],
  },

  // Headers de seguridad
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
        ],
      },
    ];
  },

  // Redirecciones
  async redirects() {
    return [
      {
        source: '/',
        destination: '/dashboard',
        permanent: false,
      },
    ];
  },

  // Configuración experimental
  experimental: {
    // Optimizar imports de lucide-react
    optimizePackageImports: ['lucide-react', 'recharts', 'date-fns'],
  },
};

module.exports = nextConfig;
</file>

<file path="package.json">
{
  "name": "global-talent-platform",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "db:generate-types": "supabase gen types typescript --project-id $SUPABASE_PROJECT_ID > src/types/database.types.ts"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@elevenlabs/react": "^0.13.0",
    "@google/generative-ai": "^0.24.1",
    "@hookform/resolvers": "^3.9.1",
    "@radix-ui/react-alert-dialog": "^1.1.2",
    "@radix-ui/react-avatar": "^1.1.1",
    "@radix-ui/react-checkbox": "^1.1.2",
    "@radix-ui/react-dialog": "^1.1.2",
    "@radix-ui/react-dropdown-menu": "^2.1.2",
    "@radix-ui/react-label": "^2.1.0",
    "@radix-ui/react-popover": "^1.1.2",
    "@radix-ui/react-progress": "^1.1.0",
    "@radix-ui/react-select": "^2.1.2",
    "@radix-ui/react-separator": "^1.1.0",
    "@radix-ui/react-slot": "^1.1.0",
    "@radix-ui/react-switch": "^1.1.1",
    "@radix-ui/react-tabs": "^1.1.1",
    "@radix-ui/react-toast": "^1.2.2",
    "@radix-ui/react-tooltip": "^1.1.3",
    "@supabase/auth-helpers-nextjs": "^0.10.0",
    "@supabase/ssr": "^0.5.1",
    "@supabase/supabase-js": "^2.46.1",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "geist": "^1.3.1",
    "lucide-react": "^0.454.0",
    "next": "^14.2.35",
    "next-themes": "^0.4.3",
    "react": "^18.3.1",
    "react-day-picker": "^9.3.0",
    "react-dom": "^18.3.1",
    "react-dropzone": "^14.2.9",
    "react-hook-form": "^7.53.1",
    "recharts": "^2.13.0",
    "sonner": "^2.0.7",
    "tailwind-merge": "^2.5.4",
    "tailwindcss-animate": "^1.0.7",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "@types/node": "^22.8.6",
    "@types/react": "^18.3.12",
    "@types/react-dom": "^18.3.1",
    "autoprefixer": "^10.4.20",
    "eslint": "^9.0.0",
    "eslint-config-next": "^16.1.3",
    "postcss": "^8.4.47",
    "supabase": "^2.72.8",
    "tailwindcss": "^3.4.14",
    "typescript": "^5.6.3"
  }
}
</file>

<file path="src/app/(dashboard)/reportes/mensual/page.tsx">
import { MonthlyReportForm } from '@/components/reportes/monthly/MonthlyReportForm';
import { Metadata } from 'next';

export const metadata: Metadata = {
  title: 'Informe Mensual | Global Talent',
  description: 'Gestión de informes mensuales para asistentes.',
};

export default function MonthlyReportPage() {
  return (
    <div className="container mx-auto py-6 px-4">
      <MonthlyReportForm />
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/reportes/semanal/[id]/page.tsx">
// =====================================================
// /reportes/semanal/[id] - Ver detalle de reporte
// =====================================================

import { Suspense } from 'react';
import { notFound } from 'next/navigation';
import Link from 'next/link';
import {
  ArrowLeft,
  Loader2,
  FileText,
  AlertTriangle,
  Calendar,
  Star,
  Lock,
} from 'lucide-react';
import { getSubmissionById } from '@/lib/actions/reports';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import {
  formatWeekRange,
  SUBMISSION_STATUS_LABELS,
  STATUS_COLORS,
  PRIORITY_LABELS,
  PRIORITY_COLORS,
  PLAN_STATUS_LABELS,
} from '@/types/reports.types';
import type { SubmissionStatus } from '@/types/reports.types';
import { cn } from '@/lib/utils';

export const metadata = {
  title: 'Detalle de Reporte | Global Talent Platform',
};

function LoadingState() {
  return (
    <div className="flex items-center justify-center min-h-[400px]">
      <div className="text-center">
        <Loader2 className="h-8 w-8 animate-spin text-emerald-500 mx-auto mb-4" />
        <p className="text-slate-400">Cargando reporte...</p>
      </div>
    </div>
  );
}

async function ReportDetail({ id }: { id: string }) {
  const result = await getSubmissionById(id);

  if (!result.success || !result.data) {
    notFound();
  }

  const submission = result.data;
  const assistant = submission.assistant;

  const getInitials = (name: string): string => {
    return name
      .split(' ')
      .map((n) => n[0])
      .join('')
      .toUpperCase()
      .slice(0, 2);
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div className="flex items-center gap-4">
          <Link href="/calidad/reportes">
            <Button variant="ghost" size="icon" className="text-slate-400 hover:text-slate-200">
              <ArrowLeft className="h-5 w-5" />
            </Button>
          </Link>
          <div>
            <h1 className="text-2xl font-bold text-slate-100">
              Reporte Semanal
            </h1>
            <p className="text-slate-400 mt-1">
              {formatWeekRange(submission.week_start, submission.week_end)}
            </p>
          </div>
        </div>

        <Badge
          variant="outline"
          className={cn(STATUS_COLORS[submission.status as SubmissionStatus])}
        >
          {submission.is_locked && <Lock className="h-3 w-3 mr-1" />}
          {SUBMISSION_STATUS_LABELS[submission.status as SubmissionStatus]}
        </Badge>
      </div>

      {/* Info del asistente */}
      {assistant && (
        <Card className="border-slate-700 bg-slate-900/50">
          <CardContent className="p-4">
            <div className="flex items-center gap-4">
              <Avatar className="h-14 w-14 border-2 border-slate-700">
                <AvatarImage src={assistant.avatar_url ?? undefined} />
                <AvatarFallback className="bg-slate-700 text-slate-300">
                  {getInitials(assistant.full_name)}
                </AvatarFallback>
              </Avatar>
              <div className="flex-1">
                <h2 className="text-lg font-medium text-slate-100">
                  {assistant.full_name}
                </h2>
                <p className="text-sm text-slate-400">{assistant.email}</p>
                {assistant.position && (
                  <p className="text-sm text-slate-500">{assistant.position}</p>
                )}
              </div>
              <div className="text-right">
                {submission.submitted_at && (
                  <div className="flex items-center gap-2 text-sm text-slate-400">
                    <Calendar className="h-4 w-4" />
                    <span>
                      Enviado:{' '}
                      {new Date(submission.submitted_at).toLocaleDateString('es-ES', {
                        weekday: 'long',
                        day: 'numeric',
                        month: 'long',
                        hour: '2-digit',
                        minute: '2-digit',
                      })}
                    </span>
                  </div>
                )}
                {submission.quality_score !== null && (
                  <div className="flex items-center justify-end gap-2 mt-2">
                    <Star className="h-4 w-4 text-amber-400" />
                    <span className="text-lg font-bold text-amber-400">
                      {submission.quality_score.toFixed(1)}
                    </span>
                  </div>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Plan GTC */}
      <Card className="border-slate-700 bg-slate-900/50">
        <CardHeader className="pb-4">
          <div className="flex items-center gap-3">
            <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-emerald-500/20">
              <FileText className="h-5 w-5 text-emerald-400" />
            </div>
            <div>
              <CardTitle className="text-lg text-slate-100">Plan GTC</CardTitle>
              <p className="text-sm text-slate-400">
                {submission.plan_entries.length} objetivo
                {submission.plan_entries.length !== 1 && 's'}
              </p>
            </div>
          </div>
        </CardHeader>

        <CardContent className="space-y-4">
          {submission.plan_entries.length === 0 ? (
            <p className="text-center text-slate-500 py-8">
              No hay objetivos registrados
            </p>
          ) : (
            submission.plan_entries.map((entry, index) => (
              <div
                key={entry.id}
                className="p-4 rounded-lg border border-slate-700 bg-slate-800/30"
              >
                <div className="flex items-start justify-between gap-4">
                  <div className="flex items-start gap-3">
                    <div className="flex h-7 w-7 items-center justify-center rounded-full bg-slate-700 text-sm font-medium text-slate-300">
                      {index + 1}
                    </div>
                    <div className="flex-1">
                      <h3 className="font-medium text-slate-100">{entry.objective}</h3>
                      {entry.description && (
                        <p className="text-sm text-slate-400 mt-1">{entry.description}</p>
                      )}
                      {entry.key_result && (
                        <div className="mt-2 p-2 rounded bg-slate-800/50">
                          <p className="text-xs text-slate-500 uppercase tracking-wide mb-1">
                            Resultado clave
                          </p>
                          <p className="text-sm text-slate-300">{entry.key_result}</p>
                        </div>
                      )}
                      {entry.comments && (
                        <div className="mt-2 p-2 rounded bg-slate-800/50">
                          <p className="text-xs text-slate-500 uppercase tracking-wide mb-1">
                            Comentarios
                          </p>
                          <p className="text-sm text-slate-300">{entry.comments}</p>
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="flex flex-col items-end gap-2">
                    <Badge variant="outline" className={PRIORITY_COLORS[entry.priority]}>
                      {PRIORITY_LABELS[entry.priority]}
                    </Badge>
                    <Badge
                      variant="outline"
                      className={cn(
                        entry.status === 'completado'
                          ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'
                          : entry.status === 'en_progreso'
                          ? 'bg-blue-500/20 text-blue-400 border-blue-500/30'
                          : 'bg-slate-500/20 text-slate-400 border-slate-500/30'
                      )}
                    >
                      {PLAN_STATUS_LABELS[entry.status]}
                    </Badge>
                    {entry.target_date && (
                      <span className="text-xs text-slate-500">
                        {new Date(entry.target_date).toLocaleDateString('es-ES')}
                      </span>
                    )}
                  </div>
                </div>
              </div>
            ))
          )}
        </CardContent>
      </Card>

      {/* Rupturas de Valor */}
      <Card className="border-slate-700 bg-slate-900/50">
        <CardHeader className="pb-4">
          <div className="flex items-center gap-3">
            <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-amber-500/20">
              <AlertTriangle className="h-5 w-5 text-amber-400" />
            </div>
            <div>
              <CardTitle className="text-lg text-slate-100">
                Ruptura de Cadena de Valor
              </CardTitle>
              <p className="text-sm text-slate-400">
                {submission.rupture_entries.length} ruptura
                {submission.rupture_entries.length !== 1 && 's'}
              </p>
            </div>
          </div>
        </CardHeader>

        <CardContent className="space-y-4">
          {submission.rupture_entries.length === 0 ? (
            <p className="text-center text-slate-500 py-8">
              No hay rupturas registradas
            </p>
          ) : (
            submission.rupture_entries.map((entry, index) => (
              <div
                key={entry.id}
                className="p-4 rounded-lg border border-slate-700 bg-slate-800/30"
              >
                <div className="flex items-start gap-3">
                  <div className="flex h-7 w-7 items-center justify-center rounded-full bg-amber-500/20">
                    <AlertTriangle className="h-4 w-4 text-amber-400" />
                  </div>
                  <div className="flex-1">
                    {/* Meta info */}
                    <div className="flex flex-wrap items-center gap-2 mb-2">
                      <Badge variant="outline" className="bg-slate-700/50 text-slate-300 border-slate-600">
                        {entry.department}
                      </Badge>
                      <Badge variant="outline" className="bg-slate-700/50 text-slate-300 border-slate-600">
                        {entry.company_value}
                      </Badge>
                      <span className="text-xs text-slate-500">
                        {new Date(entry.rupture_date).toLocaleDateString('es-ES')}
                      </span>
                    </div>

                    {/* Descripción */}
                    <div className="space-y-3">
                      <div>
                        <p className="text-xs text-slate-500 uppercase tracking-wide mb-1">
                          Ruptura de valor
                        </p>
                        <p className="text-sm text-slate-200">{entry.rupture_description}</p>
                      </div>

                      {entry.rupture_cause && (
                        <div>
                          <p className="text-xs text-slate-500 uppercase tracking-wide mb-1">
                            Motivo de la ruptura
                          </p>
                          <p className="text-sm text-slate-300">{entry.rupture_cause}</p>
                        </div>
                      )}

                      {entry.improvement_plan && (
                        <div>
                          <p className="text-xs text-slate-500 uppercase tracking-wide mb-1">
                            Plan de mejora
                          </p>
                          <p className="text-sm text-slate-300">{entry.improvement_plan}</p>
                        </div>
                      )}

                      {entry.generated_cost && (
                        <div>
                          <p className="text-xs text-slate-500 uppercase tracking-wide mb-1">
                            Gasto generado
                          </p>
                          <p className="text-sm text-slate-300">{entry.generated_cost}</p>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            ))
          )}
        </CardContent>
      </Card>

      {/* Feedback de calidad */}
      {submission.quality_feedback && (
        <Card className="border-slate-700 bg-slate-900/50">
          <CardHeader className="pb-4">
            <CardTitle className="text-lg text-slate-100">
              Feedback de Calidad
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-slate-300">{submission.quality_feedback}</p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}

export default async function ReportDetailPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = await params;
  
  return (
    <div className="container max-w-4xl py-6">
      <Suspense fallback={<LoadingState />}>
        <ReportDetail id={id} />
      </Suspense>
    </div>
  );
}
</file>

<file path="src/app/api/interviews/webhook/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase/server';

// =====================================================
// 1. FUNCIÓN DE ESPERA ACTIVA (La clave del éxito) 🕵️‍♂️
// =====================================================
async function getTranscriptWithRetry(conversationId: string, retries = 10, delayMs = 2000) {
  if (!conversationId) return null;

  const apiKey = process.env.ELEVENLABS_API_KEY;
  if (!apiKey) {
    console.error("❌ FALTA ELEVENLABS_API_KEY en .env");
    return "Error: API Key no configurada";
  }

  const url = `https://api.elevenlabs.io/v1/convai/conversations/${conversationId}`;

  for (let i = 0; i < retries; i++) {
    try {
      console.log(`⏳ [ElevenLabs] Intento ${i + 1}/${retries} obteniendo transcripción...`);
      
      const response = await fetch(url, {
        method: 'GET',
        headers: { 'xi-api-key': apiKey }
      });

      if (!response.ok) throw new Error(`API Error: ${response.status}`);

      const data = await response.json();
      
      // Verificamos si hay transcripción real
      if (data.transcript && data.transcript.length > 0) {
        // Formatear: "Role: Mensaje"
        const fullText = data.transcript
            .map((t: any) => `${t.role === 'agent' ? 'Entrevistador' : 'Candidato'}: ${t.message}`)
            .join('\n');
            
        console.log("✅ [ElevenLabs] Transcripción obtenida (" + fullText.length + " chars)");
        return fullText;
      }
      
    } catch (error) {
      console.warn(`⚠️ Intento ${i + 1} fallido, reintentando...`);
    }

    // Esperar 2 segundos antes del siguiente intento
    await new Promise(res => setTimeout(res, delayMs));
  }

  console.warn("⚠️ Timeout: ElevenLabs no entregó la transcripción a tiempo.");
  return null; // O devolver un string vacío si prefieres
}

// =====================================================
// 2. FUNCIÓN DE NOTIFICACIÓN
// =====================================================
async function notificarAlClasificador(datos: any) {
  // Ajusta esto a tu URL de Ngrok si pruebas Local-Prod, o localhost si es Local-Local
  const URL_DESTINO = process.env.INDEX1_WEBHOOK_URL || 'http://localhost:3001/webhooks/resultado-entrevista';

  console.log(`🚨 [INDEX 2] Enviando webhook a Index 1...`);
  
  try {
    const response = await fetch(URL_DESTINO, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
          token: datos.token, // Importante para que Index 1 lo reconozca
          interview_data: datos // Estructura que espera Index 1
      }),
    });

    if (!response.ok) {
      console.error(`❌ Error respuesta Index 1: ${response.status}`);
      return false;
    }
    
    const resultado = await response.json();
    console.log('✅ Index 1 confirmó recepción:', resultado);
    return true;
  } catch (error) {
    console.error('❌ Error conectando con Index 1:', error);
    return false;
  }
}

// =====================================================
// POST /api/interviews/complete
// =====================================================
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { token, conversation_id } = body; // Ignoramos 'transcript' del body, lo buscaremos nosotros

    if (!token) {
      return NextResponse.json({ success: false, error: 'Token requerido' }, { status: 400 });
    }

    const supabase = createAdminClient();

    // 1. Obtener entrevista
    const { data: interview, error: fetchError } = await supabase
      .from('interviews')
      .select('id, status, application_id')
      .eq('token', token)
      .single();

    if (fetchError || !interview) {
      return NextResponse.json({ success: false, error: 'Entrevista no encontrada' }, { status: 404 });
    }

    // 2. 🔥 OBTENER TRANSCRIPCIÓN REAL (Esperando a ElevenLabs) 🔥
    let finalTranscript = null;
    if (conversation_id) {
        finalTranscript = await getTranscriptWithRetry(conversation_id);
    }

    // Si falló la espera, usamos un fallback
    const transcriptToSave = finalTranscript || "Transcripción no disponible (Timeout o Error de API)";

    // 3. Completar en Supabase
    const { error: updateError } = await supabase
      .from('interviews')
      .update({
        status: 'completed',
        completed_at: new Date().toISOString(),
        elevenlabs_conversation_id: conversation_id || null,
        transcript: transcriptToSave // Guardamos la buena
      })
      .eq('id', interview.id);

    if (updateError) {
      console.error('Error completing interview DB:', updateError);
    } else {
        // Actualizar application status
        if (interview.application_id) {
            await supabase
                .from('applications')
                .update({ status: 'bot_completed' })
                .eq('id', interview.application_id);
        }
    }

    // 4. 🔥 NOTIFICAR AL INDEX 1 🔥
    await notificarAlClasificador({
        token: token,
        interview_id: interview.id,
        transcript: transcriptToSave, // Enviamos la completa
        audio_url: "", 
        summary: "Entrevista finalizada"
    });

    return NextResponse.json({
      success: true,
      data: { interview_id: interview.id, status: 'completed' },
    });

  } catch (error) {
    console.error('Unexpected error:', error);
    return NextResponse.json({ success: false, error: 'Error interno' }, { status: 500 });
  }
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from 'next';
import { GeistSans } from 'geist/font/sans';
import { GeistMono } from 'geist/font/mono';
import './globals.css';
import { Toaster } from 'sonner';

export const metadata: Metadata = {
  title: {
    default: 'Global Talent Platform',
    template: '%s | Global Talent',
  },
  description: 'Plataforma de gestión de talento y reclutamiento',
  icons: {
    icon: '/favicon.ico',
  },
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es" suppressHydrationWarning className="dark">
      <body
        className={`${GeistSans.variable} ${GeistMono.variable} min-h-screen bg-background font-sans antialiased`}
      >
        {children}
        <Toaster richColors position="top-right" />
      </body>
    </html>
  );
}
</file>

<file path="src/components/reportes/PlanEntryCard.tsx">
'use client';

// =====================================================
// PLAN GTC ENTRY - Componente de entrada individual
// =====================================================

import { memo, useCallback, useState } from 'react';
import { Trash2, GripVertical, ChevronDown, ChevronUp } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  type PlanEntryFormData,
  type Priority,
  type PlanStatus,
  PRIORITY_LABELS,
  PRIORITY_COLORS,
  PLAN_STATUS_LABELS,
} from '@/types/reports.types';
import { MagicWandButton } from '@/components/ui/MagicWandButton';

interface PlanEntryCardProps {
  entry: PlanEntryFormData;
  index: number;
  isExpanded: boolean;
  isLocked: boolean;
  errors?: Record<string, string[]>;
  onUpdate: (index: number, field: keyof PlanEntryFormData, value: string) => void;
  onRemove: (index: number) => void;
  onToggleExpand: (index: number) => void;
}

const PRIORITIES: Priority[] = ['alta', 'media', 'baja'];
const STATUSES: PlanStatus[] = ['no_iniciado', 'en_progreso', 'completado'];

function PlanEntryCardComponent({
  entry,
  index,
  isExpanded,
  isLocked,
  errors = {},
  onUpdate,
  onRemove,
  onToggleExpand,
}: PlanEntryCardProps) {
  const [isImproving, setIsImproving] = useState(false);

  const handleImproveEntry = async (e: React.MouseEvent) => {
    e.stopPropagation(); // Evitar colapsar al clickear el botón
    if (isImproving) return;

    // Verificar que haya al menos algo de contenido para mejorar
    const hasContent = entry.objective || entry.description || entry.key_result;
    if (!hasContent) return;

    setIsImproving(true);
    try {
      const response = await fetch('/api/ai/improve-entry', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          entry: {
            objective: entry.objective,
            description: entry.description,
            key_result: entry.key_result
          },
          type: 'plan'
        }),
      });

      if (!response.ok) throw new Error('Error improving entry');

      const data = await response.json();
      if (data.improvedEntry) {
        // Actualizar los campos recibidos
        if (data.improvedEntry.objective) onUpdate(index, 'objective', data.improvedEntry.objective);
        if (data.improvedEntry.description) onUpdate(index, 'description', data.improvedEntry.description);
        if (data.improvedEntry.key_result) onUpdate(index, 'key_result', data.improvedEntry.key_result);
      }
    } catch (error) {
      console.error('Failed to improve entry:', error);
    } finally {
      setIsImproving(false);
    }
  };

  const handleChange = useCallback(
    (field: keyof PlanEntryFormData) =>
      (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
        onUpdate(index, field, e.target.value);
      },
    [index, onUpdate]
  );
  const getFieldError = (field: string): string | undefined => {
    const key = `plan_entries.${index}.${field}`;
    return errors[key]?.[0];
  };

  const hasAnyError = Object.keys(errors).some((key) =>
    key.startsWith(`plan_entries.${index}.`)
  );

  return (
    <div
      className={cn(
        'group relative rounded-lg border transition-all duration-200',
        hasAnyError
          ? 'border-red-500/50 bg-red-500/5'
          : 'border-slate-700 bg-slate-800/50',
        isExpanded && 'ring-1 ring-emerald-500/30'
      )}
    >
      {/* Header - Siempre visible */}
      <div
        className={cn(
          'flex items-center gap-3 p-4',
          !isLocked && 'cursor-pointer'
        )}
        onClick={() => !isLocked && onToggleExpand(index)}
      >
        {/* Drag handle */}
        {!isLocked && (
          <div className="cursor-grab opacity-0 group-hover:opacity-50 transition-opacity">
            <GripVertical className="h-5 w-5 text-slate-500" />
          </div>
        )}

        {/* Número */}
        <div className="flex h-8 w-8 items-center justify-center rounded-full bg-slate-700 text-sm font-medium text-slate-300">
          {index + 1}
        </div>

        {/* Título / Objetivo (preview) */}
        <div className="flex-1 min-w-0">
          {entry.objective ? (
            <p className="text-sm font-medium text-slate-200 truncate">
              {entry.objective}
            </p>
          ) : (
            <p className="text-sm text-slate-500 italic">
              Sin objetivo definido
            </p>
          )}
        </div>

        {/* AI Action Button (Solo si está expandido y unlock) */}
        {!isLocked && isExpanded && (
          <Button
            type="button"
            variant="ghost"
            size="sm"
            onClick={handleImproveEntry}
            disabled={isImproving}
            className="hidden sm:flex items-center gap-1.5 text-emerald-400 hover:text-emerald-300 hover:bg-emerald-500/10 h-8 px-2"
            title="Mejorar redacción de todo el objetivo"
          >
            <MagicWandButton isLoading={isImproving} onClick={() => { }} className="bg-transparent p-0 hover:bg-transparent" />
            <span className="text-xs font-medium">{isImproving ? 'Mejorando...' : 'Mejorar (IA)'}</span>
          </Button>
        )}

        {/* Badges */}
        <div className="flex items-center gap-2">
          {/* ... badges code ... */}
          <Badge
            variant="outline"
            className={cn('text-xs', PRIORITY_COLORS[entry.priority])}
          >
            {PRIORITY_LABELS[entry.priority]}
          </Badge>
          <Badge
            variant="outline"
            className={cn(
              'text-xs',
              entry.status === 'completado'
                ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30'
                : entry.status === 'en_progreso'
                  ? 'bg-blue-500/20 text-blue-400 border-blue-500/30'
                  : 'bg-slate-500/20 text-slate-400 border-slate-500/30'
            )}
          >
            {PLAN_STATUS_LABELS[entry.status]}
          </Badge>
        </div>

        {/* Expand/Collapse */}
        {!isLocked && (
          <Button
            type="button"
            variant="ghost"
            size="sm"
            className="h-8 w-8 p-0 text-slate-400 hover:text-slate-200"
            onClick={(e) => {
              e.stopPropagation();
              onToggleExpand(index);
            }}
          >
            {isExpanded ? (
              <ChevronUp className="h-4 w-4" />
            ) : (
              <ChevronDown className="h-4 w-4" />
            )}
          </Button>
        )}

        {/* Delete */}
        {!isLocked && (
          <Button
            type="button"
            variant="ghost"
            size="sm"
            className="h-8 w-8 p-0 text-slate-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
            onClick={(e) => {
              e.stopPropagation();
              onRemove(index);
            }}
          >
            <Trash2 className="h-4 w-4" />
          </Button>
        )}
      </div>

      {/* Contenido expandido */}
      {isExpanded && (
        <div className="border-t border-slate-700 p-4 space-y-4">
          {/* Objetivo */}
          <div className="space-y-2">
            <Label htmlFor={`plan-${index}-objective`} className="text-slate-300">
              Objetivo <span className="text-red-400">*</span>
            </Label>
            <Input
              id={`plan-${index}-objective`}
              value={entry.objective}
              onChange={handleChange('objective')}
              disabled={isLocked}
              placeholder="Ej: Implementar piloto del callbot GTC"
              className={cn(
                'bg-slate-900/50 border-slate-700',
                getFieldError('objective') && 'border-red-500'
              )}
            />
            {getFieldError('objective') && (
              <p className="text-xs text-red-400">{getFieldError('objective')}</p>
            )}
          </div>

          {/* Descripción */}
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <Label htmlFor={`plan-${index}-description`} className="text-slate-300">
                Descripción <span className="text-red-400">*</span>
              </Label>
              {/* Individual AI button removed */}
            </div>
            <textarea
              id={`plan-${index}-description`}
              value={entry.description}
              onChange={handleChange('description')}
              disabled={isLocked}
              rows={3}
              placeholder="Describe el objetivo en detalle..."
              className={cn(
                'w-full rounded-md bg-slate-900/50 border border-slate-700 px-3 py-2 text-sm text-slate-100',
                'placeholder:text-slate-500 focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                'disabled:cursor-not-allowed disabled:opacity-50',
                getFieldError('description') && 'border-red-500'
              )}
            />
            {getFieldError('description') && (
              <p className="text-xs text-red-400">{getFieldError('description')}</p>
            )}
          </div>

          {/* Resultado clave */}
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <Label htmlFor={`plan-${index}-key_result`} className="text-slate-300">
                Resultado clave <span className="text-red-400">*</span>
              </Label>
              {/* Individual AI button removed */}
            </div>
            <textarea
              id={`plan-${index}-key_result`}
              value={entry.key_result}
              onChange={handleChange('key_result')}
              disabled={isLocked}
              rows={2}
              placeholder="¿Cómo se medirá el éxito de este objetivo?"
              className={cn(
                'w-full rounded-md bg-slate-900/50 border border-slate-700 px-3 py-2 text-sm text-slate-100',
                'placeholder:text-slate-500 focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                'disabled:cursor-not-allowed disabled:opacity-50',
                getFieldError('key_result') && 'border-red-500'
              )}
            />
            {getFieldError('key_result') && (
              <p className="text-xs text-red-400">{getFieldError('key_result')}</p>
            )}
          </div>

          {/* Row: Responsable + Prioridad + Estado + Fecha */}
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {/* Responsable */}
            <div className="space-y-2">
              <Label htmlFor={`plan-${index}-responsible`} className="text-slate-300">
                Responsable <span className="text-red-400">*</span>
              </Label>
              <Input
                id={`plan-${index}-responsible`}
                value={entry.responsible}
                onChange={handleChange('responsible')}
                disabled={isLocked}
                placeholder="Ej: Equipo de IA"
                className={cn(
                  "bg-slate-900/50 border-slate-700",
                  getFieldError('responsible') && 'border-red-500'
                )}
              />
              {getFieldError('responsible') && (
                <p className="text-xs text-red-400">{getFieldError('responsible')}</p>
              )}
            </div>

            {/* Prioridad */}
            <div className="space-y-2">
              <Label htmlFor={`plan-${index}-priority`} className="text-slate-300">
                Prioridad
              </Label>
              <select
                id={`plan-${index}-priority`}
                value={entry.priority}
                onChange={handleChange('priority')}
                disabled={isLocked}
                className={cn(
                  'w-full h-10 rounded-md bg-slate-900/50 border border-slate-700 px-3 text-sm text-slate-100',
                  'focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                  'disabled:cursor-not-allowed disabled:opacity-50'
                )}
              >
                {PRIORITIES.map((p) => (
                  <option key={p} value={p}>
                    {PRIORITY_LABELS[p]}
                  </option>
                ))}
              </select>
            </div>

            {/* Estado */}
            <div className="space-y-2">
              <Label htmlFor={`plan-${index}-status`} className="text-slate-300">
                Estado
              </Label>
              <select
                id={`plan-${index}-status`}
                value={entry.status}
                onChange={handleChange('status')}
                disabled={isLocked}
                className={cn(
                  'w-full h-10 rounded-md bg-slate-900/50 border border-slate-700 px-3 text-sm text-slate-100',
                  'focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                  'disabled:cursor-not-allowed disabled:opacity-50'
                )}
              >
                {STATUSES.map((s) => (
                  <option key={s} value={s}>
                    {PLAN_STATUS_LABELS[s]}
                  </option>
                ))}
              </select>
            </div>

            {/* Fecha objetivo */}
            <div className="space-y-2">
              <Label htmlFor={`plan-${index}-target_date`} className="text-slate-300">
                Fecha objetivo <span className="text-red-400">*</span>
              </Label>
              <Input
                id={`plan-${index}-target_date`}
                type="date"
                value={entry.target_date}
                onChange={handleChange('target_date')}
                disabled={isLocked}
                className={cn(
                  "bg-slate-900/50 border-slate-700",
                  getFieldError('target_date') && 'border-red-500'
                )}
              />
              {getFieldError('target_date') && (
                <p className="text-xs text-red-400">{getFieldError('target_date')}</p>
              )}
            </div>
          </div>

          {/* Comentarios */}
          <div className="space-y-2">
            <Label htmlFor={`plan-${index}-comments`} className="text-slate-300">
              Comentarios
            </Label>
            <textarea
              id={`plan-${index}-comments`}
              value={entry.comments}
              onChange={handleChange('comments')}
              disabled={isLocked}
              rows={2}
              placeholder="Notas adicionales, avances, bloqueos..."
              className={cn(
                'w-full rounded-md bg-slate-900/50 border border-slate-700 px-3 py-2 text-sm text-slate-100',
                'placeholder:text-slate-500 focus:border-emerald-500/50 focus:outline-none focus:ring-1 focus:ring-emerald-500/30',
                'disabled:cursor-not-allowed disabled:opacity-50'
              )}
            />
          </div>
        </div>
      )}
    </div>
  );
}

export const PlanEntryCard = memo(PlanEntryCardComponent);
</file>

<file path="src/components/shared/Sidebar.tsx">
'use client';

import Link from 'next/link';
import Image from 'next/image';
import { usePathname } from 'next/navigation';
import { useState, memo } from 'react';
import {
  LayoutDashboard,
  FileText,
  Users,
  Calendar,
  Settings,
  ChevronLeft,
  ChevronRight,
  ClipboardCheck,
  BarChart3,
  Briefcase,
  UserCheck,
  Search,
  Target,
  TrendingUp,
  Mic,
  UserPlus,
  Building2,
} from 'lucide-react';

import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import type {
  UserRole,
  UserDepartment,
  UserPosition,
  PermissionConfig
} from '@/types/database.types';
import { hasAccess } from '@/types/database.types';

// =====================================================
// CONFIGURACIÓN DE NAVEGACIÓN
// =====================================================

interface NavItem {
  label: string;
  href: string;
  icon: React.ElementType;
  permissions: PermissionConfig;
  badge?: number;
  isNew?: boolean;
}

interface NavSection {
  title: string;
  items: NavItem[];
}

const navSections: NavSection[] = [
  {
    title: 'General',
    items: [
      {
        label: 'Dashboard',
        href: '/dashboard',
        icon: LayoutDashboard,
        permissions: {
          departments: ['c_level', 'finance', 'sales', 'hr', 'quality', 'marketing', 'automation', 'development', 'operations'],
        },
      },
      {
        label: 'Reporte Semanal',
        href: '/reportes',
        icon: FileText,
        permissions: {
          departments: ['c_level', 'finance', 'sales', 'hr', 'quality', 'marketing', 'automation', 'development', 'operations'],
        },
      },
      {
        label: 'Informe Mensual',
        href: '/reportes/mensual',
        icon: BarChart3,
        permissions: {
          departments: ['c_level', 'finance', 'sales', 'hr', 'quality', 'marketing', 'automation', 'development', 'operations'],
        },
      },
      {
        label: 'Mi Perfil',
        href: '/perfil',
        icon: UserPlus,
        permissions: {
          departments: ['c_level', 'finance', 'sales', 'hr', 'quality', 'marketing', 'automation', 'development', 'operations'],
        },
      },
      {
        label: 'Calendario',
        href: '/calendario',
        icon: Calendar,
        permissions: {
          departments: ['c_level', 'finance', 'sales', 'hr', 'quality', 'marketing', 'automation', 'development', 'operations'],
        },
      },
    ],
  },
  {
    title: 'Calidad',
    items: [
      {
        label: 'Gestión Reportes',
        href: '/calidad/reportes',
        icon: ClipboardCheck,
        permissions: {
          departments: ['c_level', 'quality'],
          positions: ['ceo', 'coo', 'director', 'manager', 'specialist'],
        },
      },
      {
        label: 'Métricas Equipo',
        href: '/calidad/metricas',
        icon: BarChart3,
        permissions: {
          departments: ['c_level', 'quality'],
          positions: ['ceo', 'coo', 'director', 'manager'],
        },
      },
      {
        label: 'Asistentes',
        href: '/asistentes',
        icon: Users,
        permissions: {
          departments: ['c_level', 'quality'],
        },
      },
    ],
  },
  {
    title: 'RRHH',
    items: [
      {
        label: 'Candidatos',
        href: '/candidatos',
        icon: UserCheck,
        permissions: {
          departments: ['c_level', 'hr', 'sales'],
        },
      },
      {
        label: 'Entrevistas',
        href: '/entrevistas',
        icon: Mic,
        permissions: {
          departments: ['c_level', 'hr'],
        },
        isNew: true,
      },
      {
        label: 'Banco Talento',
        href: '/banco-talento',
        icon: Search,
        permissions: {
          departments: ['c_level', 'hr', 'sales'],
        },
      },
    ],
  },
  {
    title: 'Ventas',
    items: [
      {
        label: 'Leads',
        href: '/leads',
        icon: Target,
        permissions: {
          departments: ['c_level', 'sales', 'finance', 'quality'],
          positions: ['ceo', 'coo', 'director', 'manager'],
        },
      },
      {
        label: 'Clientes',
        href: '/clientes',
        icon: Building2,
        permissions: {
          departments: ['c_level', 'sales', 'finance'],
          positions: ['ceo', 'coo', 'director', 'manager'],
        },
      },
    ],
  },
  {
    title: 'Dirección',
    items: [
      {
        label: 'Panel Ejecutivo',
        href: '/ejecutivo',
        icon: TrendingUp,
        permissions: {
          departments: ['c_level'],
          positions: ['ceo', 'coo'],
        },
      },
      {
        label: 'Calendario Global',
        href: '/calendario-global',
        icon: Calendar,
        permissions: {
          departments: ['c_level'],
          positions: ['ceo', 'coo'],
        },
      },
      {
        label: 'Configuración',
        href: '/configuracion',
        icon: Settings,
        permissions: {
          departments: ['c_level', 'automation'],
          positions: ['ceo', 'coo', 'director'],
        },
      },
    ],
  },
];

// =====================================================
// COMPONENTE SIDEBAR
// =====================================================

interface SidebarProps {
  userRole: UserRole;
  userDepartment?: UserDepartment | null;
  userPosition?: UserPosition | null;
}

const SidebarComponent = ({
  userRole,
  userDepartment,
  userPosition
}: SidebarProps) => {
  const [collapsed, setCollapsed] = useState(false);
  const pathname = usePathname();

  // Filtrar secciones e items según permisos
  const filteredSections = navSections
    .map((section) => ({
      ...section,
      items: section.items.filter((item) =>
        hasAccess(userDepartment ?? null, userPosition ?? null, userRole, item.permissions)
      ),
    }))
    .filter((section) => section.items.length > 0);

  return (
    <TooltipProvider delayDuration={0}>
      <aside
        className={cn(
          'fixed left-0 top-0 z-40 flex h-screen flex-col border-r border-white/5 bg-slate-950/80 backdrop-blur-xl transition-all duration-300',
          collapsed ? 'w-16' : 'w-64'
        )}
      >
        {/* Logo */}
        <div className="flex h-20 items-center justify-center border-b border-white/5 py-2 px-6">
          {!collapsed && (
            <Link href="/dashboard" className="relative w-full h-full flex items-center justify-center">
              <Image
                src="/logo.png"
                alt="Global Talent"
                fill
                className="object-contain"
                priority
              />
            </Link>
          )}
          {collapsed && (
            <Link
              href="/dashboard"
              className="relative w-10 h-10 flex items-center justify-center"
            >
              <Image
                src="/logo.png"
                alt="GT"
                fill
                className="object-contain"
                priority
              />
            </Link>
          )}
        </div>

        {/* Navegación */}
        <nav className="flex-1 overflow-y-auto p-3 custom-scrollbar">
          {filteredSections.map((section, sectionIndex) => (
            <div key={section.title} className={cn(sectionIndex > 0 && 'mt-6')}>
              {/* Título de sección */}
              {!collapsed && (
                <h3 className="mb-2 px-3 text-xs font-semibold uppercase tracking-wider text-slate-500">
                  {section.title}
                </h3>
              )}

              {/* Items de la sección */}
              <div className="space-y-1">
                {section.items.map((item) => {
                  const isActive =
                    pathname === item.href || pathname.startsWith(`${item.href}/`);
                  const Icon = item.icon;

                  const linkContent = (
                    <Link
                      href={item.href}
                      className={cn(
                        'sidebar-link',
                        isActive && 'sidebar-link--active',
                        collapsed && 'justify-center px-2'
                      )}
                    >
                      <Icon className="h-5 w-5 shrink-0" />
                      {!collapsed && (
                        <>
                          <span className="flex-1">{item.label}</span>
                          {item.isNew && (
                            <span className="flex h-5 items-center rounded bg-blue-500/20 px-1.5 text-[10px] font-medium text-blue-400">
                              NUEVO
                            </span>
                          )}
                          {item.badge && item.badge > 0 && (
                            <span className="flex h-5 min-w-5 items-center justify-center rounded-full bg-blue-500 px-1.5 text-xs font-medium text-white">
                              {item.badge}
                            </span>
                          )}
                        </>
                      )}
                    </Link>
                  );

                  if (collapsed) {
                    return (
                      <Tooltip key={item.href}>
                        <TooltipTrigger asChild>{linkContent}</TooltipTrigger>
                        <TooltipContent side="right" className="flex items-center gap-2">
                          {item.label}
                          {item.isNew && (
                            <span className="rounded bg-blue-500/20 px-1 text-[10px] font-medium text-blue-400">
                              NUEVO
                            </span>
                          )}
                          {item.badge && item.badge > 0 && (
                            <span className="flex h-5 min-w-5 items-center justify-center rounded-full bg-blue-500 px-1.5 text-xs font-medium text-white">
                              {item.badge}
                            </span>
                          )}
                        </TooltipContent>
                      </Tooltip>
                    );
                  }

                  return <div key={item.href}>{linkContent}</div>;
                })}
              </div>
            </div>
          ))}
        </nav>

        {/* Toggle collapse */}
        <div className="border-t border-slate-800 p-3">
          <Button
            variant="ghost"
            size="sm"
            onClick={() => setCollapsed(!collapsed)}
            className={cn(
              'w-full justify-center text-slate-400 hover:text-white hover:bg-slate-800',
              !collapsed && 'justify-start'
            )}
          >
            {collapsed ? (
              <ChevronRight className="h-4 w-4" />
            ) : (
              <>
                <ChevronLeft className="h-4 w-4 mr-2" />
                <span>Colapsar</span>
              </>
            )}
          </Button>
        </div>
      </aside>
    </TooltipProvider>
  );
};

export const Sidebar = memo(SidebarComponent);
export default Sidebar;
</file>

<file path="src/types/database.types.ts">
// =====================================================
// src/types/database.types.ts
// TIPOS ACTUALIZADOS CON PERMISOS Y PERFIL COMPLETO
// =====================================================

// =====================================================
// ENUMS DE PERMISOS
// =====================================================

export type UserDepartment =
  | 'c_level'      // CEO, COO
  | 'finance'      // Antonio
  | 'sales'        // Pilar
  | 'hr'           // Gladymar, Viviana
  | 'quality'      // Norma, Fabiola, Suany
  | 'marketing'    // Jennifer
  | 'automation'   // Ariel, Nelson
  | 'development'  // Javier
  | 'operations';  // Asistentes externos

export type UserPosition =
  | 'ceo'
  | 'coo'
  | 'director'
  | 'manager'
  | 'specialist'
  | 'assistant';

// Mantener compatibilidad con el sistema anterior
export type UserRole = 'admin' | 'calidad' | 'rrhh' | 'marketing' | 'asistente';

// =====================================================
// TIPO DE ASISTENTE (según Zoho CRM)
// =====================================================

export type AssistantType =
  | 'gestor_operaciones'
  | 'proyectos_software'
  | 'desarrollo_web'
  | 'comunicaciones'
  | 'financiero_contable'
  | 'marketing_digital'
  | 'administrativo'
  | 'ventas_ecommerce';

export const ASSISTANT_TYPE_LABELS: Record<AssistantType, string> = {
  gestor_operaciones: 'Gestor de Operaciones',
  proyectos_software: 'Proyectos de Software',
  desarrollo_web: 'Desarrollo Web',
  comunicaciones: 'Comunicaciones',
  financiero_contable: 'Financiero y Contable',
  marketing_digital: 'Marketing Digital',
  administrativo: 'Administrativo',
  ventas_ecommerce: 'Ventas / E-commerce',
};

export const ASSISTANT_TYPE_COLORS: Record<AssistantType, string> = {
  gestor_operaciones: 'bg-slate-600',
  proyectos_software: 'bg-gray-500',
  desarrollo_web: 'bg-green-600',
  comunicaciones: 'bg-orange-500',
  financiero_contable: 'bg-yellow-500',
  marketing_digital: 'bg-lime-500',
  administrativo: 'bg-blue-500',
  ventas_ecommerce: 'bg-purple-500',
};

// =====================================================
// TIPOS DE CONTRATO
// =====================================================

export type ContractType = 'tiempo_completo' | 'medio_tiempo' | 'por_proyecto';

export const CONTRACT_TYPE_LABELS: Record<ContractType, string> = {
  tiempo_completo: 'Tiempo Completo (40h)',
  medio_tiempo: 'Medio Tiempo (20h)',
  por_proyecto: 'Por Proyecto',
};

// =====================================================
// PERFIL DE USUARIO
// =====================================================

export interface Profile {
  id: string;
  email: string;
  full_name: string | null;
  role: UserRole;
  department: UserDepartment | null;
  position: UserPosition | null;
  phone: string | null;
  timezone: string;
  country: string | null;
  avatar_url: string | null;
  created_at: string;
  updated_at: string;
}

// =====================================================
// ASISTENTE VIRTUAL (Perfil completo)
// =====================================================

export interface Assistant {
  id: string;
  user_id: string;
  full_name: string;
  email: string;
  phone: string | null;
  status: 'activo' | 'inactivo' | 'vacaciones' | 'baja';
  position: string | null;

  // Datos de asignación
  client_id: string | null;
  assistant_type: AssistantType | null;

  // Contrato
  contract_type: ContractType;
  work_schedule: string; // "10:30-19:30"
  start_date: string | null;

  // Ubicación
  timezone: string;
  country: string | null;

  // Objetivos (JSONB)
  weekly_objectives: WeeklyObjective[];
  monthly_objectives: MonthlyObjective[];

  // Habilidades
  skills: string[];
  languages: string[];

  // Metadata
  created_at: string;
  updated_at: string;
}

export interface WeeklyObjective {
  id: string;
  objective: string;
  description: string;
  key_result: string;
  priority: 'alta' | 'media' | 'baja';
  status: 'pendiente' | 'en_progreso' | 'completado';
  due_date: string;
  comments: string;
}

export interface MonthlyObjective {
  id: string;
  objective: string;
  description: string;
  key_result: string;
  progress: number; // 0-100
  status: 'pendiente' | 'en_progreso' | 'completado';
}

// =====================================================
// INFORMES MENSUALES (Nuevo Módulo)
// =====================================================

export interface MonthlyActivity {
  id: string; // generated client-side or by index
  category: string;
  description: string;
}

export interface MonthlyObjectiveEntry {
  id: string;
  established: string;
  achieved: string;
}

export interface MonthlySuggestion {
  id: string;
  description: string;
}

export interface MonthlyMetric {
  id: string;
  name: string;
  url: string;
  size: number;
  type: string;
}

export interface MonthlyReport {
  id: string;
  assistant_id: string;
  month: number;
  year: number;
  status: 'borrador' | 'enviado';

  // Secciones JSONB
  activities: MonthlyActivity[];
  objectives: MonthlyObjectiveEntry[];
  suggestions: MonthlySuggestion[];
  metrics_files: MonthlyMetric[];

  created_at: string;
  updated_at: string;
}

// =====================================================
// ASISTENTE CON RELACIONES
// =====================================================

export interface AssistantWithDetails extends Assistant {
  client?: {
    id: string;
    name: string;
  } | null;
  profile?: Profile | null;
}

// =====================================================
// LEADS (Pipeline de ventas)
// =====================================================

export type LeadStatus =
  | 'new'
  | 'to_contact'    // Contactar
  | 'contacted'
  | 'files_sent'    // Fichas Enviadas
  | 'interested'
  | 'presenting'
  | 'negotiating'
  | 'contract_sent'
  | 'won'
  | 'lost'
  | 'frozen';

export type LeadUrgency = 'low' | 'medium' | 'high' | 'urgent';
export type LeadSource = 'linkedin' | 'referral' | 'website' | 'cold_call' | 'event' | 'other';

export const LEAD_STATUS_LABELS: Record<LeadStatus, string> = {
  new: 'Nuevo',
  to_contact: 'Contactar',
  contacted: 'En Conversación',
  files_sent: 'Fichas Enviadas',
  interested: 'Interesado',
  presenting: 'Presentando',
  negotiating: 'Negociando',
  contract_sent: 'Contrato enviado',
  won: 'Ganado',
  lost: 'Perdido',
  frozen: 'Congelado',
};

export const LEAD_STATUS_COLORS: Record<LeadStatus, string> = {
  new: 'bg-blue-500',
  to_contact: 'bg-indigo-500',
  contacted: 'bg-cyan-500',
  files_sent: 'bg-violet-500',
  interested: 'bg-teal-500',
  presenting: 'bg-emerald-500',
  negotiating: 'bg-amber-500',
  contract_sent: 'bg-orange-500',
  won: 'bg-green-600',
  lost: 'bg-red-500',
  frozen: 'bg-slate-500',
};

export interface Lead {
  id: string;
  company_name: string;
  contact_name: string | null;
  contact_email: string | null;
  contact_phone: string | null;
  website: string | null;
  linkedin_url: string | null;

  assistant_type: AssistantType | null;
  quantity: number;
  budget_min: number | null;
  budget_max: number | null;
  urgency: LeadUrgency;
  notes: string | null;

  status: LeadStatus;
  assigned_to: string | null;

  presented_candidates: string[];

  first_contact_at: string | null;
  last_contact_at: string | null;
  expected_close_date: string | null;

  lost_reason: string | null;
  converted_client_id: string | null;

  source: LeadSource;
  zoho_lead_id: string | null;

  created_at: string;
  updated_at: string;
}

// =====================================================
// CANDIDATOS EN BANCO (listos para asignar)
// =====================================================

export type CandidateBankStatus =
  | 'available'
  | 'presented'
  | 'interviewing'
  | 'selected'
  | 'contracted'
  | 'unavailable';

export const CANDIDATE_BANK_STATUS_LABELS: Record<CandidateBankStatus, string> = {
  available: 'Disponible',
  presented: 'Presentado',
  interviewing: 'En entrevista',
  selected: 'Seleccionado',
  contracted: 'Contratado',
  unavailable: 'No disponible',
};

export interface AssistantCandidate {
  id: string;
  candidate_id: string | null;
  application_id: string | null;

  full_name: string;
  email: string;
  phone: string | null;

  assistant_type: AssistantType;
  skills: string[];
  languages: string[];

  cv_score: number | null;
  video_score: number | null;
  bot_score: number | null;
  human_interview_score: number | null;
  final_score: number | null;

  status: CandidateBankStatus;

  current_lead_id: string | null;
  current_client_id: string | null;
  recruiter_id: string | null;

  cv_url: string | null;
  video_url: string | null;
  ficha_url: string | null;

  zoho_candidate_id: string | null;

  created_at: string;
  updated_at: string;
}

// =====================================================
// HELPERS DE PERMISOS
// =====================================================

export interface PermissionConfig {
  departments: UserDepartment[];
  positions?: UserPosition[];
  // 'all' significa que aplica a todos dentro de los departamentos especificados
}

/**
 * Verifica si un usuario tiene acceso basado en departamento y posición
 */
export function hasAccess(
  userDepartment: UserDepartment | null,
  userPosition: UserPosition | null,
  userRole: UserRole,
  config: PermissionConfig
): boolean {
  // Admin siempre tiene acceso
  if (userRole === 'admin') return true;

  // Si no tiene departamento asignado, usar el mapeo de role
  const effectiveDepartment = userDepartment || mapRoleToDepartment(userRole);

  // Verificar departamento
  if (!config.departments.includes(effectiveDepartment)) {
    return false;
  }

  // Si no se especifican posiciones, cualquier posición del departamento tiene acceso
  if (!config.positions || config.positions.length === 0) {
    return true;
  }

  // Verificar posición
  const effectivePosition = userPosition || 'assistant';
  return config.positions.includes(effectivePosition);
}

/**
 * Mapea roles legacy a departamentos
 */
export function mapRoleToDepartment(role: UserRole): UserDepartment {
  const mapping: Record<UserRole, UserDepartment> = {
    admin: 'c_level',
    calidad: 'quality',
    rrhh: 'hr',
    marketing: 'marketing',
    asistente: 'operations',
  };
  return mapping[role];
}

/**
 * Obtiene el label del departamento
 */
export const DEPARTMENT_LABELS: Record<UserDepartment, string> = {
  c_level: 'Dirección',
  finance: 'Finanzas',
  sales: 'Ventas',
  hr: 'Recursos Humanos',
  quality: 'Calidad',
  marketing: 'Marketing',
  automation: 'Automatización',
  development: 'Desarrollo',
  operations: 'Operaciones',
};

/**
 * Obtiene el label de la posición
 */
export const POSITION_LABELS: Record<UserPosition, string> = {
  ceo: 'CEO',
  coo: 'COO',
  director: 'Director',
  manager: 'Manager',
  specialist: 'Especialista',
  assistant: 'Asistente',
};

// =====================================================
// TIPOS DE BASE DE DATOS (para Supabase)
// =====================================================

export interface Database {
  public: {
    Tables: {
      profiles: {
        Row: Profile;
        Insert: Omit<Profile, 'created_at' | 'updated_at'>;
        Update: Partial<Omit<Profile, 'id' | 'created_at'>>;
      };
      assistants: {
        Row: Assistant;
        Insert: Omit<Assistant, 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Omit<Assistant, 'id' | 'created_at'>>;
      };
      leads: {
        Row: Lead;
        Insert: Omit<Lead, 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Omit<Lead, 'id' | 'created_at'>>;
      };
      assistant_candidates: {
        Row: AssistantCandidate;
        Insert: Omit<AssistantCandidate, 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Omit<AssistantCandidate, 'id' | 'created_at'>>;
      };
      monthly_reports: {
        Row: MonthlyReport;
        Insert: Omit<MonthlyReport, 'id' | 'created_at' | 'updated_at'>;
        Update: Partial<Omit<MonthlyReport, 'id' | 'created_at'>>;
      };
    };
  };
}
</file>

<file path="src/middleware.ts">
import { createServerClient } from '@supabase/ssr';
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import type { Database } from '@/types/database.types';

/**
 * Middleware de autenticación y protección de rutas
 * - Verifica la sesión del usuario
 * - Redirige a login si no está autenticado
 * - Maneja refresh de tokens
 * - EXCLUYE rutas públicas de candidatos (/entrevista/*)
 */

// Rutas públicas que no requieren autenticación
const PUBLIC_ROUTES = [
  '/login',
  '/register',
  '/auth/callback',
  '/auth/error',
  '/entrevista',  // Sala de entrevistas para candidatos
];

// Rutas que requieren departamentos específicos
const DEPARTMENT_ROUTES: Record<string, string[]> = {
  '/configuracion': ['c_level', 'development'], // Antes: admin
  '/metricas': ['c_level', 'quality', 'marketing', 'sales'], // Antes: admin, calidad, marketing
  '/calidad': ['c_level', 'quality'], // Antes: admin, calidad
  '/busquedas': ['c_level', 'hr'], // Antes: admin, rrhh
  '/candidatos': ['c_level', 'hr'], // Antes: admin, rrhh
  '/entrevistas': ['c_level', 'hr', 'quality'], // Antes: admin, rrhh, calidad
};

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // =====================================================
  // 1. EXCEPCIÓN: DEJAR PASAR TODO LO QUE SEA API
  // (matcher puede excluir /api, pero por si acaso lo declaramos aquí también)
  // =====================================================
  if (pathname.startsWith('/api')) {
    return NextResponse.next();
  }

  // =====================================================
  // PREPARAR RESPUESTA
  // =====================================================
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  // Crear cliente de Supabase para middleware usando @supabase/ssr
  const supabase = createServerClient<Database>(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          // Establecer en las cookies de la request para que getUser vea las cookies actualizadas
          cookiesToSet.forEach(({ name, value }) =>
            request.cookies.set(name, value)
          );
          // También establecer en las cookies de la response para actualizar el navegador
          response = NextResponse.next({
            request: {
              headers: request.headers,
            },
          });
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  // =====================================================
  // VERIFICAR SI ES RUTA PÚBLICA
  // =====================================================
  const isPublicRoute = PUBLIC_ROUTES.some((route) => pathname.startsWith(route));

  // Si es ruta pública, no necesitamos verificar autenticación
  if (isPublicRoute) {
    return response;
  }

  // =====================================================
  // VERIFICAR AUTENTICACIÓN PARA RUTAS PROTEGIDAS
  // =====================================================
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser();

  // Solo registrar errores reales (no "Auth session missing!" cuando no hay usuario)
  if (error && !(error.message === 'Auth session missing!' && !user)) {
    console.error('Session error in middleware:', error.message);
  }

  // Si no hay usuario y no es ruta pública, redirigir a login
  if (!user) {
    const redirectUrl = new URL('/login', request.url);
    redirectUrl.searchParams.set('redirectTo', pathname);
    return NextResponse.redirect(redirectUrl);
  }

  // Si hay usuario y está en login, redirigir al dashboard
  if (pathname === '/login') {
    return NextResponse.redirect(new URL('/dashboard', request.url));
  }

  // =====================================================
  // VERIFICAR PERMISOS DE ROL/DEPARTAMENTO
  // =====================================================
  // Obtener el rol y departamento del usuario desde el profile
  const { data: profile } = await supabase
    .from('profiles')
    .select('role, department, position')
    .eq('id', user.id)
    .single();

  if (profile) {
    // Mapeo de compatibilidad para roles legacy si department es null
    let effectiveDepartment = profile.department;

    // Si no tiene departamento asignado, intentar inferir del rol legacy
    if (!effectiveDepartment && profile.role) {
      const roleMap: Record<string, string> = {
        'admin': 'c_level',
        'calidad': 'quality',
        'rrhh': 'hr',
        'marketing': 'marketing',
        'asistente': 'operations'
      };
      effectiveDepartment = roleMap[profile.role] || 'operations';
    }

    // Verificar si la ruta requiere un departamento específico
    for (const [route, allowedDepartments] of Object.entries(DEPARTMENT_ROUTES)) {
      if (pathname.startsWith(route)) {
        if (!effectiveDepartment || !allowedDepartments.includes(effectiveDepartment)) {
          // Usuario no tiene permiso, redirigir a dashboard con error
          const redirectUrl = new URL('/dashboard', request.url);
          redirectUrl.searchParams.set('error', 'unauthorized');
          return NextResponse.redirect(redirectUrl);
        }
        break;
      }
    }

    // Agregar headers para uso en server components
    if (profile.role) response.headers.set('x-user-role', profile.role);
    if (profile.department) response.headers.set('x-user-department', profile.department);
    if (profile.position) response.headers.set('x-user-position', profile.position);
  }

  return response;
}

// Configurar qué rutas ejecutan el middleware
export const config = {
  matcher: [
    /*
     * Coincide con todas las rutas excepto:
     * 1. /api/ (rutas API)
     * 2. /_next/ (archivos estáticos de next)
     * 3. favicon.ico
     * 4. Archivos con extensión (png, jpg, etc.)
     */
    '/((?!api|_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
};
</file>

<file path="README.md">
# 🚀 Global Talent Platform

Plataforma ERP custom para gestión de reclutamiento y talento.

## 📋 Requisitos Previos

- Node.js 18+ 
- npm o pnpm
- Cuenta de Supabase (proyecto creado)

## 🛠️ Instalación

### 1. Clonar e instalar dependencias

```bash
# Instalar dependencias
npm install

# O con pnpm (recomendado)
pnpm install
```

### 2. Configurar variables de entorno

```bash
# Copiar el archivo de ejemplo
cp .env.local.example .env.local

# Editar con tus credenciales de Supabase
```

### 3. Configurar Supabase

1. Crear un nuevo proyecto en [Supabase](https://supabase.com)
2. Ejecutar el schema SQL en el SQL Editor de Supabase (archivo `DATABASE_SCHEMA.sql`)
3. Copiar las credenciales (URL y Anon Key) a tu `.env.local`

### 4. Instalar componentes de shadcn/ui

```bash
# Inicializar shadcn/ui
npx shadcn@latest init

# Instalar componentes necesarios
npx shadcn@latest add button
npx shadcn@latest add card
npx shadcn@latest add input
npx shadcn@latest add select
npx shadcn@latest add dialog
npx shadcn@latest add alert
npx shadcn@latest add badge
npx shadcn@latest add table
npx shadcn@latest add calendar
npx shadcn@latest add dropdown-menu
npx shadcn@latest add avatar
npx shadcn@latest add tabs
npx shadcn@latest add toast
npx shadcn@latest add tooltip
npx shadcn@latest add popover
npx shadcn@latest add separator
npx shadcn@latest add progress
npx shadcn@latest add switch
npx shadcn@latest add checkbox
npx shadcn@latest add label
```

### 5. Generar tipos de TypeScript

```bash
# Instalar Supabase CLI si no está instalado
npm install -g supabase

# Login a Supabase
supabase login

# Generar tipos (reemplazar PROJECT_ID con tu ID)
npm run db:generate-types
```

### 6. Ejecutar en desarrollo

```bash
npm run dev
```

Abrir [http://localhost:3000](http://localhost:3000) en el navegador.

## 📁 Estructura del Proyecto

```
src/
├── app/                    # Next.js App Router
│   ├── (auth)/            # Rutas de autenticación
│   ├── (dashboard)/       # Rutas protegidas del dashboard
│   ├── api/               # API Routes
│   └── globals.css        # Estilos globales
│
├── components/
│   ├── ui/               # Componentes shadcn/ui
│   ├── shared/           # Componentes compartidos
│   ├── calidad/          # Componentes del módulo Calidad
│   ├── reportes/         # Componentes del módulo Reportes
│   └── calendario/       # Componentes del módulo Calendario
│
├── lib/
│   ├── supabase/         # Cliente y configuración de Supabase
│   ├── hooks/            # Custom hooks
│   └── utils/            # Funciones de utilidad
│
└── types/                # Tipos de TypeScript
```

## 🔐 Roles y Permisos

| Rol       | Permisos                                           |
| --------- | -------------------------------------------------- |
| Admin     | Acceso total, gestión de usuarios                  |
| Calidad   | Dashboard de alertas, reportes, fichas             |
| RRHH      | Búsquedas, candidatos, calendario de entrevistas   |
| Marketing | Métricas generales, acceso a scraping              |
| Asistente | Cargar reportes, ver su ficha, calendario          |

## 🎨 Tema y Diseño

- **Dark mode** por defecto (fondo #020617)
- **Paleta**: Slate + Emerald (success) + Amber (warnings)
- **Componentes**: shadcn/ui
- **Iconos**: Lucide React

## 📊 Base de Datos

La base de datos incluye:

- `profiles` - Usuarios y roles
- `assistants` - Asistentes contratados
- `weekly_reports` - Reportes semanales
- `clients` - Clientes
- `job_searches` - Búsquedas laborales
- `candidates` - Candidatos
- `calendar_events` - Eventos del calendario
- `alerts` - Sistema de alertas
- `activity_logs` - Auditoría

Row Level Security (RLS) está habilitado en todas las tablas.

## 🚀 Deploy

### Vercel (Recomendado)

1. Conectar el repositorio a Vercel
2. Configurar las variables de entorno
3. Deploy automático

```bash
# O manual con Vercel CLI
vercel
```

## 📝 Scripts Disponibles

```bash
npm run dev          # Servidor de desarrollo
npm run build        # Build de producción
npm run start        # Servidor de producción
npm run lint         # Linter
npm run db:generate-types  # Generar tipos de Supabase
```

## 🤝 Contribuir

1. Crear un branch (`git checkout -b feature/nueva-funcionalidad`)
2. Commit cambios (`git commit -m 'Agregar nueva funcionalidad'`)
3. Push al branch (`git push origin feature/nueva-funcionalidad`)
4. Abrir un Pull Request

## 📄 Licencia

Proyecto privado - Global Talent © 2024
</file>

<file path="src/app/(auth)/login/page.tsx">
'use client';

import { useState, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import Link from 'next/link';
import Image from 'next/image';
import { Eye, EyeOff, Loader2, AlertCircle, Check } from 'lucide-react';
import { createClient } from '@/lib/supabase/client';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Card,
  CardContent,
  CardFooter,
  CardHeader,
  CardTitle,
  CardDescription
} from '@/components/ui/card';
import { cn } from '@/lib/utils';

// DEV MODE USERS
const DEV_USERS = [
  { name: 'Daniel (CEO)', email: 'daniel@globaltalent.com', role: 'Director', color: 'bg-blue-600' },
  { name: 'Victor', email: 'victor@globaltalent.com', role: 'COO / Ops', color: 'bg-slate-500' },
  { name: 'Norma', email: 'norma@globaltalent.com', role: 'Calidad', color: 'bg-cyan-500' },
  { name: 'Gladymar', email: 'gladymar@globaltalent.com', role: 'RRHH', color: 'bg-pink-500' },
  { name: 'Viviana', email: 'viviana@globaltalent.com', role: 'RRHH', color: 'bg-purple-500' },
  { name: 'Reyna', email: 'reyna@globaltalent.com', role: 'Revisión RRHH', color: 'bg-indigo-500' },
  { name: 'Pilar', email: 'pilar@globaltalent.com', role: 'Ventas (Closer)', color: 'bg-emerald-500' },
  { name: 'Jennifer', email: 'jennifer@globaltalent.com', role: 'Marketing', color: 'bg-orange-500' },
  { name: 'Admin', email: 'admin@globaltalent.com', role: 'Superusuario', color: 'bg-red-500' },
];

function ProfileSelector({ onSelect }: { onSelect: (email: string) => void }) {
  return (
    <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500">
      <div className="text-center mb-6">
        <h2 className="text-xl font-semibold text-white">Acceso Staff</h2>
        <p className="text-sm text-slate-400">Seleccioná tu perfil de desarrollo</p>
      </div>

      <div className="grid gap-3 max-h-[60svh] overflow-y-auto pr-2 custom-scrollbar">
        {DEV_USERS.map((user) => (
          <button
            key={user.email}
            onClick={() => onSelect(user.email)}
            className="flex items-center gap-4 p-3 rounded-xl bg-slate-800/50 border border-slate-700/50 hover:bg-slate-800 hover:border-slate-600 transition-all text-left group"
          >
            <div className={cn("h-10 w-10 rounded-full flex items-center justify-center text-white font-bold shrink-0 shadow-lg", user.color)}>
              {user.name.charAt(0)}
            </div>
            <div className="flex-1 min-w-0">
              <p className="font-medium text-slate-200 group-hover:text-white truncate">{user.name}</p>
              <p className="text-xs text-slate-500 uppercase tracking-wider">{user.role}</p>
            </div>
            <div className="opacity-0 group-hover:opacity-100 transition-opacity">
              <div className="h-8 w-8 rounded-full bg-white/10 flex items-center justify-center">
                <Check className="h-4 w-4 text-white" />
              </div>
            </div>
          </button>
        ))}
      </div>

      <div className="pt-4 border-t border-slate-800">
        <Button
          variant="ghost"
          className="w-full text-slate-400 hover:text-white"
          onClick={() => onSelect('back')}
        >
          ← Volver al login
        </Button>
      </div>
    </div>
  );
}

function LoginForm() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const redirectTo = searchParams.get('redirectTo') || '/dashboard';

  const [mode, setMode] = useState<'selector' | 'form'>('form');
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const supabase = createClient();

  // Auto-login logic for dev selector
  const handleProfileSelect = async (selectedEmail: string) => {
    if (selectedEmail === 'back') {
      setMode('form');
      return;
    }

    setEmail(selectedEmail);
    // Hardcoded dev password
    const devPassword = 'globaltalent2026';
    setPassword(devPassword);

    // Trigger login immediately
    await performLogin(selectedEmail, devPassword);
  };

  const performLogin = async (emailInput: string, passwordInput: string) => {
    setIsLoading(true);
    setError(null);

    try {
      const { data, error: signInError } = await supabase.auth.signInWithPassword({
        email: emailInput,
        password: passwordInput,
      });

      if (signInError) {
        if (signInError.message.includes('Invalid login credentials')) {
          setError('Credenciales incorrectas. Verifica tu email y contraseña.');
          setMode('form'); // Fallback to form on error
        } else {
          setError(signInError.message);
        }
        return;
      }

      if (data.user) {
        router.push(redirectTo);
        router.refresh();
      }
    } catch {
      setError('Ocurrió un error inesperado.');
    } finally {
      setIsLoading(false);
    }
  };

  const handleManualSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    await performLogin(email, password);
  };

  return (
    <Card className="border-white/10 bg-slate-900/60 backdrop-blur-xl shadow-2xl relative overflow-hidden">
      {/* Background decoration */}
      <div className="absolute top-0 right-0 -mt-20 -mr-20 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl pointer-events-none" />
      <div className="absolute bottom-0 left-0 -mb-20 -ml-20 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl pointer-events-none" />

      <CardHeader className="space-y-1 text-center">
        {/* Logo restored */}
        <div className="mx-auto mb-8 flex h-48 w-64 items-center justify-center relative">
          <Image
            src="/logo.png"
            alt="Global Talent"
            fill
            className="object-contain drop-shadow-lg"
          />
        </div>

        <CardTitle className="text-2xl font-semibold tracking-tight">
          Bienvenido
        </CardTitle>
        <CardDescription className="text-slate-400">
          Ingresa tus credenciales para acceder
        </CardDescription>
      </CardHeader>

      <CardContent className="space-y-4">
        {mode === 'selector' ? (
          <ProfileSelector onSelect={handleProfileSelect} />
        ) : (
          <form onSubmit={handleManualSubmit} className="space-y-4 animate-in fade-in slide-in-from-left-4 duration-300">
            {error && (
              <div className="flex items-center gap-2 rounded-lg border border-red-500/30 bg-red-500/10 p-3 text-sm text-red-400">
                <AlertCircle className="h-4 w-4 shrink-0" />
                <span>{error}</span>
              </div>
            )}

            <div className="space-y-2">
              <Label htmlFor="email" className="text-slate-300">Email</Label>
              <Input
                id="email"
                type="email"
                placeholder="tu@email.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                disabled={isLoading}
                className="border-slate-700 bg-slate-800/50 text-white placeholder:text-slate-500 focus:border-blue-500/50"
              />
            </div>

            <div className="space-y-2">
              <div className="flex items-center justify-between">
                <Label htmlFor="password" className="text-slate-300">Contraseña</Label>
                <Link
                  href="/recuperar-password"
                  className="text-xs text-slate-400 hover:text-blue-400 transition-colors"
                >
                  ¿Olvidaste tu contraseña?
                </Link>
              </div>
              <div className="relative">
                <Input
                  id="password"
                  type={showPassword ? 'text' : 'password'}
                  placeholder="••••••••"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  disabled={isLoading}
                  className="border-slate-700 bg-slate-800/50 pr-10 text-white"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white"
                >
                  {showPassword ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                </button>
              </div>
            </div>

            <Button
              type="submit"
              disabled={isLoading}
              className={cn(
                'w-full bg-blue-600 hover:bg-blue-700 text-white mt-4',
                isLoading && 'opacity-70 cursor-not-allowed'
              )}
            >
              {isLoading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Ingresando...
                </>
              ) : 'Ingresar'}
            </Button>

            <p className="text-center text-xs text-slate-500">
              ¿Aún no tienes cuenta?{' '}
              <Link
                href="/register"
                className="text-blue-400 hover:underline"
              >
                Crea tu cuenta aquí
              </Link>
            </p>
          </form>
        )}
      </CardContent>

      <CardFooter className="flex flex-col gap-4 border-t border-white/5 pt-4">
        {mode === 'form' && (
          <Button
            variant="ghost"
            size="sm"
            className="text-xs text-slate-600 hover:text-slate-400 transition-colors"
            onClick={() => setMode('selector')}
          >
            Global Talent Staff Access
          </Button>
        )}

        <p className="text-center text-xs text-slate-500">
          {mode === 'form' ? "¿Problemas para acceder? Contacta soporte" : '"Conectando talento, automáticamente"'}
        </p>
      </CardFooter>
    </Card>
  );
}

export default function LoginPage() {
  return (
    <div className="mx-auto flex w-full flex-col justify-center space-y-6 px-4 sm:w-[400px]">
      <Suspense fallback={
        <div className="flex justify-center p-8">
          <Loader2 className="h-8 w-8 animate-spin text-blue-500" />
        </div>
      }>
        <LoginForm />
      </Suspense>
    </div>
  );
}
</file>

</files>
